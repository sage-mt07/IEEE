---
conversation_id: "67986927-3350-8007-8708-f7df20d520ea"
title: "Dapper SQL Server タイムアウト"
create_time: 1738041639.529514
update_time: 1738043076.859263
language_guess: "en"
num_messages: 21
part_index: 1
part_count: 1
---

### system — 2025-01-28T05:20:39.529514+00:00

_(empty)_

### user — 2025-01-28T05:20:39.541656+00:00

Dapper sqlserver error 1222 @lock_rimeout =-1 発生理由

### assistant — 2025-01-28T05:21:43.435493+00:00

_(empty)_

### assistant — 2025-01-28T05:21:43.435715+00:00

DapperでSQL Serverを操作中にエラー「1222: Lock request time out period exceeded」（@lock_timeout = -1）に遭遇する理由は、データベース内でリソース（テーブル、行、ページなど）のロックが競合してタイムアウトしたことを示しています。このエラーの発生原因と対策について説明します。

---

### **エラー発生の主な理由**
1. **ロック競合**
   - 同じリソース（例：特定のテーブルや行）を複数のトランザクションが同時に操作しようとし、ロックが解除されるのを待っている間にタイムアウトが発生。
   - 典型的には、更新系クエリ（`UPDATE`、`DELETE`）やテーブルロックを伴う`SELECT`が原因。

2. **長時間実行されているトランザクション**
   - 別のプロセスが長い間リソースをロックしている場合、Dapperから発行されたクエリがそのロック解除を待ち続け、最終的にタイムアウト。

3. **デッドロック**
   - 2つ以上のトランザクションが互いにロックを取り合い、進行不可能な状態になることがあります。この場合、SQL Serverが一方のトランザクションを強制終了する可能性があります。

4. **`LOCK_TIMEOUT`の設定**
   - SQL Serverではデフォルトでロックタイムアウトが無制限（`-1`）になっていますが、Dapperやアプリケーションコードで`LOCK_TIMEOUT`を設定している場合、その値を超えるとタイムアウトが発生します。

---

### **エラー解決のためのアプローチ**

#### 1. **トランザクションを確認**
   - 長時間のトランザクションが原因である場合、トランザクションのスコープを小さくすることを検討してください。
   - 確認コマンド：
     ```sql
     SELECT * FROM sys.dm_tran_active_transactions;
     ```

#### 2. **インデックスの最適化**
   - 適切なインデックスがないと、SQL Serverがより多くのリソースをロックする必要があります。クエリの実行計画を確認し、インデックスの最適化を行います。

#### 3. **クエリの最適化**
   - ロックを減らすために、以下を検討してください：
     - 必要最小限の行をターゲットにする。
     - 不要な`UPDLOCK`や`HOLDLOCK`を使用しない。

#### 4. **`NOLOCK`ヒントの利用**
   - 読み取り専用のクエリである場合、ロックを回避するために`NOLOCK`ヒントを使用します。ただし、これにより未コミットデータが読み取られる可能性がある点に注意してください。
     ```sql
     SELECT * FROM YourTable WITH (NOLOCK);
     ```

#### 5. **ロックタイムアウト値の調整**
   - 必要に応じて、タイムアウト値を長くすることが可能です：
     ```sql
     SET LOCK_TIMEOUT 5000; -- 5秒
     ```
   - Dapper内でカスタムSQLを記述する場合、この設定を追加できます。

#### 6. **デッドロック対策**
   - デッドロックが頻発する場合、リソースのロック順序を統一する、または分離レベルを調整することを検討します。

#### 7. **SQL Server側のモニタリング**
   - モニタリングツールやDMV（動的管理ビュー）を使用してロックの状況を把握する：
     ```sql
     SELECT request_session_id, resource_type, resource_description
     FROM sys.dm_tran_locks
     WHERE resource_type <> 'DATABASE';
     ```

---

### **Dapper特有の考慮事項**
Dapper自体は単純にSQLクエリを送信するライブラリであり、SQL Serverのロック処理には直接関与しません。ただし、以下の点に注意が必要です：
- **接続管理**
  - `using`構文を利用して、適切に接続を閉じる。
- **非同期処理**
  - `QueryAsync`や`ExecuteAsync`を使用し、ブロッキングを最小化する。

---

これらの対策を講じることで、`1222`エラーの発生を防ぐ可能性が高まります。どのアプローチを採用するかは、エラーの詳細状況やシステム構成に依存します。

### user — 2025-01-28T05:24:28.190618+00:00

Dapper でlocktimeout設定方法

### assistant — 2025-01-28T05:24:40.073638+00:00

search("Dapper \u3067locktimeout\u8a2d\u5b9a\u65b9\u6cd5")

### tool — 2025-01-28T05:24:40.073763+00:00

_(empty)_

### assistant — 2025-01-28T05:24:40.073823+00:00

Dapperを使用してSQL Serverとやり取りする際、ロックの待機時間（ロックタイムアウト）を適切に設定することで、アプリケーションのパフォーマンスや信頼性を向上させることができます。ロックタイムアウトは、SQL Serverがリソースのロックを取得しようとする際に、指定した時間内に取得できない場合にタイムアウトエラーを発生させる設定です。

**ロックタイムアウトの設定方法:**

1. **SQL Server内での設定:**

   SQL Serverでは、`SET LOCK_TIMEOUT`ステートメントを使用して、ロックの待機時間をミリ秒単位で設定できます。例えば、5秒（5000ミリ秒）待機する場合は以下のように設定します：

   ```sql
   SET LOCK_TIMEOUT 5000;
   ```

   この設定により、クエリはロックを取得するために最大5秒間待機し、それを超えるとタイムアウトエラーが発生します。 citeturn0search2

2. **Dapper内での設定:**

   Dapperは、SQLクエリを実行する際に`commandTimeout`パラメータを使用して、コマンドのタイムアウトを秒単位で設定できます。これは、SQL Serverの`SET LOCK_TIMEOUT`とは異なり、コマンド全体の実行時間のタイムアウトを設定します。例えば、Dapperの`Execute`メソッドを使用してストアドプロシージャを実行する際に、タイムアウトを60秒に設定するには以下のようにします：

   ```csharp
   using (var connection = new SqlConnection(connectionString))
   {
       connection.Open();
       var parameters = new DynamicParameters();
       // パラメータの設定
       connection.Execute("ストアドプロシージャ名", parameters, commandTimeout: 60, commandType: CommandType.StoredProcedure);
   }
   ```

   この`commandTimeout`パラメータは、コマンドの実行全体のタイムアウトを設定し、デフォルトでは30秒に設定されています。 citeturn0search0

**注意点:**

- **`SET LOCK_TIMEOUT`の効果範囲:** `SET LOCK_TIMEOUT`は、設定したセッション内でのみ有効です。そのため、Dapperを介してクエリを実行する際にこの設定を適用するには、クエリ内で`SET LOCK_TIMEOUT`を実行する必要があります。例えば、Dapperの`Execute`メソッドで複数のSQLステートメントを実行する際に、最初に`SET LOCK_TIMEOUT`を設定し、その後に実際のクエリを実行することができます：

   ```csharp
   var sql = @"
   SET LOCK_TIMEOUT 5000;
   -- 実際のクエリ
   SELECT * FROM YourTable;
   ";
   var result = connection.Query<YourModel>(sql);
   ```

- **`commandTimeout`との違い:** `commandTimeout`は、Dapperがコマンド全体の実行時間を監視し、指定した時間内に完了しない場合にタイムアウトエラーを発生させます。一方、`SET LOCK_TIMEOUT`は、特定のリソースのロック取得待機時間を設定します。これらは異なる目的のタイムアウト設定であるため、用途に応じて適切に設定してください。

適切なタイムアウト設定を行うことで、データベース操作中の待機時間を制御し、アプリケーションのパフォーマンスとユーザーエクスペリエンスを向上させることができます。

### user — 2025-01-28T05:31:23.149167+00:00

Commandtimeoutのエラー番号

### assistant — 2025-01-28T05:31:32.657585+00:00

search("Commandtimeout\u306e\u30a8\u30e9\u30fc\u756a\u53f7")

### tool — 2025-01-28T05:31:32.657699+00:00

_(empty)_

### assistant — 2025-01-28T05:31:32.657767+00:00

Dapperで`CommandTimeout`を設定した際、クエリの実行が指定した時間内に完了しない場合、タイムアウトが発生します。このとき、.NETの`SqlCommand`オブジェクトは`SqlException`をスローし、その`Number`プロパティには特定のエラー番号が設定されます。一般的に、コマンドのタイムアウトが発生した場合、`SqlException.Number`の値は`-2`となります。

このエラー番号は、SQL Serverがクエリの実行を指定された時間内に完了できなかったことを示しています。Dapperは内部的に`SqlCommand`を使用しているため、Dapper経由でクエリを実行する際にタイムアウトが発生すると、同様に`SqlException`がスローされ、その`Number`プロパティは`-2`となります。

タイムアウトの発生を防ぐためには、`CommandTimeout`の値を適切に設定することが重要です。Dapperの`Execute`や`Query`メソッドでは、`commandTimeout`パラメータを使用してタイムアウト時間を秒単位で指定できます。例えば、タイムアウト時間を60秒に設定するには、以下のように記述します：

```csharp
using (var connection = new SqlConnection(connectionString))
{
    connection.Open();
    var parameters = new DynamicParameters();
    // パラメータの設定
    connection.Execute("ストアドプロシージャ名", parameters, commandTimeout: 60, commandType: CommandType.StoredProcedure);
}
```

この設定により、クエリの実行が60秒以内に完了しない場合、タイムアウトが発生し、`SqlException`がスローされます。タイムアウトのデフォルト値は30秒ですが、長時間実行される可能性のあるクエリやストアドプロシージャを実行する際には、適切な値に調整することを検討してください。

また、Dapper全体でデフォルトのタイムアウト値を設定することも可能です。以下のように、アプリケーションの初期化時に`SqlMapper.Settings.CommandTimeout`を設定することで、全てのDapperクエリに対してデフォルトのタイムアウト値を指定できます：

```csharp
Dapper.SqlMapper.Settings.CommandTimeout = 60;
```

この設定により、個々のクエリで`commandTimeout`を指定しなくても、デフォルトで60秒のタイムアウトが適用されます。ただし、特定のクエリで異なるタイムアウト値を設定したい場合は、個別に`commandTimeout`パラメータを指定することができます。

適切なタイムアウト設定を行うことで、アプリケーションのパフォーマンスと信頼性を向上させることができます。クエリの特性や実行環境に応じて、最適なタイムアウト値を設定してください。

### user — 2025-01-28T05:42:22.098359+00:00

Sqlexveption 0x80131904

### assistant — 2025-01-28T05:42:32.505518+00:00

search("Sqlexveption 0x80131904")

### tool — 2025-01-28T05:42:32.505629+00:00

_(empty)_

### assistant — 2025-01-28T05:42:32.505686+00:00

`0x80131904` は、.NET アプリケーションが SQL Server への接続中に発生する一般的な例外コードであり、`System.Data.SqlClient.SqlException` または `Microsoft.Data.SqlClient.SqlException` に関連しています。このエラーは、さまざまな原因で発生する可能性があり、具体的なエラーメッセージや状況に応じて対処方法が異なります。

**主な原因と対処方法:**

1. **ネットワーク関連またはインスタンス固有のエラー:**
   - **原因:** SQL Server への接続時に、サーバーが見つからない、アクセスできない、またはネットワークの問題が原因で接続が確立できない場合に発生します。
   - **対処方法:**
     - SQL Server が起動しており、リモート接続を許可していることを確認します。
     - ファイアウォール設定で、SQL Server の使用するポート（デフォルトでは TCP 1433）が開いていることを確認します。
     - 接続文字列が正しく構成されていることを確認します。
     - ネットワークの安定性を確認し、必要に応じてネットワーク管理者に相談してください。

2. **SSL/TLS 証明書の問題:**
   - **原因:** サーバーの SSL 証明書が信頼されていない、または TLS バージョンの不一致が原因で、ログインプロセス中にエラーが発生することがあります。
   - **対処方法:**
     - 接続文字列に `TrustServerCertificate=True` を追加して、サーバー証明書の信頼を強制します。
     - SQL Server およびクライアントが同じ TLS バージョン（通常は TLS 1.2）をサポートしていることを確認します。
     - 可能であれば、適切な証明書をサーバーにインストールし、クライアントがそれを信頼できるように設定します。

3. **接続タイムアウト:**
   - **原因:** SQL Server への接続試行がタイムアウトする場合に発生します。
   - **対処方法:**
     - 接続文字列の `Connect Timeout` パラメータを増やして、接続試行の待機時間を延長します。
     - SQL Server のパフォーマンスや負荷を監視し、必要に応じてリソースのスケーリングや最適化を検討します。

4. **認証モードの不一致:**
   - **原因:** SQL Server が Windows 認証のみを許可しているが、接続が SQL Server 認証を使用しようとしている場合など、認証モードの不一致が原因で接続エラーが発生することがあります。
   - **対処方法:**
     - SQL Server の認証モードが、使用している接続方法（Windows 認証または SQL Server 認証）と一致していることを確認します。
     - 必要に応じて、SQL Server の認証モードを変更するか、接続方法を調整します。

これらの対処方法を試しても問題が解決しない場合、エラーメッセージの詳細や発生状況をさらに調査し、特定の問題に対応した解決策を検討することが重要です。

### user — 2025-01-28T05:44:26.881133+00:00

Errornumber 1222 state 56 class 16

### assistant — 2025-01-28T05:44:36.404626+00:00

search("Errornumber 1222 state 56 class 16")

### tool — 2025-01-28T05:44:36.404773+00:00

_(empty)_

### assistant — 2025-01-28T05:44:36.404864+00:00

SQL Server のエラー番号 1222、状態 56、クラス 16 は、ロック要求のタイムアウトが発生したことを示しています。このエラーは、特定のリソース（テーブルや行など）が別のトランザクションによってロックされており、現在のクエリがそのロックの解除を待機している間に、設定された待機時間を超過した場合に発生します。

**主な原因:**

- **ロック競合:** 別のトランザクションが対象のリソースをロックしており、そのロックが解除されるのを待つ間にタイムアウトが発生します。

**対処方法:**

1. **ロックを保持しているトランザクションの特定:**
   - 動的管理ビュー `sys.dm_os_waiting_tasks` および `sys.dm_tran_locks` を使用して、どのトランザクションがロックを保持しているかを特定します。
   - 例:
     ```sql
     SELECT * FROM sys.dm_os_waiting_tasks;
     SELECT * FROM sys.dm_tran_locks;
     ```

2. **トランザクションの終了:**
   - ロックを保持しているトランザクションが不要であれば、`KILL` コマンドを使用して強制終了します。
   - 例:
     ```sql
     KILL <SPID>;
     ```
   - `<SPID>` は、ロックを保持しているプロセスの ID です。

3. **トランザクション設計の見直し:**
   - トランザクションが長時間ロックを保持しないように、設計を見直します。
   - 大きなトランザクションを小さなトランザクションに分割することを検討してください。

4. **ロックタイムアウト設定の調整:**
   - 必要に応じて、ロックタイムアウトの設定を変更します。
   - 例:
     ```sql
     SET LOCK_TIMEOUT 5000; -- 5秒
     ```
   - この設定により、クエリはロックの取得を最大 5 秒間待機し、それを超えるとタイムアウトエラーが発生します。

詳細については、Microsoft の公式ドキュメントをご参照ください。 citeturn0search0

これらの対処方法を実施することで、エラー 1222 の発生を防止し、データベースのパフォーマンスと信頼性を向上させることができます。
