---
conversation_id: "68d478fb-525c-8321-ae63-4317a67e4215"
title: "Tfsconfig offlinedetach 仕組み"
create_time: 1758755093.643447
update_time: 1758758210.486663
language_guess: "en"
num_messages: 16
part_index: 1
part_count: 1
---

### user — 2025-09-24T23:04:52.768000+00:00

tfsconfig offlinedetach の仕組みの説明

### assistant — 2025-09-24T23:04:53.446697+00:00

_(empty)_

### assistant — 2025-09-24T23:04:53.481586+00:00

送信日時: [[REDACTED_PHONE]]:42:13 JST

`tfsconfig offlinedetach` の仕組みについて整理しました。  

---

## 背景
Team Foundation Server (TFS) / Azure DevOps Server の **Project Collection データベース** は通常、アプリケーション層（TFS サービス）と強く結びついて動作します。  
コレクション DB を他の環境へ移行・復元するとき、TFS のインスタンス情報や識別子（InstanceId、IdentityMap、ServiceHost 情報など）が一致しないと、直接アタッチできずエラーになります。  

これを解消するのが **OfflineDetach / OfflineAttach** の仕組みです。

---

## `tfsconfig offlinedetach` の動作
`TfsConfig OfflineDetach` コマンドを実行すると、対象のコレクション DB に対して以下の操作が行われます。

1. **「オンライン管理情報」の除去**  
   - `tbl_ServiceHost` や `tbl_Configuration` に保存されている「元の TFS インスタンスに結びついた情報」を削除または無効化。
   - これにより「このコレクションはどの TFS に属しているか」というひも付けが切れる。

2. **「Detached 状態フラグ」の設定**  
   - DB 内のフラグを更新して「切り離された状態（Detached）」を記録。
   - この状態にすることで、どの TFS 環境からも「OfflineAttach」できるようになる。

3. **アクセス禁止状態の付与**  
   - コレクションは TFS サービスから「使えない状態」と認識される。
   - DB としては存在しているが、ユーザーやサービスはアクセスできなくなる。

---

## その後の流れ
- **OfflineDetach 後の DB** は、他のサーバーへバックアップ／復元可能。
- 新しいサーバーで **`tfsconfig offlinedattach /attach`** を実行すると、  
  - そのサーバーの `Configuration DB` に新しい `ServiceHostId` として登録される。  
  - Identity マップが再構築され、認証・権限情報も再設定される。  

---

## ポイント
- **通常の「Detach」** は TFS 管理コンソール上でオンライン操作として行う。  
  - 元のサーバーに接続している状態で実行する。
- **「OfflineDetach」** は元サーバーに接続できない状況で使用する。  
  - 例えば、旧サーバーが壊れて TFS サービスを起動できないとき。  
  - DB を直接操作できる権限（SQL 管理者）があれば実行できる。

---

## まとめ
- `tfsconfig offlinedetach` は **DB から元の TFS とのひも付け情報を削除し、再利用可能な「Detached 状態」にするツール**。  
- 主に **サーバー障害や移行シナリオ** で使われ、コレクション DB を他の TFS 環境へ再アタッチできるようにする。  

---

👉 司令、この説明は **Azure DevOps Server 2019 → 2022 移行** のトラブルシュートに関連させてますか？  
もしそうなら「移行中に `OfflineDetach` が必要になるケース」を具体例で示しますか？

### system — 2025-09-24T23:04:53.643447+00:00

_(empty)_

### system — 2025-09-24T23:04:53.643447+00:00

_(empty)_

### system — 2025-09-24T23:04:54.415242+00:00

_(empty)_

### user — 2025-09-24T23:05:07.785443+00:00

_(empty)_

### assistant — 2025-09-24T23:06:34.813921+00:00

送信日時: [[REDACTED_PHONE]]:00:42 JST  

はい、Azure DevOps Server 2019 → 2022 移行のケースでは、基本的に次のような流れになります。  

---

## 標準的な流れ（問題がない場合）
1. **2019 環境で通常の Detach**  
   - 管理コンソールまたは `tfsconfig detach` で Project Collection をデタッチ。  
   - このとき `tbl_ServiceHost` などから「2019 インスタンスへのひも付け」が外れる。  

2. **DB バックアップ／リストア**  
   - Detach した Collection DB を SQL Server レベルでバックアップ。  
   - 新サーバーの SQL にリストア。  

3. **2022 環境で Attach**  
   - `Azure DevOps Server 2022 管理コンソール` で「コレクションのアタッチ」を実行。  
   - 必要に応じて DB スキーマがアップグレードされる。  

---

## 障害がある場合（旧サーバーで Detach できない）
- 旧サーバーが壊れていたり、TFS サービスが起動しない場合は **通常の Detach ができない**。  
- このとき使うのが **`tfsconfig offlinedetach`**。  

### 手順イメージ
1. **2019 のコレクション DB に対して `tfsconfig offlinedetach` を実行**  
   - 直接 SQL DB を対象に「Detached 状態」にする。  
   - 元の 2019 サーバーからのひも付け情報を削除する。  

2. **DB を 2022 側に移行（バックアップ／リストア）**  

3. **2022 環境で Attach**  
   - 管理コンソールからコレクションをアタッチ。  
   - スキーマが 2022 用にアップグレードされる。  

---

## まとめ
- **正常系なら**：2019 管理コンソールで Detach → 2022 で Attach。  
- **異常系（2019 で Detach 不可）なら**：`tfsconfig offlinedetach` → 2022 で Attach。  

つまり、**必ずしも offlinedetach が必要ではなく、通常の detach ができればそれで十分**です。  

---

👉 質問ですが、司令のケースは「2019 側で管理コンソールから Detach できない状態」なんでしょうか？  
それとも「Detach はできるが、Attach 時に 2022 側でエラーになった」状態ですか？

### user — 2025-09-24T23:06:34.911000+00:00

関連させてる
2019でofflinedetach してから2022にattachの流れになる？

### user — 2025-09-24T23:28:27.360000+00:00

OfflineDetach コマンドはコレクション データベース スキーマを更新するので、Azure DevOps Server 配置で使用されているデータベースに対しては実行しないでください。データベースが Azure DevOps Server 配置で使用されている場合は、代わりに TfsConfig collection /detach をご使用ください。OfflineDetach コマンドを続行しますか? (Yes/No)No

### assistant — 2025-09-24T23:28:28.358840+00:00

送信日時: [[REDACTED_PHONE]]:12:21 JST  

はい、そのメッセージが示しているのはとても重要なポイントです。  

---

## メッセージの意味
- **`OfflineDetach` は最終手段**  
  - このコマンドは、DB のスキーマを書き換えて「このコレクションはどのサーバーにも属していない（Detached）」状態にします。  
  - そのため、**まだ Azure DevOps Server 環境で利用中のコレクション DB に対して実行すると壊れる**危険があります。  

- **通常は `TfsConfig collection /detach` を使うべき**  
  - 2019 側が稼働していて、管理コンソールや `tfsconfig collection /detach` が使えるなら、必ずそちらでデタッチするのが正解です。  
  - これなら DB は安全に Detached 状態にされ、2022 への Attach が保証されます。  

- **OfflineDetach が必要なケース**  
  - 元のサーバーが完全に使えない（起動しない、壊れたなど）場合。  
  - 通常の detach ができない場合に限り、「止むを得ず」使うもの。  

---

## 司令の状況にあわせた流れ
- **2019 サーバーが動いている** → 管理コンソールから Detach するべき（OfflineDetach は不要）。  
- **2019 サーバーが壊れている／管理コンソールが動かない** → 仕方なく `OfflineDetach` を実行し、その DB を 2022 側で Attach。  

---

## まとめ
- その確認メッセージに「No」と答えたのは正解です。  
- **今の環境で DB がまだ 2019 に接続されているなら、必ず `collection /detach` を使う**。  
- `OfflineDetach` は「旧サーバーが死んでるのでどうしようもない」時の最後の手段。  

---

👉 司令の移行シナリオは「2019 がまだ稼働している状態」でしょうか？  
それなら **通常 detach → backup/restore → 2022 attach** で進めるのが安全です。

### assistant — 2025-09-24T23:55:59.801938+00:00

送信日時: [[REDACTED_PHONE]]:23:52 JST  

いい質問です。結論から言うと、**2019 で Detach したあとに再度 2019 に Attach する必要はありません**。  

---

## Detach の意味
- **Detach** すると、そのコレクションは「このサーバーには属していない」という状態になります。  
- この状態で DB をバックアップして新しい環境（2022）へ移動できるようになる。  

---

## 移行の流れに当てはめると
1. **2019 管理コンソールで Detach**  
   - コレクションが「2019 環境から切り離された状態」になる。  
2. **DB バックアップ → 2022 にリストア**  
   - 物理的に DB をコピー。  
3. **2022 管理コンソールで Attach**  
   - 新しいサーバーに結び付けられ、スキーマが 2022 向けにアップグレードされる。  

この流れで完結するので、**2019 側に再アタッチは不要**です。  

---

## 再アタッチが必要になるケース
唯一考えられるのは「移行ではなくコピー」をしたい場合です。  
- 例えば「2019 環境でも残しておきたいから、Detach → DB コピー → 再度 2019 に Attach」みたいなケース。  
- ただし、同じコレクション DB を 2019 と 2022 両方に使うことはできないので、片方は必ず停止する必要があります。  

---

✅ まとめ  
- **移行なら再アタッチ不要。**  
- **併用や検証目的で 2019 でも使いたいなら、コピーして別名 DB にしてからアタッチ。**  

---

👉 司令のゴールは「完全移行」ですか？ それとも「しばらく 2019 と 2022 を並行運用」したい感じでしょうか？

### user — 2025-09-24T23:55:59.972000+00:00

2019でコレクションのデタッチした場合、そのあとで2019にアタッチする必要がある？

### assistant — 2025-09-24T23:56:43.656287+00:00

送信日時: [[REDACTED_PHONE]]:33:11 JST  

はい、そのとおりです 👍  

---

## 手順の順序
1. **2019 管理コンソールで Detach**  
   - コレクションが「切り離し状態」になり、2019 環境からは利用できなくなる。  
   - この時点で「移行可能な安全な状態」に整う。  

2. **SQL Server で DB のフルバックアップ**  
   - Detach した状態のコレクション DB をバックアップ。  
   - そのバックアップファイル (.bak) を新しい SQL Server（2022 環境）にリストアする。  

3. **2022 管理コンソールで Attach**  
   - リストア済みのコレクション DB を選択してアタッチ。  
   - このとき自動的に DB スキーマが 2022 向けにアップグレードされる。  

---

## 注意点
- **Detach → Backup** の順序が大事です。  
  - Detach 前に取ったバックアップだと、「まだ 2019 環境にひも付いた状態」なので、そのままでは 2022 側でエラーになる可能性があります。  
- バックアップ後、元の 2019 環境に再アタッチする必要はありません（完全移行の場合）。  

---

✅ まとめ  
- **Detach してからフルバックアップ → 2022 にリストア → Attach が正しい流れ**。  
- Detach 前のバックアップは使わないほうがいい。  

---

👉 司令のケースでは、すでに 2019 の DB フルバックアップは取ってありますか？ それとも「これから Detach → Backup」をやる感じですか？

### user — 2025-09-24T23:56:43.863000+00:00

デタッチしたあとにDBのフルバックアップ？
