---
conversation_id: "68d8cb1d-6f54-8321-9ae0-fdffdea7d9b2"
title: "クエリ構文エラー解析"
create_time: 1759038252.265056
update_time: 1759038374.305247
language_guess: "en"
num_messages: 14
part_index: 1
part_count: 1
---

### user — 2025-09-28T05:44:10.837000+00:00

[[[REDACTED_PHONE]]:25:04,570] WARN 172.18.0.1 - - [Sun, 28 Sep [[REDACTED_PHONE]]:25:04 GMT] "POST /ksql HTTP/1.1" 400 193 "-" "-" 63 (io.confluent.ksql.api.server.LoggingHandler)
[[[REDACTED_PHONE]]:25:07,264] INFO Received: KsqlRequest{configOverrides={}, requestProperties={}, commandSequenceNumber=Optional.empty} (1fc6aaef-8b49-3b24-a872-f36e23e86e19): <unparsable query> (io.confluent.ksql.logging.query.QueryLogger)
[[[REDACTED_PHONE]]:25:07,265] INFO Processed unsuccessfully: KsqlRequest{configOverrides={}, requestProperties={}, commandSequenceNumber=Optional.empty} (1fc6aaef-8b49-3b24-a872-f36e23e86e19): <unparsable query> (io.confluent.ksql.logging.query.QueryLogger)
io.confluent.ksql.parser.exception.ParseFailedException: line 1:10: Syntax error at line 1:10
	at io.confluent.ksql.parser.DefaultKsqlParser.parse(DefaultKsqlParser.java:56)
	at io.confluent.ksql.engine.EngineContext.parse(EngineContext.java:160)
	at io.confluent.ksql.engine.KsqlEngine.parse(KsqlEngine.java:286)
	at io.confluent.ksql.rest.server.resources.KsqlResource.handleKsqlStatements(KsqlResource.java:308)
	at io.confluent.ksql.rest.server.KsqlServerEndpoints.lambda$executeKsqlRequest$2(KsqlServerEndpoints.java:183)
	at io.confluent.ksql.rest.server.KsqlServerEndpoints.lambda$executeOldApiEndpointOnWorker$24(KsqlServerEndpoints.java:348)
	at io.confluent.ksql.rest.server.KsqlServerEndpoints.lambda$executeOnWorker$23(KsqlServerEndpoints.java:334)
	at io.vertx.core.impl.ContextBase.lambda$executeBlocking$1(ContextBase.java:180)
	at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:277)
	at io.vertx.core.impl.ContextBase.lambda$internalExecuteBlocking$2(ContextBase.java:199)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Unknown Source)
Caused by: io.confluent.ksql.parser.ParsingException: line 1:10: Syntax error at line 1:10
	at io.confluent.ksql.parser.SyntaxErrorValidator.syntaxError(SyntaxErrorValidator.java:162)
	at org.antlr.v4.runtime.ProxyErrorListener.syntaxError(ProxyErrorListener.java:41)
	at org.antlr.v4.runtime.Parser.notifyErrorListeners(Parser.java:544)
	at org.antlr.v4.runtime.DefaultErrorStrategy.reportNoViableAlternative(DefaultErrorStrategy.java:310)
	at org.antlr.v4.runtime.DefaultErrorStrategy.reportError(DefaultErrorStrategy.java:136)
	at io.confluent.ksql.parser.SqlBaseParser.statement(SqlBaseParser.java:2526)
	at io.confluent.ksql.parser.SqlBaseParser.singleStatement(SqlBaseParser.java:377)
	at io.confluent.ksql.parser.SqlBaseParser.statements(SqlBaseParser.java:240)
	at io.confluent.ksql.parser.DefaultKsqlParser.getParseTree(DefaultKsqlParser.java:121)
	at io.confluent.ksql.parser.DefaultKsqlParser.parse(DefaultKsqlParser.java:45)
	... 13 more

このログは何を示してる？

### assistant — 2025-09-28T05:44:11.470384+00:00

_(empty)_

### assistant — 2025-09-28T05:44:11.598398+00:00

このログが示しているのは、**ksqldb に送られたクエリが構文エラーでパースできなかった**ということです。ポイントを整理しますね。

---

## 1. ログの内容
- **WARN行**  
  ```
  "POST /ksql HTTP/1.1" 400
  ```
  → REST API に対してクエリを POST したが、HTTP ステータスが **400 Bad Request** で返却されている。

- **INFO行**  
  ```
  Received: KsqlRequest{...}: <unparsable query>
  ```
  → サーバーはクエリを受け取ったが、「unparsable query（解釈不能なクエリ）」と記録されている。

- **ParseFailedException**  
  ```
  line 1:10: Syntax error at line 1:10
  ```
  → 1行目の10文字目付近で構文エラーが発生。ANTLR（ksqlDBのパーサ）がそこで失敗している。

---

## 2. どういう状況か
- ksqlDB に渡されたクエリ文字列が **SQL/KSQL 構文になっていない**。  
- 例として、以下のようなケースで起きやすいです：
  - **SQL文のキーワードや記法の誤り**  
    例: `CREATE STRAM ...` （STREAMのtypo）
  - **サポートされない関数や構文の使用**
  - **余分な記号や不足したセミコロン**
  - **REST API 呼び出し時の JSON ボディが不正**で、クエリ文字列が壊れて送られている

---

## 3. 確認すべきこと
1. 実際に送っている KSQL 文を確認する  
   - ksqlDB CLI から同じ文を実行してみるとエラーメッセージがより分かりやすいです。
2. REST API の場合は JSON の `"ksql": "..."` 部分が正しく文字列になっているかチェック。
3. エラーの位置 (`line 1:10`) を目印に、スペルミスや句読点の有無を確認。

---

## 4. まとめ
このログは、
- **クライアントがPOSTしたクエリが不正**で  
- **ksqlDBのパーサが1行目10文字目付近で構文エラーを検出し、400エラーを返した**  
ということを示しています。

---

司令、このとき送ったクエリの実物を見せてもらえれば、どこが間違っているか具体的に指摘できますよ。確認しますか？  

（送信時刻: [[REDACTED_PHONE]]:06:22 JST）

### system — 2025-09-28T05:44:12.265056+00:00

_(empty)_

### system — 2025-09-28T05:44:12.265056+00:00

_(empty)_

### system — 2025-09-28T05:44:13.346779+00:00

_(empty)_

### user — 2025-09-28T05:44:28.940256+00:00

_(empty)_

### user — 2025-09-28T05:45:15.849000+00:00

[[[REDACTED_PHONE]]:24:57,674] INFO Source DEDUPRATES created on the metastore (io.confluent.ksql.metastore.MetaStoreImpl)
[[[REDACTED_PHONE]]:24:57,674] INFO Executed statement: stream/`DEDUPRATES`/create (io.confluent.ksql.rest.server.computation.CommandRunner)
[[[REDACTED_PHONE]]:24:57,674] INFO [Producer clientId=producer-ksql_service_1, transactionalId=ksql_service_1] Closing the Kafka producer with timeoutMillis = [[REDACTED_PHONE]] ms. (org.apache.kafka.clients.producer.KafkaProducer)
[[[REDACTED_PHONE]]:24:57,678] INFO App info kafka.producer for producer-ksql_service_1 unregistered (org.apache.kafka.common.utils.AppInfoParser)
[[[REDACTED_PHONE]]:24:57,679] INFO Processed successfully: KsqlRequest{configOverrides={}, requestProperties={}, commandSequenceNumber=Optional.empty} (94e825b0-[[REDACTED_PHONE]]-aae3-e0beac5886f3): CREATE OR REPLACE STREAM stream1 (column1 VARCHAR KEY, column2 VARCHAR KEY, column3 CUSTOM_TYPE, column4 DOUBLE) WITH (KAFKA_TOPIC='[string]', KEY_FORMAT='[string]', VALUE_FORMAT='[string]', VALUE_AVRO_SCHEMA_FULL_NAME='[string]', TIMESTAMP='[string]', PARTITIONS='0', REPLICAS='0'); (io.confluent.ksql.logging.query.QueryLogger)
[[[REDACTED_PHONE]]:24:57,679] INFO App info kafka.admin.client for adminclient-7 unregistered (org.apache.kafka.common.utils.AppInfoParser)
[[[REDACTED_PHONE]]:24:57,686] INFO 172.18.0.1 - - [Sun, 28 Sep [[REDACTED_PHONE]]:24:57 GMT] "POST /ksql HTTP/1.1" 200 546 "-" "-" 401 (io.confluent.ksql.api.server.LoggingHandler)
[[[REDACTED_PHONE]]:24:57,691] INFO Received: KsqlRequest{configOverrides={}, requestProperties={}, commandSequenceNumber=Optional.empty} (1fc6aaef-8b49-3b24-a872-f36e23e86e19): <unparsable query> (io.confluent.ksql.logging.query.QueryLogger)
[[[REDACTED_PHONE]]:24:57,692] INFO Processed unsuccessfully: KsqlRequest{configOverrides={}, requestProperties={}, commandSequenceNumber=Optional.empty} (1fc6aaef-8b49-3b24-a872-f36e23e86e19): <unparsable query> (io.confluent.ksql.logging.query.QueryLogger)
io.confluent.ksql.parser.exception.ParseFailedException: line 1:10: Syntax error at line 1:10
	at io.confluent.ksql.parser.DefaultKsqlParser.parse(DefaultKsqlParser.java:56)
	at io.confluent.ksql.engine.EngineContext.parse(EngineContext.java:160)
	at io.confluent.ksql.engine.KsqlEngine.parse(KsqlEngine.java:286)
	at io.confluent.ksql.rest.server.resources.KsqlResource.handleKsqlStatements(KsqlResource.java:308)
	at io.confluent.ksql.rest.server.KsqlServerEndpoints.lambda$executeKsqlRequest$2(KsqlServerEndpoints.java:183)
	at io.confluent.ksql.rest.server.KsqlServerEndpoints.lambda$executeOldApiEndpointOnWorker$24(KsqlServerEndpoints.java:348)
	at io.confluent.ksql.rest.server.KsqlServerEndpoints.lambda$executeOnWorker$23(KsqlServerEndpoints.java:334)
	at io.vertx.core.impl.ContextBase.lambda$executeBlocking$1(ContextBase.java:180)
	at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:277)
	at io.vertx.core.impl.ContextBase.lambda$internalExecuteBlocking$2(ContextBase.java:199)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Unknown Source)
Caused by: io.confluent.ksql.parser.ParsingException: line 1:10: Syntax error at line 1:10
	at io.confluent.ksql.parser.SyntaxErrorValidator.syntaxError(SyntaxErrorValidator.java:162)
	at org.antlr.v4.runtime.ProxyErrorListener.syntaxError(ProxyErrorListener.java:41)
	at org.antlr.v4.runtime.Parser.notifyErrorListeners(Parser.java:544)
	at org.antlr.v4.runtime.DefaultErrorStrategy.reportNoViableAlternative(DefaultErrorStrategy.java:310)
	at org.antlr.v4.runtime.DefaultErrorStrategy.reportError(DefaultErrorStrategy.java:136)
	at io.confluent.ksql.parser.SqlBaseParser.statement(SqlBaseParser.java:2526)
	at io.confluent.ksql.parser.SqlBaseParser.singleStatement(SqlBaseParser.java:377)
	at io.confluent.ksql.parser.SqlBaseParser.statements(SqlBaseParser.java:240)
	at io.confluent.ksql.parser.DefaultKsqlParser.getParseTree(DefaultKsqlParser.java:121)
	at io.confluent.ksql.parser.DefaultKsqlParser.parse(DefaultKsqlParser.java:45)
	... 13 more

### assistant — 2025-09-28T05:45:16.673814+00:00

やあ司令、ログの流れを読むと──

- **03:24:57.674**  
  `DEDUPRATES` をメタストアに作成 → **成功**  
  続けて `CREATE OR REPLACE STREAM stream1 (...) WITH (...);` が **正常処理** され、`POST /ksql` は **200** を返しています。

- **その直後 (03:24:57.691〜)**  
  **別の POST** が入り、サーバ側では `<unparsable query>`（＝**文字列としてのKSQLが成立していない**）として受理 → **パース失敗**（`line 1:10` で構文エラー）。

つまり、**短時間に2本投げたうち「1本目は成功、2本目はKSQLテキストが壊れていた」** ことを示しています。`QueryLogger` が実際の文を出さず `<unparsable query>` とだけ出すのは、**KSQLの字面として解釈できない**場合（空文字/途中で文字化け/JSONの`ksql`フィールドが崩れている/テンプレート展開ミスなど）に起きがちです。`line 1:10` は**1行目の10文字目付近**でパーサが迷子になったサイン。

### よくある原因（このケースに当たりそうな順）
1. **クライアント側のテンプレート展開ミス**  
   例: 2本目の文で `{{...}}` や `[...]` のプレースホルダがそのまま残る／空文字になる。
2. **JSONボディの崩れ**（REST経由）  
   `{"ksql": "<ここが空 or 改行だけ>"}` や、`"ksql"` キー自体がない／エンコーディング不一致。
3. **先頭に不可視文字**（BOM、制御文字、全角スペース）  
   10文字目までに紛れ込むと、この位置のエラーになりやすい。
4. **コメントやラベル行の混入**  
   `/* ... */` が閉じていない、あるいは自前のラベル行（`stream/xxx/create` のような）を**SQLとして**送ってしまっている。
5. **セミコロン区切りのバッチ送信で途中が空**  
   `"; ; CREATE ...;"` のように空ステートメントが混ざる。

### いま取れる切り分け（即効版）
- **クライアント送信直前の「実際に投げたKSQL文字列」をログに出す。**  
  送信後ではなく「送信前」に `Console.WriteLine(sql)` 的に**原文**を残すのが確実。
- **同一ペイロードを `curl`/`httpie` で再現**  
  例:
  ```bash
  curl -sS -X POST localhost:8088/ksql \
    -H 'Content-Type: application/vnd.ksql.v1+json; charset=utf-8' \
    -d '{"ksql":"<ここに実際の2本目>", "streamsProperties":{}}'
  ```
  → サーバ応答でどこが壊れているかを単独で確認。
- **BOM/制御文字チェック**  
  送信文字列の先頭10〜15文字を **コードポイントでダンプ**（不可視文字の混入検査）。
- **JSON構造の検査**  
  `"ksql"` フィールドが**null/空文字/存在しない**になっていないか。

### ksqlDB側での追加観測
- `io.confluent.ksql.api.server` と `io.confluent.ksql.engine.EngineContext` を **DEBUG** に上げると、受信時の詳細が分かることがあります（ただし本文全出しはしない仕様のことが多いので、**送信側ログが主**）。
- 直後に `SHOW QUERIES;` / `SHOW STREAMS;` を投げて、**1本目が確実に反映**されているかを確認（1本目はログ上すでに成功ですが、状態の二重確認用）。

### 余談：1本目のCREATEの気づき
- `column1 VARCHAR KEY, column2 VARCHAR KEY` と**複数キー列**を宣言しています。使用中の ksqlDB バージョンによっては扱いが変わる点に注意（動いているのでここではNGではありません）。  
- `PARTITIONS='0', REPLICAS='0'` は**新規トピック生成時は無効値**です。`KAFKA_TOPIC` で**既存トピックを指している**なら無視されますが、**新規作成のつもりなら要見直し**。

---

必要なら、司令の送信側コード（KSQL文字列を作る箇所）を貼ってくれれば、**10文字目付近に何が来ているはずか**を前提にピンポイントで直します。まずは「2本目に実際に送った文字列の生ログ」を見せてもらえると最速で特定できます。

（送信日時: [[REDACTED_PHONE]]:18 JST）

### system — 2025-09-28T05:45:18.023032+00:00

_(empty)_

### system — 2025-09-28T05:45:18.120899+00:00

_(empty)_

### assistant — 2025-09-28T05:45:18.427659+00:00

_(empty)_

### assistant — 2025-09-28T05:45:43.738818+00:00

_(empty)_
