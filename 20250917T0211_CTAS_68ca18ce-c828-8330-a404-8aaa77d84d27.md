---
conversation_id: "68ca18ce-c828-8330-a404-8aaa77d84d27"
title: "CTASエラー解析"
create_time: 1758075089.980395
update_time: 1758075418.430735
language_guess: "en"
num_messages: 41
part_index: 1
part_count: 1
---

### user — 2025-09-17T02:11:25.319000+00:00

(org.apache.kafka.streams.processor.internals.StreamThread)
[[[REDACTED_PHONE]]:12:52,235] INFO stream-thread [_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-8] State transition from CREATED to STARTING (org.apache.kafka.streams.processor.internals.StreamThread)
[[[REDACTED_PHONE]]:12:52,235] INFO Executed statement: table/`BAR_TBIMP_1S_FINAL`/create (io.confluent.ksql.rest.server.computation.CommandRunner)
[[[REDACTED_PHONE]]:12:52,235] INFO [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-8-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Subscribed to topic(s): _confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition, ticks_tbimp (org.apache.kafka.clients.consumer.KafkaConsumer)
[[[REDACTED_PHONE]]:12:52,235] INFO [Producer clientId=producer-ksql_service_1, transactionalId=ksql_service_1] Closing the Kafka producer with timeoutMillis = [[REDACTED_PHONE]] ms. (org.apache.kafka.clients.producer.KafkaProducer)
[[[REDACTED_PHONE]]:12:52,242] WARN [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-1-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Error while fetching metadata with correlation id 2 : {_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition=UNKNOWN_TOPIC_OR_PARTITION} (org.apache.kafka.clients.NetworkClient)
[[[REDACTED_PHONE]]:12:52,243] INFO [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-1-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Resetting the last seen epoch of partition ticks_tbimp-0 to 0 since the associated topicId changed from null to sYbHhyjFS5uvsdxCgfzk0Q (org.apache.kafka.clients.Metadata)
[[[REDACTED_PHONE]]:12:52,243] INFO [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-1-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Cluster ID: WFJCBJQQTBWUW9CoGUGrFQ (org.apache.kafka.clients.Metadata)
[[[REDACTED_PHONE]]:12:52,243] INFO [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-1-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Discovered group coordinator kafka:29092 (id: [[REDACTED_PHONE]] rack: null) (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)
[[[REDACTED_PHONE]]:12:52,244] WARN [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-3-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Error while fetching metadata with correlation id 2 : {_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition=UNKNOWN_TOPIC_OR_PARTITION} (org.apache.kafka.clients.NetworkClient)
[[[REDACTED_PHONE]]:12:52,244] INFO [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-3-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Resetting the last seen epoch of partition ticks_tbimp-0 to 0 since the associated topicId changed from null to sYbHhyjFS5uvsdxCgfzk0Q (org.apache.kafka.clients.Metadata)

### system — 2025-09-17T02:11:29.980395+00:00

_(empty)_

### system — 2025-09-17T02:11:29.980395+00:00

_(empty)_

### system — 2025-09-17T02:11:35.259136+00:00

_(empty)_

### system — 2025-09-17T02:11:35.306546+00:00

_(empty)_

### assistant — 2025-09-17T02:11:35.332385+00:00

_(empty)_

### assistant — 2025-09-17T02:11:36.118878+00:00

_(empty)_

### assistant — 2025-09-17T02:12:03.328527+00:00

やあ司令、ログありがとう。結論だけ先に👇

- `UNKNOWN_TOPIC_OR_PARTITION` は、**CTASが起動直後に内部リパーティション・トピック（…`Aggregate-GroupBy-repartition`）へサブスクライブしたが、まだ作成・伝搬が済んでいない**時に出る“よくある”警告。**数十秒で消えるなら正常**です。
- 一方で**ずっと STARTING のまま**／内部トピックが作られないなら、**権限・トピック作成失敗・トピック再作成直後の不整合**が疑い所。

# いまのログの読み方（要点）
- `CREATED → STARTING`：起動フローOK。
- Consumer が `ticks_tbimp` と `…GroupBy-repartition` に subscribe：**GROUP BY 付きCTAS**なので内部リパーティションを使う動きは正常。
- `Producer ... Closing the Kafka producer`：**古いトランザクショナル・プロデューサのクローズ**。再起動／リバランス時に出がちで、単体では異常ではない。
- `Resetting the last seen epoch ... topicId changed`：`ticks_tbimp` を**削除→再作成**した痕跡。**コンシューマとメタデータが入れ替わった直後**に出る情報ログで、これもそれ単体ではOK。

# これが“正常な一時的警告”かを切り分けるチェック
1) **クエリ状態**
   - `SHOW QUERIES;`（または `SHOW QUERIES EXTENDED;`）
   - 期待：`RUNNING`
   - ずっと `RUNNING` にならない→下の②へ

2) **内部トピックの実在確認**
   - ブローカで  
     ```
     kafka-topics --bootstrap-server kafka:29092 \
       --describe --topic _confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition
     ```
   - 期待：トピックが存在し、パーティションとISRが表示される  
   - 存在しない／作れない→③へ

3) **作成失敗の原因切り分け**
   - ksqlDBサーバログに **「Create topics」失敗**や**AuthorizationException**がないか確認
   - ACL/RBAC を使っているなら、**`_confluent-ksql-*` および内部トピックに対する Create/Write/Delete/Describe 権限**が ksql サービスプリンシパルに付与されているか確認
   - ブローカ設定で内部トピックに影響しそうなもの：
     - `auto.create.topics.enable=true` でなくても **ksql は AdminClient で明示作成**するため必須ではないが、無効＋権限不足だと当然失敗
     - `num.partitions` / `default.replication.factor` がクラスタ現実値と矛盾しないか

4) **トピック再作成直後の不整合を解消**
   - `ticks_tbimp` を**作り直した直後**なら、**ksql サービスを再起動**してメタデータを綺麗に取り直させるのが早い
   - あるいは **`SET 'auto.offset.reset'='earliest';` で再デプロイ**（必要に応じて）

5) **永続的に STARTING のままの場合のよくある根因**
   - **内部トピック名のバリデーション**（企業ポリシーの禁止プレフィックスに該当）
   - **レプリカ要件未充足**（RF=3 だがブローカ2台など → ISR成立せず作成不可）
   - **同名残骸の不整合**（一部パーティションだけ残っている）→`kafka-topics --delete` で掃除→再実行
   - **SerDe/KEY_FORMAT の齟齬**で連鎖的に失敗（`PARTITION BY` と `KEY_FORMAT` の組合せが実際のキーに合っていない）  
     → `DESCRIBE EXTENDED BAR_TBIMP_1S_FINAL;` と `EXPLAIN <queryId>;` で推論されたキーと再分散の有無を確認

# いま取るべき最短アクション（順に実施でOK）
1. `SHOW QUERIES;` で `RUNNING` か確認  
2. 上記 `kafka-topics --describe` で **repartition トピックの存在**確認  
3. ない場合：ksql ログの「Create topic」失敗メッセージと **権限**を確認  
4. `ticks_tbimp` を最近作り直したなら **ksql 再起動**（最も手早い解毒）  
5. それでもNGなら、**トピックRF/ブローカ台数/ISR**を見て物理要件を満たす

> 目安：**60秒以内に RUNNING & 内部トピック作成**まで進めば“起動時の一過性警告”として問題なし。継続するなら上のチェックへ。

必要なら、`DESCRIBE EXTENDED BAR_TBIMP_1S_FINAL` と `SHOW QUERIES EXTENDED` の該当行を貼ってくれれば、キー推論/再分散の整合まで突き止めます。

—  
送信: [[REDACTED_PHONE]]:12 JST

### assistant — 2025-09-17T02:12:05.294610+00:00

_(empty)_

### user — 2025-09-17T02:12:51.521494+00:00

_(empty)_

### user — 2025-09-17T02:14:30.201000+00:00

[[[REDACTED_PHONE]]:12:52,353] INFO [Producer clientId=producer-ksql_service_1, transactionalId=ksql_service_1] Cluster ID: WFJCBJQQTBWUW9CoGUGrFQ (org.apache.kafka.clients.Metadata)
[[[REDACTED_PHONE]]:12:52,353] WARN [Consumer clientId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-d3686415-bb86-4cb2-816b-fe218a7cab21-StreamThread-8-consumer, groupId=_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27] Error while fetching metadata with correlation id 9 : {_confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition=UNKNOWN_TOPIC_OR_PARTITION} (org.apache.kafka.clients.NetworkClient)
[[[REDACTED_PHONE]]:12:52,353] INFO [Producer clientId=producer-ksql_service_1, transactionalId=ksql_service_1] Discovered transaction coordinator kafka:29092 (id: 1 rack: null) (org.apache.kafka.clients.producer.internals.TransactionManager)
[[[REDACTED_PHONE]]:12:52,363] ERROR stream-thread [CommandRunner] Unexpected error during topic creation for _confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition.
Error message was: org.apache.kafka.common.errors.InvalidConfigurationException: Unknown topic config name: creation.timeout.ms (org.apache.kafka.streams.processor.internals.InternalTopicManager)

### assistant — 2025-09-17T02:14:35.316247+00:00

{"search_query": [{"q": "Kafka topic config creation.timeout.ms Unknown topic config name"}, {"q": "creation.timeout.ms Kafka"}, {"q": "ksqlDB InternalTopicManager creation.timeout.ms InvalidConfigurationException"}], "response_length": "short"}

### system — 2025-09-17T02:14:36.286023+00:00

_(empty)_

### system — 2025-09-17T02:14:36.291489+00:00

_(empty)_

### assistant — 2025-09-17T02:14:36.696027+00:00

_(empty)_

### tool — 2025-09-17T02:14:45.263625+00:00

_(empty)_

### tool — 2025-09-17T02:14:45.281762+00:00

_(empty)_

### assistant — 2025-09-17T02:14:47.161621+00:00

{"search_query": [{"q": "Unknown topic config name: creation.timeout.ms Kafka"}, {"q": "creation.timeout.ms topic config Kafka Streams InternalTopicManager"}, {"q": "Kafka 3.x creation.timeout.ms topic config"}], "response_length": "short"}

### tool — 2025-09-17T02:14:51.974124+00:00

_(empty)_

### tool — 2025-09-17T02:14:51.986883+00:00

_(empty)_

### assistant — 2025-09-17T02:14:53.989589+00:00

{"search_query": [{"q": "\"creation.timeout.ms\" Kafka"}, {"q": "Unknown topic config name creation.timeout.ms ksqlDB"}, {"q": "InternalTopicManager creation.timeout.ms Kafka Streams 3.5"}], "response_length": "short"}

### tool — 2025-09-17T02:14:57.409975+00:00

_(empty)_

### tool — 2025-09-17T02:14:57.425453+00:00

_(empty)_

### assistant — 2025-09-17T02:14:59.143647+00:00

{"search_query": [{"q": "InternalTopicManager creation.timeout.ms site:github.com apache kafka streams"}, {"q": "Unknown topic config name: creation.timeout.ms Kafka Streams internal topic creation timeout"}], "response_length": "short"}

### tool — 2025-09-17T02:15:03.149709+00:00

_(empty)_

### tool — 2025-09-17T02:15:03.162866+00:00

_(empty)_

### assistant — 2025-09-17T02:15:04.827659+00:00

{"search_query": [{"q": "Confluent creation.timeout.ms topic config"}, {"q": "ksql internal topic creation.timeout.ms InvalidConfigurationException Unknown topic config name"}], "response_length": "short"}

### tool — 2025-09-17T02:15:07.527948+00:00

_(empty)_

### tool — 2025-09-17T02:15:07.542135+00:00

_(empty)_

### assistant — 2025-09-17T02:15:08.986151+00:00

{"search_query": [{"q": "\"Unknown topic config name: creation.timeout.ms\""}, {"q": "ksql Unknown topic config name creation.timeout.ms"}], "response_length": "short"}

### tool — 2025-09-17T02:15:19.107404+00:00

_(empty)_

### tool — 2025-09-17T02:15:19.122790+00:00

_(empty)_

### assistant — 2025-09-17T02:15:21.481728+00:00

{"search_query": [{"q": "ksql streams override internal topic config Unknown topic config name workaround"}, {"q": "ksqlDB set topic configs for internal topics ksql.streams.topic.create"}], "response_length": "short"}

### tool — 2025-09-17T02:15:34.009255+00:00

_(empty)_

### tool — 2025-09-17T02:15:34.024604+00:00

_(empty)_

### assistant — 2025-09-17T02:15:36.440877+00:00

{"search_query": [{"q": "Kafka Streams Topic creation configs default replication factor partitions configs"}, {"q": "ksqlDB 'topic.creation' streams config"}], "response_length": "short"}

### tool — 2025-09-17T02:15:46.518170+00:00

_(empty)_

### tool — 2025-09-17T02:15:46.533591+00:00

_(empty)_

### assistant — 2025-09-17T02:15:48.380238+00:00

司令、この行が決定打だね👇  
`InvalidConfigurationException: Unknown topic config name: creation.timeout.ms`

## 結論
- **ksqlDB / Kafka Streams が内部リパーティション用トピックを作成する際、ブローカが知らないトピック設定 `creation.timeout.ms` を渡している**ため作成に失敗しています。  
- つまり**クライアント（ksqlDB/Streams ライブラリ）の想定バージョンと、ブローカのバージョンやサポートするトピック設定がズレている**のが原因です。Kafka は未知のトピック設定を受け取ると `InvalidConfigurationException` を投げます。citeturn6search6turn4search10

## まず確認（5分チェック）
1) **ブローカのAPI/バージョン**  
```bash
kafka-broker-api-versions.sh --bootstrap-server kafka:29092
```
出力の `ApiVersions` と（もし分かれば）実ブローカのメジャー/マイナーバージョンを控える。  
2) **ksqlDB/CP のバージョン**（コンテナならタグ、`/etc/ksqldb/ksql-server.properties` も）  
3) **内部トピック作成時に付与している設定の有無**  
ksqlDB は Streams/Producer/Consumer の**有効なプロパティのみ**パススルーします。`ksql.streams.*` で未知の設定を流していないかを確認。citeturn7search3

> 補足：Kafka Streams/ksqlDB は**内部トピック（repartition/changelog）を自動作成**します。ここでサポート外の設定が入ると今回のように落ちます。citeturn6search6

## 対処パターン（上から順に実施を推奨）
1) **設定から `creation.timeout.ms` を外す/上書き無効化**  
   - `ksql-server.properties` や Helm/Compose の環境変数で、トピック作成関連の上書きが入っていないか検索：
   ```
   grep -iE 'creation\.timeout\.ms|topic\.creation|ksql\.streams\.' /path/to/ksql-server.properties
   ```
   見つかったら削除（もしくはコメントアウト）し、ksqlDB を再起動。

2) **バージョンを揃える**  
   - **ブローカ（Kafka）を ksqlDB/Streams クライアントと同系統にアップグレード**するか、逆に **ksqlDB/Confluent Platform をブローカに合わせてダウングレード**。  
   「内部トピック自動作成で使うトピック設定」は版によって増えがちなので、**クライアント＞ブローカ** の組み合わせで起きやすいです。  
   - 目安：Confluent Platform/ksqlDB のメジャーがブローカより新しすぎない構成に。

3) **一時回避（どうしても今すぐ動かす場合）**  
   - 問題の内部トピック（`…Aggregate-GroupBy-repartition`）を**手動で作成**してからクエリを起動：  
     ```bash
     kafka-topics.sh --bootstrap-server kafka:29092 \
       --create --topic _confluent-ksql-ksql_service_1query_CTAS_BAR_TBIMP_1S_FINAL_27-Aggregate-GroupBy-repartition \
       --partitions 1 --replication-factor 1
     ```
     ※ 最終的にはバージョン/設定の整合を直してください（根本解決ではありません）。

## 参考になる一次情報
- **トピック設定は“有効な設定のみ”受け付け**。未知の設定はエラーになります（Confluent Topic Configs リファレンス）。citeturn4search10  
- **ksqlDB は `ksql.streams.*` 等で**クライアント設定を**パススルー**できる（=無効な設定を流すと失敗し得る）。citeturn7search3  
- **Kafka Streams は内部トピックを自動作成**し、その作成に失敗するとクエリが上がりません。citeturn6search6

---

### 直近の実施手順（コピペ用）
1. `grep` で `creation.timeout.ms` の出所を特定 → 削除  
2. ksqlDB 再起動  
3. まだ失敗するなら `kafka-broker-api-versions.sh` の結果と ksql/CP のバージョンを教えて（整合プラン出します）  
4. 緊急稼働が必要なら上のコマンドで**手動作成**→クエリ再開

必要なら `ksql-server.properties`（上書き部分だけでOK）を貼ってくれたら、衝突している設定をピンポイントで洗い出します。

—  
送信: [[REDACTED_PHONE]]:18 JST

### assistant — 2025-09-17T02:16:02.574380+00:00

_(empty)_
