---
conversation_id: "68ec5d7f-62c4-8320-9b75-62176d97bcfa"
title: "Kafkaトランザクションエラー"
create_time: 1760320907.927319
update_time: 1760320946.731863
language_guess: "en"
num_messages: 11
part_index: 1
part_count: 1
---

### system — 2025-10-13T02:01:47.927319+00:00

_(empty)_

### system — 2025-10-13T02:01:47.927319+00:00

_(empty)_

### user — 2025-10-13T02:01:49.609000+00:00

info: Kafka.Ksql.Linq.KsqlContext[0]
      KSQL DDL (simple Rate): CREATE OR REPLACE STREAM rate (Broker VARCHAR KEY, Symbol VARCHAR KEY, Timestamp TIMESTAMP, Bid DOUBLE) WITH (KAFKA_TOPIC='rate', KEY_FORMAT='AVRO', VALUE_FORMAT='AVRO', VALUE_AVRO_SCHEMA_FULL_NAME='kafka_ksql_linq_tests_integration.rate_valueAvro', TIMESTAMP='Timestamp', PARTITIONS=1, REPLICAS=1);
info: Kafka.Ksql.Linq.KsqlContext[0]
      ksql execute: EXECUTE SQL=CREATE OR REPLACE STREAM rate (Broker VARCHAR KEY, Symbol VARCHAR KEY, Timestamp TIMESTAMP, Bid DOUBLE) WITH (KAFKA_TOPI...
warn: Kafka.Ksql.Linq.KsqlContext[0]
      Retrying DDL for Rate (attempt 1/5) due to: {"@type":"statement_error","error_code":50000,"message":"Producer with transactionalId 'ksql_service_1' and (producerId=1, epoch=77) has been fenced by another producer with the same transactionalId","statementText":"CREATE OR REPLACE STREAM rate (Broker VARCHAR KEY, Symbol VARCHAR KEY, Timestamp TIMESTAMP, Bid DOUBLE) WITH (KAFKA_TOPIC='rate', KEY_FORMAT='AVRO', VALUE_FORMAT='AVRO', VALUE_AVRO_SCHEMA_FULL_NAME='kafka_ksql_linq_tests_integration.rate_valueAvro', TIMESTAMP='Timestamp', PARTITIONS=1, REPLICAS=1);","entities":[]}
これのエラー理由は？

### system — 2025-10-13T02:01:51.079274+00:00

_(empty)_

### system — 2025-10-13T02:01:51.084110+00:00

_(empty)_

### assistant — 2025-10-13T02:01:51.097925+00:00

_(empty)_

### assistant — 2025-10-13T02:01:52.122118+00:00

_(empty)_

### assistant — 2025-10-13T02:02:09.645746+00:00

司令、これは**Kafkaのトランザクション・フェンシング**が原因です。

> Producer with transactionalId 'ksql_service_1' … has been fenced by another producer with the same transactionalId

**意味**  
同じ `transactional.id`（ここでは `ksql_service_1`）を使うプロデューサが**同時に2つ**動いており、**後から来た方が有効**、先にいた方（もしくは再起動直後の古い世代）が**フェンス（拒否）**されました。ksqlDBはコマンド・トピックへDDLを書き込む際にトランザクション付きプロデューサを使うため、**同一 `ksql.service.id` のksqlDBサーバが重複**するとこのエラーになります。

**よくある原因**
- ksqlDBサーバ（/コンテナ）が**二重起動**している（同じ `ksql.service.id`）。
- 直前のインスタンスが**不正終了**し、**新インスタンスが起動**→旧インスタンスがまだ生きていて衝突。
- 複数環境（テスト用と本番用など）で**同じ `ksql.service.id`** を使ってしまった。
- まれに、外部の独自ツール/テストで**誤って `transactional.id=ksql_service_1`** を設定した。

**確認チェックリスト（すぐできる順）**
1) `docker ps` / サービス監視で **ksqlDBコンテナの重複**がないか確認。  
2) ksqlDBの設定で **`ksql.service.id` がユニークか**確認（例：`ksql_service_dev1` など）。  
3) コマンド・トピック（`_confluent-ksql-<service-id>_command_topic`）の**重複環境**がないか確認。  
4) 他プロセスで **`transactional.id=ksql_service_1`** を誤設定していないか確認。

**復旧の定石**
- 余分なksqlDBインスタンスを**停止**する。  
- 1台構成なら、**完全停止 → 数十秒待機 → 起動**（旧プロデューサがクローズしきるまで待つ）。  
- マルチノード運用なら、**各ノードで `ksql.service.id` を共通**にしつつ、**同一クラスタの正しいHA構成**になっているか（同一コマンド・トピックを共有し、ノード数・配置が設計通りか）を点検。  
- もしテスト環境を頻繁に作り直すなら、**環境ごとに `ksql.service.id` を変える**／コマンド・トピックを**クリーンアップ**（注意して実施）する運用に。

**補足（今回のログとの関係）**  
`CREATE OR REPLACE STREAM rate …` のDDL実行はksqlDBの**コマンド・トピック書き込み**を伴います。この瞬間に同一 `transactional.id (ksql_service_1)` の別プロデューサが存在し、**エポックが進んだ**ため、古い側がフェンスされ、50000の `statement_error` としてアプリ側に返ってきています。

必要なら、現行のDocker ComposeやksqlDB設定（`ksql.service.id`、ノード数、コマンド・トピック名）を貼ってくれれば、衝突パターンを特定して**衝突しない命名と起動順**を提案します。

— 送信日時: [[REDACTED_PHONE]]:02 (JST)

### assistant — 2025-10-13T02:02:10.614637+00:00

_(empty)_

### user — 2025-10-13T02:02:26.704738+00:00

_(empty)_
