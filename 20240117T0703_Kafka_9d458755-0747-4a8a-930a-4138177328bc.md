---
conversation_id: "9d458755-0747-4a8a-930a-4138177328bc"
title: "変更されたKafkaコミット位置"
create_time: 1705474988.186051
update_time: 1705482220.398803
language_guess: "en"
num_messages: 10
part_index: 1
part_count: 1
---

### system — 2024-01-17T07:03:08.186051+00:00

_(empty)_

### user — 2024-01-17T07:03:08.187337+00:00

Kafka のcommit位置を変更するソースをc#でしめせ

### assistant — 2024-01-17T07:03:50.480221+00:00

Apache Kafkaのコミット位置を変更するためのC#ソースコードの例を提供します。このコードは、KafkaのConsumer APIを使用してコンシューマーグループのオフセットを手動で調整する方法を示しています。以下は、基本的な実装です：

```csharp
using Confluent.Kafka;
using System;
using System.Collections.Generic;
using System.Threading;

class Program
{
    public static void Main()
    {
        var conf = new ConsumerConfig
        { 
            GroupId = "test-consumer-group",
            BootstrapServers = "localhost:9092",
            // Disable the automatic commit
            EnableAutoCommit = false
        };

        using (var consumer = new ConsumerBuilder<Ignore, string>(conf).Build())
        {
            consumer.Subscribe("test_topic");

            CancellationTokenSource cts = new CancellationTokenSource();
            Console.CancelKeyPress += (_, e) => {
                e.Cancel = true;
                cts.Cancel();
            };

            try
            {
                while (true)
                {
                    try
                    {
                        var cr = consumer.Consume(cts.Token);
                        Console.WriteLine($"Consumed message '{cr.Value}' at: '{cr.TopicPartitionOffset}'.");

                        // Manually commit the offset
                        var offsets = new List<TopicPartitionOffset> { new TopicPartitionOffset(cr.TopicPartition, cr.Offset + 1) };
                        consumer.Commit(offsets);
                    }
                    catch (ConsumeException e)
                    {
                        Console.WriteLine($"Error occured: {e.Error.Reason}");
                    }
                }
            }
            catch (OperationCanceledException)
            {
                // Close the consumer
                consumer.Close();
            }
        }
    }
}
```

このコードは、Kafkaの指定されたトピックからメッセージを消費し、それらのメッセージのオフセットを手動でコミットする方法を示しています。`EnableAutoCommit`を`false`に設定することで、自動コミットを無効にし、`consumer.Commit(offsets)`を使用してオフセットを明示的にコミットしています。

Kafkaクラスターの設定や使用するトピックに応じて、`BootstrapServers`や`GroupId`、`Subscribe`メソッドの引数を適宜変更する必要があります。また、Kafkaクライアントのバージョンや設定によっては、このコードの一部を変更する必要があるかもしれません。

### user — 2024-01-17T07:05:07.282373+00:00

最新の位置にする場合は

### assistant — 2024-01-17T07:06:03.693369+00:00

最新の位置、つまり最新のメッセージにコミット位置をセットするには、KafkaのConsumer APIを使用して「最新のオフセット」にジャンプする必要があります。以下は、C#での実装の例です：

```csharp
using Confluent.Kafka;
using System;

class Program
{
    public static void Main()
    {
        var conf = new ConsumerConfig
        { 
            GroupId = "test-consumer-group",
            BootstrapServers = "localhost:9092",
            AutoOffsetReset = AutoOffsetReset.Earliest,
            EnableAutoCommit = false
        };

        using (var consumer = new ConsumerBuilder<Ignore, string>(conf).Build())
        {
            consumer.Subscribe("test_topic");

            // Move to the end of the topic to get the latest offset
            consumer.SeekToEnd();

            try
            {
                var cr = consumer.Consume();
                Console.WriteLine($"Consumed message '{cr.Value}' at: '{cr.TopicPartitionOffset}'.");

                // Commit the latest offset
                consumer.Commit();
            }
            catch (ConsumeException e)
            {
                Console.WriteLine($"Error occurred: {e.Error.Reason}");
            }

            // Ensure consumer is properly closed on exit
            consumer.Close();
        }
    }
}
```

このコードでは、`consumer.SeekToEnd()` メソッドを使用して、コンシューマーが購読しているパーティションの末尾（つまり最新のメッセージ）に移動します。その後、`consumer.Consume()` でメッセージを取得し、`consumer.Commit()` でその位置をコミットします。

注意点として、`SeekToEnd` はパーティションの最後にジャンプするため、この操作後にコンシューマーがメッセージを消費すると、最新のメッセージのみが処理されます。既存のメッセージはスキップされる点に注意してください。

また、実際の使用環境やKafkaクラスターの設定に応じて、設定値（例: `BootstrapServers`、`GroupId`）を適宜変更する必要があります。

### user — 2024-01-17T08:55:23.535124+00:00

consumer.SeekToEndがサポートされてない

### assistant — 2024-01-17T08:56:26.430334+00:00

`consumer.SeekToEnd()` がサポートされていない場合、最新のオフセットにジャンプする別の方法を採用する必要があります。Kafka 0.11 以降のバージョンでは、`QueryWatermarkOffsets` メソッドを使用して最新のオフセットを取得し、そのオフセットに手動でシークすることができます。以下は、この方法で最新の位置に移動するC#の例です：

```csharp
using Confluent.Kafka;
using System;
using System.Linq;

class Program
{
    public static void Main()
    {
        var conf = new ConsumerConfig
        {
            GroupId = "test-consumer-group",
            BootstrapServers = "localhost:9092",
            AutoOffsetReset = AutoOffsetReset.Earliest,
            EnableAutoCommit = false
        };

        using (var consumer = new ConsumerBuilder<Ignore, string>(conf).Build())
        {
            consumer.Subscribe("test_topic");

            try
            {
                // Query the end offsets for each partition
                var topicPartitions = consumer.Assignment.Select(tp => new TopicPartition(tp.Topic, tp.Partition)).ToList();
                var endOffsets = consumer.QueryWatermarkOffsets(new TopicPartitionOffset(topicPartitions[0], Offset.Unset), TimeSpan.FromSeconds(5));

                // Manually seek to the end offset
                foreach (var tp in topicPartitions)
                {
                    consumer.Seek(new TopicPartitionOffset(tp, endOffsets.High));
                }

                var cr = consumer.Consume();
                Console.WriteLine($"Consumed message '{cr.Value}' at: '{cr.TopicPartitionOffset}'.");

                // Commit the latest offset
                consumer.Commit();
            }
            catch (ConsumeException e)
            {
                Console.WriteLine($"Error occurred: {e.Error.Reason}");
            }

            // Ensure consumer is properly closed on exit
            consumer.Close();
        }
    }
}
```

このコードは、購読しているパーティションの最新のオフセットを取得し、それぞれのパーティションに対して`consumer.Seek()`を使用してそのオフセットに移動します。この操作により、次に`consumer.Consume()`を呼び出すと、最新のオフセットからのメッセージが返されます。

再度強調しますが、実際の環境や使用するKafkaクラスターの設定に応じて、必要な設定値を適宜変更してください。また、このコードは単一のトピックとパーティションを前提としています。複数のトピックやパーティションを扱う場合は、適宜コードを調整する必要があります。

### user — 2024-01-17T09:01:52.397892+00:00

consumer.QueryWatermarkOffsetsのパラメータはTopicPartition

### assistant — 2024-01-17T09:03:40.288092+00:00

失礼しました、その通りです。`QueryWatermarkOffsets` メソッドのパラメータは `TopicPartition` オブジェクトを使用します。以下のコードは、各パーティションの最新のオフセットを取得し、それぞれのパーティションに対して `consumer.Seek()` を使用して最新のオフセットに移動する例です：

```csharp
using Confluent.Kafka;
using System;
using System.Linq;

class Program
{
    public static void Main()
    {
        var conf = new ConsumerConfig
        {
            GroupId = "test-consumer-group",
            BootstrapServers = "localhost:9092",
            AutoOffsetReset = AutoOffsetReset.Earliest,
            EnableAutoCommit = false
        };

        using (var consumer = new ConsumerBuilder<Ignore, string>(conf).Build())
        {
            consumer.Subscribe("test_topic");

            try
            {
                // Wait until the consumer is assigned to a partition
                while (consumer.Assignment.Count == 0)
                {
                    consumer.Consume(TimeSpan.FromSeconds(1));
                }

                // Query the latest offsets for each assigned partition
                foreach (var partition in consumer.Assignment)
                {
                    var watermarkOffsets = consumer.QueryWatermarkOffsets(new TopicPartition("test_topic", partition.Partition), TimeSpan.FromSeconds(5));
                    
                    // Manually seek to the latest offset
                    consumer.Seek(new TopicPartitionOffset(partition.Topic, partition.Partition, watermarkOffsets.High));
                }

                var cr = consumer.Consume();
                Console.WriteLine($"Consumed message '{cr.Value}' at: '{cr.TopicPartitionOffset}'.");

                // Commit the latest offset
                consumer.Commit();
            }
            catch (ConsumeException e)
            {
                Console.WriteLine($"Error occurred: {e.Error.Reason}");
            }

            // Ensure consumer is properly closed on exit
            consumer.Close();
        }
    }
}
```

このコードでは、`QueryWatermarkOffsets` メソッドを使用して各パーティションの最新のオフセットを取得し、`consumer.Seek()` でそのオフセットにジャンプしています。`TopicPartition` オブジェクトは、対象のトピック名とパーティション番号を指定して作成します。

最新のオフセットにシークした後、`consumer.Consume()` を呼び出すと、最新のメッセージから消費を開始します。この方法は、コンシューマーが購読する各パーティションに対して個別に適用する必要があります。また、環境によっては、`TopicPartition` オブジェクトの作成に異なるトピック名やパーティション番号が必要になる可能性があるので、適宜調整してください。
