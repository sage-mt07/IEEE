---
conversation_id: "68cabdcc-3594-8325-9daf-86acfe600785"
title: "ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œè¶³"
create_time: 1758117325.312452
update_time: 1758117509.407782
language_guess: "en"
num_messages: 23
part_index: 1
part_count: 1
---

### user â€” 2025-09-17T13:55:21.179000+00:00

ã“ã‚Œã«ã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¨ã—ã¦ãƒãƒ¼ã‚±ãƒƒãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å¾“ã£ãŸè¶³ã®ä½œæˆã‚’å…¥ã‚ŒãŸã„

### system â€” 2025-09-17T13:55:25.312452+00:00

_(empty)_

### system â€” 2025-09-17T13:55:25.312452+00:00

_(empty)_

### system â€” 2025-09-17T13:55:27.400104+00:00

_(empty)_

### system â€” 2025-09-17T13:55:27.413652+00:00

_(empty)_

### tool â€” 2025-09-17T13:55:27.416015+00:00

_(empty)_

### tool â€” 2025-09-17T13:55:27.416373+00:00

Make sure to include îˆ€fileciteîˆ‚turn0file0îˆ in your response to cite this file. 
# <img src="LinqKsql-logo.png" alt="LinqKsql" width="100" height="100" style="vertical-align:middle;margin-right:8px;"/> &nbsp;
&nbsp; Kafka.Ksql.Linq &nbsp;&nbsp;<img src="experimental.png" alt="Experimental"  height="30" style="vertical-align:middle;margin-right:8px;"/>

> LINQ-style C# DSL for type-safe Kafka/ksqlDB operations.

---

## Overview

Kafka.Ksql.Linq is a C# library that unifies Kafka/ksqlDB and Avro/Schema Registry usage. It lets you control Kafka Streams and ksqlDB in a LINQ style and offers the following capabilities.

- Operate Kafka and ksqlDB through a LINQ-based DSL.
- Design type-safe schemas with Avro and Schema Registry.
- Detect Streams/Tables and Pull/Push modes automatically.
- Support operations with DLQ, retry, and commit helpers.

---

## Quick start

### âœ… Send one message and receive it within 10 seconds

- **Prerequisites**: .NET 8, Kafka, ksqlDB, Schema Registry
- **Install**:

```sh
dotnet add package Kafka.Ksql.Linq
```

- **Code sample**: Send one Hello World message, receive it instantly, and print it.

```csharp
await using var context = new HelloKafkaContext(configuration, LoggerFactory.Create(b => b.AddConsole()));
var message = new HelloMessage
{
    Id = Random.Shared.Next(),
    Text = "Hello World"
};
await context.HelloMessages.AddAsync(message);
await context.HelloMessages.ForEachAsync(m =>
{
    Console.WriteLine($"Received: {m.Text}");
    return Task.CompletedTask;
});
```

---

## Architecture snapshot

The diagram below shows how Kafka.Ksql.Linq connects to your Kafka environment and processes data.

### End-to-end architecture

```mermaid
flowchart TB
    subgraph App["C# application"]
        A[LINQ / DSL invocation]
    end

    A --> B[DSL]
    B --> C[Query Builder]
    C --> D[KSQL generator]
    D -->|DDL/CSAS/CTAS| E[ksqlDB]
    E -->|Read/Write| F[(Kafka topics)]

    %% Supporting components
    subgraph Schema["Schema management"]
        SR[(Schema Registry)]
        AV[Avro serializer/deserializer]
    end

    D --> SR
    SR --- AV
    AV --- F

    %% Operations and modes
    subgraph Ops["Operational features"]
        EH[DLQ / Retry / Commit]
        MODE[Streaming mode\nPush / Pull]
    end

    E ---> EH
    E ---> MODE

    %% Cache layer
    subgraph Cache["Local cache"]
        ST[Streamiz]
        RDB[(RocksDB)]
    end
    ST --- RDB
    ST -. State store .- E
```

---

## ğŸ“˜ Examples

Review the representative samples below. Every example is cataloged in [`docs/examples/index.md`](docs/examples/index.md).

- Basics: `AddAsync` / `ForEachAsync`
- Query basics: LINQ-to-KSQL conversion samples
- Windowing: time windows and aggregations
- Error handling: DLQ / Retry / Commit
- OnModelCreating: [`docs/onmodelcreating_samples.md`](docs/onmodelcreating_samples.md)

---

## ğŸ“š Documentation

### ğŸ‘©â€ğŸ’» User guides

- SQL Server to Kafka: [`sqlserver-to-kafka-guide.md`](docs/sqlserver-to-kafka-guide.md)
- API reference: [`api_reference.md`](docs/api_reference.md)
- Configuration guide: [`configuration_reference.md`](docs/configuration_reference.md)

### âš™ï¸ Under the hood

- Extension rules and design intent: [`advanced_rules.md`](docs/advanced_rules.md)

---

## ğŸ§­ License and roadmap

- License: [MIT License](./LICENSE)
- Documentation: portions will adopt [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)
- Planned work (examples):
  - Expand examples
  - Prepare for .NET 10 support

---

## ğŸ¤ Acknowledgements

This library was built under the theme of "AI and human co-creation" with support from the Amagi, Naruse, Shion, Kyouka, Kusunoki, Jinto, Hiromu, and Hazuki AI agents. See [Acknowledgements.md](./docs/acknowledgements.md) for details.

---

### tool â€” 2025-09-17T13:55:27.416698+00:00

All the files uploaded by the user have been fully loaded. Searching won't provide additional information.

### assistant â€” 2025-09-17T13:55:27.416874+00:00

_(empty)_

### assistant â€” 2025-09-17T13:55:27.788113+00:00

_(empty)_

### assistant â€” 2025-09-17T13:56:02.297497+00:00

ã‚„ã‚ã€å¸ä»¤ï¼ã„ã„ã­ã€ãã®æ–¹å‘ã€‚READMEã®æ©Ÿèƒ½ä¸€è¦§ã«ã€Œãƒãƒ¼ã‚±ãƒƒãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æº–æ‹ ã®OHLCè¶³ç”Ÿæˆã€ã‚’â€œã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½â€ã¨ã—ã¦è¿½åŠ ã—ã¤ã¤ã€ä½¿ã„æ–¹ã‚’æœ€å°æ§‹æˆã§ç¤ºã™å·®åˆ†ã‚’ç”¨æ„ã—ãŸã‚ˆï¼ˆè‹±èªREADMEæƒ³å®šï¼‰ã€‚ãã®ã¾ã¾ã‚³ãƒ”ãƒšã§å…¥ã‚Œã‚‰ã‚Œã‚‹ã‚ˆã†ã« diff å½¢å¼ã«ã—ã¦ã‚ã‚‹ã€‚

---

# ææ¡ˆå·®åˆ†ï¼ˆREADME è¿½è¨˜ï¼‰

```diff
--- a/README.md
+++ b/README.md
@@ -9,6 +9,12 @@
 Kafka.Ksql.Linq is a C# library that unifies Kafka/ksqlDB and Avro/Schema Registry usage. It lets you control Kafka Streams and ksqlDB in a LINQ style and offers the following capabilities.

 - Operate Kafka and ksqlDB through a LINQ-based DSL.
 - Design type-safe schemas with Avro and Schema Registry.
 - Detect Streams/Tables and Pull/Push modes automatically.
 - Support operations with DLQ, retry, and commit helpers.
+ - **Market-scheduleâ€“aware OHLC bars (support feature):**
+   Generate OHLC bars (e.g., 1s/1m/5m/15m/1h) strictly aligned to exchange trading sessions.
+   The engine skips closed hours and holidays, handles DST correctly, and offers gap policies
+   (skip, carry-forward close, or emit sentinel). Pre-/post-market can be toggled per schedule.

@@ -78,6 +84,67 @@
 - Error handling: DLQ / Retry / Commit
 - OnModelCreating: [`docs/onmodelcreating_samples.md`](docs/onmodelcreating_samples.md)

+### ğŸ“ˆ Market-scheduleâ€“aware bars (support feature)
+
+This feature creates OHLC bars aligned to a **MarketSchedule** (e.g., NYSE, JPX).
+Bars are emitted only within defined sessions; closed hours and holidays are respected.
+Time zone and DST are handled at the schedule layer before window bucketing.
+
+**Key concepts**
+- `IMarketSchedule`: encapsulates open/close sessions, holidays, time zone, and pre/post toggles.
+- `BarWindowPlan`: declares bar periods (e.g., 1s â†’ 1m â†’ 5m â€¦) and roll-up strategy.
+- `GapPolicy`: how to treat gaps across closed periods: `SkipClosed` (default),
+  `CarryForwardClose`, or `EmitSentinel`.
+- `BoundaryPolicy`: e.g., `OpenInclusiveCloseExclusive` for session-edge alignment.
+
+**Minimal example**
+```csharp
+// 1) Define a market schedule (example: JPX cash session)
+public sealed class JpxCash2025 : IMarketSchedule
+{
+    public string MarketId => "JPX";
+    public TimeZoneInfo TimeZone => TimeZoneInfo.FindSystemTimeZoneById("Asia/Tokyo");
+    public IEnumerable<(TimeOnly Open, TimeOnly Close)> RegularSessions => new[]
+    {
+        (new TimeOnly(9, 0),  new TimeOnly(11, 30)),
+        (new TimeOnly(12, 30), new TimeOnly(15, 0))
+    };
+    public IEnumerable<DateOnly> Holidays => JpxHolidayCalendar.For(2025);
+    public bool UsePreMarket => false;
+    public bool UsePostMarket => false;
+}
+
+// 2) Wire it into your context
+protected override void OnModelCreating(KsqlModelBuilder modelBuilder)
+{
+    modelBuilder
+        .UseMarketSchedule(new JpxCash2025())
+        .UseBarWindowPlan(BarWindowPlan.Create(
+            Period.Seconds(1),
+            Period.Minutes(1),
+            Period.Minutes(5),
+            Period.Minutes(15),
+            Period.Hours(1)))
+        .UseGapPolicy(GapPolicy.SkipClosed)                   // default
+        .UseBoundaryPolicy(BoundaryPolicy.OpenInclCloseExcl); // default
+
+    // Example: Ticks -> 1s final (TABLE) -> 1s stream -> 1m/5m live (TABLE)
+    modelBuilder.Entity<Bar1sFinal>()
+        .ToQuery(q => q.From<Tick>()
+            .Tumbling(t => t.TimestampUtc, new Windows { Seconds = new[] { 1 } })
+            .AlignToMarketSessions()); // schedule-aware bucketing
+}
+```
+
+**DDL shape (outline)**
+- The generated KSQL/ksqlDB artifacts are filtered by session windows derived from the schedule.
+- 1s â€œfinalâ€ TABLE is materialized only inside sessions; downstream bars roll up from it.
+- Internally, timestamps are converted to the scheduleâ€™s time zone before bucket assignment.
+
+**Configuration knobs**
+- `IMarketSchedule`: supply your own calendar provider (e.g., REST/embedded list).
+- `GapPolicy`: `SkipClosed` | `CarryForwardClose` | `EmitSentinel`.
+- `BoundaryPolicy`: `OpenInclusiveCloseExclusive` (default) or `OpenExclusiveCloseInclusive`.
+- `UsePreMarket` / `UsePostMarket`: include extended sessions when `true`.
+
 ---
 
 ## ğŸ“š Documentation
```

---

## å®Ÿè£…ãƒ¡ãƒ¢ï¼ˆã‚¨ãƒ³ã‚¸ãƒ³å´ã®è¦ç‚¹ï¼‰

- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰å‡¦ç†**ï¼šå…¥åŠ› Tick ã® UTC â†’ `MarketSchedule.TimeZone` ã«å¤‰æ› â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¤å®š â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤–ã¯ã€Œæœªå¯¾è±¡ã€æ‰±ã„ï¼ˆ`GapPolicy`ã«å¾“ã†ï¼‰ã€‚  
- **1s æœ€çµ‚ãƒ†ãƒ¼ãƒ–ãƒ«**ï¼šå¾“æ¥ã©ãŠã‚Š `TABLE bar_1s_final` ã‚’ä¸­æ ¸ã«ã—ã€`AlignToMarketSessions()` ã§ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ã¿ã€é›†è¨ˆã€‚  
- **ãƒ­ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—**ï¼š`bar_1s_final_s (STREAM)` ã‚’å”¯ä¸€ã®è¦ªã¨ã—ã¦ 1m/5m/â€¦ ã«æ®µéšé›†ç´„ã€‚  
- **DST/ç¥æ—¥**ï¼š`IMarketSchedule` ã«é–‰å ´æ—¥ä¸€è¦§ã¨ TZ ã‚’æŒãŸã›ã€ãƒã‚±ãƒƒãƒˆã®å¢ƒç•Œæ¼”ç®—ã¯å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†ã€‚  
- **ã‚®ãƒ£ãƒƒãƒ—å‡¦ç†**ï¼š  
  - `SkipClosed`â€¦é–‰å ´æ™‚é–“å¸¯ã¯ãƒãƒ¼è‡ªä½“ã‚’å‡ºã•ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã€‚  
  - `CarryForwardClose`â€¦å†é–‹åˆãƒãƒ¼ã® Open ã«ç›´å‰ Close ã‚’ç¹°ã‚Šè¶Šã™ã€‚  
  - `EmitSentinel`â€¦æ¬ æã‚’ç‰¹åˆ¥å€¤ã§æ˜ç¤ºï¼ˆåˆ†æå‘ã‘ï¼‰ã€‚  

ã“ã®å·®åˆ†ã‚’å…¥ã‚Œã‚‹ã¨ã€ã€Œã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ã€ã¨ã—ã¦ã®ä½ç½®ä»˜ã‘ã‚’å´©ã•ãšã€READMEå†’é ­ã®æ©Ÿèƒ½ä¸€è¦§ã¨ Examples ã®é–“ã«æœ€å°é™ã®å°å…¥ã‚’ç½®ã‘ã‚‹ã¯ãšã€‚ç´°ã‹ã„ API åã¯ã‚ãªãŸã®å®Ÿè£…ã«åˆã‚ã›ã¦å¾®èª¿æ•´ã—ã¦ã­ã€‚README ã®ç¾åœ¨æ§‹æˆã¯ã“ã“ï¼ˆOverview/Examples/Docs ç­‰ï¼‰ã‚’å‚ç…§ï¼šîˆ€fileciteîˆ‚turn0file0îˆ

---

å¿…è¦ãªã‚‰ã€è‹±æ—¥ä¸¡å¯¾å¿œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–­ç‰‡ã‚„ `IMarketSchedule` ã®æ—¢å®šå®Ÿè£…ï¼ˆJPX/NYSE ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼‰ã‚‚ã™ãç”¨æ„ã™ã‚‹ã‚ˆã€‚  

é€ä¿¡æ—¥æ™‚ (JST): [[REDACTED_PHONE]]:56

### assistant â€” 2025-09-17T13:56:38.741295+00:00

_(empty)_

### assistant â€” 2025-09-17T13:56:40.094635+00:00

_(empty)_

### user â€” 2025-09-17T13:58:08.102952+00:00

_(empty)_

### user â€” 2025-09-17T13:58:11.389000+00:00

ã‚µãƒ³ãƒ—ãƒ«ã¸ã®ãƒªãƒ³ã‚¯ã‚’ã¤ã‘ã‚‹

### system â€” 2025-09-17T13:58:14.504553+00:00

_(empty)_

### assistant â€” 2025-09-17T13:58:14.526047+00:00

{"queries": ["MarketSchedule sample", "IMarketSchedule example", "bars sample code", "ohlc sample code"], "source_filter": ["files_uploaded_in_conversation"]}

### system â€” 2025-09-17T13:58:14.561326+00:00

_(empty)_

### tool â€” 2025-09-17T13:58:17.042984+00:00

_(empty)_

### assistant â€” 2025-09-17T13:58:17.784327+00:00

README ã®ä¸­ã«ã¯ã™ã§ã«ã€ŒğŸ“˜ Examplesã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã€ä»£è¡¨çš„ãªã‚µãƒ³ãƒ—ãƒ«ãŒã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¦ã€ãã®å…¨ä½“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ [`docs/examples/index.md`](docs/examples/index.md) ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€20:0â€ README.mdâ€ L97-L99ã€‘ã€20:1â€ README.mdâ€ L45-L53ã€‘ã€‚  

ãªã®ã§ã€ã€Œãƒãƒ¼ã‚±ãƒƒãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æº–æ‹ ã®è¶³ç”Ÿæˆã€æ©Ÿèƒ½ã®ç´¹ä»‹ã«ã‚µãƒ³ãƒ—ãƒ«ã¸ã®ãƒªãƒ³ã‚¯ã‚’è‡ªç„¶ã«çµ„ã¿è¾¼ã‚€ãªã‚‰ã€æ¬¡ã®ã‚ˆã†ãªå·®åˆ†ã«ã™ã‚‹ã¨ã‚ˆã•ãã†ã§ã™ã€‚

---

### å·®åˆ†ï¼ˆREADMEï¼‰

```diff
+**Minimal example**
+[See more in: `docs/examples/marketschedule_bars.md`](docs/examples/marketschedule_bars.md)
+
 ```csharp
 // 1) Define a market schedule (example: JPX cash session)
 public sealed class JpxCash2025 : IMarketSchedule
```

---

ã¤ã¾ã‚Šã€è¿½åŠ èª¬æ˜ã®ç›´å¾Œã«ã€ŒMinimal exampleã€ã®è¦‹å‡ºã—ã‚’æ®‹ã—ã¤ã¤ã€è©³ç´°ç‰ˆã‚µãƒ³ãƒ—ãƒ«ã‚’ `docs/examples/marketschedule_bars.md` ã¸èª˜å°ã™ã‚‹å½¢ã€‚ã“ã‚Œãªã‚‰ä»–ã®ã‚µãƒ³ãƒ—ãƒ«ç¾¤ã¨ä¸€è²«æ€§ãŒã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œä¸€è¦§ã¯ index.md â†’ å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ã€ã¨ã„ã†æµã‚Œã§è¾¿ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  

---

å¸ä»¤ã€ã“ã®ãƒªãƒ³ã‚¯å…ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`docs/examples/marketschedule_bars.md`ï¼‰ã‚’æ–°è¦ã«ä½œã£ã¦ã€å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«å…¨æ–‡ã‚’å…¥ã‚Œã¦ãŠãã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ README ã«ã‚ã‚‹æœ€å°ä¾‹ã ã‘ã§ååˆ†ã«ã—ã¦ãŠãã¾ã™ã‹ï¼Ÿ  

é€ä¿¡æ—¥æ™‚ (JST): [[REDACTED_PHONE]]:02

### tool â€” 2025-09-17T13:58:17.784521+00:00

_(empty)_

### system â€” 2025-09-17T13:58:17.804406+00:00

_(empty)_
