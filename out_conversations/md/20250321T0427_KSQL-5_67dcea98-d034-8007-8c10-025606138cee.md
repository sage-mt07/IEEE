---
conversation_id: "67dcea98-d034-8007-8c10-025606138cee"
title: "KSQL 5分足チャート"
create_time: 1742531225.145347
update_time: 1742531361.820469
language_guess: "en"
num_messages: 7
part_index: 1
part_count: 1
---

### system — 2025-03-21T04:27:05.145347+00:00

_(empty)_

### user — 2025-03-21T04:27:05.151343+00:00

KAFKAのKSQLで５分足チャートを作成するクエリ

### assistant — 2025-03-21T04:27:05.269991+00:00

Kafka の KSQL（現在は **ksqlDB** として知られています）を使って、**5分足チャート**（5分ごとの集計）を作成するには、`WINDOW TUMBLING` を使って、タイムウィンドウごとにデータを集計します。

以下は、例えば価格データ（例：株価、仮想通貨など）を持つストリーム `price_stream` に対して、5分足チャート（始値、終値、高値、安値）を作成するクエリの例です：

```sql
CREATE TABLE price_5min_candle AS
SELECT
  SYMBOL,
  WINDOWSTART AS window_start,
  WINDOWEND AS window_end,
  EARLIEST_BY_OFFSET(PRICE) AS open,
  LATEST_BY_OFFSET(PRICE) AS close,
  MAX(PRICE) AS high,
  MIN(PRICE) AS low
FROM price_stream
WINDOW TUMBLING (SIZE 5 MINUTES)
GROUP BY SYMBOL;
```

### 前提：
- `price_stream` ストリームには少なくとも以下のカラムが存在するとします：
  - `SYMBOL`: 銘柄コードなど識別子
  - `PRICE`: 価格
  - `ROWTIME`: タイムスタンプ（KSQLが内部で使用）

### ポイント：
- `WINDOW TUMBLING (SIZE 5 MINUTES)`：5分ごとの固定ウィンドウで集計
- `EARLIEST_BY_OFFSET`：そのウィンドウ内で最も早く届いたレコード（始値）
- `LATEST_BY_OFFSET`：最も遅く届いたレコード（終値）
- `MAX`/`MIN`：高値/安値

必要に応じて `WHERE` 句や `PARTITION BY` の条件を追加できます。

ご使用のデータ構造や時系列の正確な要件に応じて、調整可能です。もし実際のスキーマがあるようでしたら、それに合わせてより具体的なクエリをご提案できます。

### assistant — 2025-03-21T04:27:17.173027+00:00

_(empty)_

### user — 2025-03-21T04:29:04.785418+00:00

window bounds column windowstart can only be used in the select clause of windowed aggregations and can not be passed to aggregate function

### assistant — 2025-03-21T04:29:04.873510+00:00

ご指摘のエラー：

> `window bounds column windowstart can only be used in the select clause of windowed aggregations and can not be passed to aggregate function`

これは `WINDOWSTART` や `WINDOWEND` を **`SELECT` 句の外、または集計関数の中で使ってはいけない** というエラーです。

---

### 修正後のクエリ（正しい書き方）：

```sql
CREATE TABLE price_5min_candle AS
SELECT
  SYMBOL,
  WINDOWSTART AS window_start,
  WINDOWEND AS window_end,
  EARLIEST_BY_OFFSET(PRICE) AS open,
  LATEST_BY_OFFSET(PRICE) AS close,
  MAX(PRICE) AS high,
  MIN(PRICE) AS low
FROM price_stream
WINDOW TUMBLING (SIZE 5 MINUTES)
GROUP BY SYMBOL;
```

### 重要ポイント：

- `WINDOWSTART` / `WINDOWEND` は **SELECT 句の中**でのみ使えます。
- `GROUP BY` に `SYMBOL` のみを指定します。
- **間違い例：** `GROUP BY SYMBOL, WINDOWSTART` ← これはエラーになります。

---

### 補足：
`EARLIEST_BY_OFFSET()` や `LATEST_BY_OFFSET()` は KSQLDB 0.10 以降で使える関数です。もしバージョンが古くて使えない場合は、代替ロジックが必要です。

---

スキーマが以下のような場合を想定しています：

```sql
CREATE STREAM price_stream (
  SYMBOL VARCHAR,
  PRICE DOUBLE
) WITH (
  KAFKA_TOPIC = 'price_topic',
  VALUE_FORMAT = 'JSON',
  TIMESTAMP = 'timestamp'  -- 明示的なタイムスタンプカラムがある場合
);
```

必要に応じて、このスキーマの定義も調整できます。  
もし `timestamp` カラムの指定がなければ、Kafka のメッセージタイムスタンプが使われます。

---

もっと詳しく見たい点があれば、ストリーム定義も含めて教えてください！
