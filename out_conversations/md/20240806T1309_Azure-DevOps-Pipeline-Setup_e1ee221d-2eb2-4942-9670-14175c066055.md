---
conversation_id: "e1ee221d-2eb2-4942-9670-14175c066055"
title: "Azure DevOps Pipeline Setup"
create_time: 1722949768.766339
update_time: 1722951369.858961
language_guess: "en"
num_messages: 15
part_index: 1
part_count: 1
---

### system — 2024-08-06T13:09:28.766339+00:00

_(empty)_

### user — 2024-08-06T13:09:28.770331+00:00

Azure DevOps でApp Serviceへデプロイするパイプラインの作成

### assistant — 2024-08-06T13:10:08.001590+00:00

_(empty)_

### assistant — 2024-08-06T13:10:08.001685+00:00

Azure DevOpsを使用してAzure App Serviceへデプロイするパイプラインを作成する手順を以下に示します。ここでは、ASP.NET Coreアプリケーションを例に説明します。

### 前提条件
1. Azure DevOpsアカウント
2. Azureサブスクリプション
3. Azure App Serviceの設定
4. Azure DevOpsにリポジトリが設定済み

### 手順

#### 1. サービスコネクションの作成
Azure DevOpsからAzureへの接続を設定します。
1. Azure DevOpsのプロジェクトに移動します。
2. 左メニューから「Project settings」を選択します。
3. 「Service connections」を選択し、「New service connection」をクリックします。
4. 「Azure Resource Manager」を選択し、「Next」をクリックします。
5. 「Service principal (automatic)」を選択し、サブスクリプションとApp Serviceのリソースグループを選択して、「Save」をクリックします。

#### 2. パイプラインの作成
1. Azure DevOpsのプロジェクトに移動します。
2. 左メニューから「Pipelines」を選択し、「New pipeline」をクリックします。
3. リポジトリのソースを選択します（例：GitHub、Azure Repos）。
4. 「YAML」を選択し、以下のYAMLファイルをベースに編集します。

#### 3. YAMLパイプラインの設定
以下に、ASP.NET Coreアプリケーションをビルドし、Azure App Serviceへデプロイする基本的なYAMLの例を示します。

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'your-app-service-name' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.x' # .NETのバージョン

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(appName)'
    package: '$(Build.ArtifactStagingDirectory)'
    runtimeStack: 'DOTNETCORE|6.0' # 適切なランタイムスタックを指定

- task: AzureAppServiceSettings@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    ResourceGroupName: '$(resourceGroup)'
    AppSettings: '-WEBSITE_RUN_FROM_PACKAGE 1'
```

### 説明
1. **trigger**: mainブランチに変更があったときにパイプラインをトリガーします。
2. **pool**: Ubuntu最新バージョンのVMイメージを使用します。
3. **variables**: Azureサブスクリプション、App Service名、リソースグループ名、環境名を変数として設定します。
4. **steps**:
    - `UseDotNet@2`: .NET SDKを使用。
    - `DotNetCoreCLI@2`: `restore`、`build`、`publish`コマンドを実行してアプリケーションをビルド。
    - `PublishBuildArtifacts@1`: ビルド成果物を発行。
    - `AzureWebApp@1`: App Serviceへデプロイ。
    - `AzureAppServiceSettings@1`: App Serviceの設定を行う（オプション）。

これにより、コードの変更がmainブランチにプッシュされると、パイプラインが自動的にトリガーされ、Azure App Serviceへデプロイされます。

### user — 2024-08-06T13:20:00.269311+00:00

appNameの調べ方

### assistant — 2024-08-06T13:20:17.165323+00:00

Azure App Serviceの`appName`は、Azureポータルから確認することができます。以下の手順で確認してください。

1. **Azureポータルにサインイン**
   - [Azureポータル](https://portal.azure.com)にサインインします。

2. **App Servicesの一覧を表示**
   - 左側のナビゲーションメニューから「App Services」をクリックします。
   - すべてのApp Servicesのリストが表示されます。

3. **アプリケーション名の確認**
   - デプロイ対象のApp Serviceを見つけて、その名前をメモします。この名前が`appName`になります。

### 具体的な手順
1. **Azureポータルでサインイン**
   ![Azureポータルのサインイン画面](https://portal.azure.com)

2. **App Servicesの一覧に移動**
   - 左側のメニューから「App Services」をクリック。
   ![App Servicesのメニュー項目](https://docs.microsoft.com/en-us/azure/app-service/media/overview-app-service/app-service-overview-menu.png)

3. **デプロイ対象のApp Serviceを選択**
   - リストから目的のApp Serviceを見つけてクリックします。
   ![App Servicesのリスト](https://docs.microsoft.com/en-us/azure/app-service/media/overview-app-service/app-services-list.png)

4. **App Service名の確認**
   - App Serviceの概要ページに移動し、上部に表示されている名前を確認します。この名前が`appName`に該当します。
   ![App Serviceの概要ページ](https://docs.microsoft.com/en-us/azure/app-service/media/overview-app-service/app-service-overview-app.png)

この`appName`をAzure DevOpsパイプラインのYAMLファイル内に設定します。たとえば、App Serviceの名前が`my-app-service`の場合、YAMLファイルは以下のように設定します。

```yaml
variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'my-app-service' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'
```

これで、正しいApp Serviceにデプロイするようにパイプラインが設定されます。

### user — 2024-08-06T13:21:13.091517+00:00

##[error]Error: Input required: appName　のエラーがでる

### assistant — 2024-08-06T13:21:39.963484+00:00

`appName`が正しく指定されていないか、変数の設定が正しくない可能性があります。YAMLファイル内の変数とタスクの設定を確認してみましょう。

以下は、変数の設定とタスクの使用例です。変数の設定が正しく行われているか確認してください。

### YAMLファイルの例

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'your-app-service-name' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.x' # .NETのバージョン

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(appName)'
    package: '$(Build.ArtifactStagingDirectory)'
    runtimeStack: 'DOTNETCORE|6.0' # 適切なランタイムスタックを指定
```

### 設定確認ポイント

1. **変数の設定**
   - `variables`セクション内の`appName`が正しく設定されていることを確認します。

2. **AzureWebAppタスクの入力**
   - `inputs`セクションで、`appName`が`$(appName)`として指定されていることを確認します。

### 具体的なチェックリスト

1. **サービスコネクション名が正しいか確認**
   - Azure DevOpsのサービスコネクションが正しく設定されているか確認します。`azureSubscription`の値が正しいことを確認してください。

2. **App Service名が正しいか確認**
   - `appName`の値が正しいApp Service名になっているか確認してください。App Service名はAzureポータルで確認できます。

3. **変数が正しく展開されているか確認**
   - パイプライン実行時に変数が正しく展開されているか確認します。展開されていない場合、YAML内の変数設定を見直してください。

エラーメッセージが続く場合は、変数の使用方法やタスクの設定に問題がある可能性があります。YAMLファイルを再度確認し、正しく設定されていることを確認してください。

### user — 2024-08-06T13:26:57.830418+00:00

Starting: AzureAppServiceSettings　でエラーになる

### assistant — 2024-08-06T13:27:43.298111+00:00

`AzureAppServiceSettings`タスクでエラーが発生する場合、設定の一部が正しくないか、必要な入力が不足している可能性があります。このタスクはApp Serviceの設定を変更するために使用されますが、必須入力項目が満たされていないとエラーが発生します。

以下に、`AzureAppServiceSettings`タスクの設定例とチェックポイントを示します。

### `AzureAppServiceSettings`タスクの設定例

```yaml
- task: AzureAppServiceSettings@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    ResourceGroupName: '$(resourceGroup)'
    AppName: '$(appName)'
    AppSettings: '-WEBSITE_RUN_FROM_PACKAGE 1'
```

### チェックポイント

1. **サービスコネクション**
   - `azureSubscription`変数が正しいサービスコネクション名に設定されているか確認してください。この名前はAzure DevOpsのサービスコネクションの設定で確認できます。

2. **リソースグループ名**
   - `resourceGroup`変数が正しいリソースグループ名に設定されているか確認してください。Azureポータルでリソースグループ名を確認できます。

3. **App Service名**
   - `appName`変数が正しいApp Service名に設定されているか確認してください。AzureポータルでApp Service名を確認できます。

4. **変数の展開**
   - パイプライン実行時に変数が正しく展開されているか確認してください。例えば、`$(azureSubscription)`、`$(resourceGroup)`、`$(appName)`の値が期待通りのものになっているかチェックします。

### 例外的なエラーの確認

`AzureAppServiceSettings`タスクでのエラーが続く場合は、以下の点も確認してみてください：

1. **Azure CLI タスクの追加**
   - `AzureAppServiceSettings`タスクの代わりに、`AzureCLI@2`タスクを使用してApp Serviceの設定を変更することもできます。以下はその例です：

```yaml
- task: AzureCLI@2
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az webapp config appsettings set --name $(appName) --resource-group $(resourceGroup) --settings WEBSITE_RUN_FROM_PACKAGE=1
```

2. **パイプラインのデバッグ**
   - パイプラインのログを確認して、エラーの詳細を特定します。必要に応じて、変数の値をログに出力してデバッグを行います。

### 完全なYAML例

以下に、完全なYAML例を示します。これには、`AzureWebApp`タスクでのデプロイと、`AzureCLI@2`タスクでのApp Service設定の変更が含まれています。

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'your-app-service-name' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.x' # .NETのバージョン

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(appName)'
    package: '$(Build.ArtifactStagingDirectory)'
    runtimeStack: 'DOTNETCORE|6.0' # 適切なランタイムスタックを指定

- task: AzureCLI@2
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az webapp config appsettings set --name $(appName) --resource-group $(resourceGroup) --settings WEBSITE_RUN_FROM_PACKAGE=1
```

これで、App Serviceへのデプロイと設定変更が正常に行われるはずです。

### user — 2024-08-06T13:29:36.567420+00:00

- task: AzureAppServiceSettings@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    ResourceGroupName: '$(resourceGroup)'
    AppSettings: '-WEBSITE_RUN_FROM_PACKAGE 1'
はデプロイに必要か

### assistant — 2024-08-06T13:30:10.119450+00:00

`AzureAppServiceSettings`タスクは必須ではありませんが、特定の設定をAzure App Serviceに適用する必要がある場合に使用されます。このタスクがエラーの原因となっている場合は、以下のオプションを検討できます：

1. **タスクの削除**: `AzureAppServiceSettings`タスクがデプロイに必須でない場合、このタスクを削除してデプロイを行うことができます。

2. **`AzureCLI`タスクを使用して設定を適用**: 必要な設定を`AzureCLI`タスクを使って適用することができます。

### タスクの削除

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'your-app-service-name' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.x' # .NETのバージョン

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(appName)'
    package: '$(Build.ArtifactStagingDirectory)'
    runtimeStack: 'DOTNETCORE|6.0' # 適切なランタイムスタックを指定
```

### `AzureCLI`タスクを使用して設定を適用

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'your-app-service-name' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.x' # .NETのバージョン

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(appName)'
    package: '$(Build.ArtifactStagingDirectory)'
    runtimeStack: 'DOTNETCORE|6.0' # 適切なランタイムスタックを指定

- task: AzureCLI@2
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az webapp config appsettings set --name $(appName) --resource-group $(resourceGroup) --settings WEBSITE_RUN_FROM_PACKAGE=1
```

これにより、App Serviceの設定を適用するために`AzureAppServiceSettings`タスクを削除するか、`AzureCLI`タスクを使用して設定を適用する方法を選択できます。

### user — 2024-08-06T13:35:30.337446+00:00

デプロイは成功したがブラウザでURLを指示すると
Your web app is running and waiting for your content
となる

### assistant — 2024-08-06T13:36:09.318842+00:00

このメッセージは、Azure App Serviceが正常に稼働しているが、アプリケーションのデプロイが正しく行われていないか、コンテンツが適切に提供されていない場合に表示されます。この問題を解決するために、以下の手順を試してみてください。

### デプロイパイプラインの確認

1. **ビルド成果物の確認**:
    - ビルドステップで成果物が正しく生成されているか確認します。
    - `dotnet publish` コマンドの出力ディレクトリが正しいか確認します。

2. **デプロイパッケージの確認**:
    - Azure DevOpsのパイプラインで生成された成果物が正しいか確認します。
    - デプロイステップで正しいパスが指定されているか確認します。

### パイプラインの修正例

#### デプロイメントの再確認

以下は、パイプラインの完全なYAML例です。特にビルドとパブリッシュステップ、およびデプロイステップに注目してください。

```yaml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'your-service-connection-name' # サービスコネクション名
  appName: 'your-app-service-name' # App Service名
  resourceGroup: 'your-resource-group' # リソースグループ名
  environmentName: 'production'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.x' # .NETのバージョン

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    projects: '**/*.csproj'
    arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)/publish'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/publish'
    ArtifactName: 'drop'
    publishLocation: 'Container'

- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azureSubscription)'
    appType: 'webApp'
    appName: '$(appName)'
    package: '$(Build.ArtifactStagingDirectory)/publish'
    runtimeStack: 'DOTNETCORE|6.0' # 適切なランタイムスタックを指定

- task: AzureCLI@2
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az webapp config appsettings set --name $(appName) --resource-group $(resourceGroup) --settings WEBSITE_RUN_FROM_PACKAGE=1
```

### デプロイパッケージの構成を確認

1. **ビルドステップのパブリッシュディレクトリを確認**:
    - `dotnet publish` の出力ディレクトリが `$(Build.ArtifactStagingDirectory)/publish` に設定されていることを確認します。

2. **デプロイステップのパッケージパスを確認**:
    - デプロイステップで `$(Build.ArtifactStagingDirectory)/publish` が正しく指定されていることを確認します。

### App Serviceのログを確認

1. **AzureポータルでApp Serviceのログを確認**:
    - Azureポータルにサインインします。
    - 該当のApp Serviceに移動します。
    - 「診断と解決策」>「診断ログ」>「アプリケーションログ」を確認します。

2. **Kuduコンソールを使用**:
    - AzureポータルでApp Serviceに移動します。
    - 「開発ツール」>「Advanced Tools (Kudu)」を開きます。
    - 「Debug console」>「CMD」からファイル構造を確認し、正しくデプロイされているか確認します。

### 追加のトラブルシューティング

- **正しいスタートアップコマンドが設定されているか確認**:
    - 必要に応じて、App Serviceの設定でスタートアップコマンドを設定します。

- **Web.configの設定**:
    - ASP.NET CoreアプリケーションのWeb.configファイルが正しく設定されているか確認します。

以上の手順で、アプリケーションが正しくデプロイされ、動作するように設定を確認および修正してください。
