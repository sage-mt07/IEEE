---
conversation_id: "678b132c-1e74-8007-b8c0-96f61f493d0a"
title: "メール送信先チェック方法"
create_time: 1737167660.60394
update_time: 1737167745.143605
language_guess: "en"
num_messages: 8
part_index: 1
part_count: 1
---

### system — 2025-01-18T02:34:20.603940+00:00

_(empty)_

### user — 2025-01-18T02:34:20.609034+00:00

office365のメール送信前に送信先をチェックする処理を追加したい

### tool — 2025-01-18T02:34:39.525809+00:00

**受信者の確認手順を検討**

受信者の確認プロセスをOffice365に追加して、誤送信を防ぎ、コンプライアンスを確保する方法を探しているところ。 Outlookのルール、Exchange Onlineの送信前ルール、サードパーティのアドイン、Power Automateフローなど、さまざまなアプローチがある。ちなみに、選ばれるのは送信前ルールやOutlookアドインかも。

**送信前チェックを考慮**

VBAスクリプトやOutlookアドイン、Exchange Onlineの送信前ルール、DLPポリシーを使って、受信者のリストを事前に検証している。

**送信前の確認を強化する**

Exchange Onlineの送信前ルールを使って受信者のリストを検証し、誤送信を防ぐ方法を検討中。アドインやPower Automateのオプションも探している。

**受信者の確認ルール設定中**

Exchange Onlineの「送信前ルール」を活用し、送信メールの受信者をチェックし、誤送信を防ぐための新しいルールを作成している。

**例外を設定し、ルールを保存**

受信者の確認をスキップしたい特定の条件を設定し、設定を見直してルールを保存している。これで出荷メールの受信者制限がサーバーで適用される。

**カスタムアドインの開発と展開**

Outlookの送信イベントに組み込み、受信者リストを事前のリストや基準と照合している。ユーザーに確認ダイアログを表示することで、受信者の確認を行っている。

**DLPポリシーの設定**

DLPポリシーを作成して、送信メールの受信者と内容を分析し、誤送信を防止するルールを適用している。

### assistant — 2025-01-18T02:34:39.525897+00:00

Office 365（現：Microsoft 365）でメール送信前に送信先をチェックする処理を追加するには、いくつかの方法があります。組織のニーズや要件に応じて、以下の方法から最適なものを選択してください。

## 1. **Exchange Online のメールフロールール（トランスポートルール）を使用する**

メールフロールールを設定することで、送信メールの送信先をサーバー側で検査し、特定の条件に基づいてメールの送信をブロックしたり、警告を表示したりすることができます。

### **設定手順:**

1. **Exchange 管理センターにアクセスする:**
   - Microsoft 365 管理センターにサインインします。
   - 左側のメニューから「**管理センター**」を選択し、「**Exchange**」をクリックします。

2. **メールフロールールの作成:**
   - 左側のメニューから「**メールフロー**」を選択し、「**ルール**」タブを開きます。
   - 「**＋（プラス）**」ボタンをクリックし、「**新しいルールの作成**」を選択します。

3. **ルールの設定:**
   - **名前:** 分かりやすい名前を付けます（例：「送信前の送信先チェック」）。
   - **条件の設定:** 「**適用する条件**」で「**宛先のアドレスに特定のドメインが含まれている場合**」など、チェックしたい条件を設定します。
   - **アクションの設定:** 条件に一致した場合のアクションを選択します。例えば、「**メッセージを拒否し、説明を添えて送信者に通知する**」や「**メッセージを隔離する**」など。
   - **例外の設定（必要に応じて）:** 特定のユーザーやグループを除外する場合は、例外条件を設定します。

4. **ルールの有効化と保存:**
   - 設定内容を確認し、「**保存**」をクリックしてルールを有効化します。

### **メリット:**
- 組織全体に適用可能で、クライアント側の設定に依存しない。
- サーバー側で一元管理できるため、セキュリティが向上。

### **注意点:**
- 過度に制限をかけると業務に支障をきたす可能性があるため、ルールは慎重に設定すること。
- テスト環境で十分に動作確認を行ってから本番環境に適用することを推奨。

## 2. **Outlook アドインを使用する**

クライアント側で送信前に送信先を確認するインタラクティブな方法として、Outlook アドインを利用する方法があります。

### **方法:**

1. **既存のアドインを利用する:**
   - Microsoft AppSource などで提供されているアドインを探し、組織の要件に合うものを導入します。

2. **カスタムアドインを開発する:**
   - 組織固有の要件がある場合、カスタムの Outlook アドインを開発します。
   - [Office アドイン開発のドキュメント](https://docs.microsoft.com/ja-jp/office/dev/add-ins/)を参考に開発します。
   - 送信ボタンのクリックイベントをフックし、送信先のアドレスを検証するロジックを実装します。
   - 条件に合わない場合、ユーザーに警告を表示したり、送信をキャンセルしたりします。

### **メリット:**
- ユーザーに対してインタラクティブなフィードバックを提供できる。
- 柔軟なカスタマイズが可能。

### **注意点:**
- アドインの開発には技術的な知識が必要。
- 組織全体に展開する場合、管理とサポートが必要。

## 3. **データ損失防止（DLP）ポリシーの設定**

送信先が特定の条件を満たしていない場合にメールの送信を制限するために、DLP ポリシーを設定する方法です。

### **設定手順:**

1. **Microsoft 365 コンプライアンスセンターにアクセス:**
   - Microsoft 365 管理センターから「**コンプライアンス**」を選択します。

2. **DLP ポリシーの作成:**
   - 「**データ損失防止**」 > 「**ポリシー**」 > 「**ポリシーの作成**」を選択します。
   - テンプレートから選択するか、カスタムポリシーを作成します。

3. **ポリシーの設定:**
   - **条件の設定:** メールの送信先や内容に基づいて条件を設定します。
   - **アクションの設定:** 条件に一致した場合のアクション（メールのブロック、通知の送信など）を設定します。
   - **例外の設定:** 必要に応じて例外条件を追加します。

4. **ポリシーの有効化と適用:**
   - 設定内容を確認し、ポリシーを有効化します。

### **メリット:**
- セキュリティとコンプライアンスを強化できる。
- 組織全体で統一されたポリシーを適用可能。

### **注意点:**
- ポリシーの設定が複雑になる場合があるため、専門知識が必要。
- 誤った設定により、正常な業務メールまでブロックされるリスクがあるため、慎重な設定とテストが必要。

## 4. **Power Automate（旧 Microsoft Flow）を利用する**

Power Automate を使用して、送信後にメールを監視し、特定の条件に合致する場合にアクションを実行するフローを作成する方法です。ただし、この方法は送信後の対応となるため、事前の送信確認には適していません。

### **方法:**

1. **Power Automate にサインイン:**
   - [Power Automate](https://flow.microsoft.com/) にアクセスし、Microsoft 365 アカウントでサインインします。

2. **新しいフローの作成:**
   - 「**自動化されたクラウド フロー**」を選択し、トリガーとして「**新しいメールが送信されたとき**」を設定します。

3. **条件とアクションの設定:**
   - メールの送信先や内容に基づいて条件を設定し、必要なアクション（通知の送信、メールの移動など）を追加します。

### **メリット:**
- カスタマイズ性が高く、様々なアクションを組み合わせられる。
- 他のアプリケーションとの連携が容易。

### **注意点:**
- 送信後の対応となるため、事前の送信防止には適さない。
- 複雑なフローを作成する場合、専門知識が必要。

## **おすすめのアプローチ**

組織全体で送信先を事前にチェックし、ポリシーを強制する場合は、**Exchange Online のメールフロールール**を使用する方法が最も効果的です。サーバー側で一元管理でき、ユーザーの操作に依存しないため、セキュリティとコンプライアンスを確実に守ることができます。

一方、ユーザーに対してインタラクティブな確認を求めたい場合や、特定のカスタマイズが必要な場合は、**Outlook アドイン**の導入を検討してください。

どちらの方法でも、導入前にテスト環境で十分な検証を行い、運用への影響を最小限に抑えることをお勧めします。

---

**参考資料:**
- [Exchange 管理センターのメールフロー規則](https://docs.microsoft.com/ja-jp/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules)
- [Outlook アドインの開発](https://docs.microsoft.com/ja-jp/office/dev/add-ins/outlook/)
- [Microsoft 365 の DLP ポリシー](https://docs.microsoft.com/ja-jp/microsoft-365/compliance/data-loss-prevention-policies?view=o365-worldwide)

質問や具体的な要件があれば、さらに詳細なアドバイスを提供できますので、お気軽にお知らせください。

### user — 2025-01-18T02:35:19.783248+00:00

Outlook アドインを使用する方法でコードと設定方法を示せ

### tool — 2025-01-18T02:35:44.439729+00:00

**進行中の作業**

Outlook アドインの使用方法を求めている。コードと設定方法も希望している。

**Visual Studio サポート**

Visual Studio を使い、Node.js や Visual Studio Code の Yeoman generator で開発する方法を説明中。

**送信イベントの操作**

送信イベントを操作するには、Outlook の add-in 特徴を利用する必要がある。

### assistant — 2025-01-18T02:35:44.439816+00:00

Outlook アドインを使用して、メール送信前に送信先をチェックする機能を追加する方法について、以下に詳細な手順とコード例を示します。このガイドでは、**Office アドイン**の開発環境の設定から、送信イベントをフックして送信先を検証するコードの実装、アドインのデプロイ方法までをカバーします。

## **前提条件**

1. **開発環境の準備**
   - **Node.js**（バージョン 14 以上）
   - **Yeoman** と **Office アドインジェネレーター**
   - **Visual Studio Code**（推奨）
   - **Microsoft 365 アカウント**（アドインのテスト用）

2. **必要なツールのインストール**
   - **Node.js**: [公式サイト](https://nodejs.org/)からインストールします。
   - **Yeoman** と **Office アドインジェネレーター**:
     ```bash
     npm install -g yo generator-office
     ```

## **ステップ 1: 新しい Outlook アドインプロジェクトの作成**

1. **プロジェクトの作成**
   ```bash
   yo office
   ```
   
2. **プロンプトへの回答**
   - **Choose a project type**: `Office Add-in project using the manifest only`
   - **Choose a script type**: `JavaScript` または `TypeScript`（ここでは `JavaScript` を選択）
   - **What do you want to name your add-in?**: 任意のプロジェクト名（例: `RecipientCheckerAddin`）
   - **Which Office client application would you like to support?**: `Outlook`

3. **プロジェクトディレクトリに移動**
   ```bash
   cd RecipientCheckerAddin
   ```

## **ステップ 2: アドインマニフェストの設定**

Outlook アドインで送信前のチェックを行うには、**On-Send** イベントを使用します。マニフェストファイル (`manifest.xml`) を編集して、`LaunchEvent` を追加します。

1. **`manifest.xml` の編集**
   ```xml
   <VersionOverrides xmlns="http://schemas.microsoft.com/office/mailappversionoverrides/1.0" xsi:type="VersionOverridesV1_0">
     <Hosts>
       <Host xsi:type="MailHost">
         <DesktopFormFactor>
           <ExtensionPoint xsi:type="Events">
             <Event Type="OnSend" FunctionName="onMessageSendHandler" />
           </ExtensionPoint>
         </DesktopFormFactor>
       </Host>
     </Hosts>
     <Resources>
       <!-- 必要に応じてリソースを追加 -->
     </Resources>
   </VersionOverrides>
   ```

2. **権限の設定**
   アドインがメールの送信情報にアクセスするために、適切な権限を設定します。`Permissions` を `ReadWriteItem` に設定します。
   ```xml
   <Permissions>ReadWriteItem</Permissions>
   ```

## **ステップ 3: On-Send イベントハンドラーの実装**

アドインが送信前に実行される JavaScript コードを実装します。

1. **`./src/commands.js` の作成または編集**

   ```javascript
   Office.initialize = () => {
     // 初期化コードが必要な場合に記述
   };

   /**
    * On-Send イベントハンドラー
    */
   async function onMessageSendHandler(event) {
     try {
       const item = Office.context.mailbox.item;

       // 送信先アドレスの取得
       let recipients = [];

       // To フィールドのアドレス取得
       const toRecipients = item.to || [];
       toRecipients.forEach(recipient => {
         recipients.push(recipient.emailAddress);
       });

       // Cc フィールドのアドレス取得（必要に応じて）
       const ccRecipients = item.cc || [];
       ccRecipients.forEach(recipient => {
         recipients.push(recipient.emailAddress);
       });

       // Bcc フィールドのアドレス取得（必要に応じて）
       const bccRecipients = item.bcc || [];
       bccRecipients.forEach(recipient => {
         recipients.push(recipient.emailAddress);
       });

       // 送信先のチェックロジック（例: 特定ドメインをブロック）
       const blockedDomains = ['blocked.com', 'example.com'];
       const invalidRecipients = recipients.filter(email => {
         const domain = email.split('@')[1].toLowerCase();
         return blockedDomains.includes(domain);
       });

       if (invalidRecipients.length > 0) {
         // エラーメッセージの表示
         await Office.context.ui.displayDialogAsync(
           'https://localhost:3000/dialog.html',
           { height: 30, width: 20 },
           result => {
             // ダイアログが閉じられた後の処理
           }
         );

         // メール送信のキャンセル
         event.completed({ allowEvent: false });
       } else {
         // メール送信を許可
         event.completed({ allowEvent: true });
       }

     } catch (error) {
       console.error('Error in onMessageSendHandler:', error);
       // エラーが発生した場合、送信をキャンセル
       event.completed({ allowEvent: false });
     }
   }

   // エクスポート（モジュールシステムを使用している場合）
   if (typeof module !== 'undefined') {
     module.exports = { onMessageSendHandler };
   }
   ```

2. **ダイアログページの作成**

   ユーザーに警告を表示するためのダイアログページ (`dialog.html`) を作成します。

   - **`./src/dialog.html` の作成**

     ```html
     <!DOCTYPE html>
     <html>
     <head>
       <meta charset="utf-8">
       <title>送信ブロック</title>
       <script>
         // ページ読み込み時に自動的に閉じる
         window.onload = function () {
           Office.onReady().then(() => {
             Office.context.ui.messageParent("メールの送信がブロックされました。送信先に不正なアドレスが含まれています。");
           });
         };
       </script>
     </head>
     <body>
       <p>送信先に不正なアドレスが含まれています。メールの送信を中止しました。</p>
     </body>
     </html>
     ```

   - **`./src/dialog.js` の作成（オプション）**
     
     必要に応じて、ダイアログ内で追加のスクリプトを実装します。

## **ステップ 4: アドインのデバッグとテスト**

1. **ローカルでアドインをホストする**

   開発中は、ローカルサーバー（例: `localhost:3000`）でアドインをホストします。`package.json` にスクリプトが含まれている場合が多いので、それを使用します。

   ```bash
   npm start
   ```

   このコマンドは、アドインのウェブサーバーを起動し、Outlook デスクトップアプリまたは Outlook on the web でアドインをテストできるようにします。

2. **Outlook でアドインをサイドローディング**

   - **Outlook on the web の場合:**
     1. Outlook を開き、設定（歯車アイコン）をクリックします。
     2. 「**すべての Outlook 設定を表示**」を選択します。
     3. 「**メール**」 > 「**カスタマイズ機能**」に移動します。
     4. 「**カスタムアドイン**」 > 「**カスタムアドインの追加**」 > 「**ファイルから追加**」を選択し、生成された `manifest.xml` をアップロードします。

   - **Outlook デスクトップアプリの場合:**
     1. Outlook を開きます。
     2. 「**ホーム**」タブで「**アドイン**」をクリックします。
     3. 「**アドインを管理**」 > 「**カスタムアドイン**」 > 「**追加**」 > 「**ファイルから追加**」を選択し、`manifest.xml` を指定します。

3. **テストの実行**
   - 新しいメール作成時に、送信ボタンをクリックすると、送信前にアドインが動作し、送信先のチェックが実行されます。
   - 送信先にブロック対象のドメインが含まれている場合、ダイアログが表示され、メールの送信がキャンセルされます。
   - 正常な送信先の場合は、メールが通常通り送信されます。

## **ステップ 5: アドインのデプロイ**

開発とテストが完了したら、アドインを組織全体に展開します。

1. **アドインのホスティング**
   - アドインのウェブコンテンツ（HTML、JavaScript、CSS など）を信頼できるウェブサーバーまたはクラウドサービス（例: Azure、AWS）にデプロイします。

2. **マニフェストの更新**
   - `manifest.xml` 内の `SourceLocation` をデプロイ先の URL に更新します。

3. **アドインの公開**
   - **管理者による展開**:
     1. **Microsoft 365 管理センター**にサインインします。
     2. **「設定」** > **「サービスとアドイン」** > **「カスタムアドイン」** を選択します。
     3. **「カスタムアドインの追加」** をクリックし、`manifest.xml` をアップロードします。
     4. 展開方法（全ユーザー、特定のグループ）を選択します。

   - **ユーザーによる追加**:
     ユーザー自身がアドインを追加できるようにする場合、Microsoft AppSource に公開するか、サイドローディングを許可します。ただし、組織内で一括展開する場合は、管理者による展開が推奨されます。

## **サンプルコードのまとめ**

以下に、主要なファイルのサンプルコードをまとめます。

### **`manifest.xml` の抜粋**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<OfficeApp xmlns="http://schemas.microsoft.com/office/appforoffice/1.1"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:bt="http://schemas.microsoft.com/office/officeappbasictypes/1.0"
           xmlns:mailappor="http://schemas.microsoft.com/office/mailappversionoverrides/1.0"
           xsi:type="MailApp">
  <Id>YOUR-ADDIN-ID</Id>
  <Version>1.0.0.0</Version>
  <ProviderName>あなたの会社名</ProviderName>
  <DefaultLocale>ja-JP</DefaultLocale>
  <DisplayName DefaultValue="Recipient Checker Add-in" />
  <Description DefaultValue="送信前に送信先をチェックするアドインです。" />
  <IconUrl DefaultValue="https://localhost:3000/icon.png" />
  <HighResolutionIconUrl DefaultValue="https://localhost:3000/icon.png" />
  <SupportUrl DefaultValue="https://yoursupporturl.com" />

  <Permissions>ReadWriteItem</Permissions>

  <VersionOverrides xmlns="http://schemas.microsoft.com/office/mailappversionoverrides/1.0" xsi:type="VersionOverridesV1_0">
    <Hosts>
      <Host xsi:type="MailHost">
        <DesktopFormFactor>
          <ExtensionPoint xsi:type="Events">
            <Event Type="OnSend" FunctionName="onMessageSendHandler" />
          </ExtensionPoint>
        </DesktopFormFactor>
      </Host>
    </Hosts>
    <Resources>
      <bt:Urls>
        <bt:Url id="functionFile" DefaultValue="https://localhost:3000/commands.html" />
        <bt:Url id="dialog" DefaultValue="https://localhost:3000/dialog.html" />
      </bt:Urls>
      <bt:ShortStrings>
        <bt:String id="title">Recipient Checker</bt:String>
      </bt:ShortStrings>
      <bt:LongStrings>
        <bt:String id="description">送信前に送信先をチェックします。</bt:String>
      </bt:LongStrings>
    </Resources>
  </VersionOverrides>
</OfficeApp>
```

### **`commands.js` の抜粋**

```javascript
Office.initialize = () => {
  // 初期化コード
};

/**
 * On-Send イベントハンドラー
 */
async function onMessageSendHandler(event) {
  try {
    const item = Office.context.mailbox.item;

    let recipients = [];

    const toRecipients = item.to || [];
    toRecipients.forEach(recipient => {
      recipients.push(recipient.emailAddress);
    });

    const ccRecipients = item.cc || [];
    ccRecipients.forEach(recipient => {
      recipients.push(recipient.emailAddress);
    });

    const bccRecipients = item.bcc || [];
    bccRecipients.forEach(recipient => {
      recipients.push(recipient.emailAddress);
    });

    const blockedDomains = ['blocked.com', 'example.com'];
    const invalidRecipients = recipients.filter(email => {
      const domain = email.split('@')[1].toLowerCase();
      return blockedDomains.includes(domain);
    });

    if (invalidRecipients.length > 0) {
      await Office.context.ui.displayDialogAsync(
        'https://yourdomain.com/dialog.html',
        { height: 30, width: 20 },
        result => {
          // ダイアログ閉鎖後の処理
        }
      );

      event.completed({ allowEvent: false });
    } else {
      event.completed({ allowEvent: true });
    }

  } catch (error) {
    console.error('Error in onMessageSendHandler:', error);
    event.completed({ allowEvent: false });
  }
}

if (typeof module !== 'undefined') {
  module.exports = { onMessageSendHandler };
}
```

### **`dialog.html` の抜粋**

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>送信ブロック</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    Office.onReady().then(() => {
      Office.context.ui.messageParent("メールの送信がブロックされました。送信先に不正なアドレスが含まれています。");
    });
  </script>
</head>
<body>
  <p>送信先に不正なアドレスが含まれています。メールの送信を中止しました。</p>
</body>
</html>
```

## **補足事項**

- **セキュリティ**: アドインの通信は HTTPS を使用し、信頼できるホスティング環境で行ってください。
- **クロスドメイン**: ダイアログや API 呼び出し時に CORS ポリシーに注意してください。
- **エラーハンドリング**: 実際の運用では、より詳細なエラーハンドリングを実装し、ユーザーに適切なフィードバックを提供してください。
- **拡張性**: 送信先のチェックロジックを柔軟に拡張できるように、設定ファイルや管理画面を設けることを検討してください。

## **参考資料**

- [Office アドインの開発](https://docs.microsoft.com/ja-jp/office/dev/add-ins/)
- [Outlook アドインの On-Send イベント](https://docs.microsoft.com/ja-jp/outlook/add-ins/outlook-on-send-addins)
- [Office.js API リファレンス](https://docs.microsoft.com/ja-jp/javascript/api/overview/outlook)

ご不明点や具体的な要件に応じたカスタマイズについての質問があれば、さらに詳細なサポートを提供いたしますので、お気軽にお知らせください。
