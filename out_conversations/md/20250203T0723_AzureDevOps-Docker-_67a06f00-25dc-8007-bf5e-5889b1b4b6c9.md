---
conversation_id: "67a06f00-25dc-8007-bf5e-5889b1b4b6c9"
title: "AzureDevOps Docker 認証エラー"
create_time: 1738567424.642131
update_time: 1738567491.490213
language_guess: "en"
num_messages: 5
part_index: 1
part_count: 1
---

### system — 2025-02-03T07:23:44.642131+00:00

_(empty)_

### user — 2025-02-03T07:23:44.649920+00:00

AzureDevopsでDockerfileから組織のArtifactsへの認証がしっぱいする。dotnet restoreコマンドでは成功する
エラーはNU1301が出る

### assistant — 2025-02-03T07:24:49.857422+00:00

_(empty)_

### assistant — 2025-02-03T07:24:49.857538+00:00

`NU1301` エラーは、`dotnet restore` または `nuget restore` 実行時に、パッケージの認証や取得に失敗したときに発生するエラーです。特に **Azure DevOps の Artifacts (パッケージフィード)** へのアクセス時に発生する場合、認証トークンの適用ミスが原因となることが多いです。

### **考えられる原因と対処方法**
#### **1. `dotnet restore` では成功するが、Docker ビルド時に失敗する**
これは、Docker のビルド時に Azure DevOps Artifacts への認証情報が適用されていない可能性があります。

**解決策:**
Docker ビルドの前に、環境変数で `NUGET_CREDENTIALPROVIDER_SESSIONTOKENCACHE_ENABLED` を `true` に設定し、`dotnet nuget add source` を使って適切に NuGet ソースを登録してください。

```yaml
- task: NuGetAuthenticate@1
  displayName: "NuGet Authentication"

- script: |
    dotnet nuget add source --username AzureDevOps --password $(System.AccessToken) \
      --store-password-in-clear-text --name "AzureArtifacts" https://pkgs.dev.azure.com/your-org/_packaging/your-feed/nuget/v3/index.json
  displayName: "Configure NuGet Source"
  env:
    VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials":[{"endpoint":"https://pkgs.dev.azure.com/your-org/_packaging/your-feed/nuget/v3/index.json","username":"AzureDevOps","password":"$(System.AccessToken)"}]}'

```

その後、Dockerfile のビルド時に `--build-arg` で認証情報を渡す：
```yaml
- script: |
    docker build --build-arg NUGET_AUTH_TOKEN=$(System.AccessToken) -t your-image .
```

Dockerfile には以下のように記述：
```dockerfile
ARG NUGET_AUTH_TOKEN
RUN dotnet restore --interactive
```
または、認証が必要な場合のために `ENV` 変数として設定する：
```dockerfile
ENV NUGET_AUTH_TOKEN=${NUGET_AUTH_TOKEN}
```

---

#### **2. Docker の `RUN dotnet restore` 実行時に認証情報が失われる**
**解決策:**
Azure Artifacts に対して `NuGet.Config` を事前に設定することで、`dotnet restore` 時の認証エラーを防ぐ。

##### **手順**
1. **ローカルで認証情報付きの NuGet.Config を作成**
   ```bash
   dotnet nuget add source https://pkgs.dev.azure.com/your-org/_packaging/your-feed/nuget/v3/index.json \
       --username AzureDevOps --password $(System.AccessToken) --store-password-in-clear-text --name "AzureArtifacts"
   ```
2. **この `NuGet.Config` を Docker ビルド時に COPY する**
   ```dockerfile
   COPY NuGet.Config /root/.nuget/NuGet/NuGet.Config
   ```
3. **Docker 内で `dotnet restore` 実行**
   ```dockerfile
   RUN dotnet restore
   ```

---

#### **3. `VSS_NUGET_EXTERNAL_FEED_ENDPOINTS` の設定不足**
Azure DevOps では `System.AccessToken` を使用した認証が可能です。Docker ビルド時に環境変数として渡すことで、NuGet の認証がうまく動作する可能性があります。

```yaml
- script: |
    echo '{"endpointCredentials":[{"endpoint":"https://pkgs.dev.azure.com/your-org/_packaging/your-feed/nuget/v3/index.json","username":"AzureDevOps","password":"$(System.AccessToken)"}]}' > endpoints.json
  displayName: "Set VSS_NUGET_EXTERNAL_FEED_ENDPOINTS"
  
- script: |
    docker build --build-arg VSS_NUGET_EXTERNAL_FEED_ENDPOINTS=$(cat endpoints.json) -t your-image .
```

または `Dockerfile` に直接埋め込む：
```dockerfile
ARG VSS_NUGET_EXTERNAL_FEED_ENDPOINTS
ENV VSS_NUGET_EXTERNAL_FEED_ENDPOINTS=${VSS_NUGET_EXTERNAL_FEED_ENDPOINTS}
```

---

### **まとめ**
1. **Docker ビルド時に Azure Artifacts への認証が適用されていない**  
   → `NuGetAuthenticate@1` タスクを実行し、`dotnet nuget add source` で認証設定

2. **Docker の `dotnet restore` 実行時に認証情報が失われる**  
   → `NuGet.Config` を作成し、Docker 内で利用

3. **`VSS_NUGET_EXTERNAL_FEED_ENDPOINTS` の設定不足**  
   → `System.AccessToken` を使って環境変数に渡す

まず `NuGet.Config` をローカルで確認し、それを Docker ビルド時に渡す方法を試すと解決する可能性が高いです。
