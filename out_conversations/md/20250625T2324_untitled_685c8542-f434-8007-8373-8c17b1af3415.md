---
conversation_id: "685c8542-f434-8007-8373-8c17b1af3415"
title: "ファイルチェック結果"
create_time: 1750893891.124572
update_time: 1751008256.098418
language_guess: "en"
num_messages: 16
part_index: 1
part_count: 1
---

### system — 2025-06-25T23:24:51.124572+00:00

_(empty)_

### user — 2025-06-25T23:24:51.124572+00:00

_(empty)_

### assistant — 2025-06-25T23:24:51.504949+00:00

やあ、いらっしゃい！ファイルをすべて確認しました。以下が今回アップロードされた各ドキュメントの概要と整合性の状態です（2025年6月26日 08:33 JST 時点）：

---

## ✅ 全体構成チェック

### 📘 `dev_guide.md`
- **目的**：新機能開発のガイドラインとnamespace別ドキュメントのリンク集。
- **特筆**：
  - Namespaceごとの設計書更新を前提としたワークフローが明確。
  - 実装例・パターンも記載あり（EntitySet追加、エラーハンドリング、Window処理）。

### 🧱 各Namespace詳細（リンク順に対応）

| Namespace | ドキュメント内容の確認 | 備考 |
|-----------|--------------------------|------|
| `Application` | ✅ [20†application_namespace_doc.md] | `Context`, `Builder`, `Options` 明確。KafkaContextの初期化フローが詳述。 |
| `Serialization` | ✅ [17†serialization_namespace_doc.md] | Avro属性主導のスキーマ生成／登録機構、キャッシュ、バージョニング対応。 |
| `Core` | ✅ [14†core_namespace_doc.md] | POCO属性、ModelBuilder、Window機能、抽象APIが網羅的に記述。 |
| `Window` | ✅ [19†window_namespace_doc.md] | Finalization処理、確定足トピック送信、POD協調の詳細あり。 |
| `Messaging` | ✅ [15†messaging_namespace_doc.md] | Producer/Consumer、DLQ処理、エラーハンドリングの詳細あり。 |
| `Query` | ✅ [16†query_namespace_doc.md] | LINQ→KSQL変換、Builder構成、Stream/Table推論が整理されている。 |
| `StateStore` | ✅ [18†statestore_namespace_doc.md] | RocksDB連携、Ready監視、Windowストア連携が明記。 |

---

## 📌 整合性・メタチェック

- 各namespace設計書には **責務、設計原則、主要クラス構成、依存関係、変更頻度** が網羅されており、`dev_guide.md` の基準と合致。
- ドキュメント内の **他namespaceとの連携記述** は双方向で整合性が取れている（例：`Window` ⇄ `Messaging`, `StateStore`）。
- `Core` 層はインターフェース定義のみで他層には依存しておらず、設計原則が守られている。
- `Serialization` と `Application` の間のスキーマ登録連携（`ConvertToAvroConfigurations()`）も一致。

---

## ✅ 次ステップ案（必要に応じて）

1. **Window Finalization層の扱い**
   - `Window` の `Finalization` 機構は設計上独立しており、`StateStore` とは依存関係なしで明確に分離可能です。
   - したがって、**WindowFinalization層は独立層として定義を維持すべき**です【19†window_namespace_doc.md】。

2. **Query層のBuilder説明**
   - Builder群（`SelectBuilder`, `GroupByBuilder`, `JoinBuilder`, etc.）はすでに役割と変更頻度が詳細に記述されています【16†query_namespace_doc.md】。
   - もし更なる詳細が必要なら、**各Builderの出力例や典型的LINQパターンとの対応関係表**の追記をおすすめします。

3. **設計原則の優先度明示**
   - `dev_guide.md` や各詳細には「Fail-Fast」「型安全性」「自動化」が繰り返し登場。
   - 優先度としては：  
     ① **型安全性**（全層共通）  
     ② **Fail-Fast**（主にApplication/Messaging/Serialization）  
     ③ **自動化**（Application/Serialization）  
     → 設計書冒頭で「原則の優先順位」を明示しておくと、AI含めた新規実装者に有効です。

4. **StateStore Ready監視のハイライト**
   - `StateStore` のReady状態監視機能は他層に比べて特に **運用面での重要性が高い**（障害検知、同期確認など）【18†statestore_namespace_doc.md】。
   - `dev_guide.md` にも「StateStoreのReady監視は運用安定性の基盤となる」旨を補記するとよいかもしれません。

---

ご希望があれば、これらを反映したドキュメント修正案（patch候補）もお作りします！

（2025年6月26日 08:33 JST）

### user — 2025-06-25T23:24:51.675000+00:00

ファイルをチェックして

### assistant — 2025-06-25T23:25:03.054367+00:00

_(empty)_

### tool — 2025-06-25T23:25:03.054514+00:00

_(empty)_

### tool — 2025-06-25T23:25:03.054568+00:00

# Kafka.Ksql.Linq 開発者ガイド

## 🎯 新機能開発前の必読事項

**重複実装を避けるため、新機能開発前に必ずこのガイドを確認してください。**

---

## 📚 Namespace別詳細ドキュメント

### 📋 概要
各namespaceの詳細設計は、以下の専用ドキュメントで管理されています。  
**変更作業前には必ず該当namespaceのドキュメントを確認してください。**

### 🏗️ 詳細設計ドキュメント一覧

| Namespace | 責務 | ドキュメント | 変更頻度 |
|-----------|------|-------------|----------|
| **Application** | 開発者向けAPI、設定管理、スキーマ自動登録 | [Application 詳細設計](docs/architecture/namespaces/Application.md) | 🔴 高 |
| **Serialization** | Avroスキーマ生成、型安全シリアライゼーション | [Serialization 詳細設計](docs/architecture/namespaces/Serialization.md) | 🔴 高 |
| **Core** | ビジネスロジック抽象化、EntityModel構築 | [Core 詳細設計](docs/architecture/namespaces/Core.md) | 🔴 高 |
| **Window** | ウィンドウ確定処理、確定足生成・配信 | [Window 詳細設計](docs/architecture/namespaces/Window.md) | 🔴 高 |
| **Messaging** | Producer/Consumer管理、エラーハンドリング | [Messaging 詳細設計](docs/architecture/namespaces/Messaging.md) | 🔴 高 |
| **Query** | LINQ→KSQL変換、クエリ実行パイプライン | [Query 詳細設計](docs/architecture/namespaces/Query.md) | 🔴 高 |
| **StateStore** | ローカル状態管理、ウィンドウ処理、Ready状態監視 | [StateStore 詳細設計](docs/architecture/namespaces/StateStore.md) | 🟡 中 |

---

## 🔧 新機能追加時の判定フロー

### 1. 対象namespace特定
```
❓ どのnamespaceの機能ですか？
  → 上記表から該当namespaceを特定
  → 該当する詳細設計ドキュメントを確認
```

### 2. 既存機能確認
```
❓ 同様の機能は既に実装されていませんか？
  → 詳細設計ドキュメントの「主要クラス構成」セクションを確認
  → 「変更頻度・作業パターン」で類似パターンを確認
```

### 3. 実装方針決定
```
❓ 新規実装 vs 既存拡張？
  → 「💡 実装上の重要なポイント」セクションを参考
  → 「🔗 他Namespaceとの連携」で影響範囲を確認
```

---

## 📝 実装パターン

### エンティティ追加パターン
```csharp
// 1. Entity定義（POCO + 属性）
[Topic("orders")]
public class Order
{
    [Key]
    public string OrderId { get; set; }
    public decimal Amount { get; set; }
}

// 2. Context追加
public class MyKafkaContext : KafkaContext
{
    public IEntitySet<Order> Orders => Set<Order>();
}

// 3. 使用例
await context.Orders.AddAsync(new Order { ... });
var orders = await context.Orders.ToListAsync();
```

### エラーハンドリングパターン
```csharp
// 既存のErrorHandlingPolicyを使用
await context.Orders
    .OnError(ErrorAction.Retry)
    .WithRetry(3, TimeSpan.FromSeconds(1))
    .ToListAsync();
```

### Window操作パターン
```csharp
// 既存のWindow拡張を使用
var windowedOrders = context.Orders.Window(5); // 5分ウィンドウ
await windowedOrders.ToListAsync();
```

---

## 🚀 開発完了後の更新手順

### 1. 該当namespace詳細ドキュメントの更新
- **主要クラス構成**: 新規クラス・機能を追加
- **変更頻度・作業パターン**: 新しいパターンを記載
- **実装上の重要なポイント**: 実装例・ベストプラクティスを追加

### 2. 他namespaceへの影響確認
- **🔗 他Namespaceとの連携**: 依存関係の更新
- 影響があるnamespaceのドキュメントも更新

### 3. 全体概要の更新
- [アーキテクチャ概要](docs/architecture/overview.md): 必要に応じて全体図・責務を更新

---

## 🔍 重複チェックリスト

新機能開発前に以下を確認：

- [ ] 該当namespaceの詳細設計ドキュメントを確認した
- [ ] 同じ責務のクラス・機能は既に存在しないか確認した
- [ ] 似たような実装パターンが既にないか確認した
- [ ] 他namespaceとの連携影響を確認した
- [ ] 設計制約・注意事項を確認した

---

## 📚 参考ドキュメント

### 🏗️ アーキテクチャ
- [全体概要](docs/architecture/overview.md) - システム全体のアーキテクチャ
- [作業指示書](docs/architecture/namespace_doc_work_instruction.md) - ドキ
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.054615+00:00

# Core 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **ビジネスロジック抽象化**: Infrastructure層への依存を排除した純粋なドメインロジック
- **型安全性・依存関係制御**: IKafkaContext、IEntitySet等の抽象インターフェース定義
- **エンティティモデル構築**: POCO属性ベースのEntityModel生成とFluent API
- **POCO属性システム**: `[Topic]`, `[Key]`, `[KafkaIgnore]`等の属性定義と処理

### 設計原則・制約
- **依存制限**: Infrastructure層（Messaging, Serialization等）への依存禁止
- **純粋関数**: 副作用なし、テスタブルな設計
- **型安全性**: ジェネリクス活用による型安全なAPI設計
- **POCO属性主導**: 手動設定より属性ベース自動構成を優先

### 他namespaceとの境界
- **Application**: KafkaContextCore基底クラスとEntityModel提供
- **Infrastructure**: 抽象インターフェース定義のみ、具象実装は下位層
- **依存方向**: Core ← Infrastructure（一方向依存を強制）

---

## 🏗️ 主要クラス構成

### 📁 Abstractions/ - 抽象化定義（🟢低変更頻度）
| ファイル | クラス/インターフェース | 責務 | 変更頻度 |
|---------|----------------------|------|----------|
| `IKafkaContext.cs` | IKafkaContext | コンテキスト操作の抽象化 | 🟢 |
| `IEntitySet.cs` | IEntitySet<T> | CRUD操作の統一API | 🟢 |
| `ISerializationManager.cs` | ISerializationManager<T> | シリアライゼーション抽象化 | 🟢 |
| `EntityModel.cs` | EntityModel | エンティティメタデータ管理 | 🟡 |
| `TopicAttribute.cs` | TopicAttribute | トピック属性定義 | 🟢 |
| `KeyAttribute.cs` | KeyAttribute | キー属性定義 | 🟢 |
| `KafkaIgnoreAttribute.cs` | KafkaIgnoreAttribute | 除外属性定義 | 🟢 |
| `AvroTimestampAttribute.cs` | AvroTimestampAttribute | タイムスタンプ属性定義 | 🟢 |
| `DecimalPrecisionAttribute.cs` | DecimalPrecisionAttribute | Decimal精度属性定義 | 🟢 |

### 📁 Context/ - コンテキスト基底（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KafkaContextCore.cs` | KafkaContextCore | KafkaContext基底実装 | 🟡 |
| `KafkaContextOptions.cs` | KafkaContextOptions | Core層設定オプション | 🟡 |

### 📁 Modeling/ - モデル構築（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `ModelBuilder.cs` | ModelBuilder | Fluent API + 属性ベース設定 | 🔴 |
| `EntityModelBuilder.cs` | EntityModelBuilder<T> | 個別エンティティ設定 | 🔴 |
| `ModelValidationResult.cs` | ModelValidationResult | モデル検証結果 | 🟡 |
| `WindowModelBuilderExtensions.cs` | Window拡張 | ウィンドウ集約設定 | 🟡 |

### 📁 Extensions/ - 拡張メソッド（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `CoreExtensions.cs` | CoreExtensions | EntityModel拡張メソッド | 🟡 |
| `EntityModelWindowExtensions.cs` | Window拡張 | Window関連拡張 | 🟡 |
| `LoggerFactoryExtensions.cs` | ログ拡張 | 汎用ログ拡張メソッド | 🟢 |
| `WindowExtensions.cs` | WindowExtensions | `.Window(minutes)`拡張 | 🟡 |

### 📁 Models/ - データモデル（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KeyExtractor.cs` | KeyExtractor | エンティティキー抽出ロジック | 🟡 |
| `ProducerKey.cs` | ProducerKey | Producer識別キー | 🟡 |

### 📁 Window/ - ウィンドウ処理（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `WindowedEntitySet.cs` | WindowedEntitySet<T> | ウィンドウ付きEntitySet | 🟡 |
| `WindowCollection.cs` | WindowCollection<T> | 複数ウィンドウ管理 | 🟡 |
| `WindowAggregatedEntitySet.cs` | WindowAggregatedEntitySet | ウィンドウ集約EntitySet | 🔴 |

### 📁 Abstractions/ErrorHandling/ - エラー処理（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `ErrorHandlingPolicy.cs` | ErrorHandlingPolicy | エラー処理ポリシー定義 | 🟡 |
| `ErrorHandlingExtensions.cs` | 拡張メソッド | エラー処理拡張API | 🟡 |
| `CircuitBreakerHandler.cs` | CircuitBreakerHandler | 回路ブレーカー実装 | 🟡 |

### 📁 Exceptions/ - 例外定義（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `CoreException.cs` | CoreException | Core例外基底クラス | 🟢 |
| `EntityModelException.cs` | EntityModelException | エンティティモデル例外 | 🟢 |
| `CoreValidationException.cs` | CoreValidationException | 検証例外 | 🟢 |

---

## 🔄 データフロー・依存関係

### EntityModel構築フロー
```
POCO型定義 → ModelBuilder.Entity<T>()
   ↓
CreateEntityModelFromType() → 属性読取り
   ↓
TopicAttribute, KeyAttribute等の解析
   ↓
EntityModel生成 → ValidationResult付与
   ↓
EntityModelBuilder<T>によるFluent API設定
```

### Context初期化フロー
```
KafkaContextCore.OnModelCreating()
   ↓
ModelBuilder作成 → Entity登録
   ↓
ApplyModelBuilderSettings() → Stream/Table型設定
   ↓
GetOrCreateEntityModel() → EntityModel取得・キャッシュ
   ↓
CreateEntitySet<T>() → 派生クラスでの具象実装
```

### EntitySet操作フロー
```
IKafkaContext.Set<T>()
   ↓
GetOrCreateEntityModel<T>() → EntityModel取得
   ↓
CreateEntitySet<T>(entityModel) → 抽象メソッド
   ↓
派生クラスで具象EventSet<T>生成
```

### Window操作フロー
```
EntitySet.Window(minutes) → WindowedEntitySet<T>
   ↓
ValidateAndGetTimestampProperty() → [AvroTimestamp]検証
   ↓
GroupByAggregate() → WindowAggregatedEntitySet生成
   ↓
KSQL Window句生成 → Infrastructure層委譲
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. ModelBuilder機能拡張**
- `ModelBuilder`: 新しいFluent API機能、属性解析ロジック拡張
- `EntityModelBuilder`: 個別エンティティ設定オプション追加
- POCO属性の新機能サポート（`[KafkaIgnore]`, `[AvroTimestamp]`等）

**2. Window処理機能拡張**
- `WindowAggregatedEntitySet`: 新しい集約関数、ウィンドウ種別対応
- Window操作のKSQL生成ロジック改善
- ウィンドウ集約の式木解析強化

**3. EntityModel機能強化**
- Stream/Table型推論ロジック改善
- 複合キー処理の拡張
- バリデーション機能強化

### 🟡 中頻度変更パターン
**1. 拡張メソッド追加**
- `CoreExtensions`: EntityModel操作の便利メソッド
- `WindowExtensions`: ウィンドウ操作の新機能
- エラーハンドリング拡張の改善

**2. コンテキスト基底機能**
- `KafkaContextCore`: 基底機能の改善、パフォーマンス最適化
- リソース管理（IDisposable/IAsyncDisposable）の強化

**3. データモデル拡張**
- `KeyExtractor`: 新しいキー抽出パターン
- エンティティメタデータ管理の改善

### 🟢 低頻度変更パターン
**1. 抽象インターフェース変更**
- `IKafkaContext`, `IEntitySet<T>`: 新機能追加（破壊的変更は慎重）
- 基本属性定義の変更

**2. 例外体系の変更**
- 新しい例外種別追加
- エラー分類の見直し

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **Infrastructure層依存禁止**: Messaging, Serialization等への直接依存不可
- **純粋関数原則**: 副作用なし、テスタブルな設計必須
- **一方向依存**: Core ← Infrastructure の依存方向強制
- **型安全性強制**: 全てのAPIでジェネリクス型パラメータ必須

### パフォーマンス考慮事項
- **リフレクション最適化**: 属性読取り・型解析のキャッシュ化
- **EntityModel生成コスト**: 初期化時の属性解析オーバーヘッド
- **Window操作メモリ**: 集約処理時のメモリ使用量制御
- **式木解析コスト**: LINQ式の解析・変換パフォーマンス

### セキュリティ・品質制約
- **型安全性保証**: 実行時型エラーの防止
- **バリデーション強制**: EntityModelの整合性チェック
- **例外設計**: 適切な例外階層と情報提供
- **リソース管理**: 適切なDispose実装

---

## 🔗 他Namespaceとの連携

### Application連携
```csharp
// KafkaContextCoreの基底機能提供
public abstract class KafkaContextCore : IKafkaContext
{
    private readonly Dictionary<Type, EntityModel> _entityModels = new();
    
    // 派生クラスでの実装必須
    protected abstract IEntitySet<T> CreateEntitySet<T>(EntityModel entityModel) where T : class;
    
    // EntityModel管理
    public Dictionary<Type, EntityModel> GetEntityModels()
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.054676+00:00

# Messaging 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **型安全Producer/Consumer管理**：EntityModel基準の型安全なKafka通信
- **Pool削除による直接管理**：複雑性を排除し、Confluent.Kafka完全委譲
- **エラーハンドリング・リトライ機能**：堅牢な障害回復とDLQ送信
- **バッチ処理・ストリーミング対応**：単発送信から大量バッチ、リアルタイム購読まで

### 設計原則・制約
- **EF風API**: DbContextライクな開発体験の提供
- **事前確定管理**: 型・トピック情報の初期化時確定、ランタイム生成なし
- **Fail-Fast**: 初期化時エラーは即座に終了、実行時は適切な例外処理
- **非同期ファースト**: 全I/O操作の非同期化とCancellationToken対応

### 他namespaceとの境界
- **Core**: EntityModelとKafkaMessageContextを受け取り、型安全性を確保
- **Serialization**: シリアライゼーションマネージャーを活用、直接Avro操作なし
- **Configuration**: 設定値に基づくProducer/Consumer設定構築
- **StateStore**: エラー時のDLQ送信、直接的なStateStore操作なし

---

## 🏗️ 主要クラス構成

### 📁 Abstractions/ - インターフェース定義（🟢低変更頻度）
| ファイル | クラス/インターフェース | 責務 | 変更頻度 |
|---------|----------------------|------|----------|
| `IKafkaProducer.cs` | IKafkaProducer<T> | 型安全Producer操作の抽象化 | 🟢 |
| `IKafkaConsumer.cs` | IKafkaConsumer<TValue,TKey> | 型安全Consumer操作の抽象化 | 🟢 |

### 📁 Configuration/ - 設定管理（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `CommonSection.cs` | CommonSection | Kafka共通設定（Bootstrap、SSL等） | 🟡 |
| `ProducerSection.cs` | ProducerSection | Producer専用設定（Acks、圧縮等） | 🟡 |
| `ConsumerSection.cs` | ConsumerSection | Consumer専用設定（GroupId、Offset等） | 🟡 |
| `TopicSection.cs` | TopicSection | トピック別設定（パーティション、レプリケーション等） | 🟡 |
| `SchemaRegistrySection.cs` | SchemaRegistrySection | Schema Registry接続・認証設定 | 🟡 |

### 📁 Producers/ - Producer管理（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KafkaProducerManager.cs` | KafkaProducerManager | 型安全Producer生成・管理・キャッシュ | 🔴 |
| `Core/KafkaProducer.cs` | KafkaProducer<T> | 型安全メッセージ送信・バッチ処理 | 🔴 |
| `DlqProducer.cs` | DlqProducer | DLQ（Dead Letter Queue）送信処理 | 🟡 |
| `Core/PooledProducer.cs` | PooledProducer | Pool管理用Producer（旧実装の名残） | 🟢 |

### 📁 Consumers/ - Consumer管理（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KafkaConsumerManager.cs` | KafkaConsumerManager | 型安全Consumer生成・管理・キャッシュ | 🔴 |
| `Core/KafkaConsumer.cs` | KafkaConsumer<TValue,TKey> | 型安全メッセージ消費・ストリーミング | 🔴 |
| `Core/PooledConsumer.cs` | PooledConsumer | Pool管理用Consumer（旧実装の名残） | 🟢 |

### 📁 Models/ - データモデル（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `DlqEnvelope.cs` | DlqEnvelope | DLQ送信用メッセージ封筒 | 🟢 |

### 📁 Internal/ - 内部機能（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `ErrorHandlingContext.cs` | ErrorHandlingContext | エラー処理・リトライ制御 | 🟡 |

### 📁 Contracts/ - 契約インターフェース（🟢低変更頻度）
| ファイル | インターフェース | 責務 | 変更頻度 |
|---------|-----------------|------|----------|
| `IErrorSink.cs` | IErrorSink | エラーレコード処理の抽象化 | 🟢 |

---

## 🔄 データフロー・依存関係

### Producer側フロー
```
Entity → KafkaProducerManager.SendAsync()
   ↓
KafkaProducer<T>.SendAsync() → KeyExtractor.ExtractKeyValue()
   ↓
IAvroSerializationManager → Serialize
   ↓
Confluent.Kafka.IProducer → Kafka Cluster
   ↓
KafkaDeliveryResult
```

### Consumer側フロー
```
Kafka Cluster → Confluent.Kafka.IConsumer
   ↓
KafkaConsumer<TValue,TKey> → IAvroSerializationManager
   ↓
Deserialize → KafkaMessage<TValue,TKey>
   ↓
EventSet.ConsumeAsync() → Business Logic
```

### エラーハンドリングフロー
```
Exception → ErrorHandlingContext
   ↓
ErrorAction.DLQ → DlqProducer → DLQ Topic
ErrorAction.Retry → Exponential Backoff → Retry
ErrorAction.Skip → Log & Continue
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. Producer/Consumer機能拡張**
- `KafkaProducerManager`: 新しい送信パターン（バッチサイズ制御、条件付き送信等）
- `KafkaConsumer`: 新しい消費パターン（フィルタリング、変換処理等）
- シリアライゼーション形式の追加対応

**2. エラーハンドリング強化**
- 新しいErrorAction種別追加
- より精密なリトライポリシー
- DLQ送信条件の細分化

**3. 設定項目拡張**
- 新しいKafka設定プロパティ対応
- 動的設定変更機能
- 環境別設定プロファイル

### 🟡 中頻度変更パターン
**1. 新しいKafka機能対応**
- Confluent Kafkaクライアントアップデート対応
- 新しい圧縮アルゴリズム
- セキュリティ機能強化

**2. パフォーマンス最適化**
- バッチ処理サイズ調整
- コネクションプール最適化
- メモリ使用量削減

### 🟢 低頻度変更パターン
**1. インターフェース変更**
- IKafkaProducer/IKafkaConsumerのメソッド追加
- 破壊的変更（慎重に実施）

**2. アーキテクチャ変更**
- Pool戦略の見直し（現在は直接管理）
- 新しい通信プロトコル対応

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **Pool削除方針**: 複雑性削減のため、ProducerPool/ConsumerPoolは使用しない
- **事前確定主義**: EntityModel情報は初期化時に確定、動的生成禁止
- **Confluent.Kafka委譲**: 低レベルKafka操作はConfluent.Kafkaライブラリに完全委譲
- **型安全性強制**: Generic型パラメータによる型安全性の強制

### パフォーマンス
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.054739+00:00

# Query 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **LINQ式からKSQL文への変換**：C# LINQ式を解析してksqlDB互換のKSQL文を生成
- **クエリ実行パイプライン管理**：段階的なクエリ実行（派生オブジェクト作成→最終実行）
- **DDL/DML分離生成**：CREATE文（DDL）とSELECT文（DML）の適切な使い分け
- **Stream/Table型推論**：LINQ操作に基づく最適なksqlDBオブジェクト型の決定

### 設計原則・制約
- **型安全性確保**：LINQ式の型情報を保持してKSQL生成時のエラーを防止
- **表現力の限界**：OrderByなど未サポート操作は明示的な例外で即座に通知
- **パフォーマンス重視**：派生オブジェクト戦略により複雑なクエリを段階的に最適化
- **診断可能性**：生成されるKSQL文をToKsql()で事前確認可能

### 他namespaceとの境界
- **Core**: EntityModelを受け取り、型情報に基づく変換を実行
- **Messaging**: 実際のKafka通信は委譲、Query層は純粋に変換処理のみ
- **Serialization**: スキーマ情報の取得のみ、直接的なシリアライゼーション処理なし

---

## 🏗️ 主要クラス構成

### 📁 Pipeline/ - 実行制御コア（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `QueryExecutionPipeline.cs` | QueryExecutionPipeline | LINQ式解析→派生オブジェクト作成→クエリ実行の統括制御 | 🔴 |
| `DDLQueryGenerator.cs` | DDLQueryGenerator | CREATE STREAM/TABLE AS文の生成 | 🔴 |
| `DMLQueryGenerator.cs` | DMLQueryGenerator | SELECT文の生成 | 🟡 |
| `StreamTableAnalyzer.cs` | StreamTableAnalyzer | 操作チェーンからStream/Table型推論 | 🔴 |
| `DerivedObjectManager.cs` | DerivedObjectManager | 中間オブジェクト（stream_123等）の管理 | 🟡 |

### 📁 Builders/ - KSQL構文生成（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `SelectBuilder.cs` | SelectBuilder | WHERE句構築（条件式の変換） | 🔴 |
| `ProjectionBuilder.cs` | ProjectionBuilder | SELECT列の構築（射影・AS句含む） | 🔴 |
| `GroupByBuilder.cs` | GroupByBuilder | GROUP BY句構築 | 🟡 |
| `JoinBuilder.cs` | JoinBuilder | JOIN句構築（複数テーブル結合） | 🟡 |
| `HavingBuilder.cs` | HavingBuilder | HAVING句構築（集約後条件） | 🟢 |
| `WindowBuilder.cs` | WindowBuilder | WINDOW句構築（時間ウィンドウ） | 🟢 |

### 📁 Ksql/ - ksqlDB REST API通信（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KsqlDbRestApiClient.cs` | KsqlDbRestApiClient | ksqlDB REST API通信、ストリーミング対応 | 🟡 |
| `KsqlDbExecutor.cs` | KsqlDbExecutor | DDL/DMLクエリ実行の抽象化 | 🟡 |

### 📁 Linq/ - JOIN拡張（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `UnifiedJoinResult.cs` | UnifiedJoinResult<TOuter,TInner> | 2テーブルJOIN結果 | 🟢 |
| `UnifiedThreeWayJoinResult.cs` | UnifiedThreeWayJoinResult<TOuter,TInner,TThird> | 3テーブルJOIN結果 | 🟢 |
| `JoinableEntitySet.cs` | JoinableEntitySet<T> | JOIN可能なEntitySet | 🟢 |

---

## 🔄 データフロー・依存関係

### 主要処理フロー
```
LINQ式 → StreamTableAnalyzer → QueryExecutionPipeline
   ↓
ExpressionAnalysisResult → DerivedObjectManager
   ↓
必要に応じて派生オブジェクト作成（DDLQueryGenerator）
   ↓
最終SELECT実行（DMLQueryGenerator）
   ↓
ksqlDB REST API（KsqlDbRestApiClient）
```

### Builder使用パターン
```
Expression → 各Builder（WHERE/SELECT/GROUP BY等）→ KSQL文字列断片
                            ↓
                    DDL/DMLQueryGeneratorで組み立て
                            ↓
                      完全なKSQL文
```

### 型推論ロジック
```
MethodCall解析 → 集約有無判定 → Stream/Table決定
- Where/Select → Stream
- GroupBy → Table
- Select after GroupBy → Table
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. 新しいLINQ演算子対応**
- `StreamTableAnalyzer`に操作特性追加
- 対応する`Builder`クラス作成または拡張
- `QueryExecutionPipeline`での処理分岐追加

**2. KSQL構文の改善**
- `SelectBuilder`でのWHERE条件表現拡張（null比較、複合条件等）
- `ProjectionBuilder`でのSELECT列表現拡張
- 新しいKSQL関数の対応

**3. エラーハンドリング強化**
- 未サポート操作の早期検出
- より詳細なエラーメッセージ
- デバッグ情報の充実

### 🟡 中頻度変更パターン
**1. JOIN機能拡張**
- 新しいJOIN種別（LEFT/RIGHT/FULL OUTER）
- より複雑なJOIN条件
- サブクエリ含むJOIN

**2. ksqlDB APIアップデート対応**
- 新しいREST APIエンドポイント
- レスポンス形式の変更対応
- 認証・セキュリティ拡張

### 🟢 低頻度変更パターン
**1. ウィンドウ機能拡張**
- 新しいウィンドウタイプ
- Grace Period等のオプション拡張

**2. パフォーマンス最適化**
- クエリ実行プラン改善
- キャッシュ機能追加

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **OrderBy未サポート**：ksqlDBのストリーミング性質上、ORDER BYは原則サポート外
-
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.054814+00:00

# Serialization 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **Avroスキーマ生成・登録**: POCO型からAvroスキーマ自動生成とSchema Registry一括登録
- **型安全シリアライゼーション**: ジェネリクス活用による型安全なSerializer/Deserializer管理
- **キャッシュ・パフォーマンス最適化**: エンティティ別Serializerキャッシュとバージョン管理
- **スキーマバージョニング・互換性**: 後方互換性チェックとスキーマ進化対応

### 設計原則・制約
- **POCO属性駆動**: `[KafkaIgnore]`, `[AvroTimestamp]`, `[DecimalPrecision]`等の属性ベース設定
- **自動生成重視**: 手動スキーマ定義なし、型からの完全自動生成
- **型安全性確保**: `IAvroSerializationManager<T>`による型指定管理
- **キャッシュファースト**: 初回生成後のキャッシュ活用によるパフォーマンス最適化

### 他namespaceとの境界
- **Core**: EntityModelとAvroEntityConfigurationの変換・活用
- **Application**: スキーマ一括登録サービスの提供
- **Messaging**: Serializer/DeserializerペアのProducer/Consumer提供
- **Configuration**: Schema Registry接続設定の適用

---

## 🏗️ 主要クラス構成

### 📁 Abstractions/ - 抽象化定義（🟢低変更頻度）
| ファイル | クラス/インターフェース | 責務 | 変更頻度 |
|---------|----------------------|------|----------|
| `AvroEntityConfiguration.cs` | AvroEntityConfiguration | エンティティ設定情報、属性自動読取 | 🟢 |
| `AvroEntityConfigurationBuilder.cs` | AvroEntityConfigurationBuilder<T> | Fluent API設定ビルダー | 🟢 |
| `AvroEntityConfigurationExtensions.cs` | 拡張メソッド | 設定便利メソッド | 🟢 |
| `AvroSerializationManager.cs` | AvroSerializationManager<T> | 型安全シリアライゼーション管理 | 🟡 |
| `IAvroSerializationManager.cs` | IAvroSerializationManager<T> | シリアライゼーション抽象化 | 🟢 |
| `interfaces.cs` | SerializerPair, DeserializerPair等 | データ構造定義 | 🟢 |

### 📁 Avro/Core/ - Avro基盤（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `AvroSchemaInfo.cs` | AvroSchemaInfo | スキーマメタデータ管理 | 🟡 |
| `AvroSerializerFactory.cs` | AvroSerializerFactory | Serializer/Deserializer生成工場 | 🟡 |
| `UnifiedSchemaGenerator.cs` | UnifiedSchemaGenerator | 統合スキーマ生成エンジン | 🔴 |
| `AvroSerializer.cs` | AvroSerializer<T> | カスタムAvroシリアライザー | 🟢 |
| `AvroDeserializer.cs` | AvroDeserializer<T> | カスタムAvroデシリアライザー | 🟢 |
| `SchemaRegistryClientWrapper.cs` | SchemaRegistryClientWrapper | Schema Registry API ラッパー | 🟡 |

### 📁 Avro/Cache/ - キャッシュ機能（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `AvroSerializerCache.cs` | AvroSerializerCache | エンティティ別Serializerキャッシュ | 🔴 |
| `AvroSerializerCache.cs` | AvroEntitySerializationManager<T> | エンティティ専用シリアライゼーション管理 | 🔴 |

### 📁 Avro/Management/ - 管理機能（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `AvroSchemaRegistrationService.cs` | AvroSchemaRegistrationService | 全スキーマ一括登録サービス | 🔴 |
| `AvroSchemaBuilder.cs` | AvroSchemaBuilder | スキーマ生成プロバイダー | 🔴 |
| `AvroSchemaVersionManager.cs` | AvroSchemaVersionManager | スキーマバージョン・互換性管理 | 🟡 |
| `AvroSchemaRepository.cs` | AvroSchemaRepository | スキーマ情報リポジトリ | 🟡 |

### 📁 Avro/Exceptions/ - 例外処理（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `AvroSchemaRegistrationException.cs` | AvroSchemaRegistrationException | スキーマ登録例外 | 🟡 |
| `SchemaRegistrationFatalException.cs` | SchemaRegistrationFatalException | Fail-Fast致命的例外 | 🟡 |

### 📁 Avro/ - 統合機能（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `ResilientAvroSerializerManager.cs` | ResilientAvroSerializerManager | リトライ・障害回復機能 | 🔴 |

---

## 🔄 データフロー・依存関係

### スキーマ生成・登録フロー
```
POCO型定義 → AvroEntityConfiguration.AutoConfigureFromAttributes()
   ↓
UnifiedSchemaGenerator.GenerateTopicSchemas()
   ↓
AvroSchemaRegistrationService.RegisterAllSchemasAsync()
   ↓
SchemaRegistryClient.RegisterSchemaAsync() → Schema Registry
   ↓
AvroSchemaInfo保存・キャッシュ
```

### Serializer取得・キャッシュフロー
```
IAvroSerializationManager<T>.GetSerializersAsync()
   ↓
AvroSerializerCache.GetAvroManager<T>()
   ↓
Cache Hit ? キャッシュ返却 : 新規作成
   ↓
AvroSerializerFactory.CreateSerializersAsync()
   ↓
SerializerPair<T>返却 + キャッシュ保存
```

### 型安全シリアライゼーションフロー
```
Producer: Entity → IAvroSerializationManager<T> → SerializerPair → byte[]
Consumer: byte[] → IAvroSerializationManager<T> → DeserializerPair → Entity
```

### スキーマバージョン管理フロー
```
AvroSchemaVersionManager.CanUpgradeAsync()
   ↓
SchemaRegistry.IsCompatibleAsync() → 互換性チェック
   ↓
UpgradeAsync() → 新スキーマ登録
   ↓
キャッシュクリア・再構築
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. スキーマ生成エンジン拡張**
- `UnifiedSchemaGenerator`: 新しい型対応、属性サポート拡張
- 新しいAvro論理型（decimal、timestamp等）対応
- POCO属性（`[KafkaIgnore]`, `[DecimalPrecision]`等）の機能拡張

**2. キャッシュ・パフォーマンス最適化**
- `AvroSerializerCache`: キャッシュ戦略改善、メモリ効率化
- `AvroEntitySerializationManager`: 統計情報拡張、モニタリング強化
- Round-trip検証、パフォーマンス測定機能

**3. スキーマ登録・管理機能**
- `AvroSchemaRegistrationService`: 一括登録ロジック改善
- `AvroSchemaBuilder`: スキーマ生成オプション拡張
- Fail-Fast例外処理の精密化

### 🟡 中頻度変更パターン
**1. スキーマバージョニング強化**
- `AvroSchemaVersionManager`: より精密な互換性チェック
- スキーマ進化ルールの拡張
- バージョン履歴管理機能

**2. Schema Registry連携改善**
- `SchemaRegistryClientWrapper`: 新しいAPI対応
- 認証・セキュリティ機能強化
- エラーハンドリング改善

**3. 設定・構成管理**
- `AvroEntityConfiguration`: 新しい設定項目追加
- Builder APIの機能拡張

### 🟢 低頻度変更パターン
**1. 抽象化インターフェース変更**
- `IAvroSerializationManager`: 新機能追加（破壊的変更は慎重）
- データ構造（SerializerPair等）の拡張

**2. 新しいシリアライゼーション形式対応**
- Avro以外の形式（JSON、Protobuf等）への対応
- フォーマット選択機能

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **POCO属性主導**: 手動スキーマ定義禁止、属性ベース自動生成必須
- **型安全性強制**: 全てのAPIでジェネリクス型パラメータ必須
- **Schema Registry必須**: スキーマレス運用不可、Registry連携前提
- **Fail-Fast原則**: スキーマ登録失敗時の即座終了

### パフォーマンス考慮事項
- **キャッシュ依存**: 初回生成コストが高い、キャッシュ効果への依存度大
- **メモリ使用量**: エンティティ別キャッシュによるメモリ消費
- **スキーマ生成コスト**: リフレクション多用による初期化時間
- **Schema Registry通信**: ネットワーク遅延・タイムアウト対策

### セキュリティ・品質制約
- **スキーマ整合性**: POCOとAvroスキーマの不整合検出
- **認証情報保護**: Schema Registry認証情報の適切な管理
- **バージョン互換性**: 後方互換性違反の防止
- **リソースリーク防止**: IDisposableの適切な実装

---

## 🔗 他Namespaceとの連携

### Core依存関係
```csharp
// EntityModel → AvroEntityConfiguration 変換
public AvroEntityConfiguration(Type entityType)
{
    EntityType = entityType;
    AutoConfigureFromAttributes(); // [Topic], [Key]等の属性自動読取
}

private void AutoConfigureFromAttributes()
{
    var topicAttribute = EntityType.GetCustomAttribute<TopicAttribute
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.054879+00:00

# StateStore 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **ローカル状態管理**: RocksDBベースの高性能な永続化ストレージ
- **KafkaトピックとStateStoreの双方向同期**: KTable準拠の状態反映
- **ウィンドウ処理**: 時間ベースの状態集約とWindow EntitySet提供
- **Ready状態監視**: Consumer Lagに基づく同期完了判定とヘルスチェック

### 設計原則・制約
- **KTable互換性**: 最新状態のみ保持、Tombstone（削除）メッセージ対応
- **非同期リアルタイム同期**: トピック変更のストレージへの即座反映
- **障害復旧対応**: バインディング自動復旧、Lag監視による状態把握
- **Window操作最適化**: 時間ウィンドウでの効率的な集約処理

### 他namespaceとの境界
- **Core**: EntityModelによる型情報とキー抽出ロジック活用
- **Messaging**: ConsumerManagerからのストリーミングデータ取得
- **Configuration**: StateStore設定（RocksDB、Window等）の適用
- **Query**: Window操作時のDDL生成とksqlDB連携（間接的）

---

## 🏗️ 主要クラス構成

### 📁 Core/ - StateStore基盤（🟡中変更頻度）
| ファイル | クラス/インターフェース | 責務 | 変更頻度 |
|---------|----------------------|------|----------|
| `IStateStore.cs` | IStateStore<TKey,TValue> | StateStore操作の抽象化 | 🟢 |
| `RocksDbStateStore.cs` | RocksDbStateStore<TKey,TValue> | RocksDB実装、永続化・メモリキャッシュ | 🟡 |

### 📁 Management/ - ストア管理（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `StateStoreManager.cs` | StateStoreManager | ストア生成・ライフサイクル管理 | 🔴 |

### 📁 Integration/ - Kafka連携（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `TopicStateStoreBinding.cs` | TopicStateStoreBinding<T> | トピック↔ストア双方向バインディング | 🔴 |
| `StateStoreBindingManager.cs` | StateStoreBindingManager | 複数バインディングの統合管理 | 🔴 |
| `BindingHealthStatus.cs` | BindingHealthStatus | バインディング健全性情報 | 🟡 |

### 📁 Monitoring/ - Ready状態監視（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `ReadyStateMonitor.cs` | ReadyStateMonitor | Consumer Lag監視・Ready判定 | 🟡 |
| `ReadyStateInfo.cs` | ReadyStateInfo | 詳細同期状態情報 | 🟡 |
| `ReadyStateChangedEventArgs.cs` | ReadyStateChangedEventArgs | Ready状態変更イベント | 🟢 |
| `LagUpdatedEventArgs.cs` | LagUpdatedEventArgs | Lag更新イベント | 🟢 |

### 📁 Extensions/ - Window拡張（🟡中変更頻度）
| ファイル | クラス/インターフェース | 責務 | 変更頻度 |
|---------|----------------------|------|----------|
| `IWindowedEntitySet.cs` | IWindowedEntitySet<T> | ウィンドウ付きEntitySet抽象化 | 🟢 |
| `WindowedEntitySet.cs` | WindowedEntitySet<T> | ウィンドウ操作の具体実装 | 🟡 |
| `WindowExtensions.cs` | WindowExtensions | `.Window(minutes)`拡張メソッド | 🟡 |
| `KafkaContextStateStoreExtensions.cs` | StateStore初期化拡張 | Context初期化時のストア準備 | 🟡 |

### 📁 Configuration/ - 設定管理（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `StateStoreOptions.cs` | StateStoreOptions | ストア設定オプション | 🟢 |
| `StateStoreConfiguration.cs` | StateStoreConfiguration | 設定変換・適用 | 🟢 |

### 📁 ルート/ - エンティティ拡張（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `EventSetWithStateStore.cs` | EventSetWithStateStore<T> | StateStore統合EntitySet | 🟡 |

---

## 🔄 データフロー・依存関係

### StateStore初期化フロー
```
KafkaContext.OnModelCreating()
   ↓
StateStoreExtensions.InitializeStateStores()
   ↓
StateStoreManager.InitializeStoresForEntity()
   ↓
RocksDbStateStore<TKey,TValue> 生成・キャッシュ
```

### トピック同期フロー
```
Kafka Topic → KafkaConsumer → TopicStateStoreBinding
   ↓
CreateKafkaMessage() → ExtractKey()
   ↓
StateStore.Put(key, value) or Delete(key)  ※Tombstone対応
   ↓
定期的な Flush() → RocksDB永続化
```

### Ready状態監視フロー
```
ReadyStateMonitor.CheckLag() (5秒間隔)
   ↓
Consumer.QueryWatermarkOffsets() → エンドオフセット取得
Consumer.Position() → 現在位置取得
   ↓
TotalLag = EndOffset - CurrentOffset
   ↓
Lag == 0 → Ready状態達成 → イベント発火
```

### Window操作フロー
```
EntitySet.Window(5) → WindowedEntitySet<T>
   ↓
StateStoreManager.GetOrCreateStore(entityType, windowMinutes)
   ↓
StateStore操作 + 元EntitySetへの委譲
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. バインディング機能強化**
- `TopicStateStoreBinding`: 新しい同期パターン、エラー回復ロジック改善
- `StateStoreBindingManager`: 複数ストア管理、ヘルスチェック精度向上
- 同期パフォーマンス最適化（バッチ処理、並列化等）

**2. ストア管理機能拡張**
- `StateStoreManager`: 新しいストア種別対応、動的設定変更
- 異なるウィンドウサイズの効率的管理
- メモリ使用量監視・制御

**3. Window操作改善**
- より複雑なウィンドウ条件（Sliding、Session等）
- ウィンドウ間でのデータ移行・マージ処理
- 集約関数の拡張

### 🟡 中頻度変更パターン
**1. Ready状態監視精度向上**
- `ReadyStateMonitor`: より細かいLag監視、予測アルゴリズム
- パーティション別状態の詳細管理
- タイムアウト・リトライロジック改善

**2. RocksDB最適化**
- `RocksDbStateStore`: 新しい永続化オプション、圧縮設定
- インデックス戦略の改善
- バックアップ・リストア機能

**3. 設定機能拡張**
- 環境別StateStore設定
- 動的設定変更対応

### 🟢 低頻度変更パターン
**1. インターフェース変更**
- `IStateStore`の新機能追加
- 破壊的変更（慎重に実施）

**2. 新ストレージバックエンド対応**
- RocksDB以外のストレージエンジン
- クラウドストレージ連携

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **KTable互換性**: 最新状態のみ保持、同一キーの古い値は上書き
- **Tombstone対応**: null値メッセージでの削除処理必須
- **非同期リアルタイム**: UI/APIブロッキングなしの状態同期
- **At-least-once保証**: Kafka Consumerの冪等性への依存

### パフォーマンス考慮事項
- **メモリ vs 永続化バランス**: ConcurrentDictionaryとRocksDBの使い分け
- **バッチフラッシュ**: 定期的フラッシュによるI/O最適化
- **Ready状態判定コスト**: 5秒間隔のLag監視によるオーバーヘッド
- **大量データ処理**: Window集約時のメモリ使用量制御

### セキュリティ
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.054947+00:00

# Window 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **ウィンドウ確定処理**: Grace Period経過後のウィンドウ確定足生成
- **確定足生成・配信**: 集約結果の`{topic}_window_final`トピック送信
- **RocksDB永続化**: 確定足データの永続化とWindow履歴管理
- **重複排除・POD協調**: 複数POD環境での確定足重複排除機能

### 設計原則・制約
- **Grace Period遵守**: ウィンドウ終了 + Grace Period後の確定処理
- **確定足の冪等性**: 同一ウィンドウキーの重複送信対策
- **POD分散協調**: 複数インスタンス環境での安全な確定処理
- **永続化ファースト**: RocksDBによる確定足履歴の確実な保存

### 他namespaceとの境界
- **Core**: WindowedEntitySet等のWindow操作基盤を活用
- **StateStore**: RocksDB連携による確定足永続化
- **Messaging**: 確定足トピック送信用のKafkaProducer使用
- **Application**: WindowFinalizationManagerの初期化・設定

---

## 🏗️ 主要クラス構成

### 📁 Finalization/ - 確定処理コア（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `WindowFinalizationManager.cs` | WindowFinalizationManager | ウィンドウ確定処理スケジューリング | 🔴 |
| `WindowProcessor.cs` | WindowProcessor<T> | エンティティ別ウィンドウ処理 | 🔴 |
| `WindowProcessor.cs` | WindowProcessor (基底) | 抽象ウィンドウ処理 | 🟡 |

### 📁 Finalization/Consumer/ - 確定足消費（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `WindowFinalConsumer.cs` | WindowFinalConsumer | 確定足消費・RocksDB保存 | 🟡 |

### 📁 Finalization/Models/ - データモデル（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `WindowFinalMessage.cs` | WindowFinalMessage | 確定足メッセージ構造 | 🟢 |
| `WindowState.cs` | WindowState<T> | ウィンドウ状態管理 | 🟢 |
| `WindowConfiguration.cs` | WindowConfiguration<T> | ウィンドウ設定情報 | 🟢 |

### 📁 Finalization/Options/ - 設定管理（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `WindowFinalizationOptions.cs` | WindowFinalizationOptions | 確定処理設定オプション | 🟢 |

### 📁 Finalization/Abstractions/ - 抽象化（🟢低変更頻度）
| ファイル | インターフェース | 責務 | 変更頻度 |
|---------|-----------------|------|----------|
| `IKafkaProducer.cs` | IKafkaProducer | Kafka送信抽象化 | 🟢 |

---

## 🔄 データフロー・依存関係

### ウィンドウ確定処理フロー
```
イベント受信 → WindowProcessor<T>.AddToWindow()
   ↓
複数ウィンドウサイズでWindowState<T>管理
   ↓
定期確定チェック → ShouldFinalizeWindow(Grace Period判定)
   ↓
FinalizeWindow() → 集約処理実行
   ↓
WindowFinalMessage生成 → {topic}_window_final送信
   ↓
RocksDB永続化 → 確定足履歴保存
```

### 確定足消費・永続化フロー
```
{topic}_window_final → WindowFinalConsumer.SubscribeToFinalizedWindows()
   ↓
HandleFinalizedWindowWithRocksDB() → 重複排除チェック
   ↓
初回確定足のみ処理 → RocksDB.Put(windowKey, finalMessage)
   ↓
外部ハンドラー実行 → ビジネスロジック処理
```

### POD協調・重複排除フロー
```
複数POD → 同一ウィンドウ確定
   ↓
各PODから{topic}_window_final送信（同一キー）
   ↓
WindowFinalConsumer → 初回到着のみ処理
   ↓
後続の重複メッセージは無視・ログ出力
```

### 履歴検索・参照フロー
```
GetFinalizedWindow(windowKey)
   ↓
メモリキャッシュ確認 → Hit時は即返却
   ↓
RocksDB.Get(windowKey) → 永続化データ取得
   ↓
結果をメモリキャッシュにも保存
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. 確定処理ロジック改善**
- `WindowFinalizationManager`: スケジューリング間隔調整、並列処理最適化
- `WindowProcessor<T>`: 新しい集約関数対応、Grace Period計算改善
- 確定判定ロジック（`ShouldFinalizeWindow`）の精密化

**2. パフォーマンス最適化**
- バッチ確定処理の実装
- メモリ使用量最適化（古いWindowState清掃）
- RocksDB書き込み最適化

**3. エラーハンドリング強化**
- 確定処理失敗時のリトライ機能
- 部分失敗時の復旧処理
- POD間協調での異常ケース対応

### 🟡 中頻度変更パターン
**1. 確定足消費機能拡張**
- `WindowFinalConsumer`: 新しい検索パターン、フィルタリング機能
- 履歴管理機能（保持期間、圧縮等）
- 統計・モニタリング機能

**2. 設定・構成管理**
- WindowConfigurationの新オプション
- 動的設定変更対応
- 環境別設定プロファイル

**3. RocksDB連携改善**
- バックアップ・リストア機能
- 圧縮・最適化設定
- パーティション対応

### 🟢 低頻度変更パターン
**1. データモデル変更**
- `WindowFinalMessage`: 新フィールド追加（慎重に実施）
- `WindowState<T>`: 状態管理の拡張

**2. インターフェース変更**
- `IKafkaProducer`: 新機能追加（破壊的変更は慎重）

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **Grace Period遵守**: ウィンドウ終了後の待機時間必須
- **確定足の冪等性**: 同一キーの重複送信防止必須
- **POD分散対応**: 複数インスタンス環境での安全性確保
- **永続化保証**: RocksDBによる確定足履歴の確実な保存

### パフォーマンス考慮事項
- **メモリ管理**: WindowStateの適切なライフサイクル管理
- **RocksDB I/O**: 書き込み頻度とフラッシュタイミング最適化
- **タイマー間隔**: 確定処理間隔と精度のバランス
- **POD間通信**: Kafkaトピック経由の効率的な協調

### セキュリティ・品質制約
- **データ整合性**: 確定足の正確性と完全性保証
- **重複排除**: 完全な冪等性確保
- **障害回復**: POD障害時の確定処理継続性
- **リソースリーク防止**: Timer、RocksDB等の適切な解放

---

## 🔗 他Namespaceとの連携

### Core連携
```csharp
// WindowedEntitySetとの統合
public void AddToWindow(T entity, DateTime eventTime)
{
    foreach (var windowMinutes in _config.Windows)
    {
        var windowKey = GenerateWindowKey(entity, eventTime, windowMinutes);
        var windowState = _windowStates.GetOrAdd(windowKey, _ => new WindowState<T>
        {
            WindowStart = windowStart,
            WindowEnd = windowEnd,
            WindowMinutes = windowMinutes,
            Events = new List<T>(),
            IsFinalized = false
        });
        
        lock (windowState.Lock)
        {
            if (!windowState.IsFinalized)
            {
                windowState.Events.Add(entity);
                windowState.LastUpdated = DateTime.UtcNow;
            }
        }
    }
}
```

### StateStore連携
```csharp
// RocksDB永続化
public WindowFinalConsumer(
    RocksDbStateStore<string, WindowFinalMessage> rocksDbStore,
    ILoggerFactory? loggerFactory = null)
{
    _rocksDbStore = rocksDbStore;
}

private async Task HandleFinalizedWindowWithRocksDB(WindowFinalMessage message,
    Func<WindowFinalMessage, Task> messageHandler)
{
    // 重複チェック：同一キーの場合は最初に到着したものを採用
    if (_finalizedWindows.TryAdd(message.WindowKey, message))
    {
        // RocksDBに保存
        _rocksDbStore.Put(message.WindowKey, message);
        
        // 外部ハンドラー実行
        await messageHandler(message);
    }
}
```

### Messaging連携
```csharp
// 確定足トピック送信
private async Task SendToFinalTopic(string windowKey, object finalizedData, WindowState<T> windowState)
{
    var finalTopicMessage = new WindowFinalMessage
    {
        WindowKey = windowKey,
        WindowStart = windowState.WindowStart,
        WindowEnd = windowState.WindowEnd,
        WindowMinutes = windowState.WindowMinutes,
        EventCount = windowState.Events.Count,
        AggregatedData = finalizedData,
        FinalizedAt = DateTime.UtcNow,
        PodId = Environment.MachineName // POD識別用
    };

    // KafkaProducerを使用して送信
    await _config.FinalTopicProducer.SendAsync(
        topic: $"{_config.TopicName}_window_final",
        key: windowKey,
        value: finalTopicMessage);
}
``
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.055027+00:00

# Application 詳細設計

## 🎯 責務・設計方針

### 主要責務
- **開発者向けAPI提供**：EF風の直感的なKafkaContext APIとFluent Builder設計
- **設定管理・バリデーション**：Schema Registry接続、ログ設定、初期化オプションの統合管理
- **スキーマ自動登録**：起動時のAvroスキーマ一括登録とFail-Fast設計
- **Producer/Consumer統合**：Pool削除による直接管理とシンプル化設計

### 設計原則・制約
- **EF風API**: DbContextライクな開発体験、親しみやすいインターフェース
- **Fail-Fast**: 初期化時エラーは即座に終了、実行時は適切な例外処理
- **自動化優先**: OnModelCreating → スキーマ登録 → 接続確認の自動フロー
- **Pool削除方針**: 複雑性削減のため、直接Manager使用でシンプル化

### 他namespaceとの境界
- **Core**: EntityModelとKafkaContextCoreを活用、型安全性を確保
- **Messaging**: ProducerManager/ConsumerManagerの直接管理
- **Serialization**: スキーマ登録サービスとの連携、Avro操作委譲
- **Query**: （直接連携なし、Core経由でEntitySet提供）

---

## 🏗️ 主要クラス構成

### 📁 Extensions/ - 拡張メソッド（🟢低変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `AvroSchemaInfoExtensions.cs` | AvroSchemaInfoExtensions | スキーマSubject名生成、型推論ヘルパー | 🟢 |

### 📁 Context/ - コンテキスト実装（🔴高変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KsqlContext.cs` | KafkaContext | 簡素化統合KafkaContext、Pool削除版 | 🔴 |
| `KsqlContext.cs` | EventSetWithSimplifiedServices<T> | 簡素化Manager統合EventSet | 🔴 |

### 📁 Builder/ - Fluent API（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KsqlContextBuilder.cs` | KsqlContextBuilder | Fluent API設定、コンテキスト構築 | 🟡 |

### 📁 Options/ - 設定管理（🟡中変更頻度）
| ファイル | クラス | 責務 | 変更頻度 |
|---------|--------|------|----------|
| `KsqlContextOptions.cs` | KsqlContextOptions | 設定値管理、バリデーション | 🟡 |
| `KsqlContextOptionsExtensions.cs` | KsqlContextOptionsExtensions | 設定拡張メソッド | 🟡 |

---

## 🔄 データフロー・依存関係

### Context初期化フロー
```
KsqlContextBuilder.Create()
   ↓
UseSchemaRegistry() → KsqlContextOptions設定
   ↓
BuildContext<T>() → KafkaContext実装クラス生成
   ↓
OnModelCreating() → Core.ModelBuilder実行
   ↓
ConvertToAvroConfigurations() → AvroEntityConfiguration変換
   ↓
AvroSchemaRegistrationService → スキーマ一括登録（Fail-Fast）
```

### EntitySet操作フロー
```
context.Orders.AddAsync()
   ↓
EventSetWithSimplifiedServices<T>.SendEntityAsync()
   ↓
KafkaProducerManager.SendAsync() → Messaging層委譲
   ↓
ProducerManager → SerializationManager → Kafka送信
```

### 設定適用フロー
```
KsqlContextOptions
   ↓
SchemaRegistryClient → ISchemaRegistryClient設定
LoggerFactory → ILoggerFactory設定
Validation設定 → AutoRegister/FailOnErrors等
   ↓
BuildContext時に各Manager初期化で使用
```

---

## 🚀 変更頻度・作業パターン

### 🔴 高頻度変更パターン
**1. Context機能拡張**
- `KafkaContext`: 新しいEntitySet操作、Manager統合方式変更
- `EventSetWithSimplifiedServices`: Producer/Consumer操作の拡張
- Core層との連携パターン改善

**2. 初期化・設定機能強化**
- OnModelCreating時の自動スキーマ登録ロジック改善
- ConvertToAvroConfigurations変換ロジック拡張
- Fail-Fast例外処理の精密化

**3. Pool削除対応の継続改善**
- Manager直接使用パターンの最適化
- リソース管理方式の改善
- エラーハンドリング強化

### 🟡 中頻度変更パターン
**1. Builder API拡張**
- `KsqlContextBuilder`: 新しい設定オプション対応
- Fluent API種別の追加
- 設定バリデーション強化

**2. Options機能拡張**
- `KsqlContextOptions`: 新しい設定項目追加
- Schema Registry以外の外部サービス設定
- 環境別設定プロファイル

**3. 設定拡張メソッド**
- `KsqlContextOptionsExtensions`: 便利メソッド追加
- 設定パターンの標準化

### 🟢 低頻度変更パターン
**1. Extensions拡張**
- `AvroSchemaInfoExtensions`: 新しいスキーマ操作
- Subject命名規則変更（慎重に実施）

**2. アーキテクチャ変更**
- Pool戦略の見直し（現在は直接管理）
- Context初期化フローの根本的変更

---

## 📝 設計制約・注意事項

### アーキテクチャ制約
- **Pool削除方針**: ProducerPool/ConsumerPoolは使用しない、Manager直接管理
- **Fail-Fast原則**: スキーマ登録失敗時は即座にアプリケーション終了
- **EF風API維持**: DbContextライクなインターフェース設計の堅持
- **自動化優先**: OnModelCreating完了後の自動スキーマ登録強制

### パフォーマンス考慮事項
- **初期化時間**: スキーマ一括登録によるスタートアップ時間への影響
- **Manager直接管理**: Pool削除によるシンプル化とリソース効率化
- **設定バリデーション**: 起動時の設定検証コスト
- **リソースリーク防止**: IDisposableの適切な実装

### セキュリティ・品質制約
- **Schema Registry認証**: SSL/SASL設定の適切な管理
- **設定検証**: 不正設定の早期検出
- **例外透過性**: Core/Infrastructure例外の適切な伝播
- **ログ出力**: 初期化・設定関連の詳細ログ

---

## 🔗 他Namespaceとの連携

### Core依存関係
```csharp
// EntityModel: POCO→Avro設定変換
protected IReadOnlyDictionary<Type, AvroEntityConfiguration> ConvertToAvroConfigurations(
    Dictionary<Type, EntityModel> entityModels)
{
    foreach (var kvp in entityModels)
    {
        var entityModel = kvp.Value;
        var avroConfig = new AvroEntityConfiguration(entityModel.EntityType)
        {
            TopicName = entityModel.TopicAttribute?.TopicName,
            KeyProperties = entityModel.KeyProperties
        };
        avroConfigs[kvp.Key] = avroConfig;
    }
}
```

### Messaging連携
```csharp
// 簡素化Manager（Pool削除版）
public KafkaContext()
{
    _producerManager = new KafkaProducerManager(
        Microsoft.Extensions.Options.Options.Create(new KsqlDslOptions()),
        null   // LoggerFactory
    );

    _consumerManager = new KafkaConsumerManager(
        Microsoft.Extensions.Options.Options.Create(new KsqlDslOptions()),
        null   // LoggerFactory
    );
}

// EventSet送信処理
protected override async Task SendEntityAsync(T entity, Cancellation
The file is too long and its contents have been truncated.

### tool — 2025-06-25T23:25:03.055073+00:00

Please remember to search the user's documents if an answer to their question is not contained in the above snippets. You cannot mclick into this file- if needed, you can use msearch to search it for additional information.
