---
conversation_id: "66f76ad7-e184-8007-942b-6b05412d69ef"
title: "Entra ID WebAPI負荷試験"
create_time: 1727490776.103375
update_time: 1727491174.538721
language_guess: "en"
num_messages: 19
part_index: 1
part_count: 1
---

### system — 2024-09-28T02:32:56.103375+00:00

_(empty)_

### user — 2024-09-28T02:32:56.111510+00:00

以下の条件を考慮した事前設定と操作について記載
・entra idを利用したwebapiの負荷試験をおこなう
・同時実行数は20とする
・同時実行に利用するユーザーは別々のものを利用する

### assistant — 2024-09-28T02:33:19.409340+00:00

_(empty)_

### assistant — 2024-09-28T02:33:19.409540+00:00

Entra IDを利用したWebAPIの負荷試験を行うための事前設定と操作について、以下の条件を考慮して記載します。

### 条件
- **負荷試験対象のWebAPI**：Entra IDを利用したWebAPI
- **同時実行数**：20ユーザー
- **ユーザー**：同時実行で使用するユーザーは異なるユーザーを利用

### 事前設定

1. **ユーザー設定（Entra ID）**
   - 負荷試験用に少なくとも20ユーザーのアカウントをEntra IDに登録します。これらのユーザーは、各リクエストで異なる認証トークンを利用します。
   - 各ユーザーに適切なロールや権限を付与し、WebAPIにアクセスできるようにします。

2. **認証トークンの取得**
   - それぞれのユーザーに対して、OAuth 2.0を使用してアクセストークンを取得します。これには、各ユーザーごとに`client_id`、`client_secret`、およびユーザーの資格情報を使ってトークンエンドポイントにリクエストを送る必要があります。
   - トークン取得に成功したら、アクセストークンを保存しておきます（JMeterのスクリプト内で利用）。

3. **JMeterスクリプトの設定**
   - **Thread Groupの設定**：スレッド数を20に設定し、各スレッドが異なるユーザーで実行されるようにします。これにより、同時に20ユーザーがAPIを呼び出す負荷試験が実行されます。
   - **HTTPリクエストの設定**：各リクエストには、アクセストークンをAuthorizationヘッダーに`Bearer`トークンとして設定します。JMeterで動的にユーザーを切り替えるには、各スレッドごとに異なるトークンを設定する必要があります。

    ```yaml
    Authorization: Bearer ${TOKEN}
    ```

   - **CSV Data Set Config**：20ユーザー分のアクセストークンを含むCSVファイルを用意し、各スレッドごとにこのファイルから適切なトークンを読み取るように設定します。例えば、CSVファイルは次のようになります：

    ```csv
    user1_token
    user2_token
    user3_token
    ...
    ```

4. **負荷試験環境の準備**
   - 負荷試験を実施するためのサーバーを十分にスケールさせ、試験中にリソース不足にならないようにします。必要であれば、Kubernetesなどを利用してPodを水平スケールさせます。
   - ログの収集やメトリクスの監視ができるよう、DatadogやAzure Monitorなどのモニタリングツールを設定しておきます。

### 操作手順

1. **JMeterのセットアップ**
   - JMeterを起動し、事前に作成したJMeterスクリプトをロードします。
   - `Thread Group`の設定が20スレッドであること、`CSV Data Set Config`が正しく設定されていることを確認します。

2. **負荷試験の実行**
   - スクリプトを実行します。同時に20ユーザーがWebAPIにアクセスし、負荷をかけます。
   - リクエストごとに異なるアクセストークンが適用されているか、レスポンスステータスやエラーログを確認します。

3. **結果の分析**
   - JMeterのレポートを分析し、レスポンスタイムや成功率、エラー率などを確認します。
   - モニタリングツールでCPU使用率、メモリ消費量、スケール動作などのリソース消費も確認します。

### 補足
- **スレッドごとのアクセストークン管理**：20ユーザーのアクセストークンが動的に切り替わることが重要です。そのため、`CSV Data Set Config`を使用して各スレッドで異なるアクセストークンを使用する設計にします。
- **監視と調整**：負荷試験中にWebAPIがどのように応答しているかをリアルタイムで監視し、必要に応じてリソースを調整します。

この手順を実施することで、Entra IDを利用したWebAPIの同時実行20ユーザーによる負荷試験を行うことができます。

### user — 2024-09-28T02:33:57.346073+00:00

認証トークンはjmeterスクリプトで取得する

### assistant — 2024-09-28T02:34:12.047412+00:00

The user prefers to obtain authentication tokens directly within the JMeter script for their load testing.

### tool — 2024-09-28T02:34:12.047553+00:00

Model set context updated.

### assistant — 2024-09-28T02:34:12.047632+00:00

JMeterスクリプト内で認証トークンを動的に取得する方法について説明します。

### 事前準備

1. **クライアント設定**
   - 負荷試験に利用するクライアントID、クライアントシークレット、テナントID、および認証エンドポイントを確認します。
   - 各ユーザーの資格情報（ユーザー名とパスワード）を取得します。

### JMeterスクリプトの構成

1. **Thread Groupの設定**
   - まず、各スレッドでユーザーごとにトークンを取得できるよう、Thread Groupを設定します。スレッド数は同時実行するユーザー数（20）に設定します。

2. **HTTP Request Sampler - トークン取得**
   - 認証トークンを取得するために、OAuth 2.0認証エンドポイントにリクエストを送信するHTTP Request Samplerを追加します。
   - トークン取得用のHTTP Requestを以下のように設定します。

   **リクエストURL**:
   ```
   https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token
   ```
   **HTTPメソッド**:
   ```
   POST
   ```

   **パラメータ**:
   - `client_id`: クライアントID
   - `client_secret`: クライアントシークレット
   - `grant_type`: password
   - `username`: ${USERNAME} （CSVファイルやユーザー定義変数で設定）
   - `password`: ${PASSWORD} （CSVファイルやユーザー定義変数で設定）
   - `scope`: api://{application_id}/.default

3. **CSV Data Set Config**
   - `CSV Data Set Config`を使用して、ユーザーごとの資格情報（ユーザー名とパスワード）を読み込みます。これにより、各スレッドが異なるユーザーの資格情報を使用してトークンを取得できます。
   - CSVファイルの例:
     ```csv
     user1,password1
     user2,password2
     ...
     ```

4. **JSON Extractor**
   - トークン取得リクエストのレスポンスからアクセストークンを抽出するために、`JSON Extractor`を追加します。
   - パス：`$.access_token`を指定し、変数名を`ACCESS_TOKEN`にします。

5. **HTTP Request Sampler - WebAPI呼び出し**
   - 認証が成功し、トークンが取得された後、そのトークンを利用してAPIリクエストを行います。
   - 新しいHTTP Request Samplerを作成し、Authorizationヘッダーに`Bearer ${ACCESS_TOKEN}`を設定します。

6. **HTTP Header Manager**
   - APIリクエストのためにHTTP Header Managerを追加し、以下のように設定します。
     - `Authorization`: `Bearer ${ACCESS_TOKEN}`
     - `Content-Type`: `application/json`

### サンプルJMeterスクリプト

```yaml
Thread Group:
  Number of Threads: 20
  Ramp-Up Period: 1
  Loop Count: 1

  CSV Data Set Config:
    Filename: users.csv
    Variables: USERNAME, PASSWORD

  HTTP Request Sampler - Token Request:
    URL: https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token
    Method: POST
    Body Data:
      client_id=your_client_id&
      client_secret=your_client_secret&
      grant_type=password&
      username=${USERNAME}&
      password=${PASSWORD}&
      scope=api://{application_id}/.default

  JSON Extractor:
    Name of created variables: ACCESS_TOKEN
    JSON Path Expression: $.access_token

  HTTP Request Sampler - API Request:
    URL: https://yourapiurl.com/endpoint
    Method: GET
    HTTP Header Manager:
      Authorization: Bearer ${ACCESS_TOKEN}
      Content-Type: application/json
```

### 実行手順

1. **CSVファイルの準備**
   - `users.csv`ファイルを用意し、20ユーザーの資格情報を記載します。

2. **スクリプトの実行**
   - JMeterスクリプトを実行すると、各スレッドがユーザーごとにトークンを取得し、そのトークンを使ってAPIリクエストを送信します。

3. **結果の確認**
   - 負荷試験が完了した後、レスポンスステータスやパフォーマンスデータを確認します。

この構成により、JMeter内で自動的に認証トークンを取得し、同時に20ユーザーによるWebAPIへの負荷試験を行うことができます。

### user — 2024-09-28T02:35:05.021588+00:00

client_id: クライアントID
client_secret: クライアントシークレット
はjmeter用に作成したものを利用する。アプリケーションが利用するものとは異なるものとする

### assistant — 2024-09-28T02:35:14.104198+00:00

The user will use a separate `client_id` and `client_secret` created specifically for JMeter testing. These credentials will be different from those used by the application.

### tool — 2024-09-28T02:35:14.104281+00:00

Model set context updated.

### assistant — 2024-09-28T02:35:14.104338+00:00

JMeterでの負荷試験に使用する`client_id`と`client_secret`は、アプリケーションが利用するものとは異なる専用のものを作成するとのことですね。これに基づいて、以下のように負荷試験用のJMeter設定を行います。

### 1. **Azure ADでJMeter専用のアプリケーション登録**
   - **Azure AD**にアクセスし、JMeter専用のクライアント（アプリケーション登録）を行います。
   - アプリケーション登録後、**クライアントID**と**クライアントシークレット**を生成します。この値をJMeterで使用します。
   - **APIアクセス許可**で、必要なスコープや権限（たとえば、WebAPIへのアクセス権限）を付与します。

### 2. **JMeterスクリプトの設定**
   - 生成した専用の`client_id`と`client_secret`をJMeterスクリプトに設定します。これにより、負荷試験用のクライアントとして正しくトークンが取得され、負荷試験が実施されます。

   ```yaml
   client_id=your_jmeter_client_id&
   client_secret=your_jmeter_client_secret&
   ```

### 注意点
- **分離された権限**: JMeter用のアプリケーション登録には、必要最小限の権限だけを付与することが重要です。これにより、アプリケーション本体と負荷試験の設定が独立して管理できます。
- **モニタリング**: 負荷試験中に発生する問題やトークンの取得エラーが適切にログに記録されるよう、JMeterのログ設定を確認しておくこともおすすめします。

この設定により、負荷試験がアプリケーション本体の設定に影響を与えることなく、分離された環境で実施できます。

### user — 2024-09-28T02:35:26.607895+00:00

これらをまとめてblog化

### assistant — 2024-09-28T02:35:46.173264+00:00

ブログ記事にまとめた形で、JMeterを使ったEntra ID認証付きWebAPIの負荷試験の方法について以下の内容を記載します。

---

# Entra IDを利用したWebAPIの負荷試験をJMeterで行う方法

今回は、Azure Entra IDを使った認証を必要とするWebAPIに対して、JMeterを使用して負荷試験を行う方法をご紹介します。JMeterを用いて、特定のクライアント専用の認証トークンを自動的に取得し、異なるユーザーごとに同時実行でAPIリクエストを行うシナリオを構築します。

## 1. 準備

### 1.1 Azure ADでの事前設定
まず、Azure ADで負荷試験専用のアプリケーション登録を行います。これにより、実際のアプリケーションが使用するものとは異なるクライアントIDとクライアントシークレットを生成します。これは負荷試験用に分離されており、本番環境への影響を最小限に抑えるために重要な手順です。

#### 手順
1. **Azureポータル**にアクセスし、**Azure Active Directory** > **アプリの登録**を選択。
2. 負荷試験専用の新しいアプリケーションを登録し、**クライアントID**と**クライアントシークレット**を生成します。
3. **APIアクセス権限**を追加し、WebAPIにアクセスできるよう必要なスコープを付与します。たとえば、`api://{your_api_id}/.default` というスコープです。

このアプリケーションを負荷試験専用として設定することで、本番環境で使うものとは異なるクライアント情報が生成されます。

## 2. JMeterスクリプトの設定

JMeterでは、HTTPリクエストを通じてEntra ID認証トークンを自動的に取得し、そのトークンを使用してWebAPIへの負荷をかけます。今回は、20ユーザーを同時実行し、各ユーザーが異なるトークンを使用してAPIリクエストを行います。

### 2.1 CSV Data Set Configの設定
JMeter内で、複数のユーザー資格情報を利用するため、`CSV Data Set Config`を使用します。これにより、20ユーザー分の資格情報をCSVファイルから読み込みます。

**CSVファイルのフォーマット例**：
```csv
[[REDACTED_EMAIL]],password1
[[REDACTED_EMAIL]],password2
[[REDACTED_EMAIL]],password3
...
```

このファイルをJMeterに読み込ませ、各スレッドが異なるユーザー資格情報を利用します。

### 2.2 トークン取得リクエストの設定
各ユーザーがAPIにアクセスするために、認証トークンを取得する必要があります。OAuth 2.0の`password`フローを利用して、ユーザー資格情報を使いトークンを取得します。

**HTTP Request Samplerの設定**：
- **URL**：`https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token`
- **メソッド**：`POST`
- **Body Data**：
    ```yaml
    client_id=your_jmeter_client_id&
    client_secret=your_jmeter_client_secret&
    grant_type=password&
    username=${USERNAME}&
    password=${PASSWORD}&
    scope=api://{your_api_id}/.default
    ```

ここで、`client_id`と`client_secret`は事前に作成したJMeter専用のものを使用します。また、`username`と`password`は`CSV Data Set Config`から動的に設定されます。

### 2.3 JSON Extractorの設定
トークン取得リクエストのレスポンスから、`access_token`を抽出するために、`JSON Extractor`を使用します。これにより、次のAPIリクエストに必要なトークンを抽出します。

- **JSON Path Expression**：`$.access_token`
- **変数名**：`ACCESS_TOKEN`

### 2.4 APIリクエストの設定
最後に、取得した`ACCESS_TOKEN`を使ってWebAPIにリクエストを送信します。`HTTP Header Manager`を使い、`Authorization`ヘッダーに`Bearer ${ACCESS_TOKEN}`を設定します。

**HTTP Request Samplerの設定**：
- **URL**：`https://yourapiurl.com/endpoint`
- **メソッド**：`GET`
- **HTTP Header Managerの設定**：
    - `Authorization`: `Bearer ${ACCESS_TOKEN}`
    - `Content-Type`: `application/json`

## 3. スクリプト実行

JMeterスクリプトを準備し、実行します。各スレッドが異なるユーザー資格情報を使用し、認証トークンを取得し、それを使ってAPIに負荷をかける形になります。スレッド数は同時実行数（20）に設定します。

## 4. 結果の確認

負荷試験が終了した後、JMeterのレポートやログを確認し、各ユーザーのリクエストが正常に処理されたか、レスポンスステータスやエラーを確認します。また、モニタリングツール（例：DatadogやAzure Monitor）を使って、負荷試験中のリソース使用状況やパフォーマンスを監視します。

---

この方法を利用することで、Entra IDを使用したWebAPIに対して、特定のクライアント専用の認証トークンを使いながら負荷試験を行うことが可能になります。これにより、複数ユーザーによる同時アクセス時の性能評価やボトルネックの特定が容易になります。

### user — 2024-09-28T02:39:06.624027+00:00

Content-Type: application/json
は利用するAPIに依存するため削除するか説明を追加する

### assistant — 2024-09-28T02:39:33.918386+00:00

The user prefers to remove or add a clarification for the `Content-Type: application/json` header depending on the API being tested.

### tool — 2024-09-28T02:39:33.918506+00:00

Model set context updated.

### assistant — 2024-09-28T02:39:33.918601+00:00

以下は修正を加えたブログ記事の内容です。`Content-Type: application/json`の取り扱いについて説明を追加しました。

---

# Entra IDを利用したWebAPIの負荷試験をJMeterで行う方法

今回は、Azure Entra IDを使った認証を必要とするWebAPIに対して、JMeterを使用して負荷試験を行う方法をご紹介します。JMeterを用いて、特定のクライアント専用の認証トークンを自動的に取得し、異なるユーザーごとに同時実行でAPIリクエストを行うシナリオを構築します。

## 1. 準備

### 1.1 Azure ADでの事前設定
まず、Azure ADで負荷試験専用のアプリケーション登録を行います。これにより、実際のアプリケーションが使用するものとは異なるクライアントIDとクライアントシークレットを生成します。これは負荷試験用に分離されており、本番環境への影響を最小限に抑えるために重要な手順です。

#### 手順
1. **Azureポータル**にアクセスし、**Azure Active Directory** > **アプリの登録**を選択。
2. 負荷試験専用の新しいアプリケーションを登録し、**クライアントID**と**クライアントシークレット**を生成します。
3. **APIアクセス権限**を追加し、WebAPIにアクセスできるよう必要なスコープを付与します。たとえば、`api://{your_api_id}/.default` というスコープです。

このアプリケーションを負荷試験専用として設定することで、本番環境で使うものとは異なるクライアント情報が生成されます。

## 2. JMeterスクリプトの設定

JMeterでは、HTTPリクエストを通じてEntra ID認証トークンを自動的に取得し、そのトークンを使用してWebAPIへの負荷をかけます。今回は、20ユーザーを同時実行し、各ユーザーが異なるトークンを使用してAPIリクエストを行います。

### 2.1 CSV Data Set Configの設定
JMeter内で、複数のユーザー資格情報を利用するため、`CSV Data Set Config`を使用します。これにより、20ユーザー分の資格情報をCSVファイルから読み込みます。

**CSVファイルのフォーマット例**：
```csv
[[REDACTED_EMAIL]],password1
[[REDACTED_EMAIL]],password2
[[REDACTED_EMAIL]],password3
...
```

このファイルをJMeterに読み込ませ、各スレッドが異なるユーザー資格情報を利用します。

### 2.2 トークン取得リクエストの設定
各ユーザーがAPIにアクセスするために、認証トークンを取得する必要があります。OAuth 2.0の`password`フローを利用して、ユーザー資格情報を使いトークンを取得します。

**HTTP Request Samplerの設定**：
- **URL**：`https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token`
- **メソッド**：`POST`
- **Body Data**：
    ```yaml
    client_id=your_jmeter_client_id&
    client_secret=your_jmeter_client_secret&
    grant_type=password&
    username=${USERNAME}&
    password=${PASSWORD}&
    scope=api://{your_api_id}/.default
    ```

ここで、`client_id`と`client_secret`は事前に作成したJMeter専用のものを使用します。また、`username`と`password`は`CSV Data Set Config`から動的に設定されます。

### 2.3 JSON Extractorの設定
トークン取得リクエストのレスポンスから、`access_token`を抽出するために、`JSON Extractor`を使用します。これにより、次のAPIリクエストに必要なトークンを抽出します。

- **JSON Path Expression**：`$.access_token`
- **変数名**：`ACCESS_TOKEN`

### 2.4 APIリクエストの設定
最後に、取得した`ACCESS_TOKEN`を使ってWebAPIにリクエストを送信します。`HTTP Header Manager`を使い、`Authorization`ヘッダーに`Bearer ${ACCESS_TOKEN}`を設定します。

**注意**: `Content-Type` ヘッダーの設定は、テスト対象となるAPIによって異なる場合があります。多くの場合、`application/json` ですが、APIが異なるデータフォーマットを期待する場合は、そのフォーマットに合わせてヘッダーを調整する必要があります。ここでは一般的な例として`application/json`を使用しています。

**HTTP Request Samplerの設定**：
- **URL**：`https://yourapiurl.com/endpoint`
- **メソッド**：`GET`
- **HTTP Header Managerの設定**：
    - `Authorization`: `Bearer ${ACCESS_TOKEN}`
    - `Content-Type`: `application/json`（必要に応じて変更）

## 3. スクリプト実行

JMeterスクリプトを準備し、実行します。各スレッドが異なるユーザー資格情報を使用し、認証トークンを取得し、それを使ってAPIに負荷をかける形になります。スレッド数は同時実行数（20）に設定します。

## 4. 結果の確認

負荷試験が終了した後、JMeterのレポートやログを確認し、各ユーザーのリクエストが正常に処理されたか、レスポンスステータスやエラーを確認します。また、モニタリングツール（例：DatadogやAzure Monitor）を使って、負荷試験中のリソース使用状況やパフォーマンスを監視します。

---

この方法を利用することで、Entra IDを使用したWebAPIに対して、特定のクライアント専用の認証トークンを使いながら負荷試験を行うことが可能になります。これにより、複数ユーザーによる同時アクセス時の性能評価やボトルネックの特定が容易になります。
