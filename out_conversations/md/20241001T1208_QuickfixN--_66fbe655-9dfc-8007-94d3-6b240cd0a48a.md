---
conversation_id: "66fbe655-9dfc-8007-94d3-6b240cd0a48a"
title: "QuickfixN サーバ 切替条件"
create_time: 1727784533.923738
update_time: 1727784649.874539
language_guess: "en"
num_messages: 9
part_index: 1
part_count: 1
---

### system — 2024-10-01T12:08:53.923738+00:00

_(empty)_

### user — 2024-10-01T12:08:53.928064+00:00

Quickfixnについて、HeatBeatを30秒単位に行っている。サーバは２個登録している
この場合、サーバが切り替わるのはどのような条件か

### assistant — 2024-10-01T12:09:07.965327+00:00

_(empty)_

### assistant — 2024-10-01T12:09:07.965430+00:00

User is using Quickfixn with a 30-second heartbeat interval, and they have registered two servers.

### tool — 2024-10-01T12:09:07.965511+00:00

Model set context updated.

### assistant — 2024-10-01T12:09:07.965586+00:00

In QuickfixN, when using two servers and a heartbeat interval of 30 seconds, server failover typically occurs under the following conditions:

1. **Missed Heartbeats:** If QuickfixN detects that the primary server has missed a certain number of consecutive heartbeats (usually based on the `HeartBtInt` setting and a tolerance level like `MaxLatency`), it will consider the connection to that server lost.

2. **Connection Loss:** If the connection to the primary server drops unexpectedly, QuickfixN will attempt to reconnect. If it cannot reconnect after multiple retries, it will failover to the secondary server.

The exact number of missed heartbeats or retry attempts before switching to the backup server can usually be configured in the session settings.

### user — 2024-10-01T12:10:05.150964+00:00

レートが一定間隔来ない場合、別のサーバに再コネクトする方法は

### assistant — 2024-10-01T12:10:48.937186+00:00

QuickfixNでレート（特定のメッセージやデータの受信）が一定間隔で来ない場合に、別のサーバに再接続する方法は、通常の切断検知だけでは難しいですが、以下のアプローチを組み合わせることで実現可能です。

### 1. **Heartbeatの監視**
QuickfixNのデフォルトの動作では、HeartBeatメッセージのやり取りを監視し、一定期間内にHeartbeatが受信されない場合に接続を切断します。これを活用することで、サーバー側の問題を検出し、再接続が試みられます。ただし、レートの問題がHeartbeatに影響を及ぼさない場合、これだけでは対処できない場合があります。

### 2. **アプリケーションレベルでの監視**
アプリケーション側で特定のレート（例: MarketDataやExecutionReportなどのメッセージ）の受信を監視し、一定時間そのメッセージが届かなかった場合に再接続をトリガーする方法です。具体的には以下のように実装できます。

- **メッセージ監視の実装**: メッセージを受信するたびにタイムスタンプを記録し、バックグラウンドで定期的にそのタイムスタンプと現在時刻を比較します。
- **再接続のトリガー**: 一定時間（例: 30秒や60秒）メッセージが受信されていない場合に、現在の接続を手動で切断し、他のサーバーに再接続を試みます。

### 3. **ReconnectOnMessageTimeoutのカスタム実装**
QuickfixNにはデフォルトでレートの監視機能はありませんが、セッション設定をカスタマイズして再接続を行うことも可能です。例えば、独自にTimeoutを設定し、そのTimeoutを過ぎた場合に`Disconnect`メソッドを呼び出して別のサーバーへの接続を試みるようなロジックを実装できます。

### 4. **複数サーバーのFailoverの設定**
QuickfixNの設定で、複数のサーバーを登録してFailoverを有効にすることが可能です。再接続処理が必要になった場合、セッションが自動的にバックアップサーバに切り替わるように設定します。以下のような設定をセッション設定ファイルに追加します。

```ini
[SESSION]
ConnectionType=initiator
...
ReconnectInterval=30
SocketConnectPort=5001
SocketConnectHost=primary_server
BackupConnectionHost=backup_server
BackupConnectionPort=5001
```

上記のように`BackupConnectionHost`を設定すると、再接続時に自動的にバックアップサーバーに切り替わることができます。

### まとめ
- Heartbeatとメッセージのレート監視を組み合わせて、メッセージの受信が停止した場合に再接続を試みる。
- アプリケーションレベルでレートの監視を行い、一定時間データが来ない場合に再接続をトリガーする。
- QuickfixNの設定で複数のサーバを登録し、バックアップサーバへの自動切り替えを行う。

これにより、レートが来ない場合にも迅速に再接続を試みることが可能になります。
