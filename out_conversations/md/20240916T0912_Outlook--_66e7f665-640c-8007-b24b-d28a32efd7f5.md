---
conversation_id: "66e7f665-640c-8007-b24b-d28a32efd7f5"
title: "Outlook アドイン ダイアログ"
create_time: 1726477925.687017
update_time: 1726478142.539136
language_guess: "en"
num_messages: 11
part_index: 1
part_count: 1
---

### system — 2024-09-16T09:12:05.687017+00:00

_(empty)_

### user — 2024-09-16T09:12:05.692472+00:00

o365のoutlookのアドインでメール送信前に確認のダイアログを表示するソースを作成

### assistant — 2024-09-16T09:12:43.706072+00:00

_(empty)_

### assistant — 2024-09-16T09:12:43.706168+00:00

Microsoft Office 365のOutlookアドインで、メール送信前に確認ダイアログを表示するには、JavaScriptとOffice.jsライブラリを使用して、`ItemSend`イベントをトリガーにカスタム確認ダイアログを実装します。以下は基本的な手順です。

### 1. Office.jsを使用したOutlookアドインプロジェクトのセットアップ
Outlookアドインのプロジェクトを作成するためには、まず基本的なセットアップを行います。

#### 必要なツール
- Node.js
- Yo Office ツール（Microsoftが提供するOfficeアドイン用テンプレート）

#### 手順
1. Node.jsがインストールされていることを確認。
2. `yo office` を使用して新しいOfficeアドインプロジェクトを作成します。
   ```bash
   npm install -g yo generator-office
   yo office
   ```
   指示に従って、Outlookアドインプロジェクトを作成します。

### 2. メール送信前に確認ダイアログを表示するコード

アドインがメールの送信操作を検知し、カスタムダイアログを表示するために`Office.context.mailbox.item`と`ItemSend`イベントを使用します。

#### 手順
1. **manifest.xml** で `ItemSend` イベントを追加。
   ```xml
   <ExtensionPoint xsi:type="Events">
      <Event Type="ItemSend" FunctionName="onMessageSend" />
   </ExtensionPoint>
   ```

2. **Functions.js** に送信時にダイアログを表示するJavaScriptコードを追加。

```javascript
Office.initialize = function (reason) {
  // 初期化コード（必要に応じて追加）
};

// メール送信前に呼び出されるイベントハンドラー
function onMessageSend(event) {
  // 確認ダイアログを表示
  let userConfirmation = confirm("このメールを送信してもよろしいですか？");

  if (userConfirmation) {
    // ユーザーがOKをクリックした場合、メールは送信されます
    event.completed({ allowEvent: true });
  } else {
    // キャンセルした場合、送信をキャンセルします
    event.completed({ allowEvent: false });
  }
}
```

### 3. アドインの動作説明

- `Office.initialize` はOutlookアドインが初期化されたときに実行されます。
- `onMessageSend` 関数は、メールの送信が開始される前に実行されます。この関数では、`confirm()` を使用してダイアログを表示し、ユーザーの選択に基づいて送信の許可またはキャンセルを行います。

### 4. テストとデプロイ
アドインをサイドロードしてテストするには、Outlook Webまたはデスクトップアプリケーションでアドインをロードして、動作を確認します。

- **サイドロード**：`manifest.xml` ファイルをOutlookにインポートして、アドインをローカルでテストできます。
- **デプロイ**：テストが完了したら、Microsoft 365のアドイン管理ポータルを使用して、組織全体にアドインをデプロイできます。

以上で、メール送信前に確認ダイアログを表示するOutlookアドインが作成できます。

### user — 2024-09-16T09:13:13.168628+00:00

これに送信先が自分の組織外の場合にダイアログを表示する条件を追加

### assistant — 2024-09-16T09:13:53.259601+00:00

送信先が自分の組織外の場合にのみ確認ダイアログを表示するようにするには、メールの送信先のドメインを取得し、ユーザーの組織のドメインと照合するロジックを追加する必要があります。

以下のように、送信先のメールアドレスを取得して、そのドメインが自分の組織のドメインかどうかを確認する条件を組み込むことができます。

### 更新したコード例

1. **manifest.xml** には特に変更はありません。

2. **Functions.js** に送信先が自分の組織外の場合に確認ダイアログを表示するロジックを追加します。

```javascript
Office.initialize = function (reason) {
  // 初期化コード（必要に応じて追加）
};

// 組織のドメインを指定 (例: "yourorganization.com")
const organizationDomain = "yourorganization.com";

// メール送信前に呼び出されるイベントハンドラー
function onMessageSend(event) {
  // メールの宛先情報を取得
  const toRecipients = Office.context.mailbox.item.to;

  // 宛先が自分の組織外かどうかを確認する
  let isExternalRecipient = false;

  for (let i = 0; i < toRecipients.length; i++) {
    let emailAddress = toRecipients[i].emailAddress;

    if (!emailAddress.endsWith(`@${organizationDomain}`)) {
      isExternalRecipient = true;
      break;
    }
  }

  // 組織外の宛先が含まれている場合に確認ダイアログを表示
  if (isExternalRecipient) {
    let userConfirmation = confirm("このメールの送信先に組織外の宛先が含まれています。送信してもよろしいですか？");

    if (userConfirmation) {
      // ユーザーがOKをクリックした場合、メールは送信されます
      event.completed({ allowEvent: true });
    } else {
      // キャンセルした場合、送信をキャンセルします
      event.completed({ allowEvent: false });
    }
  } else {
    // 送信先がすべて組織内の場合、そのまま送信
    event.completed({ allowEvent: true });
  }
}
```

### コードの詳細な説明

1. **組織のドメイン設定**:
   - `organizationDomain` に自分の組織のドメイン名（例: `yourorganization.com`）を設定します。

2. **宛先メールアドレスの確認**:
   - `Office.context.mailbox.item.to` で宛先のメールアドレスリストを取得します。
   - 宛先のドメイン部分（`@`以降）を取得し、組織のドメインと一致するかどうかを確認します。

3. **組織外の宛先が含まれる場合の動作**:
   - 組織外の宛先が含まれている場合、`confirm()` で確認ダイアログを表示し、ユーザーの確認を求めます。
   - ユーザーが送信をキャンセルした場合、メールの送信を停止します (`event.completed({ allowEvent: false })`)。

4. **組織内の宛先のみの場合の動作**:
   - 送信先がすべて組織内の場合は、確認ダイアログを表示せずにそのままメールを送信します。

### 注意点
- ドメイン比較の方法として、ここでは `emailAddress.endsWith('@yourorganization.com')` を使用していますが、複数のドメインが組織内で使われる場合は、複数のドメインをチェックするように変更することも可能です。
- `Office.context.mailbox.item.to` の他にも、CCやBCCの宛先リストもチェックする必要があれば、それらも同様に取得してチェックすることができます。

### 今後の改善点
- 複数ドメインの対応。
- CCやBCCの宛先チェックの追加。
- ユーザーが自分のアドレスにメールを送信する場合の特別な処理。

これで、送信先が組織外の場合のみ確認ダイアログが表示されるようになります。

### user — 2024-09-16T09:14:01.755607+00:00

組織のドメインは送信元ユーザーのメールアドレスから取得する

### assistant — 2024-09-16T09:14:44.708384+00:00

送信元ユーザーのメールアドレスから組織のドメインを取得し、それに基づいて送信先が組織外かどうかを確認するロジックを実装することができます。

`Office.context.mailbox.userProfile.emailAddress` で送信元ユーザーのメールアドレスを取得し、そのドメイン部分を切り出して比較に使用します。

以下のようにコードを修正します。

### 更新したコード例

```javascript
Office.initialize = function (reason) {
  // 初期化コード（必要に応じて追加）
};

// メール送信前に呼び出されるイベントハンドラー
function onMessageSend(event) {
  // 送信元ユーザーのメールアドレスを取得
  const senderEmailAddress = Office.context.mailbox.userProfile.emailAddress;
  
  // 送信元のドメインを取得
  const organizationDomain = senderEmailAddress.split('@')[1]; // ドメイン部分を取得
  
  // メールの宛先情報を取得
  const toRecipients = Office.context.mailbox.item.to;

  // 宛先が自分の組織外かどうかを確認する
  let isExternalRecipient = false;

  for (let i = 0; i < toRecipients.length; i++) {
    let emailAddress = toRecipients[i].emailAddress;

    if (!emailAddress.endsWith(`@${organizationDomain}`)) {
      isExternalRecipient = true;
      break;
    }
  }

  // 組織外の宛先が含まれている場合に確認ダイアログを表示
  if (isExternalRecipient) {
    let userConfirmation = confirm("このメールの送信先に組織外の宛先が含まれています。送信してもよろしいですか？");

    if (userConfirmation) {
      // ユーザーがOKをクリックした場合、メールは送信されます
      event.completed({ allowEvent: true });
    } else {
      // キャンセルした場合、送信をキャンセルします
      event.completed({ allowEvent: false });
    }
  } else {
    // 送信先がすべて組織内の場合、そのまま送信
    event.completed({ allowEvent: true });
  }
}
```

### 追加した機能の詳細な説明

1. **送信元のドメインを取得**:
   - `Office.context.mailbox.userProfile.emailAddress` で送信元ユーザーのメールアドレスを取得します。
   - `split('@')` を使用して、メールアドレスから`@`の後の部分（ドメイン）を取得します。

2. **宛先のドメインとの比較**:
   - 取得した送信元のドメイン（`organizationDomain`）と、宛先のメールアドレスのドメインを比較します。
   - 宛先に組織外のドメインが含まれている場合のみ、確認ダイアログを表示します。

### 注意点
- 送信元のドメインを動的に取得するため、特定の組織に依存せずにアドインが機能します。
- 宛先が組織内かどうかの判断は、送信元のドメインと宛先のドメインを直接比較することで行います。
- ドメイン部分は単純な文字列の後方一致（`endsWith`）で比較していますが、必要に応じて複数のドメインを許容するロジックを追加することもできます。

### 今後の改善点
- CCやBCCの宛先の確認も同様に実装できます（`Office.context.mailbox.item.cc` や `Office.context.mailbox.item.bcc` を使用して宛先を取得）。
- 複数のドメインに対応するロジック（例: グローバル企業の異なる地域ドメイン）も検討可能です。

これで、送信元ユーザーのメールアドレスから組織のドメインを自動的に取得し、送信先が外部のドメインの場合に確認ダイアログを表示するアドインの実装が完了します。

### user — 2024-09-16T09:14:59.829538+00:00

添付ファイルがある場合の条件を追加

### assistant — 2024-09-16T09:15:41.792833+00:00

添付ファイルがある場合にのみ確認ダイアログを表示する条件を追加するには、`Office.context.mailbox.item.attachments`を使用して、メールに添付ファイルが含まれているかどうかを確認することができます。

以下のコードに、添付ファイルがある場合にのみ確認ダイアログを表示する条件を追加します。

### 更新したコード例

```javascript
Office.initialize = function (reason) {
  // 初期化コード（必要に応じて追加）
};

// メール送信前に呼び出されるイベントハンドラー
function onMessageSend(event) {
  // 送信元ユーザーのメールアドレスを取得
  const senderEmailAddress = Office.context.mailbox.userProfile.emailAddress;
  
  // 送信元のドメインを取得
  const organizationDomain = senderEmailAddress.split('@')[1]; // ドメイン部分を取得
  
  // メールの宛先情報を取得
  const toRecipients = Office.context.mailbox.item.to;

  // 宛先が自分の組織外かどうかを確認する
  let isExternalRecipient = false;

  for (let i = 0; i < toRecipients.length; i++) {
    let emailAddress = toRecipients[i].emailAddress;

    if (!emailAddress.endsWith(`@${organizationDomain}`)) {
      isExternalRecipient = true;
      break;
    }
  }

  // 添付ファイルがあるかどうかを確認
  const attachments = Office.context.mailbox.item.attachments;

  // 組織外の宛先が含まれており、かつ添付ファイルがある場合に確認ダイアログを表示
  if (isExternalRecipient && attachments.length > 0) {
    let userConfirmation = confirm("このメールの送信先に組織外の宛先が含まれており、添付ファイルがあります。送信してもよろしいですか？");

    if (userConfirmation) {
      // ユーザーがOKをクリックした場合、メールは送信されます
      event.completed({ allowEvent: true });
    } else {
      // キャンセルした場合、送信をキャンセルします
      event.completed({ allowEvent: false });
    }
  } else {
    // 条件に該当しない場合、そのまま送信
    event.completed({ allowEvent: true });
  }
}
```

### 追加された機能の詳細な説明

1. **添付ファイルの確認**:
   - `Office.context.mailbox.item.attachments` でメールに添付されたファイルの情報を取得します。これは配列で返されるため、`attachments.length > 0` で添付ファイルがあるかどうかを確認します。

2. **条件の追加**:
   - 宛先が組織外であり、かつ添付ファイルが含まれている場合にのみ確認ダイアログを表示するように変更しました。
   - 組織外の宛先が含まれていても、添付ファイルがない場合はダイアログを表示せず、そのまま送信されます。

### 注意点
- 添付ファイルがない場合や、送信先がすべて組織内の場合は、確認ダイアログを表示せずにそのまま送信します。
- 宛先の確認ロジックと添付ファイルの確認ロジックを組み合わせたため、どちらの条件にも該当しない場合（添付ファイルがなく、すべての宛先が組織内）、メールは通常通り送信されます。

### 改善のアイデア
- 添付ファイルの種類（特定のファイル形式など）やサイズに基づいて確認ダイアログを表示する条件を追加することも可能です。
- 宛先のCCやBCCも含めて、組織外の宛先をチェックするロジックを追加することができます。

これで、送信先が組織外かつ添付ファイルがある場合に確認ダイアログを表示するアドインが完成します。
