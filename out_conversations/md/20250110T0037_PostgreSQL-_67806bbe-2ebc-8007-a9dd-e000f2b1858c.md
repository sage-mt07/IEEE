---
conversation_id: "67806bbe-2ebc-8007-a9dd-e000f2b1858c"
title: "PostgreSQL ログ分析設定"
create_time: 1736469438.475137
update_time: 1737103932.516278
language_guess: "en"
num_messages: 13
part_index: 1
part_count: 1
---

### system — 2025-01-10T00:37:18.475137+00:00

_(empty)_

### user — 2025-01-10T00:37:18.480249+00:00

Azure database for Postgresql を使用する前提で以下回答
アプリケーションから出力されたクエリをログで確認したい、
ログはlog analyticsを利用する前提
postgresql側の設定とlog analyticsのクエリを示せ

### assistant — 2025-01-10T00:37:35.725485+00:00

_(empty)_

### assistant — 2025-01-10T00:37:35.725664+00:00

Azure Database for PostgreSQL を使用して、アプリケーションから出力されたクエリをログで確認する方法について、以下に設定と Log Analytics クエリを示します。

---

### 1. PostgreSQL 側の設定

Azure Database for PostgreSQL では、ログ設定を構成する必要があります。以下の手順を実施してください。

#### (1) 設定変更

Azure Portal で PostgreSQL サーバーの設定を変更します。

1. **PostgreSQL サーバーに移動**: Azure Portal にログインし、対象の PostgreSQL サーバーを選択。
2. **"Server parameters"（サーバーパラメーター）を選択**。
3. 以下のパラメーターを設定します:
   - `log_statement`:
     - 値: `all`（全てのクエリをログに記録）
   - `log_duration`:
     - 値: `on`（クエリ実行時間を記録）
   - `log_connections`:
     - 値: `on`（新しい接続の記録）
   - `log_disconnections`:
     - 値: `on`（切断イベントの記録）

#### (2) サーバー再起動

一部の設定変更後は、PostgreSQL サーバーを再起動する必要があります。

---

### 2. Log Analytics の設定

Azure Database for PostgreSQL の診断ログを Azure Monitor に転送し、Log Analytics でクエリを実行できるようにします。

#### (1) 診断設定を有効化

1. **"Monitoring"（モニタリング） > "Diagnostic settings"（診断設定）を開く**。
2. **"Add diagnostic setting"（診断設定を追加）をクリック**。
3. 以下の設定を行う:
   - **ログカテゴリ**:
     - `PostgreSQLLogs`（PostgreSQL のログを含む）
   - **送信先**:
     - Log Analytics ワークスペースを選択。
4. 設定を保存。

#### (2) Log Analytics クエリ

Log Analytics ワークスペースで以下のクエリを実行します。

```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLSERVERS"
| where Category == "PostgreSQLLogs"
| project TimeGenerated, Resource, log_s
| where log_s contains "statement"
| sort by TimeGenerated desc
```

- **クエリ内容**:
  - `ResourceType == "POSTGRESQLSERVERS"`: PostgreSQL サーバーのログを対象。
  - `Category == "PostgreSQLLogs"`: PostgreSQL ログカテゴリを指定。
  - `log_s contains "statement"`: SQL ステートメントを含むログを抽出。
  - `sort by TimeGenerated desc`: 時系列で最新順に並べ替え。

---

### 3. 結果の確認

この設定により、アプリケーションから送信された SQL クエリや接続状況を Log Analytics で確認できます。必要に応じてクエリをカスタマイズし、より具体的なログを抽出してください。

### user — 2025-01-10T00:38:06.327497+00:00

設定に必要なライブラリがあればそれも示せ

### assistant — 2025-01-10T00:38:30.421369+00:00

Azure Database for PostgreSQL の設定や Log Analytics の活用に必要なライブラリを以下に示します。

---

### 1. PostgreSQL 側の設定に必要なライブラリ
PostgreSQL サーバーの設定自体には、特に追加のライブラリは必要ありません。ただし、以下の環境が整っていることを確認してください。

- **Azure Portal**:
  - Web ブラウザでアクセスできる環境。
- **PostgreSQL クライアントツール**（任意）:
  - 設定を確認するために `psql` や GUI ツール（pgAdmin 等）があると便利です。
  - インストールコマンド例:
    ```bash
    sudo apt install postgresql-client   # Ubuntu
    brew install libpq                  # macOS
    ```
  - 設定確認例:
    ```sql
    SHOW log_statement;
    ```

---

### 2. Log Analytics の設定に必要なライブラリ

#### (1) **Azure CLI**
診断設定をスクリプトで自動化する場合、Azure CLI が必要です。

- **Azure CLI のインストール**:
  - インストール手順: [Azure CLI の公式ドキュメント](https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli)
  - インストール後、Azure CLI を使用して診断設定を追加できます。
    ```bash
    az monitor diagnostic-settings create \
        --name "PostgreSQLDiagnostics" \
        --resource "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.DBforPostgreSQL/servers/{server-name}" \
        --logs '[{"category": "PostgreSQLLogs", "enabled": true}]' \
        --workspace "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.OperationalInsights/workspaces/{workspace-name}"
    ```

#### (2) **Azure SDK for Python (Azure Management Libraries)**

プログラムで診断設定や Log Analytics を操作する場合、Azure SDK for Python を使用できます。

- **必要なライブラリのインストール**:
  ```bash
  pip install azure-mgmt-monitor azure-loganalytics
  ```

- **設定スクリプト例**:
  以下は、Python を使用して診断設定を有効化する例です。

  ```python
  from azure.identity import DefaultAzureCredential
  from azure.mgmt.monitor import MonitorManagementClient

  subscription_id = "your-subscription-id"
  resource_group = "your-resource-group"
  postgres_server_name = "your-postgres-server"
  workspace_resource_id = "your-log-analytics-workspace-resource-id"

  credentials = DefaultAzureCredential()
  monitor_client = MonitorManagementClient(credentials, subscription_id)

  diagnostic_settings = {
      "logs": [{"category": "PostgreSQLLogs", "enabled": True}],
      "workspace_id": workspace_resource_id
  }

  resource_id = f"/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.DBforPostgreSQL/servers/{postgres_server_name}"
  monitor_client.diagnostic_settings.create_or_update(resource_id, "PostgreSQLDiagnostics", diagnostic_settings)
  ```

---

### 3. ログ確認に必要なライブラリ

#### (1) **Log Analytics クエリ用 SDK**

ログクエリをプログラムで実行したい場合、Azure Monitor Query ライブラリが便利です。

- **必要なライブラリのインストール**:
  ```bash
  pip install azure-monitor-query
  ```

- **クエリ実行例**:
  ```python
  from azure.monitor.query import LogsQueryClient
  from azure.identity import DefaultAzureCredential

  client = LogsQueryClient(credential=DefaultAzureCredential())
  query = """
  AzureDiagnostics
  | where ResourceType == "POSTGRESQLSERVERS"
  | where Category == "PostgreSQLLogs"
  | project TimeGenerated, Resource, log_s
  | where log_s contains "statement"
  | sort by TimeGenerated desc
  """
  workspace_id = "your-log-analytics-workspace-id"

  result = client.query_workspace(workspace_id, query, timespan="PT1H")

  for row in result:
      print(row)
  ```

---

### 4. 必須ライブラリまとめ

- **Azure CLI**: `az` コマンドで診断設定を行う場合に使用。
- **PostgreSQL クライアントツール**（任意）: 設定確認やクエリ実行に利用。
- **Azure SDK for Python**（プログラムで診断設定を管理する場合）:
  - `azure-mgmt-monitor`
  - `azure-loganalytics`
- **Log Analytics クエリ SDK**（ログ確認用）:
  - `azure-monitor-query`

これらのライブラリを使用することで、Azure Database for PostgreSQL のログ設定と Log Analytics 統合を効率的に実現できます。

### user — 2025-01-10T00:46:39.729782+00:00

flexibleserverを前提に内容を書き換え

### assistant — 2025-01-10T00:47:12.366790+00:00

Azure Database for PostgreSQL Flexible Server を前提に、アプリケーションから出力されたクエリをログで確認するための設定方法と Log Analytics のクエリを以下に示します。

---

### 1. PostgreSQL 側の設定

Azure Database for PostgreSQL Flexible Server を使用する場合、必要なログ設定を構成します。

#### (1) 設定変更

Azure Portal で Flexible Server のログ設定を変更します。

1. **PostgreSQL サーバーに移動**:
   Azure Portal にログインし、対象の PostgreSQL Flexible Server を選択します。

2. **"Server parameters"（サーバーパラメーター）を選択**:
   必要なパラメーターを以下のように設定します。
   - `log_statement`:
     - 値: `all`（全てのクエリをログに記録）
   - `log_duration`:
     - 値: `on`（クエリ実行時間を記録）
   - `log_connections`:
     - 値: `on`（新しい接続の記録）
   - `log_disconnections`:
     - 値: `on`（切断イベントの記録）

3. **"Server Logs"（サーバーログ）の構成**:
   - ログ出力を Azure Monitor に送信するため、`log_checkpoints` や `log_error_verbosity` の調整も必要に応じて行います。

4. **サーバー再起動**:
   一部の設定変更後、サーバー再起動が必要です。

---

### 2. Log Analytics の設定

Flexible Server のログを Azure Monitor に統合し、Log Analytics でクエリを実行できるようにします。

#### (1) 診断設定を有効化

1. **"Monitoring"（モニタリング） > "Diagnostic settings"（診断設定）を開く**。
2. **"Add diagnostic setting"（診断設定を追加）をクリック**。
3. 以下を設定します:
   - **ログカテゴリ**:
     - `PostgreSQLLogs`（PostgreSQL のクエリログを含む）
   - **送信先**:
     - Log Analytics ワークスペースを選択。
4. 設定を保存します。

#### (2) Log Analytics クエリ

Log Analytics ワークスペースで以下のクエリを実行します。

```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVERS"
| where Category == "PostgreSQLLogs"
| project TimeGenerated, Resource, log_s
| where log_s contains "statement"
| sort by TimeGenerated desc
```

- **クエリの意味**:
  - `ResourceType == "POSTGRESQLFLEXIBLESERVERS"`: PostgreSQL Flexible Server のログを対象とします。
  - `Category == "PostgreSQLLogs"`: クエリログを含むカテゴリを指定。
  - `log_s contains "statement"`: クエリステートメントを含むログのみ抽出。
  - `sort by TimeGenerated desc`: 時系列で最新順に並べ替え。

---

### 3. 必要なライブラリ

#### (1) **Azure CLI**

診断設定をスクリプトで自動化する場合、Azure CLI が必要です。

- **Azure CLI のインストール**:
  - インストール手順: [Azure CLI の公式ドキュメント](https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli)

- **診断設定のコマンド例**:
  ```bash
  az monitor diagnostic-settings create \
      --name "PostgreSQLFlexibleDiagnostics" \
      --resource "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{server-name}" \
      --logs '[{"category": "PostgreSQLLogs", "enabled": true}]' \
      --workspace "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.OperationalInsights/workspaces/{workspace-name}"
  ```

#### (2) **Azure SDK for Python**

プログラムで診断設定や Log Analytics を操作する場合、Azure SDK for Python を使用します。

- **必要なライブラリのインストール**:
  ```bash
  pip install azure-mgmt-monitor azure-loganalytics
  ```

- **設定スクリプト例**:
  ```python
  from azure.identity import DefaultAzureCredential
  from azure.mgmt.monitor import MonitorManagementClient

  subscription_id = "your-subscription-id"
  resource_group = "your-resource-group"
  postgres_flexible_server_name = "your-postgres-flexible-server"
  workspace_resource_id = "your-log-analytics-workspace-resource-id"

  credentials = DefaultAzureCredential()
  monitor_client = MonitorManagementClient(credentials, subscription_id)

  diagnostic_settings = {
      "logs": [{"category": "PostgreSQLLogs", "enabled": True}],
      "workspace_id": workspace_resource_id
  }

  resource_id = f"/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{postgres_flexible_server_name}"
  monitor_client.diagnostic_settings.create_or_update(resource_id, "PostgreSQLFlexibleDiagnostics", diagnostic_settings)
  ```

---

### 4. 注意点

- **Flexible Server の制約**:
  - Azure Database for PostgreSQL Flexible Server では、専用のリソースグループとネットワーク設定が推奨されます。
  - ログ量が増えるとコストが増加するため、必要に応じて `log_statement` を `mod` や `ddl` に調整してください。

- **ログの取り扱い**:
  - 大量のログが記録される場合、Log Analytics のクエリに適切なフィルタを追加することを検討してください。

これらの手順を実施することで、アプリケーションのクエリログを効率的に収集し、Log Analytics で可視化できます。

### user — 2025-01-10T02:17:42.916555+00:00

AzureDiagnostics
| where strlen(Application_name_s)>0
でクエリ発行時期のイベントはとれたがクエリが見えない

### assistant — 2025-01-10T02:18:08.424495+00:00

Azure Monitor の `AzureDiagnostics` テーブルでクエリを記録したログが見えない場合、以下のポイントを確認して、適切な情報が収集されるように設定を調整してください。

---

### 1. `log_statement` の確認
PostgreSQL のログ設定において、`log_statement` パラメーターが適切に設定されていないと、クエリの内容がログに記録されません。

- 現在の設定を確認:
  ```sql
  SHOW log_statement;
  ```

- **適切な値**:
  - `all`: すべてのクエリを記録（推奨）。
  - 他の値の場合、特定の種類のクエリのみが記録されます。

- 設定変更（Azure Portal または `psql` クライアント）:
  ```sql
  ALTER SYSTEM SET log_statement = 'all';
  SELECT pg_reload_conf();
  ```

---

### 2. PostgreSQL のログフォーマット確認
Flexible Server の診断ログはデフォルトではすべてが収集されるわけではありません。クエリ内容を含む詳細なログを取得するには、以下の設定を確認してください。

- **診断設定で `PostgreSQLLogs` が有効か確認**:
  Azure Portal の「診断設定」で、`PostgreSQLLogs` カテゴリが選択されていることを確認してください。

- **`log_duration` の有効化**:
  クエリの実行時間を記録するには、`log_duration` を `on` に設定します。

---

### 3. `AzureDiagnostics` クエリ例

以下のクエリを試して、ログデータ内のクエリ内容を確認してください。

```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVERS"
| where Category == "PostgreSQLLogs"
| project TimeGenerated, Application_name_s, log_s
| where log_s contains "SELECT" or log_s contains "INSERT" or log_s contains "UPDATE" or log_s contains "DELETE"
| sort by TimeGenerated desc
```

- **フィルタ説明**:
  - `ResourceType == "POSTGRESQLFLEXIBLESERVERS"`: PostgreSQL Flexible Server のログを対象とします。
  - `log_s contains "SELECT"` などで、クエリが含まれるログを抽出します。

---

### 4. クエリが見えない場合の追加確認

1. **ログ量制限**:
   Flexible Server のログ量が制限されている場合、クエリが記録されていない可能性があります。この場合、`log_statement` を `all` に設定し、ログを Azure Monitor に送信する設定を確認してください。

2. **ログの遅延**:
   Azure Monitor へのログ転送に遅延が発生する場合があります。クエリ発行後に一定時間待機して再確認してください。

3. **ログサイズの制御**:
   非常に長いクエリや頻繁なクエリ実行がある場合、ログ出力がトリミングされることがあります。この場合、PostgreSQL のパラメーター `log_line_prefix` を調整して、クエリの開始部分を確実に取得できるようにします。

---

### 5. ログ設定例 (Azure CLI)
診断ログの設定を Azure CLI を使って再設定する例です。

```bash
az monitor diagnostic-settings create \
    --name "PostgreSQLFlexibleServerLogs" \
    --resource "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{server-name}" \
    --logs '[{"category": "PostgreSQLLogs", "enabled": true}]' \
    --workspace "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.OperationalInsights/workspaces/{workspace-name}"
```

---

### 6. クエリ出力例

正しく設定が行われていれば、`AzureDiagnostics` テーブルに以下のようなログが含まれるはずです。

| **TimeGenerated**       | **Application_name_s** | **log_s**                                |
|--------------------------|-------------------------|------------------------------------------|
| [[REDACTED_PHONE]]-10T12:00:00Z    | MyApp                  | `SELECT * FROM users WHERE id = 1;`     |
| [[REDACTED_PHONE]]-10T12:01:00Z    | MyApp                  | `INSERT INTO orders VALUES (1, 'item');`|

ログが引き続き確認できない場合、PostgreSQL 側の設定や Azure Monitor 診断設定を再確認してください。

### user — 2025-01-10T02:19:54.382360+00:00

log_sがない

### assistant — 2025-01-10T02:20:23.333732+00:00

`AzureDiagnostics` テーブルに `log_s` が存在しない場合、PostgreSQL のログ内容が適切に収集されていない可能性があります。この場合、以下の手順を確認・調整してください。

---

### 1. ログ構成の確認

`AzureDiagnostics` テーブルに記録される内容は、PostgreSQL Flexible Server の診断ログ設定によって決まります。まず、ログが適切に出力されているか確認します。

#### (1) PostgreSQL のログ設定

`log_statement` やその他のログ関連設定を以下のように変更します。これにより、クエリ内容がログに含まれるようになります。

- **必要な設定**:
  ```sql
  ALTER SYSTEM SET log_statement = 'all';     -- 全てのクエリを記録
  ALTER SYSTEM SET log_duration = 'on';      -- クエリ実行時間を記録
  ALTER SYSTEM SET log_checkpoints = 'on';   -- チェックポイントを記録
  ALTER SYSTEM SET log_connections = 'on';   -- 接続情報を記録
  ALTER SYSTEM SET log_disconnections = 'on'; -- 切断情報を記録
  SELECT pg_reload_conf();                   -- 設定の再読み込み
  ```

#### (2) 診断設定の確認

Azure Portal または Azure CLI を使って、診断設定で `PostgreSQLLogs` が有効になっているか確認します。

```bash
az monitor diagnostic-settings list \
  --resource "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{server-name}"
```

出力に `PostgreSQLLogs` が含まれていない場合は、次のコマンドで設定を追加します。

```bash
az monitor diagnostic-settings create \
    --name "PostgreSQLFlexibleServerLogs" \
    --resource "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{server-name}" \
    --logs '[{"category": "PostgreSQLLogs", "enabled": true}]' \
    --workspace "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.OperationalInsights/workspaces/{workspace-name}"
```

---

### 2. `AzureDiagnostics` のカラム確認

Log Analytics の `AzureDiagnostics` テーブルは環境によって異なるカラム構成を持つ場合があります。まず、現在のカラム名を確認します。

#### (1) カラム一覧取得

以下のクエリを実行し、使用可能なカラムを確認します。

```kql
AzureDiagnostics
| getschema
```

このクエリで、`log_s` に相当するカラムが `Message` や別の名前で記録されている可能性があります。

#### (2) クエリ内容を含むカラムの確認

`Application_name_s` やクエリログが記録されるカラム名を特定するため、以下のクエリを試します。

```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVERS"
| where Category == "PostgreSQLLogs"
| project *
| limit 10
```

このクエリで出力されたデータから、クエリ内容や関連情報を記録しているカラムを探します。

---

### 3. カラム名が特定された場合

ログ内容が確認できた場合、そのカラム名を用いてクエリを修正します。

例: クエリ内容が `Message` に記録されていた場合

```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVERS"
| where Category == "PostgreSQLLogs"
| project TimeGenerated, Application_name_s, Message
| where Message contains "SELECT" or Message contains "INSERT" or Message contains "UPDATE" or Message contains "DELETE"
| sort by TimeGenerated desc
```

---

### 4. ログ内容が不足している場合

もしクエリ内容が取得できない場合は、次の対応を検討してください。

#### (1) PostgreSQL サーバーに直接接続してログ確認

PostgreSQL Flexible Server 上で実際のログファイルに記録されているか確認します。

```sql
SELECT * FROM pg_stat_activity WHERE state = 'active';
```

#### (2) Azure Monitor の設定確認

Azure Monitor にログが送信されているが、内容が不十分な場合は、サポートに問い合わせて詳細なログ収集が有効化されているか確認してください。

---

### 5. Log Analytics のログ例

以下のようにクエリログが記録されていることが期待されます。

| **TimeGenerated**       | **Application_name_s** | **Message**                                |
|--------------------------|-------------------------|--------------------------------------------|
| [[REDACTED_PHONE]]-10T12:00:00Z    | MyApp                  | `SELECT * FROM users WHERE id = 1;`       |
| [[REDACTED_PHONE]]-10T12:01:00Z    | MyApp                  | `INSERT INTO orders VALUES (1, 'item');`  |

必要に応じてクエリや設定を調整して再度確認してください。
