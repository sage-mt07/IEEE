---
conversation_id: "6777e500-2994-8007-9f7b-4c2f6e0163cb"
title: "書籍登録機能実装"
create_time: 1735910656.331277
update_time: 1735910693.57845
language_guess: "en"
num_messages: 5
part_index: 1
part_count: 1
---

### system — 2025-01-03T13:24:16.331277+00:00

_(empty)_

### user — 2025-01-03T13:24:16.337010+00:00

## 書籍登録機能のC#コード生成

**目的:** ユーザーが入力した書籍情報を検証し、データベースに保存するC#コードを生成してください。

**入力:** 

* 書籍タイトル (string)
* 著者名 (string)
* ISBN (string)
* 出版日 (DateTime)
* 価格 (decimal)

**出力:** 

* 検証結果 (bool) - true: 成功、false: 失敗
* エラーメッセージ (string) - 検証失敗時のエラーメッセージ

**制約:** 

* .NET 8 環境で動作するC#コードで記述してください。
* 入力検証は、以下のルールに従ってください。
    * 書籍タイトルは必須入力で、255文字以内であること。
    * 著者名は必須入力で、100文字以内であること。
    * ISBNは必須入力で、13桁の数字またはハイフンを含む形式（例：[[REDACTED_PHONE]]-9）であること。
    * 出版日は必須入力で、過去の日付であること。
    * 価格は必須入力で、0以上の数値であること。
* データベースは、SQL Serverを使用し、接続文字列は "your_connection_string" としてください。
* データベースのテーブル名は "Books" で、カラム名は "Title", "Author", "ISBN", "PublishedDate", "Price" とします。
* Entity Framework Coreを使用してデータベースにアクセスしてください。
* エラー処理を適切に行ってください。
* 例外が発生した場合は、例外メッセージをエラーメッセージとして返してください。

**その他:** 

* SQLインジェクション対策を考慮してください。
* コーディングスタイルは、.NETの標準的なコーディング規約に従ってください。
* 必要に応じてコメントを追加してください。

**例:**

**入力:**

* 書籍タイトル: "すごいC#プログラミング"
* 著者名: "田中太郎"
* ISBN: "[[REDACTED_PHONE]]-5"
* 出版日: [[REDACTED_PHONE]]
* 価格: 2800

**出力:**

* 検証結果: true
* エラーメッセージ: ""


**期待するコード:**

書籍情報を検証し、データベースに保存するメソッド `RegisterBook` を含む `BookService` クラスのコードを生成してください。

### tool — 2025-01-03T13:24:52.038279+00:00

**Validating and saving**

I’m working through how to validate input properties for registering a book, using EF Core to store data in a "Books" database, and returning a success or error message.

**Setting up the context**

I’m configuring the DbContext with the "your_connection_string" and considering adding the Book class to the snippet as necessary.

**Validating and saving**

I’m confirming the validation of input properties for RegisterBook and ensuring the Book class is included to handle database operations effectively.

**Validating ISBN**

I’m working through a simple approach to validate ISBN by removing hyphens, ensuring a 13-digit numeric format, and verifying the publication date is not future-dated.

### assistant — 2025-01-03T13:24:52.038402+00:00

以下に、.NET 8 かつ Entity Framework Core を利用したサンプルコードを示します。  
本コードは、書籍情報を検証したうえでデータベース（SQL Server）に保存する `RegisterBook` メソッドを含む `BookService` クラスの例です。

必要に応じて、クラス名や名前空間、パッケージ参照（NuGet で `Microsoft.EntityFrameworkCore` および `Microsoft.EntityFrameworkCore.SqlServer`）などを調整してください。

```csharp
using System;
using System.Linq;                // For .Any(), .All() etc.
using Microsoft.EntityFrameworkCore;

namespace BookRegistrationSample
{
    /// <summary>
    /// 書籍エンティティ
    /// </summary>
    public class Book
    {
        // 主キー
        public int Id { get; set; }

        // タイトル
        public string Title { get; set; } = default!;

        // 著者名
        public string Author { get; set; } = default!;

        // ISBN (13桁の数字またはハイフン含む形式)
        public string ISBN { get; set; } = default!;

        // 出版日
        public DateTime PublishedDate { get; set; }

        // 価格
        public decimal Price { get; set; }
    }

    /// <summary>
    /// 書籍情報を保存するためのDbContext
    /// </summary>
    public class BookDbContext : DbContext
    {
        // 接続文字列は "your_connection_string" を使用
        private const string ConnectionString = "your_connection_string";

        public DbSet<Book> Books { get; set; } = default!;

        // DbContextOptionsを受け取るコンストラクタ
        public BookDbContext(DbContextOptions<BookDbContext> options)
            : base(options)
        {
        }

        // OnConfiguring をオーバーライドして明示的に接続文字列を指定
        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            // 既に設定されている場合は上書きしない
            if (!optionsBuilder.IsConfigured)
            {
                // SQL Server を使用
                optionsBuilder.UseSqlServer(ConnectionString);
            }
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // テーブル名を "Books" に設定
            modelBuilder.Entity<Book>().ToTable("Books");

            // カラムのマッピングを指定（必要に応じて設定）
            modelBuilder.Entity<Book>(entity =>
            {
                entity.Property(e => e.Title).HasColumnName("Title");
                entity.Property(e => e.Author).HasColumnName("Author");
                entity.Property(e => e.ISBN).HasColumnName("ISBN");
                entity.Property(e => e.PublishedDate).HasColumnName("PublishedDate");
                entity.Property(e => e.Price).HasColumnName("Price");
            });
        }
    }

    /// <summary>
    /// 書籍登録サービスクラス
    /// </summary>
    public class BookService
    {
        private readonly BookDbContext _context;

        // コンストラクタでDbContextを受け取る
        public BookService(BookDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// 書籍情報を検証し、データベースに登録する
        /// </summary>
        /// <param name="title">書籍タイトル</param>
        /// <param name="author">著者名</param>
        /// <param name="isbn">ISBN (13桁の数字またはハイフン含む形式)</param>
        /// <param name="publishedDate">出版日 (過去の日付)</param>
        /// <param name="price">価格 (0以上)</param>
        /// <returns> (検証結果, エラーメッセージ) </returns>
        public (bool IsSuccess, string ErrorMessage) RegisterBook(
            string title,
            string author,
            string isbn,
            DateTime publishedDate,
            decimal price)
        {
            // 入力検証 -------------------------------------------------------
            // 1. タイトルは必須・255文字以内
            if (string.IsNullOrWhiteSpace(title))
            {
                return (false, "書籍タイトルは必須入力です。");
            }
            if (title.Length > 255)
            {
                return (false, "書籍タイトルは255文字以内で入力してください。");
            }

            // 2. 著者名は必須・100文字以内
            if (string.IsNullOrWhiteSpace(author))
            {
                return (false, "著者名は必須入力です。");
            }
            if (author.Length > 100)
            {
                return (false, "著者名は100文字以内で入力してください。");
            }

            // 3. ISBNは必須・13桁の数字またはハイフン含む形式かどうかを簡易チェック
            if (string.IsNullOrWhiteSpace(isbn))
            {
                return (false, "ISBNは必須入力です。");
            }
            // ISBNのハイフンを除去したうえで13桁の数字のみかどうかを検証
            var isbnDigitsOnly = isbn.Replace("-", "");
            if (isbnDigitsOnly.Length != 13 || !isbnDigitsOnly.All(char.IsDigit))
            {
                return (false, "ISBNは13桁の数字(ハイフン含可)で入力してください。");
            }

            // 4. 出版日は必須・過去の日付
            if (publishedDate == default)
            {
                return (false, "出版日は必須入力です。");
            }
            if (publishedDate.Date >= DateTime.Today)
            {
                return (false, "出版日は過去の日付を指定してください。");
            }

            // 5. 価格は必須・0以上
            if (price < 0)
            {
                return (false, "価格は0以上で入力してください。");
            }

            // データベースへの保存処理 ---------------------------------------
            try
            {
                // Book エンティティを作成
                var newBook = new Book
                {
                    Title = title,
                    Author = author,
                    ISBN = isbn,
                    PublishedDate = publishedDate,
                    Price = price
                };

                // データベースに追加
                _context.Books.Add(newBook);

                // 保存 (INSERT 実行)
                _context.SaveChanges();

                // 成功
                return (true, string.Empty);
            }
            catch (Exception ex)
            {
                // 例外が発生した場合、例外メッセージを返す
                return (false, ex.Message);
            }
        }
    }
}
```

## 説明

1. **Book クラス**  
   - テーブル "Books" とマッピングされるエンティティです。  
   - `Title`, `Author`, `ISBN`, `PublishedDate`, `Price` のプロパティを持ちます。

2. **BookDbContext クラス**  
   - EF Core の `DbContext` を継承し、`Books` テーブルへのアクセスを提供します。  
   - `OnConfiguring` メソッドで SQL Server に接続するための接続文字列 (`"your_connection_string"`) を指定しています。  
   - `OnModelCreating` メソッドでテーブル名やカラムのマッピングを行っています。

3. **BookService クラス**  
   - コンストラクタで受け取った `BookDbContext` を用いて、データベースへの書籍情報の登録を行います。  
   - `RegisterBook` メソッド内で、入力パラメータの検証を行い、問題がある場合は `(false, "エラーメッセージ")` を返します。  
   - 検証に通った場合のみ、新規 `Book` オブジェクトを作成し、`DbContext` に追加 → `SaveChanges()` でデータベースへ保存します。  
   - データベース保存時に例外 (`Exception`) が発生した場合は、例外メッセージをそのまま戻り値のエラーメッセージとして返します。

## 使い方 (例)

```csharp
using System;
using Microsoft.EntityFrameworkCore;
using BookRegistrationSample;

class Program
{
    static void Main()
    {
        // DbContextOptions の設定
        var options = new DbContextOptionsBuilder<BookDbContext>()
            // 必要に応じて UseSqlServer(...) 呼び出しを追加できます
            .Options;

        // DbContext を生成
        using var dbContext = new BookDbContext(options);

        // サービスクラスを生成
        var bookService = new BookService(dbContext);

        // 書籍情報を登録（例）
        var (isSuccess, errorMessage) = bookService.RegisterBook(
            title: "すごいC#プログラミング",
            author: "田中太郎",
            isbn: "[[REDACTED_PHONE]]-5",
            publishedDate: new DateTime(2023, 1, 15),
            price: 2800m
        );

        if (isSuccess)
        {
            Console.WriteLine("書籍登録に成功しました。");
        }
        else
        {
            Console.WriteLine($"書籍登録に失敗しました。エラー: {errorMessage}");
        }
    }
}
```

- 必要に応じて `appsettings.json` などに接続文字列を置き、`Program.cs` や `Startup.cs` で `services.AddDbContext<BookDbContext>(...)` を呼び出す構成にすることをおすすめします。  
- 上記コードはあくまでサンプルです。実運用では、例外時のロギングや詳細なバリデーションなどを追加してください。
