---
conversation_id: "66f6211f-5c30-8007-baa0-1c4d560c8dc9"
title: "Azure App Service 監視設定"
create_time: 1727406367.555295
update_time: 1727406484.685961
language_guess: "en"
num_messages: 7
part_index: 1
part_count: 1
---

### system — 2024-09-27T03:06:07.555295+00:00

_(empty)_

### user — 2024-09-27T03:06:07.559062+00:00

Azure App Service コンテナとpostgresqlの組み合わせにおいて監視設定をおこなうべき項目

### assistant — 2024-09-27T03:06:35.749847+00:00

_(empty)_

### assistant — 2024-09-27T03:06:35.749945+00:00

Azure App Service コンテナと PostgreSQL を組み合わせた監視設定では、以下の項目を重点的に監視することをお勧めします。

### 1. **アプリケーションのパフォーマンスと稼働状況**
   - **応答時間**: リクエストからレスポンスまでの時間を追跡し、スローダウンがないか確認します。
   - **スループット**: 単位時間当たりに処理されるリクエスト数を監視します。
   - **エラー率**: HTTP ステータスコード 500 系のエラーや、データベース接続エラーなどを確認します。
   - **アプリケーションログ**: エラーや警告、例外を追跡します。Datadog などの監視ツールと統合すると効果的です。

### 2. **PostgreSQL のパフォーマンス**
   - **接続数の監視**: PostgreSQL へのアクティブな接続数が制限を超えないか確認します。接続プールの使用状況も重要です。
   - **クエリパフォーマンス**: 遅いクエリや高負荷をかけるクエリを検出するため、クエリの実行時間を監視します。
   - **データベースの負荷状況**: CPU 使用率、メモリ使用率、ディスク I/O などのリソース使用状況を監視します。
   - **トランザクションの状況**: コミットされないトランザクションやデッドロックの監視。

### 3. **コンテナの稼働状況**
   - **コンテナの CPU とメモリ使用率**: アプリケーションコンテナのリソース使用量が適切かどうかを確認します。負荷が高すぎる場合、スケーリングの設定を見直す必要があります。
   - **コンテナの再起動頻度**: コンテナが頻繁に再起動している場合は、アプリケーションや環境の安定性に問題がある可能性があります。

### 4. **ネットワークの状態**
   - **ネットワークレイテンシ**: App Service コンテナと PostgreSQL 間の通信遅延が発生していないか監視します。
   - **データ転送量**: ネットワークを介したデータ転送量を追跡し、帯域幅の問題がないか確認します。

### 5. **スケーリングの状態**
   - **App Service のスケーリングメトリクス**: CPU 使用率やメモリ使用量に基づいて App Service が自動的にスケールアウトしているか確認します。スケール設定が適切かも評価します。

### 6. **セキュリティ監視**
   - **データベースアクセスの監視**: 不正なアクセスや許可されていないアクションが行われていないかを監視します。
   - **ログイン試行と失敗**: PostgreSQL のログイン試行や失敗ログを監視し、不審なアクセスがないか確認します。

これらの項目を Azure Monitor や Application Insights、PostgreSQL の監視ツールと連携することで、システム全体の健全性を維持し、問題が発生した際に迅速に対応できます。

### user — 2024-09-27T03:07:15.234868+00:00

監視設定方法

### assistant — 2024-09-27T03:08:04.233659+00:00

Azure App Service コンテナと PostgreSQL の監視設定方法は、主に以下の手順で実行できます。Azure Monitor や Application Insights などのツールを使用して設定を行い、Azure で一元管理します。

### 1. **Azure Monitor を使用した監視設定**

Azure Monitor は Azure リソースのパフォーマンスや稼働状況を追跡するための総合的なサービスです。以下の手順で監視設定を行います。

#### 1.1 **App Service の監視設定**

1. **Azure Portal にログイン**し、監視する App Service のリソースを選択します。
2. 左側のメニューから **「診断設定」** を選択します。
3. **診断設定を追加** をクリックして、新しい診断設定を作成します。
4. 必要に応じて、以下のログを有効にします。
   - **ApplicationLogging (ファイルシステム)**: アプリケーションのログを取得します。
   - **AppServiceHTTPLogs**: HTTP リクエストに関連するログを取得します。
   - **AppServiceConsoleLogs**: コンソール出力を取得します。
   - **AppServiceAuditLogs**: セキュリティに関する監査ログを取得します。
5. ログの送信先として **Log Analytics**、**ストレージアカウント**、**イベントハブ** のいずれかを指定します。

#### 1.2 **PostgreSQL の監視設定**

1. **Azure Database for PostgreSQL** に移動し、左側のメニューから **「診断設定」** を選択します。
2. **診断設定を追加** をクリックして、新しい診断設定を作成します。
3. 次のログを有効にします。
   - **PostgreSQLSlowQueries**: 遅延クエリを監視します。
   - **PostgreSQLConnections**: 接続状況を監視します。
   - **PostgreSQLQueryStoreRuntimeStatistics**: クエリのパフォーマンスに関する統計情報を収集します。
   - **PostgreSQLDatabaseWaitStatistics**: データベース内の待機時間に関する情報を取得します。
4. 監視データの送信先として、**Log Analytics**、**ストレージアカウント**、**イベントハブ** を選択します。

### 2. **Application Insights の設定**

Application Insights を使用すると、アプリケーションの詳細なパフォーマンスデータを収集できます。特にエラーレート、応答時間、スループットなどの監視に便利です。

#### 2.1 **App Service に Application Insights を有効化**

1. App Service のリソースに移動し、左側のメニューから **「Application Insights」** を選択します。
2. **Application Insights の有効化** をクリックします。すでに有効化されている場合は、設定を確認してください。
3. **プロファイリング** を有効化し、アプリケーションのパフォーマンスデータ（CPU 使用率、メモリ使用率、依存関係）を収集します。
4. 設定後、Application Insights のダッシュボードで詳細なパフォーマンスデータを確認できます。

#### 2.2 **カスタム メトリクスの設定**

App Service や PostgreSQL に関するカスタムメトリクスを作成し、監視項目に追加できます。

1. **Log Analytics ワークスペース**に移動し、クエリを作成してカスタム メトリクスを定義します。例えば、特定の HTTP ステータスコードや、クエリの実行時間などをフィルタリングするクエリを作成可能です。
2. 作成したクエリを **アラートルール** として設定し、アラートが発生する条件を指定します。
3. メール通知や Webhook など、アラートが発生した際の対応方法を設定します。

### 3. **Log Analytics を使用したログの収集と分析**

Log Analytics を使用して、App Service と PostgreSQL のログを一元管理し、詳細な分析を行うことができます。

1. **Log Analytics ワークスペース** を作成または選択し、App Service と PostgreSQL の診断設定でこのワークスペースを指定します。
2. **ログクエリ** を使用して、カスタムのダッシュボードを作成します。たとえば、以下のようなクエリを使用して、エラーレートやリクエストパフォーマンスを監視できます。

   ```kusto
   AppRequests
   | where success == false
   | summarize errorCount = count() by bin(timestamp, 1h)
   ```

   このようにして、時間ごとのエラーレートや応答時間などを追跡できます。

3. **アラートルール** を設定して、特定のしきい値を超えた場合に通知が発生するようにします。

### 4. **Azure Monitor Alerts の設定**

1. **アラート ルール** を Azure Monitor で設定して、App Service や PostgreSQL のパフォーマンス、スロークエリ、エラー発生率などに基づいてアラートを送信するようにします。
2. アラートをトリガーするメトリクスやログ クエリを指定し、アラートが発生した際に通知する **アクション グループ**（メール、Webhook、Azure Function など）を指定します。

### 5. **スケーリングの監視**

Azure App Service のスケールアウトを監視し、必要に応じて自動でスケールする設定を行います。

1. **Azure Portal** の App Service リソースに移動し、**スケールアウト（App Service プラン）** を選択します。
2. **メトリックに基づくスケール** を選択し、CPU 使用率やメモリ使用率に基づいてスケールルールを作成します。

### まとめ
これらの手順を通じて、Azure App Service コンテナと PostgreSQL の監視設定を行い、アプリケーションやデータベースのパフォーマンスや稼働状況を適切に把握することができます。Azure Monitor と Application Insights を組み合わせることで、統合的かつリアルタイムにシステム全体の監視が可能になります。
