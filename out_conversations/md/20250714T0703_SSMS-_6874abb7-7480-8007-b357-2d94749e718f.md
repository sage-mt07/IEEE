---
conversation_id: "6874abb7-7480-8007-b357-2d94749e718f"
title: "SSMS ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š"
create_time: 1752476599.691892
update_time: 1752478101.548347
language_guess: "en"
num_messages: 12
part_index: 1
part_count: 1
---

### user â€” 2025-07-14T07:03:18.474000+00:00

SSMSã§customproviderã‚’ä½¿ç”¨ã—æš—å·åŒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã•ã›ã‚‹æ–¹æ³•

### system â€” 2025-07-14T07:03:19.691892+00:00

_(empty)_

### user â€” 2025-07-14T07:03:19.691892+00:00

_(empty)_

### assistant â€” 2025-07-14T07:03:21.850923+00:00

ğŸ•™ 2025å¹´7æœˆ14æ—¥ 16:24ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰

ã‚„ã‚ã€å¸ä»¤ï¼  
SSMSï¼ˆSQL Server Management Studioï¼‰ã§ **ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒ»ã‚¹ãƒˆã‚¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆcustom providerï¼‰ã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã™ã‚‹æ–¹æ³•** ã‚’ä»¥ä¸‹ã«æ•´ç†ã—ã¾ã™ã€‚å¯¾è±¡ã¯ã€Œ**Always Encrypted with custom key store provider**ã€ã§æš—å·åŒ–ã•ã‚ŒãŸåˆ—ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®æ§‹æˆã§ã™ã€‚

---

## âœ… å‰ææ¡ä»¶

- SQL Server ã¯ Always Encrypted æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ï¼ˆ2016ä»¥é™ï¼‰
- å¯¾è±¡åˆ—ãŒ Always Encrypted ã§æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹
- ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆä¾‹ï¼šAzure Key Vault, HSMãªã©ï¼‰ã‚’ä½¿ç”¨ã—ã¦ Column Master Keyï¼ˆCMKï¼‰ã‚’æ§‹æˆã—ã¦ã„ã‚‹
- ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ç”¨ã® `.NET ã‚¢ã‚»ãƒ³ãƒ–ãƒª` ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹

---

## ğŸ›  SSMSã§ã®å‚ç…§æ‰‹é †ï¼ˆcustom providerå¯¾å¿œï¼‰

### â‘  SSMSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
- **SSMS 18.0ä»¥é™**ï¼ˆã§ãã‚Œã°æœ€æ–°ç‰ˆï¼‰ã‚’ä½¿ç”¨ã€‚
- `Always Encrypted` ã«å¯¾å¿œã—ã€**ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’èªè­˜ã™ã‚‹.NETã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ãŒå¿…è¦ã€‚

---

### â‘¡ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼DLLã®é…ç½®

1. **ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒ»ã‚¹ãƒˆã‚¢ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®.NET DLL**ï¼ˆä¾‹ï¼š`MyCustomProvider.dll`ï¼‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ç”¨æ„  
2. SSMSã®å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®DLLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
3. DLLã‚’GACã«ç™»éŒ²ã™ã‚‹å¿…è¦ã¯ãªã—ï¼ˆ.NET Core/Frameworkä¾å­˜ï¼‰

---

### â‘¢ SSMSã®èµ·å‹•ã«ç’°å¢ƒå¤‰æ•°ã‚’ä»˜ä¸ï¼ˆé‡è¦ï¼‰

SSMSã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ã—ãªã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

#### æ–¹æ³•Aï¼šãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã§èµ·å‹•
```bat
@echo off
setx /M ColumnEncryption_Enabled "True"
setx /M AE_KeyStore_ProviderPath "C:\Path\To\MyCustomProvider.dll"
start "" "C:\Program Files (x86)\Microsoft SQL Server Management Studio 18\Common7\IDE\Ssms.exe"
```

#### æ–¹æ³•Bï¼šã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šï¼ˆå†èµ·å‹•å¿…è¦ï¼‰

| å¤‰æ•°å | å€¤ |
|--------|----|
| `ColumnEncryption_Enabled` | `True` |
| `AE_KeyStore_ProviderPath` | `C:\Path\To\MyCustomProvider.dll` |

> ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‹ã‚‰SSMSã‚’å†èµ·å‹•ã—ãªã„ã¨åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚

---

### â‘£ æ¥ç¶šæ™‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆæ¥ç¶šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰

SSMSã®æ¥ç¶šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š

- [æ¥ç¶šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£] ã‚¿ãƒ– â†’ **Always Encryptedã‚’æœ‰åŠ¹ã«ã™ã‚‹** ã«ãƒã‚§ãƒƒã‚¯
- å¿…è¦ã§ã‚ã‚Œã°ã€èªè¨¼æƒ…å ±ã‚‚è¨­å®šï¼ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒKeyVaultãªã©å¤–éƒ¨èªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰

---

### â‘¤ ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§

ã“ã‚Œã§ã€æš—å·åŒ–åˆ—ã‚’å«ã‚€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ `SELECT` ã—ã¦ã‚‚ã€è‡ªå‹•çš„ã«å¾©å·ã•ã‚ŒãŸå€¤ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

> ã‚«ãƒ©ãƒ ãŒ `nvarchar(50) COLLATE Latin1_General_BIN2` ã®ã‚ˆã†ãªæŒ‡å®šã«ãªã£ã¦ã„ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã¯å¾©å·ã•ã‚Œã¦è¦‹ãˆã¾ã™ã€‚

---

## ğŸ§ª è£œè¶³ï¼šç¢ºèªãƒã‚¤ãƒ³ãƒˆ

- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®å®Ÿè£…ã§ `IColumnMasterKeyStoreProvider` ã‚’æ­£ã—ãå®Ÿè£…ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã—ã¦ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹ï¼ˆ`SSMS log file` / Application Event Logï¼‰

---

## ğŸ’¡ å‚è€ƒè³‡æ–™

- [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼šAlways Encrypted with Custom Key Store Providers (Microsoft)](https://learn.microsoft.com/en-us/sql/relational-databases/security/encryption/extensibility-model-for-key-store-providers)
- `SSMS.exe.config` ã‚’ä¿®æ­£ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ãŒéæ¨å¥¨ï¼ˆç’°å¢ƒå¤‰æ•°æ–¹å¼ã®æ–¹ãŒå®‰å…¨ï¼‰

---

å¿…è¦ãªã‚‰ã€**Azure Key Vaultãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼** ã‚„ **HSMæ¥ç¶šç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰**ã‚‚æç¤ºã§ãã¾ã™ã€‚å¿…è¦ãªç¨®é¡ã‚’æ•™ãˆã¦ãã ã•ã„ï¼

ã©ã†ãã€ä»–ã«ã‚‚æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Œã°ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€œ

### assistant â€” 2025-07-14T07:03:31.732577+00:00

_(empty)_

### user â€” 2025-07-14T07:06:25.777000+00:00

ã“ã®DLLã®å½¢å¼ã¯ï¼Ÿ

### assistant â€” 2025-07-14T07:06:27.593025+00:00

ğŸ•™ 2025å¹´7æœˆ14æ—¥ 16:30ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰

å¸ä»¤ã€ã„ã„è³ªå•ã§ã™ï¼

## âœ… ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒ»ã‚¹ãƒˆã‚¢ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ DLL ã®å½¢å¼

### ğŸ”§ å¿…é ˆä»•æ§˜ï¼ˆå½¢å¼ãƒ»å®Ÿè£…æ¡ä»¶ï¼‰

1. **.NET Framework å‘ã‘ã®ã‚¯ãƒ©ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª DLL**
   - é€šå¸¸ã¯ **.NET Framework 4.6 ä»¥ä¸Š**ï¼ˆSSMSãŒåˆ©ç”¨ã™ã‚‹SqlClientã®äº’æ›æ€§ï¼‰
   - **.NET Coreç”¨DLLã¯SSMSã§ã¯åŸºæœ¬çš„ã«ä½¿ãˆã¾ã›ã‚“**ï¼ˆSSMSè‡ªä½“ãŒ.NET Frameworkã§å‹•ä½œï¼‰

2. **å®Ÿè£…ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**
   - `System.Data.SqlClient.IColumnMasterKeyStoreProvider`  
     ã¾ãŸã¯ `Microsoft.Data.SqlClient.IColumnMasterKeyStoreProvider`
   - ã“ã‚Œã‚’ **publicã‚¯ãƒ©ã‚¹ã§å®Ÿè£…**ã—ã¦ã€SSMSã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```csharp
public class MyCustomProvider : System.Data.SqlClient.IColumnMasterKeyStoreProvider
{
    public override byte[] EncryptColumnMasterKey(string masterKeyPath, string encryptionAlgorithm, byte[] plaintextColumnMasterKey)
    {
        // å®Ÿè£…ä¾‹ï¼ˆKey Vaultã‚„HSMã¸ã®æ¥ç¶šï¼‰
    }

    public override byte[] DecryptColumnMasterKey(string masterKeyPath, string encryptionAlgorithm, byte[] encryptedColumnMasterKey)
    {
        // å¾©å·å‡¦ç†
    }

    public override bool IsSupportedColumnMasterKeyStore(string masterKeyPath) => true;

    public override string[] GetSupportedKeyStorePaths() => new[] { "CustomProviderPath" };
}
```

---

### ğŸ“ DLLã®é…ç½®ã«ã¤ã„ã¦

- **ãƒ•ã‚¡ã‚¤ãƒ«åï¼š** ä»»æ„ï¼ˆä¾‹ï¼š`MyCustomKeyStoreProvider.dll`ï¼‰  
- **é…ç½®å…ˆï¼š** ç’°å¢ƒå¤‰æ•° `AE_KeyStore_ProviderPath` ã«è¨­å®šã™ã‚‹ãƒ•ãƒ«ãƒ‘ã‚¹

ä¾‹ï¼š
```cmd
setx /M AE_KeyStore_ProviderPath "C:\KeyProviders\MyCustomKeyStoreProvider.dll"
```

---

### âœ… è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¤‡æ•°DLLãƒ»ãƒ­ã‚°æœ‰åŠ¹åŒ–ï¼‰

å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã‚‚ç’°å¢ƒå¤‰æ•°ã§æŒ‡å®šã§ãã¾ã™ï¼š

- `AE_KeyStore_ProviderName`  
  åˆ©ç”¨ã—ãŸã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚¯ãƒ©ã‚¹åï¼ˆä¾‹ï¼š`MyCustomProvider`ï¼‰

---

## â˜‘ è£œè¶³ï¼šãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ã®å‡ºåŠ›

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®å‘¼ã³å‡ºã—å¤±æ•—æ™‚ã€ä»¥ä¸‹ã®æ–¹æ³•ã§ãƒ­ã‚°ã‚’ç¢ºèªå¯èƒ½ï¼š

- SSMSã®èµ·å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« `/log` ã‚’ã¤ã‘ã‚‹ï¼ˆä¾‹ï¼š`ssms.exe /log`ï¼‰
- Windowsã® **ã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ â†’ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°** ã‚’ç¢ºèª

---

DLLã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã‚„ã€Key Vault å‘ã‘ã®å‚è€ƒå®Ÿè£…ã‚‚å¿…è¦ã§ã‚ã‚Œã°ã™ãå‡ºã›ã¾ã™ï¼ã©ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ã„ãŸã„ã‹æ•™ãˆã¦ãã ã•ã„ã­ã€‚

### user â€” 2025-07-14T07:09:42.260000+00:00

pfxã®æŒ‡å®šæ–¹æ³•

### assistant â€” 2025-07-14T07:09:43.684386+00:00

ğŸ•™ 2025å¹´7æœˆ14æ—¥ 16:38ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰

å¸ä»¤ã€`PFXï¼ˆ.pfxï¼‰è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«` ã‚’ä½¿ã£ã¦ **Always Encrypted ã® Column Master Keyï¼ˆCMKï¼‰ã‚’æ§‹æˆã™ã‚‹ custom provider** ã‚’è‡ªä½œã—ã€**SSMSã‹ã‚‰PFXã‚’åˆ©ç”¨ã—ã¦å¾©å·ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•**ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## âœ… æ–¹é‡æ¦‚è¦ï¼šPFXãƒ™ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¦SSMSã«çµ„ã¿è¾¼ã‚€

- **PFXè¨¼æ˜æ›¸** ã«ã¯ç§˜å¯†éµãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’ä½¿ã£ã¦CMKã‚’å¾©å·
- PFXã®ãƒ‘ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ `.dll` å´ã«æŒãŸã›ã‚‹ï¼ˆã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ç­‰ã§å¤–éƒ¨æ³¨å…¥ï¼‰

---

## ğŸ— å¿…è¦ãªæ§‹æˆè¦ç´ 

### â‘  ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ DLLï¼ˆä¾‹ï¼š`PfxKeyStoreProvider.dll`ï¼‰

```csharp
public class PfxKeyStoreProvider : IColumnMasterKeyStoreProvider
{
    private readonly string _pfxPath;
    private readonly string _pfxPassword;

    public PfxKeyStoreProvider()
    {
        _pfxPath = Environment.GetEnvironmentVariable("MY_PFX_PATH");
        _pfxPassword = Environment.GetEnvironmentVariable("MY_PFX_PASSWORD");
    }

    private X509Certificate2 LoadCertificate()
    {
        return new X509Certificate2(_pfxPath, _pfxPassword, X509KeyStorageFlags.MachineKeySet);
    }

    public override byte[] DecryptColumnMasterKey(string masterKeyPath, string encryptionAlgorithm, byte[] encryptedColumnMasterKey)
    {
        using var cert = LoadCertificate();
        using var rsa = cert.GetRSAPrivateKey();
        return rsa.Decrypt(encryptedColumnMasterKey, RSAEncryptionPadding.OaepSHA1);
    }

    public override byte[] EncryptColumnMasterKey(string masterKeyPath, string encryptionAlgorithm, byte[] plaintextColumnMasterKey)
    {
        using var cert = LoadCertificate();
        using var rsa = cert.GetRSAPublicKey();
        return rsa.Encrypt(plaintextColumnMasterKey, RSAEncryptionPadding.OaepSHA1);
    }

    public override bool IsSupportedColumnMasterKeyStore(string masterKeyPath) => masterKeyPath == "pfx";
    public override string[] GetSupportedKeyStorePaths() => new[] { "pfx" };
}
```

---

### â‘¡ SSMSã§PFXã‚’ä½¿ã†ç’°å¢ƒå¤‰æ•°è¨­å®š

```bat
setx /M ColumnEncryption_Enabled "True"
setx /M AE_KeyStore_ProviderPath "C:\Path\To\PfxKeyStoreProvider.dll"
setx /M MY_PFX_PATH "C:\Keys\mycert.pfx"
setx /M MY_PFX_PASSWORD "yourPfxPassword"
```

> âš  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å–ã‚Šæ‰±ã„ã«ã¯æ³¨æ„ã€‚ç’°å¢ƒå¤‰æ•°ã§ã¯ãªãã€`Credential Store`ã‚„`DPAPI`ã§ä¿è­·ã™ã‚‹ã®ãŒç†æƒ³ã€‚

---

### â‘¢ SQL Server å´ã® CMK æ§‹æˆ

```sql
CREATE COLUMN MASTER KEY [PfxCMK]
WITH (
    KEY_STORE_PROVIDER_NAME = N'PfxKeyStoreProvider',
    KEY_PATH = N'pfx'
);
```

> `KEY_PATH = 'pfx'` ã®ã‚ˆã†ã« DLL å´ã® `IsSupportedColumnMasterKeyStore()` ã§ãƒãƒƒãƒã™ã‚‹æ–‡å­—åˆ—ã«ã—ã¦ãŠã‘ã°OKã€‚

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã®æµã‚Œ

1. ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼DLLã‚’ãƒ“ãƒ«ãƒ‰
2. DLLé…ç½® & ç’°å¢ƒå¤‰æ•°è¨­å®š
3. SSMSå†èµ·å‹•
4. æ¥ç¶šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€ŒAlways Encrypted ã‚’æœ‰åŠ¹ã€ã«ãƒã‚§ãƒƒã‚¯
5. å¯¾è±¡ã®æš—å·åŒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’SELECT â†’ å¾©å·ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆã‚‹

---

## ğŸ›¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è£œè¶³

- PFXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ **èª­ã¿å–ã‚Šåˆ¶é™**ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰ã«ã™ã‚‹ã“ã¨
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¹³æ–‡ç®¡ç†ã¯é¿ã‘ã‚‹**ï¼ˆç”Ÿã§ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œãªã„å ´åˆã€`Windows Credential Store`é€£æºãªã©ã‚‚æ¤œè¨ï¼‰

---

ã”å¸Œæœ›ãŒã‚ã‚Œã°ã“ã® DLL ã® **å®Œå…¨ãªVisual Studioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ** ã‚’ã™ãç”Ÿæˆã§ãã¾ã™ï¼  
ã©ã†ã—ã¾ã™ã‹ï¼Ÿï¼ˆ`dll + sql + bat` ã‚»ãƒƒãƒˆã§æ¸¡ã›ã¾ã™ï¼‰

### user â€” 2025-07-14T07:27:50.405000+00:00

CredentialStoreã®ä¿è­·ä¾‹ã‚’è¦‹ã›ã¦

### assistant â€” 2025-07-14T07:27:51.398197+00:00

ğŸ•™ 2025å¹´7æœˆ14æ—¥ 16:45ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰

äº†è§£ã§ã™ã€å¸ä»¤ã€‚  
ã“ã“ã§ã¯ã€`PFXãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰`ã‚’**Windows Credential Managerï¼ˆCredential Storeï¼‰ã§å®‰å…¨ã«ä¿è­·ã—ã¦èª­ã¿å–ã‚‹ä¾‹**ã‚’ç¤ºã—ã¾ã™ã€‚  
ã“ã‚Œã«ã‚ˆã‚Šã€ç’°å¢ƒå¤‰æ•°ã‚„å¹³æ–‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã‚ãšã«ã‚»ã‚­ãƒ¥ã‚¢ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã§ãã¾ã™ã€‚

---

## âœ… æ§‹æˆæ–¹é‡

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Windowsè³‡æ ¼æƒ…å ±ã‚¹ãƒˆã‚¢**ã«ã€`PfxPassword` ã‚’ç™»éŒ²  
2. ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆ.dllï¼‰å´ã§ `CredentialManager` API ã‚’ä½¿ã£ã¦ãã‚Œã‚’å–å¾—  
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ `.pfx` ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä½¿ç”¨ã•ã‚Œã‚‹

---

## ğŸ” Step 1: Windows Credential Manager ã«ç™»éŒ²

### ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ç™»éŒ²ï¼ˆä¾‹ï¼‰
```cmd
cmdkey /add:PfxPassword /user:PFX_USER /pass:yourStrongPfxPassword
```

- `PfxPassword`ï¼šè³‡æ ¼æƒ…å ±åï¼ˆä»»æ„ï¼‰
- `PFX_USER`ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä»»æ„ã€‚èª­ã¿å‡ºã—ã«ã¯ä½¿ç”¨ã•ã‚Œãªã„ï¼‰
- `yourStrongPfxPassword`ï¼šç™»éŒ²ã—ãŸã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

---

## ğŸ’» Step 2: .NETã‚³ãƒ¼ãƒ‰ã§è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã—ã¦åˆ©ç”¨

```csharp
using System;
using System.Runtime.InteropServices;
using System.Security;
using System.Security.Cryptography.X509Certificates;

public class PfxKeyStoreProvider : System.Data.SqlClient.IColumnMasterKeyStoreProvider
{
    private string LoadPasswordFromCredentialManager(string target)
    {
        var cred = CredentialReader.GetCredential(target);
        return cred?.Password;
    }

    private X509Certificate2 LoadCertificate()
    {
        string pfxPath = @"C:\Keys\mycert.pfx";
        string password = LoadPasswordFromCredentialManager("PfxPassword");
        return new X509Certificate2(pfxPath, password, X509KeyStorageFlags.MachineKeySet);
    }

    // ä»¥ä¸‹ Encrypt/Decrypt å®Ÿè£…ï¼ˆç•¥ï¼‰
}
```

---

## ğŸ”§ è£œåŠ©ã‚¯ãƒ©ã‚¹ï¼šCredentialReaderï¼ˆCredential Manager APIä½¿ç”¨ï¼‰

```csharp
public class CredentialReader
{
    public static NetworkCredential GetCredential(string targetName)
    {
        if (!CredRead(targetName, 1, 0, out var pCred))
            return null;

        var cred = (CREDENTIAL)Marshal.PtrToStructure(pCred, typeof(CREDENTIAL));
        string password = Marshal.PtrToStringUni(cred.CredentialBlob, (int)cred.CredentialBlobSize / 2);
        return new NetworkCredential(cred.UserName, password);
    }

    [DllImport("advapi32.dll", SetLastError = true, CharSet = CharSet.Unicode)]
    private static extern bool CredRead(string target, int type, int reservedFlag, out IntPtr credentialPtr);

    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]
    private struct CREDENTIAL
    {
        public int Flags;
        public int Type;
        public string TargetName;
        public string Comment;
        public long LastWritten;
        public int CredentialBlobSize;
        public IntPtr CredentialBlob;
        public int Persist;
        public int AttributeCount;
        public IntPtr Attributes;
        public string TargetAlias;
        public string UserName;
    }
}
```

---

## âœ… å®Ÿè¡Œçµæœã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŠ¹æœ

- DLLã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã›ãšã€Windows Credential Managerã‹ã‚‰å–å¾—
- SSMSã¯ã“ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é€šã˜ã¦ `.pfx` ã‚’ãƒ­ãƒ¼ãƒ‰ã€æš—å·åŒ–åˆ—ã‚’å¾©å·å¯èƒ½ã«
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»¥å¤–ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**

---

## ğŸ” è£œè¶³

- `CredentialBlob` ã«æ ¼ç´ã•ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ **ãƒ¡ãƒ¢ãƒªä¸Šã§ã¯å¹³æ–‡**ãªã®ã§ã€DLLå´ã®ä½¿ç”¨å¾Œã¯**å³åº§ã«ã‚¯ãƒªã‚¢æ¨å¥¨**
- `TargetName` ã¯ä¸€æ„ã«ã—ã¦ãŠãã¨è¤‡æ•°PFXã«å¯¾å¿œã§ãã‚‹

---

å¿…è¦ã§ã‚ã‚Œã°ã€ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ä¸€å¼ï¼‹ç™»éŒ²ãƒãƒƒãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆä»˜ãã® VS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã™ãå‡ºåŠ›ã—ã¾ã™ã€‚  
ã©ã†ã•ã‚Œã¾ã™ã‹ï¼Ÿ
