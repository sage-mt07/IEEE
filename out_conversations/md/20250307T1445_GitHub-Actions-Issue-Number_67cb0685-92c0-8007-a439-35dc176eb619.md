---
conversation_id: "67cb0685-92c0-8007-a439-35dc176eb619"
title: "GitHub Actions Issue Number"
create_time: 1741358725.781225
update_time: 1741358991.215458
language_guess: "en"
num_messages: 9
part_index: 1
part_count: 1
---

### system — 2025-03-07T14:45:25.781225+00:00

_(empty)_

### system — 2025-03-07T14:45:25.781225+00:00

_(empty)_

### assistant — 2025-03-07T14:45:25.857269+00:00

`ISSUE_NUMBER` が環境変数として設定されていないために `KeyError: 'ISSUE_NUMBER'` が起きています。  
GitHub Actions のステップ間では、`echo "KEY=VALUE" >> $GITHUB_OUTPUT` で書き出したものは**そのまま環境変数になるわけではなく**、「次のステップで `steps.<id>.outputs.<key>` という形で参照できる**出力**」になります。  
直接Python内で `os.environ['ISSUE_NUMBER']` を参照したい場合は、下記のように `env:` ブロックでステップの出力を環境変数に割り当ててあげる必要があります。

```yaml
      - name: Get issue details
        id: issue
        run: |
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Generate modified code with Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.ISSUE_NUMBER }}  # ここで出力を環境変数にマッピング
        run: |
          python <<EOF_PY
          import os
          import google.generativeai as genai
          from github import Github

          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          g = Github(os.environ['GITHUB_TOKEN'])

          repo = g.get_repo(os.environ['GITHUB_REPOSITORY'])
          issue_number = os.environ['ISSUE_NUMBER']  # 環境変数から取得できるようになる
          issue = repo.get_issue(number=int(issue_number))

          prompt = f"以下のIssueの内容に基づいてコードを修正してください:\n\nタイトル: {issue.title}\n内容: {issue.body}"
          model = genai.GenerativeModel('gemini-pro')
          response = model.generate_content(prompt)

          print(f"MODIFIED_CODE<<EOF\n{response.text}\nEOF")
          EOF_PY
```

上記のように修正していただくと、`ISSUE_NUMBER` を `os.environ` 経由で正しく取得できるはずです。

### tool — 2025-03-07T14:45:26.118547+00:00

**環境変数の確認**  
GitHub Actionsスクリプトで環境変数ISSUE_NUMBERが認識されないため、KeyError: 'ISSUE_NUMBER'が発生。issue詳細を取得するステップでISSUE_NUMBERを出力に設定している。

**環境変数の修正を検討**

Pythonステップで環境変数ISSUE_NUMBERを利用しようとしたが、設定されていない。GitHubの出力から環境変数として追加する方法を探っている。

**環境変数の設定**

GitHubの出力を環境変数として設定し、次のステップでPythonコードに渡す方法を模索中。

**環境変数の調整**

環境変数ISSUE_NUMBERを設定し、Pythonコード内で直接参照する方法を検討中。これにより、セキュリティトークンなどの情報を正確に渡すことができる。

### user — 2025-03-07T14:45:26.546000+00:00

githubactionの以下のスクリプトでエラーが発生している
エラー：Run python <<EOF_PY
Traceback (most recent call last):
  File "<stdin>", line 9, in <module>
  File "/opt/hostedtoolcache/Python/3.9.21/x64/lib/python3.9/os.py", line 679, in __getitem__
    raise KeyError(key) from None
KeyError: 'ISSUE_NUMBER'
スクリプト；
name: LLM Code Fix

on:
  issues:
    types: [labeled]

jobs:
  fix:
    if: github.event.label.name == 'llm-fix'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.issue.head.ref || github.event.issue.base.ref || github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai PyGithub

      - name: Get issue details
        id: issue
        run: |
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          
      - name: Generate modified code with Gemini API
        id: gemini
        run: |
          python <<EOF_PY
          import os
          import google.generativeai as genai
          from github import Github

          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          g = Github(os.environ['GITHUB_TOKEN'])

          repo = g.get_repo(os.environ['GITHUB_REPOSITORY'])
          issue_number = os.environ['ISSUE_NUMBER']
          issue = repo.get_issue(number=issue_number)

          prompt = f"以下のIssueの内容に基づいてコードを修正してください:\n\nタイトル: {issue.title}\n内容: {issue.body}"
          model = genai.GenerativeModel('gemini-pro')
          response = model.generate_content(prompt)

          print(f"MODIFIED_CODE<<EOF\n{response.text}\nEOF")
          EOF_PY
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update file on GitHub
        run: |
          python <<EOF_PY
          import os
          from github import Github

          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['GITHUB_REPOSITORY'])
          file_path = "path/to/your/file.py"  # 修正対象ファイルのパス
          branch_name = f"fix-issue-${{ steps.issue.outputs.ISSUE_NUMBER }}"

          contents = repo.get_contents(file_path, ref=os.environ['GITHUB_REF_NAME'])
          new_content = os.environ['MODIFIED_CODE']
          commit_message = f"Fix issue #${{ steps.issue.outputs.ISSUE_NUMBER }} with LLM"

          repo.update_file(contents.path, commit_message, new_content, contents.sha, branch=branch_name)
          EOF_PY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODIFIED_CODE: ${{ steps.gemini.outputs.MODIFIED_CODE }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Create pull request
        run: |
          python <<EOF
          import os
          from github import Github

          g = Github(os.environ['GITHUB_TOKEN'])
          repo = g.get_repo(os.environ['GITHUB_REPOSITORY'])
          branch_name = f"fix-issue-${{ steps.issue.outputs.ISSUE_NUMBER }}"
          base_branch = "${{ github.event.issue.base.ref }}"
          title = f"Fix issue #${{ steps.issue.outputs.ISSUE_NUMBER }} with LLM"
          body = "This pull request was created by an LLM based on the issue."

          repo.create_pull(title=title, body=body, head=branch_name, base=base_branch)
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

### assistant — 2025-03-07T14:49:37.130188+00:00

PyGithub の `repo.get_issue(number)` は文字列ではなく **整数型** を要求しているために起こるエラーです。  
GitHub Actions で環境変数として受け取ると文字列になるので、int に変換してあげる必要があります。  

たとえば以下のように `issue_number = int(os.environ['ISSUE_NUMBER'])` としておけば解決するはずです:

```python
issue_number = int(os.environ['ISSUE_NUMBER'])  # 文字列 → intにキャスト
issue = repo.get_issue(number=issue_number)
```

このように修正して、引数 `number` に整数型を渡してください。

### tool — 2025-03-07T14:49:37.475802+00:00

**エラーの特定と解決**

GitHub Actionsで発生したエラーの原因を探っている。`get_issue`関数が整数を期待しているのに、文字列`'5'`が渡されている。環境変数`'5'`が原因かもとの見方。

**エラー原因の特定**

`get_issue`関数が整数を要求しているのに、環境変数`'5'`の文字列が渡されている。解決策としては、`issue_number`を整数に変換して渡すことが有効。

### user — 2025-03-07T14:49:37.904000+00:00

Run python <<EOF_PY
Traceback (most recent call last):
  File "<stdin>", line 10, in <module>
  File "/opt/hostedtoolcache/Python/3.9.21/x64/lib/python3.9/site-packages/github/Repository.py", line 3086, in get_issue
    assert isinstance(number, int), number
AssertionError: 5
のエラーが発生する
