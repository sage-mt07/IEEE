---
conversation_id: "a686c0e6-1c55-40f7-b52b-d5f4107e826f"
title: "Azure Load Testing 手順"
create_time: 1721606053.165485
update_time: 1721656621.366259
language_guess: "en"
num_messages: 13
part_index: 1
part_count: 1
---

### system — 2024-07-21T23:54:13.165485+00:00

_(empty)_

### user — 2024-07-21T23:54:13.170348+00:00

以下の条件での負荷テスト実施する手順を示せ
・Azure Load Testingを利用する
・対象のAPIはAzure Entra IDを利用した認証をおこなっている

### assistant — 2024-07-21T23:54:32.188403+00:00

_(empty)_

### assistant — 2024-07-21T23:54:32.188488+00:00

Azure Load Testing を使用して、Azure Entra ID を利用した認証を持つ API に対する負荷テストを実施する手順は以下の通りです。

### 手順

#### 1. Azure Load Testing リソースの作成

1. **Azure ポータル**にサインインします。
2. 左側のナビゲーションパネルから「**作成リソース**」をクリックします。
3. 「**Load Testing**」と検索し、「**Azure Load Testing**」を選択します。
4. 「**作成**」をクリックし、必要な情報を入力してリソースを作成します。
   - サブスクリプション
   - リソースグループ
   - 名前
   - リージョン

#### 2. JMeter テストプランの作成

1. **Apache JMeter**をインストールし、起動します。
2. 新しいテストプランを作成します。
3. テストプランに「**Thread Group**」を追加します。
4. Thread Group に「**HTTP Request Defaults**」を追加し、API の基本 URL を設定します。
5. Thread Group に「**HTTP Request**」を追加し、具体的な API エンドポイントを設定します。
6. 認証トークンの取得と設定を行うため、「**PreProcessor**」として「**HTTP Header Manager**」を追加します。

#### 3. 認証トークンの取得

Azure Entra ID で認証を行うには、事前にアクセストークンを取得する必要があります。このために、スクリプトを作成します。

1. 「**Thread Group**」に「**BeanShell PreProcessor**」を追加します。
2. 以下のようなスクリプトを使用して、アクセストークンを取得します。

```java
import java.io.*;
import java.net.*;
import org.json.JSONObject;

// Azure AD の認証情報
String tenantId = "YOUR_TENANT_ID";
String clientId = "YOUR_CLIENT_ID";
String clientSecret = "YOUR_CLIENT_SECRET";
String resource = "YOUR_API_RESOURCE_ID";

// トークンエンドポイント
String tokenEndpoint = "https://login.microsoftonline.com/" + tenantId + "/oauth2/token";

URL url = new URL(tokenEndpoint);
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setRequestMethod("POST");
conn.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
conn.setDoOutput(true);

String data = "grant_type=client_credentials&client_id=" + clientId + "&client_secret=" + clientSecret + "&resource=" + resource;
OutputStream os = conn.getOutputStream();
os.write(data.getBytes());
os.flush();

BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
String inputLine;
StringBuffer response = new StringBuffer();
while ((inputLine = in.readLine()) != null) {
    response.append(inputLine);
}
in.close();

JSONObject json = new JSONObject(response.toString());
String accessToken = json.getString("access_token");

// トークンを変数として設定
vars.put("accessToken", accessToken);
```

3. 取得したアクセストークンを使用して API リクエストを行うように設定します。
4. 「**HTTP Header Manager**」で Authorization ヘッダーを設定します。

```java
Authorization: Bearer ${accessToken}
```

#### 4. 負荷テストの実行

1. 作成した JMeter テストプランを保存します。
2. Azure ポータルに戻り、作成した Azure Load Testing リソースを選択します。
3. 「**テスト**」タブで「**新しいテストを作成**」をクリックします。
4. テストの設定を行います。
   - テストの名前
   - テストプランファイル (JMeter スクリプト) のアップロード
   - 負荷プロファイルの設定 (ユーザー数、持続時間など)
5. 「**作成**」をクリックし、テストを実行します。

#### 5. 結果の確認

1. テストが完了すると、結果が Azure ポータルに表示されます。
2. 各メトリック (応答時間、成功率、失敗率など) を確認し、API のパフォーマンスを評価します。

これで、Azure Load Testing を使用して Azure Entra ID を利用した認証を持つ API に対する負荷テストを実施する手順は完了です。

### user — 2024-07-21T23:55:13.621231+00:00

Azure EntraIDではclient secretを利用していない

### assistant — 2024-07-21T23:55:39.385477+00:00

Azure Entra ID (以前のAzure AD)でClient Secretを利用せず、例えばCertificate (クライアント証明書)を使用する場合の負荷テストの手順を以下に示します。

### 手順

#### 1. Azure Load Testing リソースの作成

1. **Azure ポータル**にサインインします。
2. 左側のナビゲーションパネルから「**作成リソース**」をクリックします。
3. 「**Load Testing**」と検索し、「**Azure Load Testing**」を選択します。
4. 「**作成**」をクリックし、必要な情報を入力してリソースを作成します。
   - サブスクリプション
   - リソースグループ
   - 名前
   - リージョン

#### 2. JMeter テストプランの作成

1. **Apache JMeter**をインストールし、起動します。
2. 新しいテストプランを作成します。
3. テストプランに「**Thread Group**」を追加します。
4. Thread Group に「**HTTP Request Defaults**」を追加し、API の基本 URL を設定します。
5. Thread Group に「**HTTP Request**」を追加し、具体的な API エンドポイントを設定します。
6. 認証トークンの取得と設定を行うため、「**PreProcessor**」として「**HTTP Header Manager**」を追加します。

#### 3. 認証トークンの取得

Azure Entra ID で認証を行うには、事前にアクセストークンを取得する必要があります。このために、スクリプトを作成します。

1. 「**Thread Group**」に「**BeanShell PreProcessor**」を追加します。
2. 以下のようなスクリプトを使用して、アクセストークンを取得します。

```java
import java.io.*;
import java.net.*;
import java.security.KeyFactory;
import java.security.PrivateKey;
import java.security.Signature;
import java.security.spec.PKCS8EncodedKeySpec;
import java.util.Base64;
import org.json.JSONObject;

String tenantId = "YOUR_TENANT_ID";
String clientId = "YOUR_CLIENT_ID";
String certPath = "PATH_TO_YOUR_CERTIFICATE";
String keyPath = "PATH_TO_YOUR_PRIVATE_KEY";
String resource = "YOUR_API_RESOURCE_ID";

// トークンエンドポイント
String tokenEndpoint = "https://login.microsoftonline.com/" + tenantId + "/oauth2/v2.0/token";

// 認証要求の準備
String jwtHeader = "{\"alg\":\"RS256\",\"typ\":\"JWT\"}";
String jwtPayload = "{\"aud\":\"" + tokenEndpoint + "\",\"iss\":\"" + clientId + "\",\"sub\":\"" + clientId + "\",\"jti\":\"" + java.util.UUID.randomUUID().toString() + "\",\"exp\":" + (System.currentTimeMillis() / 1000 + 3600) + "}";

String encodedHeader = Base64.getUrlEncoder().encodeToString(jwtHeader.getBytes("UTF-8"));
String encodedPayload = Base64.getUrlEncoder().encodeToString(jwtPayload.getBytes("UTF-8"));
String toSign = encodedHeader + "." + encodedPayload;

PKCS8EncodedKeySpec spec = new PKCS8EncodedKeySpec(Files.readAllBytes(Paths.get(keyPath)));
PrivateKey privateKey = KeyFactory.getInstance("RSA").generatePrivate(spec);
Signature signature = Signature.getInstance("SHA256withRSA");
signature.initSign(privateKey);
signature.update(toSign.getBytes("UTF-8"));
String signedJwt = Base64.getUrlEncoder().encodeToString(signature.sign());

String clientAssertion = toSign + "." + signedJwt;

// トークンリクエスト
URL url = new URL(tokenEndpoint);
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setRequestMethod("POST");
conn.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
conn.setDoOutput(true);

String data = "grant_type=client_credentials&client_id=" + clientId + "&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&client_assertion=" + clientAssertion + "&scope=" + resource + "/.default";
OutputStream os = conn.getOutputStream();
os.write(data.getBytes());
os.flush();

BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
String inputLine;
StringBuffer response = new StringBuffer();
while ((inputLine = in.readLine()) != null) {
    response.append(inputLine);
}
in.close();

JSONObject json = new JSONObject(response.toString());
String accessToken = json.getString("access_token");

// トークンを変数として設定
vars.put("accessToken", accessToken);
```

3. 取得したアクセストークンを使用して API リクエストを行うように設定します。
4. 「**HTTP Header Manager**」で Authorization ヘッダーを設定します。

```java
Authorization: Bearer ${accessToken}
```

#### 4. 負荷テストの実行

1. 作成した JMeter テストプランを保存します。
2. Azure ポータルに戻り、作成した Azure Load Testing リソースを選択します。
3. 「**テスト**」タブで「**新しいテストを作成**」をクリックします。
4. テストの設定を行います。
   - テストの名前
   - テストプランファイル (JMeter スクリプト) のアップロード
   - 負荷プロファイルの設定 (ユーザー数、持続時間など)
5. 「**作成**」をクリックし、テストを実行します。

#### 5. 結果の確認

1. テストが完了すると、結果が Azure ポータルに表示されます。
2. 各メトリック (応答時間、成功率、失敗率など) を確認し、API のパフォーマンスを評価します。

これで、Azure Load Testing を使用して Azure Entra ID を利用した認証を持つ API に対する負荷テストを実施する手順は完了です。

### user — 2024-07-22T03:31:57.158523+00:00

上記スクリプトはpowershellで記述できないのか

### assistant — 2024-07-22T03:32:35.400364+00:00

PowerShellで同じタスクを行うスクリプトを以下に示します。このスクリプトはAzure Entra IDを使用して認証トークンを取得し、そのトークンを使用してAPIにリクエストを送信するためのものです。

### 手順

#### 1. PowerShellスクリプトの作成

まず、PowerShellスクリプトを作成します。このスクリプトは、認証トークンを取得し、JMeterの変数として設定するためのものです。

```powershell
# PowerShellでJWTを作成し、Azure Entra IDからトークンを取得するスクリプト

param(
    [string]$tenantId = "YOUR_TENANT_ID",
    [string]$clientId = "YOUR_CLIENT_ID",
    [string]$certPath = "PATH_TO_YOUR_CERTIFICATE",
    [string]$keyPath = "PATH_TO_YOUR_PRIVATE_KEY",
    [string]$resource = "YOUR_API_RESOURCE_ID"
)

# JWTの作成に必要な情報
$tokenEndpoint = "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token"
$jwtHeader = @{
    alg = "RS256"
    typ = "JWT"
} | ConvertTo-Json | % { [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($_)).TrimEnd('=') }

$jwtPayload = @{
    aud = $tokenEndpoint
    iss = $clientId
    sub = $clientId
    jti = [Guid]::NewGuid().ToString()
    exp = [Math]::Floor((Get-Date).AddHours(1).ToUniversalTime().Subtract([datetime]'[[REDACTED_PHONE]]').TotalSeconds)
} | ConvertTo-Json | % { [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($_)).TrimEnd('=') }

$toSign = "$jwtHeader.$jwtPayload"

# Private Keyの読み込みと署名
$key = [Convert]::FromBase64String((Get-Content -Path $keyPath -Raw) -replace '\s', '')
$pkcs8 = New-Object Security.Cryptography.Pkcs8PrivateKeyInfo
$privateKey = $pkcs8.Decode($key)
$signer = New-Object System.Security.Cryptography.RSACryptoServiceProvider
$signer.ImportParameters($privateKey)

$signedJwt = [Convert]::ToBase64String($signer.SignData([Text.Encoding]::UTF8.GetBytes($toSign), 'SHA256'))

$clientAssertion = "$toSign.$signedJwt"

# トークンリクエスト
$body = @{
    grant_type = "client_credentials"
    client_id = $clientId
    client_assertion_type = "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
    client_assertion = $clientAssertion
    scope = "$resource/.default"
}

$response = Invoke-RestMethod -Method Post -Uri $tokenEndpoint -ContentType "application/x-www-form-urlencoded" -Body $body

# アクセストークンの取得
$accessToken = $response.access_token

# トークンをファイルに保存（JMeterで使用するため）
Set-Content -Path "accessToken.txt" -Value $accessToken
```

#### 2. JMeterの設定

1. **Apache JMeter**をインストールし、起動します。
2. 新しいテストプランを作成します。
3. テストプランに「**Thread Group**」を追加します。
4. Thread Group に「**HTTP Request Defaults**」を追加し、API の基本 URL を設定します。
5. Thread Group に「**HTTP Request**」を追加し、具体的な API エンドポイントを設定します。
6. 認証トークンの設定を行うため、「**PreProcessor**」として「**BeanShell PreProcessor**」を追加します。

#### 3. BeanShell PreProcessorでトークンを読み込む

JMeterのBeanShell PreProcessorで、PowerShellスクリプトが生成したトークンを読み込み、APIリクエストのヘッダーに設定します。

```java
// BeanShell PreProcessorでトークンを読み込む
String accessToken = new String(Files.readAllBytes(Paths.get("accessToken.txt")), StandardCharsets.UTF_8).trim();
vars.put("accessToken", accessToken);
```

#### 4. HTTP Header Managerの設定

1. 「**HTTP Header Manager**」を追加し、Authorization ヘッダーを設定します。

```java
Authorization: Bearer ${accessToken}
```

#### 5. 負荷テストの実行

1. 作成したJMeterテストプランを保存します。
2. Azureポータルに戻り、作成したAzure Load Testingリソースを選択します。
3. 「**テスト**」タブで「**新しいテストを作成**」をクリックします。
4. テストの設定を行います。
   - テストの名前
   - テストプランファイル (JMeterスクリプト) のアップロード
   - 負荷プロファイルの設定 (ユーザー数、持続時間など)
5. 「**作成**」をクリックし、テストを実行します。

#### 6. 結果の確認

1. テストが完了すると、結果がAzureポータルに表示されます。
2. 各メトリック (応答時間、成功率、失敗率など) を確認し、API のパフォーマンスを評価します。

これで、Azure Load Testingを使用してAzure Entra IDを利用した認証を持つAPIに対する負荷テストをPowerShellスクリプトを使用して実施する手順は完了です。

### user — 2024-07-22T03:32:50.959752+00:00

azure load testingではjmeter以外を使用することはできないのか

### assistant — 2024-07-22T03:33:17.470169+00:00

Azure Load Testingでは、JMeter以外のツールを使用することも可能です。具体的には、LoadRunnerやGatlingといった他の負荷テストツールもサポートされています。以下に、LoadRunnerを使用してAzure Entra ID認証を持つAPIに対する負荷テストを実施する手順を示します。

### 手順

#### 1. LoadRunnerのスクリプト作成

まず、LoadRunnerを使用して認証トークンを取得し、APIにリクエストを送信するためのスクリプトを作成します。

##### 1.1 LoadRunner VuGenスクリプトの作成

LoadRunner VuGen (Virtual User Generator) を使用して、HTTPリクエストのスクリプトを作成します。

```c
// Include necessary libraries
#include "web_api.h"

// Define global variables
char accessToken[2048];

// Action function for VuGen script
Action()
{
    // Azure AD OAuth2 token endpoint
    char *tokenEndpoint = "https://login.microsoftonline.com/YOUR_TENANT_ID/oauth2/v2.0/token";

    // Client assertion JWT
    char *clientAssertion = "YOUR_CLIENT_ASSERTION_JWT";

    // API resource ID
    char *resource = "YOUR_API_RESOURCE_ID";

    // Create token request body
    lr_save_string(
        "grant_type=client_credentials&client_id=YOUR_CLIENT_ID"
        "&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
        "&client_assertion=YOUR_CLIENT_ASSERTION_JWT&scope=YOUR_API_RESOURCE_ID/.default",
        "requestBody");

    // Send token request
    web_custom_request("GetToken",
        "URL=https://login.microsoftonline.com/YOUR_TENANT_ID/oauth2/v2.0/token",
        "Method=POST",
        "Resource=0",
        "RecContentType=application/json",
        "Referer=",
        "Snapshot=t1.inf",
        "Mode=HTTP",
        "EncType=application/x-www-form-urlencoded",
        "Body={requestBody}",
        LAST);

    // Save the token to a parameter
    web_reg_save_param_ex(
        "ParamName=accessToken",
        "LB={\"access_token\":\"",
        "RB=\"}",
        "Notfound=warning",
        LAST);

    // Print the access token to log
    lr_output_message("Access Token: %s", lr_eval_string("{accessToken}"));

    // Set the authorization header for subsequent requests
    web_add_header("Authorization", lr_eval_string("Bearer {accessToken}"));

    // Example API request using the token
    web_url("API Request",
        "URL=https://YOUR_API_ENDPOINT",
        "Resource=0",
        "RecContentType=application/json",
        "Referer=",
        "Snapshot=t2.inf",
        "Mode=HTTP",
        LAST);

    return 0;
}
```

#### 2. Azure Load Testing リソースの作成

1. **Azure ポータル**にサインインします。
2. 左側のナビゲーションパネルから「**作成リソース**」をクリックします。
3. 「**Load Testing**」と検索し、「**Azure Load Testing**」を選択します。
4. 「**作成**」をクリックし、必要な情報を入力してリソースを作成します。
   - サブスクリプション
   - リソースグループ
   - 名前
   - リージョン

#### 3. LoadRunnerスクリプトのアップロードと設定

1. Azure ポータルで作成したAzure Load Testingリソースを選択します。
2. 「**テスト**」タブで「**新しいテストを作成**」をクリックします。
3. テストの設定を行います。
   - テストの名前
   - LoadRunnerスクリプトのアップロード
   - 負荷プロファイルの設定（ユーザー数、持続時間など）
4. 「**作成**」をクリックし、テストを実行します。

#### 4. 結果の確認

1. テストが完了すると、結果がAzureポータルに表示されます。
2. 各メトリック（応答時間、成功率、失敗率など）を確認し、APIのパフォーマンスを評価します。

これで、Azure Load Testingを使用してLoadRunnerを用いた負荷テストを実施する手順は完了です。他のツールを使用する場合も、基本的な手順は同様ですので、各ツールの仕様に合わせてスクリプトを作成し、Azure Load Testingにアップロードしてテストを実行します。

### user — 2024-07-22T03:33:39.474118+00:00

Gatlingの例を

### assistant — 2024-07-22T03:34:09.857279+00:00

Gatlingを使用して、Azure Entra IDを利用した認証を持つAPIに対する負荷テストを実施する手順を以下に示します。

### 手順

#### 1. Gatlingのインストール

まず、Gatlingをインストールします。公式サイトからダウンロードできます。

#### 2. テストシナリオの作成

Gatlingを使用して、アクセストークンを取得し、そのトークンを使ってAPIリクエストを送信するシナリオを作成します。以下に、Scalaで記述されたGatlingのスクリプトの例を示します。

##### 2.1 トークン取得用スクリプトの作成

```scala
import scala.concurrent.duration._

import io.gatling.core.Predef._
import io.gatling.http.Predef._
import io.gatling.core.structure.ScenarioBuilder

class AzureEntraIDSimulation extends Simulation {

  // Azure ADの設定
  val tenantId = "YOUR_TENANT_ID"
  val clientId = "YOUR_CLIENT_ID"
  val clientSecret = "YOUR_CLIENT_SECRET"
  val resource = "YOUR_API_RESOURCE_ID"

  // HTTPプロトコル設定
  val httpProtocol = http
    .baseUrl("https://login.microsoftonline.com")
    .inferHtmlResources()

  // 認証トークンを取得するシナリオ
  val authScenario: ScenarioBuilder = scenario("Azure Entra ID Authentication")
    .exec(
      http("Get Token")
        .post(s"/${tenantId}/oauth2/v2.0/token")
        .formParam("grant_type", "client_credentials")
        .formParam("client_id", clientId)
        .formParam("client_secret", clientSecret)
        .formParam("scope", s"${resource}/.default")
        .check(jsonPath("$.access_token").saveAs("accessToken"))
    )
    .pause(1)

  // 取得したトークンを使用してAPIにリクエストを送信するシナリオ
  val apiScenario: ScenarioBuilder = scenario("API Request with Token")
    .exec(
      http("API Request")
        .get("https://YOUR_API_ENDPOINT")
        .header("Authorization", "Bearer ${accessToken}")
        .check(status.is(200))
    )

  // シミュレーションの設定
  setUp(
    authScenario.inject(atOnceUsers(1)).protocols(httpProtocol),
    apiScenario.inject(rampUsers(10) during (30 seconds)).protocols(httpProtocol)
  )
}
```

#### 3. Gatlingシミュレーションの実行

1. 上記のスクリプトをGatlingのプロジェクトディレクトリの`src/test/scala`フォルダに保存します。
2. コマンドラインからGatlingのホームディレクトリに移動し、以下のコマンドを実行してシミュレーションを開始します。

```sh
bin/gatling.sh
```

3. インタラクティブメニューが表示されるので、シミュレーションのクラス名（例：`AzureEntraIDSimulation`）を選択してテストを実行します。

#### 4. Azure Load Testing リソースの作成

1. **Azure ポータル**にサインインします。
2. 左側のナビゲーションパネルから「**作成リソース**」をクリックします。
3. 「**Load Testing**」と検索し、「**Azure Load Testing**」を選択します。
4. 「**作成**」をクリックし、必要な情報を入力してリソースを作成します。
   - サブスクリプション
   - リソースグループ
   - 名前
   - リージョン

#### 5. Gatlingシミュレーションのアップロードと設定

1. Azureポータルで作成したAzure Load Testingリソースを選択します。
2. 「**テスト**」タブで「**新しいテストを作成**」をクリックします。
3. テストの設定を行います。
   - テストの名前
   - Gatlingシミュレーションのアップロード
   - 負荷プロファイルの設定（ユーザー数、持続時間など）
4. 「**作成**」をクリックし、テストを実行します。

#### 6. 結果の確認

1. テストが完了すると、結果がAzureポータルに表示されます。
2. 各メトリック（応答時間、成功率、失敗率など）を確認し、APIのパフォーマンスを評価します。

これで、Azure Load Testingを使用してGatlingを用いた負荷テストを実施する手順は完了です。他のツールを使用する場合も、基本的な手順は同様ですので、各ツールの仕様に合わせてスクリプトを作成し、Azure Load Testingにアップロードしてテストを実行します。
