---
conversation_id: "687ee6db-4c24-8007-b45a-c270da454d61"
title: "CancellationToken キャンセル元判別"
create_time: 1753147099.625504
update_time: 1753147125.76387
language_guess: "en"
num_messages: 6
part_index: 1
part_count: 1
---

### system — 2025-07-22T01:18:19.625504+00:00

_(empty)_

### user — 2025-07-22T01:18:19.625504+00:00

_(empty)_

### user — 2025-07-22T01:18:19.628681+00:00

C#のcanceltoken を親子関係とした場合、どちらの要因でcancelが発生したか確認する方法

### assistant — 2025-07-22T01:18:19.951700+00:00

やあ、いらっしゃい！困ってること、気になること、なんでも聞いてみてください〜  
**（送信日時：[[REDACTED_PHONE]]:39 JST）**

---

`CancellationToken` の**親子関係（リンクされたトークン）**において、「**どちらの要因でキャンセルが発生したか**」を**直接知る方法はありません**。  
しかし、以下の方法で**間接的に判別**することが可能です。

---

## 🔧 方法1：**複数トークンにコールバックを登録して追跡**

```csharp
var ctsParent = new CancellationTokenSource();
var ctsChild = new CancellationTokenSource();
var linkedCts = CancellationTokenSource.CreateLinkedTokenSource(ctsParent.Token, ctsChild.Token);

bool cancelledByParent = false;
bool cancelledByChild = false;

ctsParent.Token.Register(() => cancelledByParent = true);
ctsChild.Token.Register(() => cancelledByChild = true);

try
{
    await SomeOperationAsync(linkedCts.Token);
}
catch (OperationCanceledException)
{
    if (cancelledByParent)
        Console.WriteLine("キャンセルは親トークンによって発生しました。");
    else if (cancelledByChild)
        Console.WriteLine("キャンセルは子トークンによって発生しました。");
    else
        Console.WriteLine("キャンセルの原因は特定できません。");
}
```

---

## 💡 方法2：**ラップクラスでキャンセル要因を記録する**

独自の `MyCancellationSource` などを作って、キャンセルの発火元をログ・記録しておく設計もあります。たとえば：

```csharp
enum CancelReason
{
    None,
    Parent,
    Child
}

class TrackableCancellation
{
    public CancelReason Reason { get; private set; } = CancelReason.None;
    public CancellationToken Token => _linked.Token;

    private readonly CancellationTokenSource _linked;
    private readonly CancellationTokenSource _ctsParent;
    private readonly CancellationTokenSource _ctsChild;

    public TrackableCancellation(CancellationToken parent, CancellationToken child)
    {
        _ctsParent = CancellationTokenSource.CreateLinkedTokenSource(parent);
        _ctsChild = CancellationTokenSource.CreateLinkedTokenSource(child);
        _linked = CancellationTokenSource.CreateLinkedTokenSource(_ctsParent.Token, _ctsChild.Token);

        parent.Register(() => Reason = CancelReason.Parent);
        child.Register(() => Reason = CancelReason.Child);
    }
}
```

---

## 🧠 注意点
- `.IsCancellationRequested` や `ThrowIfCancellationRequested()` では**発火元の情報は取れない**。
- 複数トークンのキャンセルをリンクした場合、**どれが先かの順序**を記録しないと後からはわからない。

---

## ✅ まとめ

| 方法 | 内容 | 備考 |
|------|------|------|
| コールバックでフラグ | 最も簡単かつ実用的 | 多用するとコードが煩雑になる |
| ラップクラスで原因記録 | テスト・ロギングに最適 | 実装と設計がやや重くなる |

---

必要なら、ラップクラス化の雛形も整えます！  
ご希望あれば具体的なユースケースを聞かせてくださいね。

### assistant — 2025-07-22T01:18:31.534908+00:00

_(empty)_
