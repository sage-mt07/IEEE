---
conversation_id: "6724e45f-cbe4-8007-b612-8af64a50e9e7"
title: "App Service パフォーマンス確認"
create_time: 1730471008.122216
update_time: 1730471661.253488
language_guess: "en"
num_messages: 11
part_index: 1
part_count: 1
---

### system — 2024-11-01T14:23:28.122216+00:00

_(empty)_

### user — 2024-11-01T14:23:28.131635+00:00

App ServiceにBlazor webassemblyとapiを同梱したサービスを展開している
特定の時間帯に遅い、つながらないの問い合わせが発生した。
まず何から確認すればよいのか

### assistant — 2024-11-01T14:23:50.042365+00:00

_(empty)_

### assistant — 2024-11-01T14:23:50.042460+00:00

App Service上のBlazor WebAssemblyとAPIで特定の時間帯に遅延や接続不能の問題が発生している場合、以下の点を確認すると原因の特定に役立ちます：

1. **App Serviceの監視データの確認**  
   Azure Portalの「監視」機能を使い、特定の時間帯にCPU、メモリ、ディスクI/O、ネットワーク帯域などのリソース使用率を確認します。リソースが高負荷状態にあれば、スケールアウトやスケールアップを検討します。

2. **App Serviceのインスタンス数とスケール設定の確認**  
   特定の時間帯にトラフィックが集中する可能性があるため、App Serviceのスケール設定を確認します。スケールアウトの設定を自動にしていない場合、手動でインスタンス数を増やすか、スケールアウトポリシーを変更します。

3. **Application Insightsでの詳細ログ調査**  
   Application Insightsを有効にしている場合、リクエストのレスポンス時間や失敗率を分析し、特定のエンドポイントやクエリが遅延や失敗の原因となっているか確認します。

4. **外部依存の確認**  
   APIが外部サービスや他のAzureリソース（データベース、Azure ADなど）に依存している場合、その依存先でパフォーマンスの問題や接続遅延が発生しているか確認します。

5. **エラーや例外ログの確認**  
   エラーログに接続エラーやタイムアウトの例外が発生していないかを確認します。特に高負荷時にリクエストが増加し、接続プールの枯渇やスロットリングが原因で失敗することがあります。

6. **ネットワークと負荷テストの確認**  
   特定の時間帯にユーザー数が急増する場合、負荷テストを実施してシミュレーションし、スロットリングが発生するかを確認します。また、Azureのリージョン間でネットワークの遅延があるかを確認します。

これらを順番に調査し、問題の時間帯にどのような要因が影響しているのかを明確にすることで、次のアクションが見えてきます。

### user — 2024-11-01T14:24:02.328557+00:00

Azure ADを認証に使用している

### assistant — 2024-11-01T14:24:31.612675+00:00

Azure ADを認証に使用している場合、特定の時間帯に遅延や接続不能の問題が発生する原因として、以下の点も確認するとよいでしょう：

1. **Azure ADのスロットリング制限**  
   Azure ADにはAPI呼び出しのスロットリング制限があります。特に高負荷な時間帯に、同時に多くの認証リクエストが発生すると、制限に引っかかり、認証処理が遅くなったり失敗したりすることがあります。Graph APIを使用している場合、[リクエスト制限](https://learn.microsoft.com/ja-jp/graph/throttling)を確認し、適切なリトライや遅延処理を導入します。

2. **エラーログの確認**  
   認証関連のエラーが特定の時間帯に増えていないか、Azure ADのログやApplication Insightsで確認します。特に`401 Unauthorized`や`403 Forbidden`エラー、または`invalid_token`のエラーメッセージが発生していないかを確認します。

3. **App ServiceとAzure ADの接続設定**  
   App Service側で設定されているAzure ADの接続設定（例：リダイレクトURIやエンドポイントの有効性）に誤りがないかを再確認します。また、Azure ADのトークンキャッシュ設定やリフレッシュトークンの有効期限が短すぎないか確認します。

4. **認証トークンの有効期限**  
   特定の時間帯にアクセスが集中し、トークンの有効期限が切れているときに再認証が発生する場合、App Service側のキャッシュ設定やリフレッシュトークンの使用方法を見直すとよいでしょう。トークン更新時にAzure ADへのリクエストが集中すると、遅延の原因となります。

5. **アプリケーションの接続プール**  
   Azure AD認証後のHttpClient接続プールやAPIリクエストが影響していないか確認します。App Service上のAPI側で、認証リクエストのハンドリングとバックエンドとの接続プール設定が適切か確認し、負荷に対応できる構成を確認します。

6. **Application Insightsの依存関係トレース**  
   Application Insightsの「依存関係」機能で、Azure ADや他のリソースとの認証に関する遅延やエラーがあるかを確認します。特にAzure ADの認証リクエストやトークン発行が遅延する場合、その状況を可視化することで原因究明の手がかりになります。

これらを確認し、特定の時間帯の認証負荷やAzure ADのスロットリングによる影響を評価することで、対策を講じることができます。

### user — 2024-11-01T14:25:20.800779+00:00

Azure ADのログで認証関連を確認する方法

### assistant — 2024-11-01T14:25:57.411301+00:00

Azure ADで認証関連のログを確認するには、Azureポータルから「監査ログ」と「サインインログ」を使用する方法が有効です。以下に具体的な手順を示します。

### 1. Azureポータルでサインインログを確認する
サインインログには、Azure ADを通じて行われた認証試行の詳細情報が記録されています。遅延や接続問題が発生した時間帯のログを確認すると、認証エラーやスロットリングの発生状況を把握できます。

#### 手順:
1. **Azureポータルにアクセス**し、「Azure Active Directory」サービスに移動します。
2. 左側のメニューから「**サインインログ**」を選択します。
3. **期間のフィルター**を使って問題が発生した時間帯を選択します。
4. **ユーザー名**、**アプリケーション名**（Blazor WebAssemblyやAPIのアプリ名）、**状態**でフィルターを適用して、特定のエラーや失敗を絞り込みます。

#### 確認ポイント:
- **ステータス**: 成功、失敗、もしくは条件付きアクセスのブロックが発生しているか。
- **クライアントアプリケーション**: WebやAPIのリクエストが問題の原因か確認します。
- **詳細**: エラーコードやメッセージ（例: `AADSTS50196`など）を確認し、特定のエラーが繰り返し発生していないかを確認します。

### 2. 監査ログでの詳細な操作の確認
監査ログには、Azure AD内での各種操作が記録されています。設定変更やアカウントのロックアウト、条件付きアクセスポリシーの適用などが原因で問題が発生している場合、監査ログで詳細を確認します。

#### 手順:
1. 同様に「Azure Active Directory」サービスに移動し、左メニューから「**監査ログ**」を選択します。
2. **イベントの種類**で「ログイン」または「条件付きアクセス」関連のイベントにフィルターをかけ、該当の操作が問題の時間帯に影響していないか確認します。

### 3. Application Insightsとの連携による依存関係の確認
Azure ADの認証エラーや遅延が特定のアプリケーションに与える影響をより詳細に分析するには、Application Insightsと連携して依存関係のトレースを確認することも効果的です。特にAzure AD認証に伴う遅延やエラー発生の状況を可視化できます。

#### 手順:
1. Application Insightsを有効にしている場合、「依存関係」タブからAzure ADの認証に関連する依存関係を特定します。
2. 遅延が生じている認証リクエストや失敗しているリクエストのパターンを確認します。

### 4. エラーコードの確認と対策
サインインログで特定のエラーコードが頻発している場合、そのエラーコードに基づき対策を検討します。以下は一般的なエラーコードの例です。

- **AADSTS50020**: ユーザーの認証に失敗しました（異なるテナントのアカウントを使用している可能性があります）。
- **AADSTS50076**: 条件付きアクセスや多要素認証（MFA）の要求が原因です。
- **AADSTS50196**: トークンキャッシュの制限などでトークンの発行に失敗しています。

エラーコードの詳細は、[Azure ADの公式ドキュメント](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/reference-aadsts-error-codes)で確認できます。

以上の方法でAzure ADのログを確認し、問題の原因を特定することで、対策を講じやすくなります。

### user — 2024-11-01T14:33:54.337142+00:00

このような事柄が発生したときに速やかに調査可能か？

### assistant — 2024-11-01T14:34:20.662736+00:00

Azure ADのログを活用して速やかに調査を行うには、以下の準備を行うと効率的です。これにより、問題が発生した際に迅速に対応できるようになります。

### 1. **監視とアラートの自動化**
   - **アラートの設定**  
     特定のエラーや異常が発生した際に自動でアラートが届くよう、Azure Monitorを使用してアラートを設定します。たとえば、「サインインログ」や「監査ログ」に基づき、特定のエラーコードや失敗イベントが一定回数以上発生した場合にアラートが出るようにします。
   - **定期的なメトリクス監視**  
     Application InsightsやAzure Monitorのメトリクスを使って、遅延や認証失敗が一定の閾値を超えた場合に自動通知する設定も有効です。

### 2. **ログの保管と分析環境の整備**
   - **Log Analytics ワークスペースの活用**  
     Azure ADのログをLog Analyticsワークスペースに接続することで、ログデータを長期間保管し、クエリによる迅速な検索が可能になります。特にKQL（Kusto Query Language）を使ったクエリをあらかじめ準備しておけば、問題が発生した際にすぐに原因を絞り込むことができます。
   - **Application Insightsと統合**  
     Application InsightsとAzure ADのログを組み合わせて確認できるようにすることで、アプリケーションのエラーや遅延の原因が認証周りで発生しているかどうかをすぐに特定できます。

### 3. **特定の問題発生時の調査手順のマニュアル化**
   - 問題発生時の調査フローをあらかじめ定義しておき、関連ログの確認方法やエラーコードの対処方法をまとめた手順書を用意すると、迅速な対応が可能です。  
   - また、トラブルシューティングの実践的なチェックリストをチームで共有しておけば、必要な情報を漏れなく調査できます。

### 4. **キャッシュや負荷分散設定の最適化**
   - Azure ADの認証はキャッシュの影響を受けやすいため、トークンのキャッシュ設定やリフレッシュトークンの有効期限設定も見直します。また、負荷が予想される時間帯には、スケールアウトや接続プールの設定が適切に行われているか確認します。
  
### 5. **担当者のアラートと通知の整備**
   - 認証失敗や遅延の重要なアラートを受信する担当者やグループを明確にしておくと、問題が発生した際の対応速度が上がります。Teamsやメール通知、あるいは専用のアラート管理ツール（PagerDuty、OpsGenieなど）を使うとスムーズです。

以上の準備をしておくと、Azure ADを使った認証に関する問題が発生したときにも迅速に調査・対策が可能になります。
