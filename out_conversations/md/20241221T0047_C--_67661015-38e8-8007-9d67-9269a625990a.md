---
conversation_id: "67661015-38e8-8007-9d67-9269a625990a"
title: "C# クロージャ 解説"
create_time: 1734742037.37055
update_time: 1734742052.61179
language_guess: "en"
num_messages: 5
part_index: 1
part_count: 1
---

### system — 2024-12-21T00:47:17.370550+00:00

_(empty)_

### user — 2024-12-21T00:47:17.374519+00:00

ｃ#のクロージャとは

### assistant — 2024-12-21T00:47:31.561888+00:00

_(empty)_

### assistant — 2024-12-21T00:47:31.562016+00:00

C#の**クロージャ（Closure）**とは、**メソッドやラムダ式が、その外側で定義された変数（ローカル変数やパラメーター）への参照を持ち続ける機能**のことを指します。つまり、クロージャは関数やラムダ式のスコープが拡張され、そのスコープ外で定義された変数を捕捉して保持する仕組みを提供します。

### 具体例
以下はクロージャの基本的な例です：

```csharp
using System;

class Program
{
    static void Main()
    {
        int count = 0;

        // クロージャ：外部スコープの変数 count をキャプチャして利用
        Action increment = () =>
        {
            count++;
            Console.WriteLine($"Count: {count}");
        };

        increment(); // Count: 1
        increment(); // Count: 2
        increment(); // Count: 3
    }
}
```

この例では、ラムダ式（`increment`）が外部の変数`count`をキャプチャしています。その結果、ラムダ式内で`count`を操作すると、`count`の状態が保持されます。

---

### 特徴と注意点

1. **変数のキャプチャ**:
   - クロージャは**参照として変数をキャプチャ**します。そのため、元の変数の値が変わると、クロージャ内でもその変更が反映されます。

2. **匿名メソッドやラムダ式**:
   - クロージャは、主に**匿名メソッド**や**ラムダ式**で使用されます。

3. **キャプチャの注意点**:
   - ループ内で変数をキャプチャする場合、意図しない挙動が起きることがあります。例えば以下の例：

```csharp
using System;
using System.Collections.Generic;

class Program
{
    static void Main()
    {
        var actions = new List<Action>();
        for (int i = 0; i < 3; i++)
        {
            actions.Add(() => Console.WriteLine(i));
        }

        foreach (var action in actions)
        {
            action(); // 3, 3, 3 と出力される
        }
    }
}
```

上記のコードでは、`i`がループのたびにキャプチャされるのではなく、**最後の`i`の値（3）**がすべてのラムダ式で共有されてしまいます。

解決するには、`i`のコピーを使います：

```csharp
for (int i = 0; i < 3; i++)
{
    int copy = i; // コピーを作成
    actions.Add(() => Console.WriteLine(copy));
}
```

---

### 実用例
クロージャは、次のような場面でよく使用されます：

1. **イベント処理**:
   外部の状態を保持しながら、イベントのコールバックを作成します。

2. **非同期処理**:
   非同期タスク内でローカル変数を使用する際に便利です。

3. **部分適用やカスタム関数の生成**:
   状態を保持する関数を動的に作成します。

クロージャは、C#プログラムで柔軟性と表現力を向上させる非常に便利な機能です。
