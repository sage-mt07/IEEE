---
conversation_id: "67b278fd-3f30-8007-b9c0-a8cc80ec8736"
title: "SQLServerデータベース設定クエリ"
create_time: 1739749629.482175
update_time: 1739750397.521201
language_guess: "en"
num_messages: 28
part_index: 1
part_count: 1
---

### system — 2025-02-16T23:47:09.481827+00:00

_(empty)_

### system — 2025-02-16T23:47:09.482175+00:00

_(empty)_

### system — 2025-02-16T23:47:09.482175+00:00

_(empty)_

### user — 2025-02-16T23:47:09.489707+00:00

SQLServerのデータベース設定に関するクエリ

### tool — 2025-02-16T23:47:21.757111+00:00

**考慮中のSQL Server設定クエリ**

ユーザーは「SQL Serverのデータベース設定に関するクエリ」について尋ねている。これは設定を変更するためのクエリか、サーバーの設定を確認するクエリの可能性がある。詳細が不明なので、どのようなクエリが求められているのかを整理する必要がある。データベース設定を設定または取得するためのSQLクエリの例を提供すれば良いかもしれない。

**SQL Server設定クエリ例**

SQL Serverでは、設定を確認・変更するためのストアドプロシージャやビューがいくつかあります。以下に一般的なクエリの例を示します。

1. サーバー設定確認: `EXEC sp_configure;` または `SELECT * FROM sys.configurations;`
2. データベース設定確認: `SELECT name, collation_name, is_read_only FROM sys.databases;`
3. リカバリモデル確認: `SELECT name, recovery_model_desc FROM sys.databases;`
4. 設定変更例: `EXEC sp_configure 'show advanced options', 1; RECONFIGURE;`
5. ALTER DATABASEコマンド: `ALTER DATABASE [YourDatabaseName] SET RECOVERY FULL;`

詳細は公式資料で確認することもできます。

### assistant — 2025-02-16T23:47:21.757196+00:00

以下は、SQL Server のデータベースやサーバー設定を確認・変更するための一般的なクエリ例です。

---

### 1. サーバー全体の構成オプションの確認

SQL Server では、システムストアドプロシージャ `sp_configure` を利用してサーバーの設定状況を確認できます。

```sql
EXEC sp_configure;
```

これにより、基本的な設定が一覧表示されます。詳細なオプション（高度な設定）も確認するには、まず高度なオプションの表示を有効にする必要があります。

```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure;
```

---

### 2. システム設定の詳細確認

サーバー全体の設定について、`sys.configurations` ビューを利用することで、各設定の名前、値、変更可能な状態などを確認できます。

```sql
SELECT name, value, value_in_use, description
FROM sys.configurations;
```

---

### 3. データベース固有の設定確認

各データベースの設定（例えば、照合順序やリカバリモデル、読み取り専用フラグなど）を確認するためのクエリ例です。

**照合順序の確認：**

```sql
SELECT name, collation_name
FROM sys.databases;
```

**リカバリモデルの確認：**

```sql
SELECT name, recovery_model_desc
FROM sys.databases;
```

**読み取り専用の状態確認：**

```sql
SELECT name, is_read_only
FROM sys.databases;
```

---

### 4. データベース設定の変更例

データベースの設定変更には `ALTER DATABASE` 文を使用します。例えば、リカバリモデルを FULL に変更する場合は以下のようになります。

```sql
ALTER DATABASE YourDatabaseName
SET RECOVERY FULL;
```

また、特定のオプションを変更する場合、サーバー全体の設定として `sp_configure` を使う例もあります。

```sql
EXEC sp_configure 'max degree of parallelism', 4;
RECONFIGURE;
```

---

これらのクエリは、SQL Server の管理やパフォーマンス調整、データベース運用の基本的な確認・設定変更に有用です。詳細なオプションや設定値の意味については、Microsoft の公式ドキュメント（例：SQL Server の [sp_configure (Transact-SQL)](https://learn.microsoft.com/ja-jp/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql)）を参照すると、より詳しい情報が得られます。

### user — 2025-02-16T23:48:37.035939+00:00

sys.databasesにはユーザーDBも含まれるのか。特定のDBの設定項目と設定値を取得するクエリは

### tool — 2025-02-16T23:48:45.710337+00:00

**回答の確認**

最初の質問に関して、「sys.databases」にはユーザーデータベースも含まれています。システムデータベースとともに、ユーザーデータベースの情報も表示されるため、答えは「はい」です。

次に、特定のデータベース設定を取得するには、「sys.database_principals」や「sys.database_options」、または「sys.configurations」をクエリする方法があります。「sys.databases」も、例えば「collation_name」や「recovery_model_desc」などのカラムを利用して情報を取得できます。

**クエリの提案**

「sys.databases」はシステムデータベースとユーザーデータベースの両方を含みます。特定のデータベースの設定を取得するには、`sys.databases`で次のようなクエリを実行できます：

```sql
SELECT 
    name,
    collation_name,
    recovery_model_desc,
    state_desc,
    is_auto_close_on,
    is_auto_shrink_on,
    is_read_only
FROM sys.databases
WHERE name = 'YourDatabaseName';
```

また、データベースごとの設定項目は、`sys.database_scoped_configurations`で確認可能ですが、SQL Serverの新しいバージョンでしか使用できない場合があります。

### assistant — 2025-02-16T23:48:45.710439+00:00

はい、sys.databases にはシステムデータベース（master、tempdb、model、msdb）に加えて、ユーザーが作成したデータベースも含まれます。

特定のデータベースの主要な設定項目（照合順序、リカバリモデル、互換性レベル、読み取り専用かどうかなど）を取得するには、以下のようなクエリが考えられます。たとえば、データベース名が「YourDatabaseName」の場合：

```sql
SELECT 
    name,
    collation_name,
    recovery_model_desc,
    state_desc,
    is_read_only,
    is_auto_close_on,
    is_auto_shrink_on,
    compatibility_level
FROM sys.databases
WHERE name = 'YourDatabaseName';
```

また、SQL Server 2016 以降では、データベース固有のスコープ設定を管理するためのビュー `sys.database_scoped_configurations` も利用できます。こちらは、現在のデータベースコンテキストで有効な設定を確認するために使用できます。使用例は以下の通りです：

```sql
USE YourDatabaseName;
GO
SELECT *
FROM sys.database_scoped_configurations;
```

これらのクエリにより、対象データベースの各種設定項目とその値を確認できます。必要に応じて、さらに細かい設定や追加のプロパティを Microsoft の公式ドキュメント（例：citeturn7file4）などでご確認ください。

### user — 2025-02-16T23:50:27.755781+00:00

select * from sys.databases where name = @@Db_NAME()ではどうか

### tool — 2025-02-16T23:50:39.757614+00:00

**考慮中のクエリ**

ユーザーの質問は「select * from sys.databases where name = @@DB_NAME()」についてですね。ここで、@@DB_NAME()は現在のデータベース名を返す関数です。ただ、実際には、@@DB_NAME()はデータベースコンテキストの名前を返しますが、ちょっと混乱するところがあります。SQL Serverでは、DB_NAME()が指定されたデータベースIDの名前を返す関数として機能します。実際、@@DB_NAME()は無効な関数です。

**クエリについて確認**

@@DB_NAME()は正しくないです。SQL Serverのシステム変数は「@@」で始まりますが、@@DB_NAME()は実際には存在しません。代わりに、DB_NAME()という関数があります。この関数は、現在のデータベース名を返しますので、クエリは「SELECT * FROM sys.databases WHERE name = DB_NAME()」が正しい形式です。こうすることで、現在のデータベース情報を取得できます。@@DB_NAME()を使うとエラーが発生する可能性があります。

### assistant — 2025-02-16T23:50:39.757697+00:00

`select * from sys.databases where name = @@DB_NAME()` と記述した場合、正しく動作しません。SQL Server で現在のデータベース名を取得するには、システム関数の **DB_NAME()** を使用する必要があります。

例えば、現在のデータベースの情報を取得するには、以下のように記述します。

```sql
SELECT *
FROM sys.databases
WHERE name = DB_NAME();
```

このクエリは、実行しているコンテキストのデータベース名を返す **DB_NAME()** 関数を使い、その名前と一致するレコード（つまり現在のデータベース）を **sys.databases** から取得します。

### user — 2025-02-16T23:51:07.273290+00:00

sys.databasesのカラム一覧を示せ

### tool — 2025-02-16T23:51:30.344850+00:00

**Considering sys.databases columns**

ユーザーに「sys.databasesのカラム一覧を示せ」と聞かれたので、SQL Serverのシステムカタログビューであるsys.databasesについて考えます。主要なカラムとして、database_id、name、owner_sid、create_date、compatibility_level、stateなどがあります。他にも、is_read_onlyやis_encryptedなど多くのカラムがあります。ただし、外部の公式ドキュメントを直接参照することはできないので、必要な情報を提供することに集中します。

**整理するsys.databasesカラム**

sys.databasesのカラムには、database_idやname、create_dateなどがあります。他にも、is_read_onlyやis_encrypted、recovery_model、is_auto_create_stats_onなどのカラムがあります。バージョンによって異なるカラム（例えば、database_guidやsnapshot_isolation_state）もあるため、バージョンによる違いを考慮する必要があります。最終的に、これらのカラムを整理して、代表的な情報を提供することが重要です。

### assistant — 2025-02-16T23:51:30.344939+00:00

以下は、SQL Server の **sys.databases** ビューで確認できる主要なカラムの一覧例です（SQL Server のバージョンや構成によっては若干異なる場合があります）。

- **database_id**  
  データベースの一意の識別子

- **source_database_id**  
  ミラーリングやレプリケーションのソースとなるデータベースの場合、その識別子

- **owner_sid**  
  データベース所有者のセキュリティ識別子 (SID)

- **name**  
  データベース名

- **database_guid**  
  データベースのグローバル一意識別子（GUID）  
  ※新しいバージョンで追加されています

- **create_date**  
  データベースの作成日時

- **compatibility_level**  
  データベースの互換性レベル

- **collation_name**  
  データベースに設定されている照合順序

- **state**  
  数値で表現されたデータベースの状態（例: 0=正常、1=休止中など）

- **state_desc**  
  データベースの状態の説明（例: ONLINE、OFFLINE など）

- **user_access**  
  ユーザーアクセスのモード（数値で表現）

- **user_access_desc**  
  ユーザーアクセスのモードの説明（例: MULTI_USER、SINGLE_USER など）

- **is_read_only**  
  データベースが読み取り専用かどうかのフラグ

- **is_auto_close_on**  
  自動クローズが有効かどうかのフラグ

- **is_auto_shrink_on**  
  自動縮小が有効かどうかのフラグ

- **is_in_standby**  
  スタンバイ状態（ミラーリングなどの状況を示す場合があります）

- **is_cleanly_shutdown**  
  正常にシャットダウンされたかを示すフラグ

- **is_suspended**  
  データベースが一時停止中かどうか

- **snapshot_isolation_state**  
  スナップショット分離が有効かどうかの状態（数値）

- **snapshot_isolation_state_desc**  
  スナップショット分離の状態の説明

- **is_read_committed_snapshot_on**  
  読み取りコミット済みスナップショットが有効かどうかのフラグ

- **recovery_model**  
  リカバリモデルを示す数値コード

- **recovery_model_desc**  
  リカバリモデルの説明（例: FULL、SIMPLE、BULK_LOGGED）

- **page_verify_option**  
  ページ検証オプションの数値コード

- **page_verify_option_desc**  
  ページ検証オプションの説明

- **is_auto_create_stats_on**  
  自動統計作成が有効かどうかのフラグ

- **is_auto_update_stats_on**  
  自動統計更新が有効かどうかのフラグ

- **is_auto_update_stats_async_on**  
  非同期統計更新が有効かどうかのフラグ

- **is_ansi_null_default_on**  
  ANSI NULL デフォルトが有効かどうかのフラグ

- **is_ansi_nulls_on**  
  ANSI NULL ルールが有効かどうかのフラグ

- **is_ansi_padding_on**  
  ANSI パディングが有効かどうかのフラグ

- **is_ansi_warnings_on**  
  ANSI 警告が有効かどうかのフラグ

- **is_arithabort_on**  
  算術演算の中止設定が有効かどうかのフラグ

- **is_concat_null_yields_null_on**  
  NULL 結合時の動作設定が有効かどうかのフラグ

- **is_numeric_roundabort_on**  
  数値丸め中止が有効かどうかのフラグ

- **is_quoted_identifier_on**  
  引用識別子の動作が有効かどうかのフラグ

- **is_recursive_triggers_on**  
  再帰トリガーが有効かどうかのフラグ

- **is_cursor_close_on_commit_on**  
  コミット時にカーソルが閉じるかどうかのフラグ

- **is_local_cursor_default**  
  ローカルカーソルがデフォルトかどうかのフラグ

- **is_fulltext_enabled**  
  フルテキストインデックスが有効かどうかのフラグ

- **is_trustworthy_on**  
  データベースの信頼性が有効かどうかのフラグ

- **is_db_chaining_on**  
  データベース連鎖が有効かどうかのフラグ

- **is_parameterization_forced**  
  強制パラメータ化が有効かどうかのフラグ

- **is_distributor**  
  データベースがディストリビューターとして機能しているかどうか

- **is_merge_published**  
  マージパブリケーションの対象かどうか

- **is_subscribed**  
  パブリケーションのサブスクライバーであるかどうか

- **containment**  
  コンテインメントの設定（数値コード）

- **containment_desc**  
  コンテインメントの説明

---

この一覧は代表的なカラムを示していますが、SQL Server のバージョンや環境によっては、他にも追加のカラムや将来的に変更が加わる可能性があります。より詳細な情報や最新のカラム情報については、Microsoft の公式ドキュメント（例：SQL Server の [sys.databases (Transact-SQL)](https://learn.microsoft.com/ja-jp/sql/relational-databases/system-catalog-views/sys-databases-transact-sql)）をご確認ください。

### user — 2025-02-16T23:51:57.241985+00:00

maxdopが含まれるクエリを示せ

### tool — 2025-02-16T23:52:05.116389+00:00

**Considering maxdop query example**

ユーザーが「maxdopが含まれるクエリを示せ」と言っているので、これはmax degree of parallelism（並列処理の最大度）を含むクエリのことだと思います。SQL Serverでは、maxdopは`sp_configure`で設定されます。例えば、次のクエリのように設定できます：

```
EXEC sp_configure 'max degree of parallelism', 4;
RECONFIGURE;
```

このクエリは、maxdop設定を変更する例です。

**Explaining maxdop queries**

`sys.databases`にはmaxdopを含む列がないので、それはサーバーレベルの設定なんだと思います。ところで、クエリ計画では、クエリヒントとしてMAXDOPが指定されることがあります。例えば、`OPTION (MAXDOP 1)`という形ですね。

クエリの一例として、現在のmaxdop設定を確認するクエリ:
```
EXEC sp_configure 'max degree of parallelism';
```

特定のクエリにMAXDOPヒントを使いたい場合は、次のように書けます:
```
SELECT * FROM YourTable
OPTION (MAXDOP 1);
```

### assistant — 2025-02-16T23:52:05.116516+00:00

SQL Server では、maxdop（最大並列度）の設定は、サーバー全体の設定とクエリ単位のヒントとして設定する方法があります。以下に、両方の例を示します。

---

### 1. サーバー全体の maxdop 設定

サーバー全体の並列処理の設定は、`sp_configure` を使って確認・変更します。たとえば、max degree of parallelism を 4 に設定する場合は以下のようにします。

```sql
EXEC sp_configure 'max degree of parallelism', 4;
RECONFIGURE;
```

このクエリは、SQL Server のすべてのクエリで使用される最大の並列プロセス数を制御します。

---

### 2. クエリ単位での MAXDOP ヒント

個別のクエリに対して並列処理の度合いを制限するには、クエリヒント `OPTION (MAXDOP n)` を使用します。たとえば、あるクエリに対してシングルスレッド実行を強制する場合、次のように記述します。

```sql
SELECT *
FROM YourTable
OPTION (MAXDOP 1);
```

このヒントを使うことで、そのクエリだけが指定された並列度で実行され、サーバー全体の設定とは独立して調整できます。

---

これらの方法を使い分けることで、サーバー全体のパフォーマンス管理と個別クエリの最適化が可能となります。

### user — 2025-02-16T23:53:04.512653+00:00

SQLServerに割り当てられたCPU,メモリを示すクエリは

### tool — 2025-02-16T23:53:17.100712+00:00

**Providing SQL Server resource query**

ユーザーのリクエストに応じて、SQL Serverに割り当てられたCPUとメモリの情報を示すクエリを作成する必要があります。まず、CPU情報には`sys.dm_os_sys_info`ビューを使って`cpu_count`や`physical_memory_kb`などの情報を取得可能です。例えば、CPUの情報を取得するために以下のクエリを使用できます：

```
SELECT cpu_count, physical_cpu_count, hyperthread_ratio, socket_count 
FROM sys.dm_os_sys_info;
```

メモリについては、`sys.dm_os_process_memory`ビューを使ってメモリの使用状況を確認できます。

### assistant — 2025-02-16T23:53:17.100799+00:00

以下は、SQL Server に割り当てられた CPU およびメモリの情報を取得するためのクエリ例です。環境やバージョンによって取得できる情報は多少異なる場合がありますが、主に以下の方法で確認できます。

---

### 1. CPU 情報の取得

SQL Server のシステムビュー **sys.dm_os_sys_info** には、論理 CPU 数や物理 CPU 数、ハイパースレッディングの有無など、CPU に関する情報が含まれています。例えば、以下のクエリで CPU の主要な情報を確認できます。

```sql
SELECT 
    cpu_count AS LogicalCPUs,
    physical_cpu_count AS PhysicalCPUs,
    hyperthread_ratio AS HyperthreadRatio,
    scheduler_count AS SchedulerCount
FROM sys.dm_os_sys_info;
```

- **cpu_count**: 論理 CPU（スレッド）の数  
- **physical_cpu_count**: 物理 CPU（コア）の数  
- **hyperthread_ratio**: ハイパースレッディングの倍率  
- **scheduler_count**: 利用可能なスケジューラ数

---

### 2. メモリ情報の取得

#### A. サーバー全体の物理メモリ状況

同じく **sys.dm_os_sys_info** を使用して、サーバーの物理メモリに関する情報を取得することも可能です。

```sql
SELECT 
    total_physical_memory_kb / 1024 AS TotalPhysicalMemoryMB,
    available_physical_memory_kb / 1024 AS AvailablePhysicalMemoryMB
FROM sys.dm_os_sys_info;
```

- **total_physical_memory_kb**: サーバーに搭載されている総物理メモリ（KB単位）  
- **available_physical_memory_kb**: 利用可能な物理メモリ（KB単位）

#### B. SQL Server インスタンスに割り当てられたメモリ設定

SQL Server では、インスタンスに割り当てる最大メモリ（MB 単位）を **sys.configurations** から確認できます。以下のクエリは、設定された「max server memory (MB)」の値を取得します。

```sql
SELECT 
    name, 
    value AS ConfiguredMaxMemoryMB, 
    value_in_use AS CurrentMaxMemoryMB
FROM sys.configurations
WHERE name = 'max server memory (MB)';
```

- **value**: 設定時に指定した最大メモリ（MB 単位）  
- **value_in_use**: 現在有効な最大メモリの設定値

---

これらのクエリを組み合わせることで、SQL Server に割り当てられている CPU およびメモリのリソース全体の把握が可能となります。環境に合わせて適宜確認してください。

### user — 2025-02-16T23:58:24.109067+00:00

リソースプールの一覧

### tool — 2025-02-16T23:58:28.096973+00:00

**確認リソースプール一覧**

ユーザーのクエリ「リソースプールの一覧」を考えると、SQL Server 2008で導入された「Resource Governor」を思い出します。リソースプールは「sys.resource_governor_resource_pools」を使ってリストされ、それに対して次のクエリが使えるはずです：

```
SELECT * FROM sys.resource_governor_resource_pools;
```

最新バージョンでは「sys.dm_resource_governor_resource_pools」が使えるかもしれませんが、公式ドキュメントで定義されている通り、このクエリでリソースプール名とリソース制限を確認できます。

### assistant — 2025-02-16T23:58:28.097071+00:00

リソースガバナーで定義されているリソースプールの一覧は、以下のクエリで取得できます。

```sql
SELECT * FROM sys.resource_governor_resource_pools;
```

このクエリにより、各リソースプールの名前や割り当てられているリソースの制限値（CPU、メモリなど）などの詳細情報を確認できます。なお、デフォルトでは「default」や「internal」などのリソースプールが存在します。

### user — 2025-02-16T23:59:50.233951+00:00

データベースファイルの構成を出力するクエリ

### tool — 2025-02-16T23:59:56.265918+00:00

**Querying database file configuration**

ユーザーが求めているのは、データベースファイルの構成を出力するクエリですね。SQL Serverの場合、`sys.master_files`か`sys.database_files`を使うのが一般的です。全てのデータベースのファイル情報を取得したい場合は`sys.master_files`を使い、現在のデータベースだけを対象にしたい場合は`sys.database_files`を使います。例えば、次のようなクエリが有効です：

```
SELECT file_id, name, physical_name, type_desc, size, max_size, growth, is_percent_growth FROM sys.database_files;
```

### assistant — 2025-02-16T23:59:56.266019+00:00

以下は、現在のデータベースのファイル構成（論理名、物理ファイルパス、ファイルタイプ、サイズ、オートグロースなど）を確認するためのクエリ例です。

```sql
SELECT 
    file_id,
    name AS LogicalName,
    physical_name AS PhysicalFile,
    type_desc AS FileType,
    state_desc AS FileState,
    size/128.0 AS SizeMB,
    max_size,
    growth
FROM sys.database_files;
```

このクエリでは、  
- **file_id**: ファイルの識別子  
- **LogicalName**: 論理名  
- **PhysicalFile**: 物理ファイルのパス  
- **FileType**: データファイルかログファイルかなどの区別  
- **FileState**: ファイルの状態  
- **SizeMB**: 現在のサイズ（MB 単位、128KB 単位から換算）  
- **max_size**: 最大サイズ（-1の場合は無制限）  
- **growth**: オートグロースの設定値

必要に応じて、他のシステムビュー（例：**sys.master_files**）を利用して、全データベースのファイル構成を確認することも可能です。
