---
conversation_id: "6870753e-e950-8007-9219-9b856dabfd80"
title: "ローカルVM ネットワーク設定"
create_time: 1752200511.076723
update_time: 1752286147.366881
language_guess: "en"
num_messages: 12
part_index: 1
part_count: 1
---

### user — 2025-07-11T02:21:49.584000+00:00

local vm に3台構成、１台はDC、２台はメンバーサーバー
この場合、NWの簡易的な設定方法は？

### system — 2025-07-11T02:21:51.076723+00:00

_(empty)_

### user — 2025-07-11T02:21:51.076723+00:00

_(empty)_

### assistant — 2025-07-11T02:21:52.003996+00:00

【[[REDACTED_PHONE]]:05 JST】

やあ、司令！  
ローカルVMで「1台DC（ドメインコントローラー）、2台メンバーサーバー」の3台構成を想定した簡易NW（ネットワーク）設定の一般的な手順をまとめます。

---

## 1. **物理/仮想NWの設計方針**

**パターンA：完全閉鎖の仮想ネットワーク（推奨）**  
- **用途**：外部ネットに繋がない完全検証環境  
- **方法**：  
  - Hyper-V/VMware/VirtualBox いずれも「**内部ネットワーク**（Internal Network）」や「**プライベートネットワーク**」を構成
  - すべてのVMのNICを同じ仮想ネットワークに接続

**パターンB：外部アクセス併用**  
- **用途**：外部へのソフトウェアインストールやWindows Updateが必要  
- **方法**：  
  - 仮想ネットワークを2つ作成（例：**NATネットワーク**＋**内部ネットワーク**）
  - 各VMにNICを2枚挿して「管理・アップデート用」「ドメイン内通信用」に分離  
  - または、NAT付きの仮想ネットワークで全てのVMを接続し、外部アクセス時のみNAT経由でインターネットアクセス許可

---

## 2. **IPアドレス設定例（完全閉鎖・手動割当の場合）**

| サーバ名   | 役割           | 例：IPアドレス      | サブネットマスク | ゲートウェイ | DNSサーバ      |
|:-----------|:---------------|:-------------------|:----------------|:-------------|:--------------|
| VM-DC      | ドメインコントローラー | [[REDACTED_PHONE]]      | [[REDACTED_PHONE]].0   | （空白）      | [[REDACTED_PHONE]]|
| VM-MEM1    | メンバーサーバー     | [[REDACTED_PHONE]]      | [[REDACTED_PHONE]].0   | （空白）      | [[REDACTED_PHONE]]|
| VM-MEM2    | メンバーサーバー     | [[REDACTED_PHONE]]      | [[REDACTED_PHONE]].0   | （空白）      | [[REDACTED_PHONE]]|

- **ポイント**  
  - ドメイン参加時は「DNS」に**DCサーバ自身のIP**を指定
  - ゲートウェイは不要（外部通信させないなら）

---

## 3. **簡易手順（例：VMware/Hyper-V）**

1. **仮想ネットワークを新規作成（Internal/Private/NAT）**
2. **各VMのネットワークアダプタを上記仮想ネットワークに割当**
3. **各VMのWindows側でIPアドレスを静的割当（上記表参照）**
4. **ドメインコントローラを構築し、DNSサービスも同時導入**
5. **メンバーサーバーでドメイン参加時、DNSはDCのIPを指定**

---

## 4. **その他メモ**
- **DHCP不要**（IPは手動がベター）
- Windows Firewallは最初はOFFで開始し、動作確認後に必要に応じてON推奨
- 外部からRDP等でアクセスする場合は、NATまたはブリッジ接続とする

---

「どの仮想化ソフトか」「外部通信要否」などもう少し具体要件があれば、さらに詳細化できます！  
不足があれば聞いてください。

【[[REDACTED_PHONE]]:05 JST】

### assistant — 2025-07-11T02:22:02.984355+00:00

_(empty)_

### user — 2025-07-11T02:22:19.135000+00:00

local ipを割り当てる以外の方法はある？

### assistant — 2025-07-11T02:22:20.715070+00:00

【[[REDACTED_PHONE]]:10 JST】

はい、**ローカルIPを“手動で割り当てる”以外の方法**もいくつか存在します。  
想定されるパターンと利点・注意点を簡単にまとめます。

---

### 1. **DHCPサーバーを立てる（自動割り当て）**

- **構成例**  
  - 仮想NW内でVMのいずれか（または別途小型Linux等）をDHCPサーバとして設定
  - 各VMのNICを「DHCPで自動取得」にしておくと、自動でIP割り当て
  - **Active Directory環境の場合**は、**ドメインコントローラーが同時にDHCPサーバ**になることも多い
- **メリット**  
  - IPの重複などの心配がなくなる
  - サーバ台数が増えても管理が楽
- **デメリット**
  - DHCP構築の手間がある（テスト用途ならちょっと大げさな場合も）

---

### 2. **仮想化ソフトの「NAT」または「ブリッジ」モード利用**

- **NAT/ブリッジ（VMware/Hyper-V/VirtualBox共通）**
  - ホストOSや外部ネットワークのDHCP機能に“丸投げ”する方法
  - 仮想NWを「NAT」または「ブリッジ」接続に設定  
    → VMのNICをDHCP自動取得設定  
    → 物理NW側やホストOSのDHCPからIPが自動付与される

- **注意点**
  - IPがランダムに変わる場合がある（ドメイン環境では**DNS登録と名前解決**に注意！）
  - セキュリティ要件で“完全閉鎖”が求められる場合は適さない

---

### 3. **APIPA（自動プライベートIPアドレス割り当て）**

- **解説**
  - DHCPサーバが存在しないとき、Windowsは自動的に`169.254.x.x`のIPを自身に割り当てる
  - テストや一時的なNW切断時のみ有効
- **用途**
  - 3台ともAPIPAになれば、お互い通信は一応可能
- **注意**
  - 本格的なADドメインや運用サーバでは原則非推奨（名前解決やNW管理上トラブルが起こりやすい）

---

### 4. **Zeroconf/Bonjour等の自動検出プロトコル**

- **特徴**
  - mDNSやBonjourを利用し、NWに「名前だけ」でアクセスできる仕組み
  - Windowsのみだと実用性は限定的
- **実運用ではほとんど使われない（検証用途なら可）**

---

### まとめ

- **お手軽**＝NAT/ブリッジ＋DHCP（自動取得）
- **確実で安定**＝手動割り当て
- **大量サーバ・自動化志向**＝仮想NW内でDHCPサーバ（Windows Server役割追加等）
- **実験レベル**＝APIPAやBonjour

どのパターンも**「ドメイン参加時のDNS指定」**は忘れずに！

もし「AD/ドメイン構成だけは絶対に固定したいが、ほかは柔軟でも良い」など、こだわりや制約あれば、シナリオに応じて具体例を出しますので教えてください。

【[[REDACTED_PHONE]]:10 JST】

### user — 2025-07-11T02:22:55.227000+00:00

あとで、最新パッチの適用があるので、インターネットへのアクセスも許可したい

### assistant — 2025-07-11T02:22:56.950314+00:00

【[[REDACTED_PHONE]]:13 JST】

了解です、司令！

**「基本は閉鎖ネットワークだけど、最新パッチ適用のため**  
**インターネット（外部ネット）アクセスも一時的・定期的に許可したい」**  
こういう要望は**検証環境やテストAD構成**ではよくある話です。

---

## ◆ おすすめ構成

### 1. **NATネットワーク（推奨・一番楽）**

- **概要**  
  - 仮想化ソフト側で「NATネットワーク」を作成し、全VMをそこに接続
  - VMからインターネット（外部）へはNATを介してアクセス可
  - **外部からVMへの直接アクセスは不可（セキュア）**
- **使い方**
  - 通常運用時はVMのNICをNATネットワークのまま
  - Windows Updateや必要なときだけ「ネットワーク設定→プロキシやFWを調整」すればOK
- **注意点**
  - NATネットワークの**DHCP範囲**でIPが割り当てられるので、AD/DNS等は**固定IP推奨**  
    （VMware NATは固定IPもOK／VirtualBoxはホストオンリー+NATの二重NICでもOK）

---

### 2. **NIC二重化（Internal＋NAT/Bridge）**

- **各VMに2枚NICをつける方法**  
  - 1枚目：**Internal/ホストオンリー**（ドメイン/内部通信用・固定IP）
  - 2枚目：**NATやブリッジ**（外部アクセス用・DHCP自動取得）
  - Windowsで用途ごとにNIC優先度・ルーティング制御
  - Windows UpdateやWebアクセス時のみ外部NIC経由

- **構成例**
  | NIC          | 用途            | IP設定       | DNS設定                 |
  |:-------------|:----------------|:-------------|:------------------------|
  | NIC1         | 内部通信用      | 固定IP       | DCのIP（ADのDNS用）     |
  | NIC2         | 外部アクセス用  | DHCP自動取得 | 必要に応じて外部DNSも可 |

- **ポイント**  
  - **Windowsのネットワーク優先度（メトリック）設定**で、DC/DNSは内部NICを最優先に  
  - 必要時だけNIC2を有効にしてパッチ適用、完了後は無効化も可能

---

### 3. **仮想NWの切り替え運用**

- NICは1本だけど、VMの「ネットワーク割り当て」を**Internal⇔NAT**で手動切替
  - 普段はInternalやHostOnly
  - 必要時だけNATへ割り当て変更し、アップデート
- 物理PCのNWアドレス体系やNW切断トラブルに注意

---

## ◆ 注意点まとめ

- **AD環境では「ドメイン用NICのDNS設定」は必ずDC自身（またはAD/DNSサーバ）を指定**
- **Windows Updateなど外部アクセス時のみ外部DNSに切り替える場合も、終わったら必ず戻す**
- **一時的な外部アクセスはNICの「有効/無効」や「仮想NWの切り替え」で管理**
- **NAT＋Internal NICの二重構成は物理NWが絡む場合も安全性高い**

---

**一番現実的・トラブルが少ないのは「NIC2枚（Internal＋NAT）」です。**  
- 普段はInternal（固定IP、AD通信）  
- 必要なときだけNAT側も有効にし、外部アクセス  
- 終わったらNAT側NICを「無効」に戻す

**このパターンが一般的です。**

もし仮想環境（VMware/Hyper-V/VirtualBox等）の種類や構成イメージがあれば、  
個別に具体例・スクショ案も提示できますので、必要なら教えてください！

【[[REDACTED_PHONE]]:13 JST】

### user — 2025-07-11T02:24:58.224000+00:00

仮想スイッチのdefault switchは内部用？
外部を追加する必要がある？

### assistant — 2025-07-11T02:24:59.794134+00:00

【[[REDACTED_PHONE]]:18 JST】

はい、「Default Switch」の扱いは仮想化ソフトによって意味が微妙に異なりますが、  
**Hyper-V**の場合を中心にまとめます。

---

## ◆ Hyper-V の「Default Switch」とは？

### ● **Default Switchの正体**

- **Hyper-V標準で自動作成される仮想スイッチ**
- Windows 10/11 Hyper-V では最初から存在
- **用途：NAT付きの簡易的な外部アクセス用スイッチ**
  - VMから外部インターネットには出られる（NAT越し）
  - ただし、**ホストPC⇔VM間の通信や、他VM間の固定IP割当などは微妙に不安定／不向き**
- **IP割当は自動（DHCP）**
- **ホストPCの物理NW設定が変わると、Default SwitchのIPもコロコロ変わる場合がある**
- **NW的には「外部でも内部でもない、中間」**

---

### ● **実運用上のポイント**

- **閉鎖NW・固定IPのAD構成**には**Default Switchは“やや不向き”**
  - 固定IPの割り当てや、ドメイン用DNS指定が難しい
  - VM間の通信も安定しないことがある
- **「一時的な外部アクセス」「とりあえずネットに出したい」用途には便利**
- **複数VMで内部NW＋外部NWを明確に分けたいなら「新たに仮想スイッチを作成」推奨**

---

## ◆ 外部用仮想スイッチは必要？

- **ADや本格サーバ検証には、追加推奨**
  - **「内部用（Internal Network）」：ADやメンバーサーバ間専用、固定IPで構成**
  - **「外部用（External Network）」：物理NICにブリッジ、またはNAT用スイッチを別作成**
    - 外部ネットに出す必要があれば「NATスイッチ」または「External Switch」作成

- **NIC二重化運用（上記案）では、「内部NW用」と「外部/NAT用」スイッチ両方を作成し、VMのNICを2本に割り当てるのが最も柔軟＆安定**

---

### 【簡易まとめ】

- **Default Switch：NAT経由の外部アクセス用（テスト用途、固定IPには不向き）**
- **本格運用／ADテスト：内部用スイッチ＋必要なら外部用スイッチを自分で追加がベスト**
- **外部用スイッチ追加は推奨！（必要に応じて）**

---

#### もし具体的なHyper-Vの「仮想スイッチマネージャー」での作り方や設定画面キャプチャが必要なら、  
どのOS・バージョンか教えてくれれば詳細ガイドも作成します！

【[[REDACTED_PHONE]]:18 JST】
