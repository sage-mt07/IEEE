---
conversation_id: "66f9fddc-463c-8007-8619-7b4e951ac3a1"
title: "Rejectメッセージのログ出力"
create_time: 1727659484.464704
update_time: 1727659593.24115
language_guess: "en"
num_messages: 9
part_index: 1
part_count: 1
---

### system — 2024-09-30T01:24:44.464704+00:00

_(empty)_

### user — 2024-09-30T01:24:44.470801+00:00

Quickfixnを使用している
Rejectが発生した原因となるメッセージをログに出力したい

### assistant — 2024-09-30T01:25:01.327608+00:00

_(empty)_

### assistant — 2024-09-30T01:25:01.327769+00:00

The user is using QuickFIX/N and wants to log the message that caused a reject to occur.

### tool — 2024-09-30T01:25:01.327883+00:00

Model set context updated.

### assistant — 2024-09-30T01:25:01.327978+00:00

To log the message that caused a reject in QuickFIX/N, you can customize the `FromAdmin` method in your `Application` class implementation. This method handles incoming admin messages (e.g., Logon, Logout, Reject, etc.). Here's an example of how you can do this:

```csharp
public class MyQuickFixApp : QuickFix.Application
{
    public override void FromAdmin(Message message, SessionID sessionID)
    {
        try
        {
            string msgType = message.Header.GetString(QuickFix.Fields.Tags.MsgType);
            if (msgType == QuickFix.Fields.MsgType.REJECT)
            {
                // Log the entire reject message
                Console.WriteLine($"Received Reject Message: {message.ToString()}");

                // Optionally, extract the Text field from the reject message
                if (message.IsSetField(QuickFix.Fields.Tags.Text))
                {
                    string rejectReason = message.GetString(QuickFix.Fields.Tags.Text);
                    Console.WriteLine($"Reject Reason: {rejectReason}");
                }
            }
        }
        catch (FieldNotFoundException e)
        {
            Console.WriteLine($"Error: {e.Message}");
        }
    }

    // Implement other required methods here (e.g., OnCreate, OnLogon, OnLogout)
}
```

This will log the full reject message whenever one is received. You can customize the logging mechanism based on your logging framework or preferences.

### user — 2024-09-30T01:26:02.094418+00:00

これはRejectのメッセージを出力している
これではない

### assistant — 2024-09-30T01:26:32.711431+00:00

Rejectの原因となったメッセージをログに出力したい場合、`ToApp`や`FromApp`メソッドで送信もしくは受信されたアプリケーションメッセージをキャプチャし、Rejectが発生した際にそのキャプチャされたメッセージを特定する必要があります。Rejectの発生後に、その原因となるメッセージをログに残す処理を行う方法の例です。

1. **メッセージの保存**：送信したメッセージをキャプチャして保存します。
2. **Reject発生時にそのメッセージを参照**：Rejectメッセージのフィールドから、該当するメッセージを特定し、ログに出力します。

以下は、これを実現する簡単なサンプルコードです。

```csharp
public class MyQuickFixApp : QuickFix.Application
{
    private Dictionary<int, Message> messageStore = new Dictionary<int, Message>();

    public override void ToApp(Message message, SessionID sessionID)
    {
        // MsgSeqNumを取得してメッセージを保存する
        int msgSeqNum = message.Header.GetInt(QuickFix.Fields.Tags.MsgSeqNum);
        messageStore[msgSeqNum] = message;

        Console.WriteLine($"Sent Message: {message.ToString()}");
    }

    public override void FromAdmin(Message message, SessionID sessionID)
    {
        try
        {
            string msgType = message.Header.GetString(QuickFix.Fields.Tags.MsgType);
            if (msgType == QuickFix.Fields.MsgType.REJECT)
            {
                // Reject メッセージの RefSeqNum フィールドから原因となるメッセージを特定する
                int refSeqNum = message.GetInt(QuickFix.Fields.Tags.RefSeqNum);

                if (messageStore.ContainsKey(refSeqNum))
                {
                    Message rejectedMessage = messageStore[refSeqNum];
                    Console.WriteLine($"Rejected Message: {rejectedMessage.ToString()}");
                }
                else
                {
                    Console.WriteLine($"No stored message found for RefSeqNum: {refSeqNum}");
                }
            }
        }
        catch (FieldNotFoundException e)
        {
            Console.WriteLine($"Error: {e.Message}");
        }
    }

    // 他の必要なメソッドを実装する (OnCreate, OnLogon, OnLogout など)
}
```

このコードでは、メッセージ送信時に`MsgSeqNum`に基づいてメッセージを保存し、Rejectメッセージが来たときに`RefSeqNum`を参照して、対応するメッセージをログに出力します。このようにすることで、Rejectの原因となったメッセージを取得してログに出力できます。
