---
conversation_id: "6897ec7e-aaf8-8321-a929-b7a359315929"
title: "KSQL ãƒˆãƒ”ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼å›é¿"
create_time: 1754786944.048574
update_time: 1754824151.645842
language_guess: "en"
num_messages: 209
part_index: 2
part_count: 2
---

### ãƒ†ã‚¹ãƒˆè¨­è¨ˆä¸Šã®æ³¨æ„
- Kafka ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¯ `Chr.Avro.Confluent` ã‚’åˆ©ç”¨ã—ãŸ POCO å‹ã®è‡ªå‹•ã‚¹ã‚­ãƒ¼ãƒé€£æºã‚’æ¨å¥¨ã—ã¾ã™ã€‚
- `GROUP BY` ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ Push Query ã¨ã—ã¦ `EMIT CHANGES` ãŒè‡ªå‹•ä»˜ä¸ã•ã‚Œã¾ã™ã€‚Pull Query ã‚„ TABLE ã‚¯ã‚¨ãƒªã§ `GROUP BY` ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
- `WINDOW` å¥ã¯ `GROUP BY` ã®ç›´å¾Œã«é…ç½®ã—ã¦ãã ã•ã„ã€‚
- `CASE` å¼ã§ã¯ `THEN`/`ELSE` ã®å‹ã‚’å¿…ãšä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- `MIN`/`MAX` ãªã©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ å°‚ç”¨é›†è¨ˆé–¢æ•°ã‚’å«ã‚€å ´åˆã€ã‚¯ã‚¨ãƒªã¯è‡ªå‹•çš„ã« `CREATE STREAM` ã¨ã—ã¦ç”Ÿæˆã•ã‚Œã¾ã™ã€‚`CREATE TABLE` ã‚’æ˜ç¤ºã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

## Context ã‚¯ãƒ©ã‚¹ã¨ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹

| API                   | èª¬æ˜                                   | å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ | å®Ÿè£…çŠ¶æ…‹ |
|------------------------|----------------------------------------|------------|---------|
| `IKsqlContext`         | ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ“ä½œã®æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹   | Context    | âœ…      |
| `KafkaContextCore`     | `IKsqlContext` å®Ÿè£…ã®åŸºåº•ã‚¯ãƒ©ã‚¹        | Context    | âœ…      |
| `KsqlContext`          | Kafkaé€£æºã‚’çµ±åˆã—ãŸæŠ½è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ    | Context    | âœ…      |
| `KsqlContextBuilder`   | `KsqlContextOptions` æ§‹ç¯‰ç”¨ãƒ“ãƒ«ãƒ€ãƒ¼   | Application| âœ…      |
| `KsqlContextOptions`   | ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¸ã‚¹ãƒˆãƒªç­‰ã®è¨­å®šä¿æŒ        | Application| âœ…      |
| `IEventSet<T>`         | LINQ/Streamingæ“ä½œã®å…±é€šã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹| Stream/Table| âœ…     |
| `IManualCommitMessage<T>` | æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸             | Subscription| âœ…     |

## LINQ é¢¨ DSL ä¸€è¦§

| DSL ãƒ¡ã‚½ãƒƒãƒ‰                   | èª¬æ˜                          | æˆ»ã‚Šå€¤å‹                          | å¯¾è±¡ãƒ¬ã‚¤ãƒ¤    | å®Ÿè£…çŠ¶æ…‹ |
|--------------------------------|-------------------------------|-----------------------------------|---------------|---------|
| `.Where(predicate)`            | æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿                  | `IEventSet<T>`                    | Stream/Table  | âœ…      |
| `.Window(WindowDef \| TimeSpan)` | ã‚¿ã‚¤ãƒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æŒ‡å®š       | `IQueryable<T>`                   | Stream        | âœ…      |
| `.Window(int minutes)`          | `WindowMinutes`ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿  | `IEntitySet<T>`                  | Stream/Table  | âœ…      |
| `.Window().BasedOn<TSchedule>(keySelector, ?openProp, ?closeProp)` | `[ScheduleRange]` å±æ€§ã€ã¾ãŸã¯ `openProp`/`closeProp` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é–‹å§‹/çµ‚äº†ã‚’ç¤ºã™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«POCOã«åŸºã¥ãã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç”Ÿæˆ | `IQueryable<T>` | Stream | âœ… |
| `.GroupBy(...)`                | ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãŠã‚ˆã³é›†ç´„          | `IEventSet<IGrouping<TKey, T>>`   | Stream/Table  | âœ…      |
| `.OnError(ErrorAction)`        | ã‚¨ãƒ©ãƒ¼å‡¦ç†æ–¹é‡æŒ‡å®š            | `EventSet<T>`                     | Stream        | âœ…      |
| `.WithRetry(int)`              | ãƒªãƒˆãƒ©ã‚¤è¨­å®š                  | `EventSet<T>`                     | Stream        | âœ…      |
| `.StartErrorHandling()`        | ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒ¼ãƒ³é–‹å§‹            | `IErrorHandlingChain<T>`          | Stream        | âœ…      |
| `.WithManualCommit()`          | æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿        | `IEntityBuilder<T>`               | Subscription  | âœ…      |
| `.Limit(int)`                  | **ä¿æŒä»¶æ•°åˆ¶é™ã€‚Tableå‹(Set<T>)ã§ã®ã¿åˆ©ç”¨å¯ã€‚OnModelCreatingã§å®šç¾©ã—ã€è¶…éåˆ†ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ã€‚** | `IEntitySet<T>`                  | Table  | âœ…      |

- `ToList`/`ToListAsync` ã¯ Pull Query ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€F:src/Query/Pipeline/DMLQueryGenerator.csâ€ L27-L34ã€‘ã€‚
- `WithManualCommit()` ã‚’æŒ‡å®šã—ãªã„ `ForEachAsync()` ã¯è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå‹•ä½œã¨ãªã‚Šã¾ã™ã€F:docs/old/manual_commit.mdâ€ L1-L23ã€‘ã€‚
- `OnError(ErrorAction.DLQ)` ã‚’æŒ‡å®šã™ã‚‹ã¨ DLQ ãƒˆãƒ”ãƒƒã‚¯ã¸é€ä¿¡ã•ã‚Œã¾ã™ã€F:docs/old/defaults.mdâ€ L52-L52ã€‘ã€‚
- `ctx.Set<DlqEnvelope>()` ã‚’æŒ‡å®šã™ã‚‹ã¨ DLQ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—ã§ãã¾ã™ã€‚DLQ ã¯ç„¡é™ãƒ­ã‚°ã®ãŸã‚ `Take()` ã‚„ `ToListAsync()` ãªã©ã®ä¸€æ‹¬å–å¾— API ã¯åˆ©ç”¨ã§ããšã€`ForEachAsync()` ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã¾ãŸ DLQ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ `.OnError(ErrorAction.DLQ)` ã‚’æŒ‡å®šã™ã‚‹ã¨ç„¡é™ãƒ«ãƒ¼ãƒ—ã«ãªã‚‹ãŸã‚ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚
- Messaging ã‚¯ãƒ©ã‚¹è‡ªä½“ã¯ DLQ é€ä¿¡å‡¦ç†ã‚’æŒãŸãšã€`ErrorOccurred`/`DeserializationError`/`ProduceError` ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã˜ã¦å¤–éƒ¨ã§ DLQ é€ä¿¡ã‚’è¡Œã„ã¾ã™ã€‚
- `Set<T>().Limit(n)` ã¯ Table å‹ã®ä¿æŒä»¶æ•°ã‚’åˆ¶é™ã™ã‚‹ DSL ã§ã™ã€‚`OnModelCreating` å†…ã§æŒ‡å®šã—ã€è¶…éåˆ†ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ã€‚Stream å‹ã‚„å®Ÿè¡Œæ™‚ã‚¯ã‚¨ãƒªã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
- ãƒãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã¯ `WithWindow().Select<TBar>()` ã§ `BarTime` ã«ä»£å…¥ã—ãŸå¼ãŒè‡ªå‹•çš„ã«è¨˜éŒ²ã•ã‚Œã€`Limit` ã®ä¸¦ã³æ›¿ãˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- `RemoveAsync(key)` ã¯å€¤ `null` ã®ãƒˆãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã‚’é€ã‚Šã€KTable ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è©²å½“ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
- `.Window().BasedOn<TSchedule>` ã‚’ç”¨ã„ã‚‹å ´åˆã€ãƒãƒ¼ã¯ `[ScheduleRange]` å±æ€§ã€ã¾ãŸã¯ `openProp`/`closeProp` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç¤ºã•ã‚ŒãŸ `Open` ï½ `Close` ã®ç¯„å›²ã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚æ—¥è¶³ç”Ÿæˆã§ `Close` ãŒ 6:30 ã®ã¨ãã¯ã€6:30 æœªæº€ã®ãƒ‡ãƒ¼ã‚¿ãŒå½“æ—¥ã®çµ‚å€¤ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
- ãƒãƒ¼ã‚„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å®šç¾©ã¯å¿…ãš `KafkaKsqlContext.OnModelCreating` å†…ã§å®£è¨€ã—ã¦ãã ã•ã„ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã¯å®šç¾©æ¸ˆã¿ã® `Set<T>` ã‚’å‚ç…§ã™ã‚‹ã ã‘ã§ã™ã€‚
- `WithWindow<Rate, MarketSchedule>()` ã«ç¶šã‘ã¦ `.Select<RateCandle>()` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ§‹æˆã§ãã¾ã™ã€‚
- `WithWindow<TEntity, TSchedule>(windows, timeSelector, rateKey, scheduleKey)` ã¨ã—ã¦ `timeSelector` å¼•æ•°ã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åŒºåˆ‡ã‚‹æ™‚åˆ»ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ˜ç¤ºã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æˆ»ã‚Šå€¤å‹ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã§ã€DSLãƒã‚§ãƒ¼ãƒ³ã«ãŠã‘ã‚‹æ¬¡ã®æ“ä½œã‚’åˆ¤æ–­ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ç‰¹ã« `OnError()` ã‚„ `WithRetry()` ã¯ `EventSet<T>` ã‚’è¿”ã™ãŸã‚ã€ç¶šã‘ã¦ `IEventSet` ç³»ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚
### ToQuery ãƒã‚§ãƒ¼ãƒ³

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | æ³¨æ„ç‚¹ |
|---|---|---|
| `.From<T>()` | ãƒ“ãƒ¥ãƒ¼å®šç¾©ã®é–‹å§‹ | - |
| `.Join<T2>(condition)` | 2ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã§ã®å†…éƒ¨çµåˆ | å¾Œç¶šã« `.Where` å¿…é ˆ |
| `.Where(predicate)` | çµåˆæ¡ä»¶ã‚„ãƒ•ã‚£ãƒ«ã‚¿ | `.Join` ä½¿ç”¨æ™‚ã¯å¿…é ˆ |
| `.Select(selector)` | æŠ•å½± | å‘¼ã³å‡ºã—é †åºã¯ `From`â†’`Join?`â†’`Where`â†’`Select` |

ã“ã‚Œã‚‰ã¯ `modelBuilder.Entity<T>().ToQuery(q => q ... )` å†…ã§ä½¿ç”¨ã—ã€`KsqlQueryModel` ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

## å±æ€§ (Attribute) å®šç¾©

| å±æ€§                       | å½¹å‰²                           | å®Ÿè£…çŠ¶æ…‹ |
|----------------------------|--------------------------------|---------|
| `MaxLengthAttribute`       | æ–‡å­—åˆ—é•·åˆ¶é™                   | âœ…      |
| `ScheduleRangeAttribute`   | å–å¼•é–‹å§‹ãƒ»çµ‚äº†ã‚’ã¾ã¨ã‚ã¦æŒ‡å®šã™ã‚‹å±æ€§ | ğŸš§ |

`WithDeadLetterQueue()` ã¯éå»ã®è¨­è¨ˆã§ææ¡ˆã•ã‚Œã¾ã—ãŸãŒã€ç¾åœ¨ã¯ `OnError(ErrorAction.DLQ)` ã«ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

## æ§‹æˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ãƒ“ãƒ«ãƒ€ãƒ¼

| API                        | èª¬æ˜                             | å®Ÿè£…çŠ¶æ…‹ |
|----------------------------|----------------------------------|---------|
| `KsqlDslOptions`           | DLQ è¨­å®šã‚„ ValidationMode ãªã© DSL å…¨ä½“ã®æ§‹æˆã‚’ä¿æŒ | âœ… |
| `ModelBuilder`             | POCO ã‹ã‚‰ `EntityModel` ã‚’æ§‹ç¯‰ã™ã‚‹ãƒ“ãƒ«ãƒ€ãƒ¼ | âœ… |
| `KafkaAdminService`        | DLQ ãƒˆãƒ”ãƒƒã‚¯ä½œæˆãªã©ã®ç®¡ç†æ“ä½œ  | âœ…      |
| `AvroOperationRetrySettings`| Avroæ“ä½œã”ã¨ã®ãƒªãƒˆãƒ©ã‚¤è¨­å®š     | âœ…      |
| `AvroRetryPolicy`          | ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚„é…å»¶ãªã©ã®è©³ç´°ãƒãƒªã‚·ãƒ¼ | âœ…  |

`KsqlDslOptions.DlqTopicName` ã¯æ—¢å®šã§ `"dead-letter-queue"` ã§ã™ã€F:src/Core/Dlq/DlqProducer.csâ€ L248-L256ã€‘ã€‚

<a id="fluent-api-list"></a>### Fluent API ä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|----------|------|
| `Entity<T>(readOnly = false, writeOnly = false)` | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰æŒ‡å®š |
| `.AsStream()` | ã‚¹ãƒˆãƒªãƒ¼ãƒ å‹ã¨ã—ã¦ç™»éŒ² |
| `.AsTable(topicName = null, useCache = true)` | ãƒ†ãƒ¼ãƒ–ãƒ«å‹ã¨ã—ã¦ç™»éŒ² |
| `.WithManualCommit()` | æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ– |
| `.ToQuery(build)` | æ–°DSLã§ã®ã‚¯ã‚¨ãƒªå®šç¾© |

<a id="fluent-api-guide"></a>
## Fluent API ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

POCO ãƒ¢ãƒ‡ãƒ«ã‚’ Fluent API ã§æ§‹æˆã™ã‚‹éš›ã®è¨­è¨ˆæŒ‡é‡ã¨ç§»è¡Œãƒ•ãƒ­ãƒ¼ã‚’ã¾ã¨ã‚ã¾ã™ã€‚å±æ€§ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®ç§»è¡Œå¾Œã¯
`IEntityBuilder<T>` ã‚’ç”¨ã„ã¦å®£è¨€çš„ã«è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
### 1. åŸºæœ¬æ–¹é‡
 - `[KsqlTopic]` ã‚„ `[KsqlKey]` ãªã©ã®å±æ€§ã§ãƒˆãƒ”ãƒƒã‚¯åã‚„ã‚­ãƒ¼é †åºã‚’å®£è¨€ã—ã¾ã™ã€‚
 - Fluent API ã¯ã‚¯ã‚¨ãƒªæ§‹ç¯‰ã‚„ãƒ¢ãƒ¼ãƒ‰æŒ‡å®šã®ã¿ã‚’æ‹…ã„ã€ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã¯å±æ€§ã«é›†ç´„ã—ã¾ã™ã€‚
 - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²æ™‚ã¯ `readonly` `writeonly` `readwrite` ã® 3 ç¨®é¡ã§å½¹å‰²ã‚’æŒ‡å®šã—ã€æœªæŒ‡å®šæ™‚ã¯ `readwrite` ã¨ã¿ãªã—ã¾ã™ã€‚
### 2. æ¨å¥¨è¨˜è¿°ä¾‹
```csharp
[KsqlTopic("orders")]
public class Order
{
    [KsqlKey(Order = 0)]
    public int Id { get; set; }
    public decimal Amount { get; set; }
}

void OnModelCreating(ModelBuilder builder)
{
    builder.Entity<Order>(writeOnly: true);
}
```
`[KsqlTopic]` ã‚„ `[KsqlDecimal]` å±æ€§ã§ãƒˆãƒ”ãƒƒã‚¯ã‚„ç²¾åº¦ã‚’å®£è¨€ã§ãã¾ã™ã€‚
### 3. æ—¢å­˜ POCO â†’ Fluent API ç§»è¡Œãƒ•ãƒ­ãƒ¼
1. POCO ã¸ `[KsqlTopic]` ã¨ `[KsqlKey]` ã‚’ä»˜ä¸ã—ã¦ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’è¨˜è¿°ã™ã‚‹ã€‚
2. `OnModelCreating` ã§ã¯ `Entity<T>()` ã®ç™»éŒ²ã®ã¿è¡Œã„ã€ãã®ä»–ã¯å±æ€§ã«å§”ã­ã‚‹ã€‚
3. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚­ãƒ¼é †åºã‚„ãƒˆãƒ”ãƒƒã‚¯è¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèªã™ã‚‹ã€‚
   æ—§å±æ€§ã«é–¢ã™ã‚‹è©³ç´°ã¯ `docs/namespaces/core_namespace_doc.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
### 4. MappingManager ã¨ã®é€£æº
`MappingManager` ã‚’åˆ©ç”¨ã—ã¦ key/value ã‚’æŠ½å‡ºã™ã‚‹ä¾‹ã§ã™ã€‚è©³ç´°ã¯ `docs/architecture/key_value_flow.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```csharp
var ctx = new MyKsqlContext(options);
var mapping = ctx.MappingManager;
var entity = new Order { Id = 1, Amount = 100 };
var (key, value) = mapping.ExtractKeyValue(entity);
await ctx.AddAsync(entity, headers: new Dictionary<string, string> { ["is_dummy"] = "true" });
```
#### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²ã¯ `OnModelCreating` å†…ã§ä¸€æ‹¬å®šç¾©ã™ã‚‹ã€‚
- `MappingManager` ã‚’æ¯å› `new` ã—ãªã„ã€‚DI ã‚³ãƒ³ãƒ†ãƒŠã§å…±æœ‰ã—ã€ãƒ¢ãƒ‡ãƒ«ç™»éŒ²æ¼ã‚Œã‚’é˜²ãã€‚
### 5. è¿½åŠ æ¤œè¨äº‹é …
- `[KsqlTopic]` å±æ€§ã§æŒ‡å®šã§ããªã„è©³ç´°è¨­å®šã®æ‰±ã„ã‚’æ¤œè¨ä¸­ã€‚
- MappingManager ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ç¯„å›²ï¼‰ã‚’ç¢ºå®šã™ã‚‹å¿…è¦ã‚ã‚Šã€‚
### 6. ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã§ã®æ°—ã¥ã
- `AddSampleModels` æ‹¡å¼µã§ `MappingManager` ã¸ã®ç™»éŒ²ã‚’ã¾ã¨ã‚ã‚‹ã¨æ¼ã‚Œé˜²æ­¢ã«ãªã‚‹ã€‚
- è¤‡åˆã‚­ãƒ¼ã¯ `Dictionary<string, object>` ã¨ã—ã¦æŠ½å‡ºã•ã‚Œã‚‹ãŸã‚ã€å‹å®‰å…¨ãƒ©ãƒƒãƒ‘ãƒ¼ã®æ¤œè¨ä½™åœ°ã‚ã‚Šã€‚
- `Dictionary<string,string>` å‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ Avro ã® `map` (`{"type": "map", "values": "string"}`) ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã€‚
  - ã‚­ãƒ¼ãƒ»å€¤ã¨ã‚‚ã«æ–‡å­—åˆ—ã®ã¿ã‚µãƒãƒ¼ãƒˆã€‚ãã®ä»–ã®å‹ã‚„ãƒã‚¹ãƒˆæ§‹é€ ã¯æœªå¯¾å¿œã€‚
  - `null` ã¯è¨±å®¹ã•ã‚Œãªã„ãŸã‚ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ç©ºãƒ‡ã‚£ã‚¯ã‚·ãƒ§ãƒŠãƒªã§åˆæœŸåŒ–ã™ã‚‹ã€‚
- `decimal` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ `DecimalPrecisionConfig` ã§è¨­å®šã•ã‚ŒãŸ `precision`/`scale` ã‚’æŒã¤ Avro `bytes` (`logicalType: decimal`) ã¨ã—ã¦ç”Ÿæˆã•ã‚Œã‚‹ã€‚
- è¤‡æ•°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç™»éŒ²ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒã‚ã‚‹ã¨ `OnModelCreating` ã®è¨˜è¿°é‡ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹ã€‚
### 7. AddAsync çµ±ä¸€ã«ä¼´ã†ãƒã‚¤ãƒ³ãƒˆ
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ API ã¯ `AddAsync` ã«ä¸€æœ¬åŒ–ã—ãŸã€‚æ—§ `ProduceAsync` ã¯å»ƒæ­¢äºˆå®šã€‚
- LINQ ã‚¯ã‚¨ãƒªè§£æã‹ã‚‰ `MappingManager.ExtractKeyValue()` ã‚’çµŒç”±ã— `AddAsync` ã‚’å‘¼ã³å‡ºã™æµã‚Œã‚’ã‚µãƒ³ãƒ—ãƒ«åŒ–ã€‚
- è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã¯ [architecture/query_to_addasync_sample.md](architecture/query_to_addasync_sample.md) ã‚’å‚ç…§ã€‚

## ToQuery DSL

`ToQuery` ã¯ View å®šç¾©å°‚ç”¨ã® Fluent API ã§ã™ã€‚`From<T>()` ã‚’èµ·ç‚¹ã« `Join<T2>()`ã€`Where(...)`ã€`Select(...)` ã‚’é †ã«å‘¼ã³å‡ºã—ã¦ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚JOIN ã¯2ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚Šã€çµåˆæ¡ä»¶ã¯ `Join` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§æŒ‡å®šã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ `Where` ã§è¿½åŠ ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œãˆã¾ã™ã€‚å‘¼ã³å‡ºã—é †åºãŒå®ˆã‚‰ã‚Œãªã„å ´åˆã‚„æœªã‚µãƒãƒ¼ãƒˆã® JOIN æ•°ã¯æ§‹æ–‡æ¤œè¨¼ã§ä¾‹å¤–ã¨ãªã‚Šã¾ã™ã€‚

```csharp
modelBuilder.Entity<OrderSummary>().ToQuery(q => q
    .From<Order>()
    .Join<Customer>((o, c) => o.CustomerId == c.Id)
    .Where((o, c) => c.IsActive)
    .Select((o, c) => new OrderSummary { OrderId = o.Id, CustomerName = c.Name }));
```

`.ToQuery(...)` ã§å¾—ã‚‰ã‚ŒãŸ `KsqlQueryModel` ã¯ `KsqlContext` åˆæœŸåŒ–æ™‚ã« `CREATE STREAM/TABLE AS SELECT` æ–‡ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| API / Enum                 | èª¬æ˜                           | å®Ÿè£…çŠ¶æ…‹ |
|----------------------------|--------------------------------|---------|
| `ErrorAction` (Skip/Retry/DLQ) | ã‚¨ãƒ©ãƒ¼æ™‚ã®åŸºæœ¬ã‚¢ã‚¯ã‚·ãƒ§ãƒ³    | âœ…      |
| `ErrorHandlingPolicy`      | ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚„ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©è¨­å®šã‚’ä¿æŒ | âœ… |
| `ErrorHandlingExtensions`  | `.OnError()` `.WithRetryWhen()` ç­‰ã®æ‹¡å¼µ | âœ… |
| `DlqProducer` / `DlqEnvelope` | DLQ é€ä¿¡å‡¦ç†               | âœ…      |
| `DlqOptions`    | DLQ ãƒˆãƒ”ãƒƒã‚¯ã®ä¿æŒæœŸé–“ç­‰ã‚’æŒ‡å®š | âœ…      |

## çŠ¶æ…‹ç›£è¦–ãƒ»å†…éƒ¨æ©Ÿæ§‹

| API                         | èª¬æ˜                             | å®Ÿè£…çŠ¶æ…‹ |
|-----------------------------|----------------------------------|---------|
| `ReadyStateMonitor`         | ãƒˆãƒ”ãƒƒã‚¯åŒæœŸçŠ¶æ…‹ã®ç›£è¦–           | âœ…      |
| `CacheBinding`         | Kafka ãƒˆãƒ”ãƒƒã‚¯ã¨ Cache ã®åŒæ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° | âœ… |
| `SchemaRegistryClient`      | ã‚¹ã‚­ãƒ¼ãƒç®¡ç†ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ        | âœ…      |
| `ResilientAvroSerializerManager` | Avroæ“ä½œã®ãƒªãƒˆãƒ©ã‚¤ç®¡ç†     | âœ…      |

| `WindowFinalizationManager` | Windowæœ€çµ‚åŒ–å‡¦ç†ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†  | âœ…      |

## å„ API ã®å‚™è€ƒ

- `IEventSet<T>.WithRetry()` ã®å®Ÿè£…ä¾‹ã¯ `EventSet.cs` ã«ã‚ã‚Šã¾ã™ã€F:src/EventSet.csâ€ L238-L258ã€‘ã€‚
- `OnError` ã®æ‹¡å¼µã¯ `EventSetErrorHandlingExtensions.cs` ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€F:src/EventSetErrorHandlingExtensions.csâ€ L8-L20ã€‘ã€‚
- æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆã®åˆ©ç”¨ä¾‹ã¯ [manual_commit.md](old/manual_commit.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
- `StartErrorHandling()` â†’ `.Map()` â†’ `.WithRetry()` ã®æµã‚Œã§ç´°ã‹ã„ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
- `AvroOperationRetrySettings` ã§ SchemaRegistry æ“ä½œã®ãƒªãƒˆãƒ©ã‚¤æ–¹é‡ã‚’åˆ¶å¾¡ã—ã¾ã™ã€F:src/Configuration/Options/AvroOperationRetrySettings.csâ€ L8-L33ã€‘ã€‚
### tool â€” 2025-08-10T08:58:56.674113+00:00

All the files uploaded by the user have been fully loaded. Searching won't provide additional information.
### assistant â€” 2025-08-10T08:58:56.720005+00:00

_(empty)_
### assistant â€” 2025-08-10T08:59:07.061493+00:00

_(empty)_
### user â€” 2025-08-10T09:01:12.718000+00:00

ksqlContextã®APIã®ä¸€éƒ¨ã«ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ä½œã£ã¦
### system â€” 2025-08-10T09:01:13.892763+00:00

_(empty)_
### assistant â€” 2025-08-10T09:01:13.926154+00:00

_(empty)_
### assistant â€” 2025-08-10T09:01:19.450677+00:00

äº†è§£ã€‚`ksqlContext` é…ä¸‹ã« â€œDLQå°‚ç”¨â€ ã‚’æŠ±ãè¾¼ã‚€ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã€**æ—¢å­˜ã®æ–‡è„ˆã‚’å£Šã•ãš**ã«æœ€å°APIã‚’è¶³ã—ã¾ã™ã€‚  
ï¼ˆ`IKsqlContext.Dlq` ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿã‚„ã—ã€èª­ã‚€ãƒ»è¦—ããƒ»å†æŠ•å‡½ã‚’ã¾ã¨ã‚ã‚‹ï¼‰

# ææ¡ˆAPIï¼ˆC#ï¼‰

```csharp
public interface IKsqlContext
{
    // æ—¢å­˜API ...

    /// <summary>DLQå°‚ç”¨ã®èª­ã¿å–ã‚Šï¼å†æŠ•å‡½APIã€‚</summary>
    IDlqClient Dlq { get; }
}

public interface IDlqClient
{
    /// <summary>é€æ¬¡èª­ã¿å–ã‚Šï¼ˆç›£è¦–ãƒ»å¸¸é§å‘ã‘ï¼‰ã€‚RawBytesã‚’å¯èª­åŒ–ã—ã¦è¿”ã™ã€‚</summary>
    IAsyncEnumerable<DlqRecord> ReadAsync(DlqReadOptions? options = null, CancellationToken ct = default);

    /// <summary>å…ˆé ­ã‹ã‚‰Nä»¶ã ã‘ãƒ—ãƒ«ï¼ˆUI/HTTPå‘ã‘ï¼‰ã€‚</summary>
    Task<IReadOnlyList<DlqRecord>> PeekAsync(int maxCount = 100, DlqReadOptions? options = null, CancellationToken ct = default);

    /// <summary>è¨±å¯æ¡ä»¶ã®ã‚‚ã¨ã§å†æŠ•å‡½ã€‚DLQâ†’DLQã¯ç¦æ­¢ã€‚</summary>
    Task<DlqReplayResult> ReplayAsync(DlqRecord record, DlqReplayOptions? options = null, CancellationToken ct = default);
}

// DTO/ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå…¬é–‹ï¼‰
public sealed record DlqRecord(
    string MessageId, string Topic, int Partition, long Offset, DateTime TimestampUtc,
    byte[] RawBytes, string? RawText, string PayloadFormat, int? SchemaId,
    string? SchemaSubject, int? SchemaVersion, IReadOnlyDictionary<string,string> Headers,
    string? ErrorType, string? ErrorMessage, string? StackTrace);

public sealed class DlqReadOptions
{
    public string TopicName { get; init; } = "dead-letter-queue";
    public string ValueFormat { get; init; } = "AVRO"; // å°†æ¥ "JSON" ã¸åˆ‡æ›¿å¯
    public bool FromBeginning { get; init; } = false;
    public int MaxBytesForRawText { get; init; } = 64 * 1024;
}

public sealed record DlqReplayOptions(string? TargetTopic = null);
public sealed record DlqReplayResult(bool Succeeded, string? Reason = null);
```

## ãµã‚‹ã¾ã„ï¼ˆè¦ç‚¹ï¼‰
- **å¯èª­åŒ–**ï¼š`RawBytes â†’ RawText` ã¯å†…éƒ¨ã§å®Ÿæ–½ï¼ˆJSONæ•´å½¢/AVROâ†’JSONåŒ–/ä¸å¯ã¯Base64å…ˆé ­ï¼‹truncatedï¼‰ã€‚  
- **re-DLQç¦æ­¢**ï¼š`options.TopicName` ãŒDLQãªã‚‰ `ReplayAsync` ã¯å¸¸ã« `Succeeded=false`ã€‚  
- **å°†æ¥ã®JSONç§»è¡Œ**ï¼š`DlqReadOptions.ValueFormat` ã‚’ `"JSON"` ã«å¤‰ãˆã‚‹ã ã‘ã§å¯¾å¿œã€‚  
- **DeserializationErroré€£æº**ï¼šé€šå¸¸ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å´ã® `DeserializationError` ã¯ãã®ã¾ã¾ä½¿ç”¨å¯ï¼ˆDLQå´ã¯åˆ¥é…ç·šï¼‰ã€‚

## æ—¢å®šå®Ÿè£…ã®å·®ã—è¾¼ã¿ã‚¤ãƒ¡ãƒ¼ã‚¸
```csharp
public sealed class KsqlContext : IKsqlContext
{
    public IDlqClient Dlq { get; }

    public KsqlContext(/* æ—¢å­˜DIç¾¤ */, IDlqClient dlqClient /* inject */)
    {
        // æ—¢å­˜åˆæœŸåŒ–...
        Dlq = dlqClient;
    }
}
```

```csharp
public sealed class DlqClient : IDlqClient
{
    // ä¾å­˜: Kafka IConsumer<byte[],byte[]>, ISchemaRegistryClient?, ILogger, Producer(å†æŠ•å‡½ç”¨) ç­‰
    public async IAsyncEnumerable<DlqRecord> ReadAsync(DlqReadOptions? opt = null, [EnumeratorCancellation] CancellationToken ct = default)
    {
        // byte[] å—ä¿¡ â†’ å¯èª­åŒ–ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã§ RawText/Format/SchemaId ã‚’ä»˜ä¸ â†’ DlqRecord ã§è¿”ã™
        // æˆåŠŸæ™‚ã®ã¿ã‚³ãƒŸãƒƒãƒˆã€‚å‡¦ç†å¤±æ•—ã¯ãƒ­ã‚°ã—ã¦å‰é€²ï¼ˆãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
        // ï¼ˆå®Ÿè£…è©³ç´°ã¯æ—¢å‡ºã‚¹ã‚±ãƒ«ãƒˆãƒ³ã«æº–æ‹ ï¼‰
        yield break;
    }

    public Task<IReadOnlyList<DlqRecord>> PeekAsync(int maxCount = 100, DlqReadOptions? opt = null, CancellationToken ct = default)
    { /* ReadAsync ã‚’å†…éƒ¨ã§ä½¿ã£ã¦ N ä»¶ã ã‘é›†ã‚ã¦è¿”ã™ */ throw new NotImplementedException(); }

    public Task<DlqReplayResult> ReplayAsync(DlqRecord record, DlqReplayOptions? options = null, CancellationToken ct = default)
    { /* ãƒãƒªã‚·åˆ¤å®šã®ä¸Šã§å…ƒTopicç­‰ã¸Produceã€‚DLQâ†’DLQã¯ç¦æ­¢ */ throw new NotImplementedException(); }
}
```

## ä½¿ã„æ–¹ï¼ˆåˆ©ç”¨å´ã‚³ãƒ¼ãƒ‰ï¼‰
```csharp
await foreach (var r in ksqlContext.Dlq.ReadAsync(
    new DlqReadOptions { TopicName = "dead-letter-queue", ValueFormat = "AVRO" }, ct))
{
    logger.LogInformation("[DLQ] {topic}@{off} {fmt} sid={sid}\n{raw}",
        r.Topic, r.Offset, r.PayloadFormat, r.SchemaId, r.RawText);

    // æ¡ä»¶ä»˜ãã§å†æŠ•å‡½
    var replay = await ksqlContext.Dlq.ReplayAsync(r);
    if (!replay.Succeeded) logger.LogWarning("Replay skipped: {reason}", replay.Reason);
}

// ç”»é¢ç”¨
var head = await ksqlContext.Dlq.PeekAsync(50, new DlqReadOptions { FromBeginning = true });
```

## è¨­å®šä¾‹ï¼ˆ`KsqlDslOptions` æ‹¡å¼µï¼‰
```json
{
  "KsqlDsl": {
    "DlqTopicName": "dead-letter-queue",
    "Dlq": {
      "ValueFormat": "AVRO",              // or "JSON"
      "Reader": { "GroupId": "dlq-worker", "MaxBytesForRawText": 65536 }
    }
  }
}
```

ã“ã®å½¢ãªã‚‰ã€**æ—¢å­˜ã® `KsqlContext` åˆ©ç”¨è€…ã¯ `.Dlq` ã‚’å‘¼ã¶ã ã‘**ã§å°‚ç”¨å‡¦ç†ãŒä½¿ãˆã€å°†æ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’JSONã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚å¥‘ç´„ã¯ä¸å¤‰ã§ã™ã€‚å¿…è¦ãªã‚‰ã€ã“ã®APIã‚’ `api_reference.md` ä½“è£ã§è¿½è¨˜ã¾ã§ã‚„ã‚Šã¾ã™ã€‚  

ï¼ˆ[[REDACTED_PHONE]]:01 JSTï¼‰
### assistant â€” 2025-08-10T09:01:19.877342+00:00

_(empty)_
### assistant â€” 2025-08-10T09:02:55.058648+00:00

äº†è§£ã€**`ReadAsync` ã ã‘**ã«çµã£ãŸ API æ¡ˆã€ksqlContext ç›´ä¸‹ã® â€œDLQã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆâ€ ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚å®Ÿè£…ã¯æœ€å°ãƒ»å°†æ¥æ‹¡å¼µã—ã‚„ã™ã„å½¢ã§ã™ã€‚

# ææ¡ˆAPIï¼ˆReadå°‚ç”¨ï¼‰

```csharp
public interface IKsqlContext
{
    IDlqClient Dlq { get; }  // æ—¢å­˜ã«è¿½åŠ 
}

public interface IDlqClient
{
    /// <summary>
    /// DLQ ã‚’é€æ¬¡èª­ã¿å–ã‚Šã€äººé–“å¯èª­ãª RawText ã‚’ä»˜ä¸ã—ã¦è¿”ã—ã¾ã™ã€‚
    /// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆBase64 å…ˆé ­ã®ã¿ç­‰ï¼‰ã§å¿…ãš 1 ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¾ã¨ã‚ã¾ã™ã€‚
    /// </summary>
    IAsyncEnumerable<DlqRecord> ReadAsync(
        DlqReadOptions? options = null,
        CancellationToken ct = default);
}
```

## ä»˜éšå‹ï¼ˆæœ€å°ï¼‰

```csharp
public sealed record DlqRecord(
    string MessageId,                 // Guid.ToString("D")
    string Topic,
    int Partition,
    long Offset,
    DateTime TimestampUtc,
    byte[] RawBytes,                  // çœŸå®Ÿã®ã‚½ãƒ¼ã‚¹ï¼ˆãã®ã¾ã¾ï¼‰
    string? RawText,                  // å¯èª­åŒ–æ¸ˆã¿ï¼ˆæ•´å½¢JSON/ãƒ†ã‚­ã‚¹ãƒˆ/ä¸€éƒ¨Base64ãªã©ï¼‰
    string PayloadFormat,             // "avro" | "json" | "protobuf" | "binary" | "empty"
    int? SchemaId,                    // Confluent wire-format ãªã‚‰æŠ½å‡º
    string? SchemaSubject,
    int? SchemaVersion,
    IReadOnlyDictionary<string,string> Headers,
    string? ErrorType,
    string? ErrorMessage,
    string? StackTrace);
```

```csharp
public sealed class DlqReadOptions
{
    public string TopicName { get; init; } = "dead-letter-queue";
    public string ValueFormat { get; init; } = "AVRO"; // å°†æ¥ "JSON" ã«å¤‰æ›´å¯
    public bool FromBeginning { get; init; } = false;  // true ã§ earliest ã«ã‚·ãƒ¼ã‚¯
    public int MaxBytesForRawText { get; init; } = 64 * 1024; // RawText ã®æœ€å¤§ç”Ÿæˆã‚µã‚¤ã‚º
    public bool CommitOnRead { get; init; } = true;    // true: 1ä»¶ã”ã¨ã«ã‚³ãƒŸãƒƒãƒˆã—ã¦å‰é€²
}
```

## ãµã‚‹ã¾ã„ï¼ˆä»•æ§˜è¦ç‚¹ï¼‰
- **å—ä¿¡ã¯å¸¸ã« byte[]** ã¨ã—ã¦è¡Œã„ã€å†…éƒ¨ã§å¯èª­åŒ–ï¼ˆJSONæ•´å½¢ / AVROâ†’JSON åŒ– / å¤±æ•—æ™‚ã¯ Base64 å…ˆé ­ï¼‹`(truncated)`ï¼‰ã€‚
- **SchemaId æŠ½å‡º**ï¼šConfluent ãƒ¯ã‚¤ãƒ¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå…ˆé ­ 0 + 4byte IDï¼‰ã®å ´åˆã¯ `SchemaId` ã‚’è¨­å®šã€‚
- **ã‚³ãƒŸãƒƒãƒˆ**ï¼š`CommitOnRead=true` ã®ã¨ãã€å¯èª­åŒ–ãŒæˆåŠŸã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ **yield å‰ã« commit**ã€‚å¯èª­åŒ–ã«å¤±æ•—ã—ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨˜éŒ²ã‚’ç”Ÿæˆã—ã¦ **commit**ï¼ˆç„¡é™ãƒªãƒˆãƒ©ã‚¤é˜²æ­¢ï¼‰ã€‚
- **ã‚­ãƒ£ãƒ³ã‚»ãƒ«**ï¼š`CancellationToken` ã§å®‰å…¨ã«ä¸­æ–­ï¼ˆ`OperationCanceledException` ã¯å¤–ã¸æŠ•ã’ãšå®Œäº†ã¨ã—ã¦çµ‚äº†ï¼‰ã€‚
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ‡æ›¿**ï¼šDLQ ã‚’ JSON ã«ç§»è¡Œã—ã¦ã‚‚ã€`ValueFormat="JSON"` ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ã§åˆ©ç”¨å´ã¯ãã®ã¾ã¾ã€‚
- **re-DLQ ç¦æ­¢**ï¼šæœ¬ API ã¯ **èª­ã‚€ã ã‘**ã€‚å†æŠ•å‡½ã¯åˆ¥ API ã«å¾Œæ—¥è¿½åŠ ï¼ˆå¥‘ç´„ã‚’æ±šã•ãªã„ï¼‰ã€‚

## ä½¿ã„æ–¹ï¼ˆæœ€å°ä¾‹ï¼‰

```csharp
await foreach (var r in ksqlContext.Dlq.ReadAsync(
    new DlqReadOptions {
        TopicName = "dead-letter-queue",
        ValueFormat = "AVRO",          // å°†æ¥ JSON ã¸åˆ‡æ›¿å¯
        FromBeginning = false,
        MaxBytesForRawText = 64 * 1024,
        CommitOnRead = true
    }, ct))
{
    _log.LogInformation("[DLQ] {topic}[{part}]@{off} fmt={fmt} sid={sid}\n{raw}",
        r.Topic, r.Partition, r.Offset, r.PayloadFormat, r.SchemaId, r.RawText);
    // èª­ã‚€ã ã‘ã€‚å†æŠ•å‡½ã¯åˆ¥ãƒ¬ã‚¤ãƒ¤ã§ã€‚
}
```

## å®Ÿè£…ãƒ¡ãƒ¢ï¼ˆå†…å´ã®æœŸå¾…å€¤ï¼‰
- **å¯èª­åŒ–**ã¯ 1 ãƒ¡ã‚½ãƒƒãƒ‰ã«é›†ç´„ï¼ˆä¾‹ï¼š`DlqPayloadFormatter.PopulateAsync`ï¼‰ã€‚  
  - JSON: UTF-8 ã§æ•´å½¢  
  - AVRO: Schema Registry ãŒã‚ã‚Œã° Generic ã§ JSON åŒ–ã€ãªã‘ã‚Œã° Base64 éƒ¨åˆ†è¡¨ç¤º  
  - Protobuf: å¯èƒ½ãªã‚‰ JSON åŒ–  
- **ãƒ˜ãƒƒãƒ€**ã¯ `Dictionary<string,string>` ã« UTF-8 ã§å–ã‚Šè¾¼ã¿ï¼ˆèª­ã‚ãªã„ã‚‚ã®ã¯ Base64 ã§å¯ï¼‰ã€‚  
- **MessageId**ï¼šDLQ ã«å…¥ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’å„ªå…ˆã€‚ãªã‘ã‚Œã° `Guid.NewGuid().ToString("D")` ã§ä»˜ä¸ã€‚

å¿…è¦ãªã‚‰ã€ã“ã® API ã‚’ `api_reference.md` ã«è¿½è¨˜ã™ã‚‹ãƒ‘ãƒƒãƒã‚‚ã™ãå‡ºã—ã¾ã™ã€‚  

ï¼ˆ[[REDACTED_PHONE]]:03 JSTï¼‰
### user â€” 2025-08-10T09:02:55.203000+00:00

ReadAsyncã®APIã ã‘ã¨ã—ã¾ã™
### system â€” 2025-08-10T09:02:55.550077+00:00

_(empty)_
### assistant â€” 2025-08-10T09:02:55.558213+00:00

_(empty)_
### assistant â€” 2025-08-10T09:03:07.607721+00:00

_(empty)_
### system â€” 2025-08-10T09:05:30.610599+00:00

_(empty)_
### assistant â€” 2025-08-10T09:05:30.705563+00:00

äº†è§£ã§ã™ã€‚  
`DlqReadOptions` ã‹ã‚‰ **`TopicName`** ã¨ **`ValueFormat`** ã‚’å‰Šé™¤ã—ã€Avroå°‚ç”¨å‰æã«ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‡ºã—ã¾ã™ã€‚  

---

## æ›´æ–°ç‰ˆ APIï¼ˆReadå°‚ç”¨ / Avroå›ºå®šï¼‰

```csharp
public interface IKsqlContext
{
    IDlqClient Dlq { get; }  // æ—¢å­˜ã«è¿½åŠ 
}

public interface IDlqClient
{
    /// <summary>
    /// DLQ ã‚’é€æ¬¡èª­ã¿å–ã‚Šã€äººé–“å¯èª­ãª RawText ã‚’ä»˜ä¸ã—ã¦è¿”ã—ã¾ã™ã€‚
    /// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆBase64 å…ˆé ­ã®ã¿ç­‰ï¼‰ã§å¿…ãš 1 ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¾ã¨ã‚ã¾ã™ã€‚
    /// </summary>
    IAsyncEnumerable<DlqRecord> ReadAsync(
        DlqReadOptions? options = null,
        CancellationToken ct = default);
}
```
### ä»˜éšå‹ï¼ˆå¤‰æ›´ãªã—ï¼‰

```csharp
public sealed record DlqRecord(
    string MessageId,
    string Topic,
    int Partition,
    long Offset,
    DateTime TimestampUtc,
    byte[] RawBytes,
    string? RawText,
    string PayloadFormat,             // å›ºå®šå€¤ "avro"
    int? SchemaId,
    string? SchemaSubject,
    int? SchemaVersion,
    IReadOnlyDictionary<string,string> Headers,
    string? ErrorType,
    string? ErrorMessage,
    string? StackTrace);
```
### ç°¡ç•¥åŒ–ã•ã‚ŒãŸ `DlqReadOptions`

```csharp
public sealed class DlqReadOptions
{
    public bool FromBeginning { get; init; } = false;  // true: earliest ã‹ã‚‰èª­ã‚€
    public int MaxBytesForRawText { get; init; } = 64 * 1024; 
    public bool CommitOnRead { get; init; } = true;    // true: 1ä»¶ã”ã¨ã«ã‚³ãƒŸãƒƒãƒˆ
}
```

---
### ä½¿ã„æ–¹ä¾‹

```csharp
await foreach (var r in ksqlContext.Dlq.ReadAsync(
    new DlqReadOptions {
        FromBeginning = false,
        MaxBytesForRawText = 64 * 1024,
        CommitOnRead = true
    }, ct))
{
    _log.LogInformation("[DLQ] {topic}[{part}]@{off} sid={sid}\n{raw}",
        r.Topic, r.Partition, r.Offset, r.SchemaId, r.RawText);
}
```

---

ã“ã®å½¢ã«ã—ã¦ãŠãã¨ã€  
- **ãƒˆãƒ”ãƒƒã‚¯åå›ºå®š**ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã§çµ±ä¸€ç®¡ç†ï¼‰  
- **Avroå°‚ç”¨**ï¼ˆSchema Registryå‰æã§JSONåŒ–ï¼‰  
- APIå‘¼ã³å‡ºã—ã¯ç°¡æ½”  

ã¨ã„ã†æ§‹é€ ã«ãªã‚Šã¾ã™ã€‚  

ã“ã®ã‚ã¨ã€APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã«è¿½è¨˜ã™ã‚‹å½¢å¼ã§æ›¸ãå‡ºã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€ãã†ã—ã¾ã™ã‹ï¼Ÿ  
ï¼ˆ[[REDACTED_PHONE]]:06 JSTï¼‰
### user â€” 2025-08-10T09:05:31.798000+00:00

DlqReadOptionsã‹ã‚‰TopicName ã¯å¤–ã™ã€‚ã“ã‚Œã¯å…¨ä½“ã§æ±ºã¾ã£ã¦ã‚‹ãŸã‚
ValueFormat ã¯å¤–ã™ã€‚avroã®ã¿ã®ãŸã‚
### user â€” 2025-08-10T09:06:07.761000+00:00

ã“ã‚Œã§codexã«ä¾é ¼ã—ã¾ã™ã€‚apiä»•æ§˜æ›¸ç­‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å«ã‚æŒ‡ç¤ºæ–‡ã‚’ãã ã•ã„
### assistant â€” 2025-08-10T09:06:08.371779+00:00

å¸ä»¤ã€Codexå‘ã‘ã®**ãã®ã¾ã¾è²¼ã‚Œã‚‹ä¾é ¼æ–‡**ã‚’ç”¨æ„ã—ãŸã‚ˆã€‚  
ï¼ˆAPIå®Ÿè£…ï¼‹ãƒ†ã‚¹ãƒˆï¼‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã¾ã§å«ã‚ãŸç™ºæ³¨æ›¸ï¼‰

---

# Codexä¾é ¼æ–‡ï¼šDLQ Readå°‚ç”¨APIã®è¿½åŠ ï¼ˆAvroå›ºå®šï¼‰ï¼‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

## ç›®çš„
- `ksqlContext` é…ä¸‹ã« **DLQç”¨ Read å°‚ç”¨API** ã‚’è¿½åŠ ã—ã€DLQï¼ˆAvroå›ºå®šï¼‰ã‚’â€œå¯èª­åŒ–ã—ã¦â€é€æ¬¡å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚  
- **Topicåã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã§å›ºå®š**ï¼ˆ`KsqlDslOptions.DlqTopicName` ã‚’æƒ³å®šï¼‰ã€‚  
- **ValueFormat ã¯ Avro å›ºå®š**ã€‚  
- ä»•æ§˜ã«åŸºã¥ã **APIä»•æ§˜æ›¸ãƒ»ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹æ›´æ–°** ã‚‚åŒæ™‚ã«è¡Œã†ã€‚

---

## ã‚¹ã‚³ãƒ¼ãƒ— / è¦ä»¶ï¼ˆå¿…é ˆï¼‰
1) **å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®è¿½åŠ **
   - `IKsqlContext` ã« `IDlqClient Dlq { get; }` ã‚’è¿½åŠ 
   - `IDlqClient`ï¼ˆReadå°‚ç”¨ï¼‰ã‚’æ–°è¦è¿½åŠ 
   - ä»˜éš DTO/Options ã‚’è¿½åŠ ï¼ˆä»•æ§˜ã¯ä¸‹è¨˜ï¼‰

   ```csharp
   public interface IKsqlContext
   {
       IDlqClient Dlq { get; } // æ–°è¦
   }

   public interface IDlqClient
   {
       /// <summary>
       /// DLQ ã‚’é€æ¬¡èª­ã¿å–ã‚Šã€äººé–“å¯èª­ãª RawText ã‚’ä»˜ä¸ã—ã¦è¿”ã—ã¾ã™ã€‚
       /// ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆBase64 å…ˆé ­ã®ã¿ç­‰ï¼‰ã§ 1 ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¾ã¨ã‚ã¾ã™ã€‚
       /// </summary>
       IAsyncEnumerable<DlqRecord> ReadAsync(
           DlqReadOptions? options = null,
           CancellationToken ct = default);
   }

   public sealed record DlqRecord(
       string MessageId,
       string Topic,
       int Partition,
       long Offset,
       DateTime TimestampUtc,
       byte[] RawBytes,
       string? RawText,
       string PayloadFormat,   // å›ºå®šå€¤ "avro"
       int? SchemaId,          // Confluent wire-formatã‹ã‚‰æŠ½å‡ºã§ããŸå ´åˆã®ã¿
       string? SchemaSubject,
       int? SchemaVersion,
       IReadOnlyDictionary<string,string> Headers,
       string? ErrorType,
       string? ErrorMessage,
       string? StackTrace
   );

   public sealed class DlqReadOptions
   {
       public bool FromBeginning { get; init; } = false;     // trueãªã‚‰ earliest ã¸ã‚·ãƒ¼ã‚¯
       public int MaxBytesForRawText { get; init; } = 64 * 1024;
       public bool CommitOnRead { get; init; } = true;       // true: 1ä»¶ã”ã¨ã«ã‚³ãƒŸãƒƒãƒˆ
   }
   ```

2) **å®Ÿè£…æ–¹é‡ï¼ˆæœ€å°ãƒ»å …ç‰¢ï¼‰**
   - **ãƒˆãƒ”ãƒƒã‚¯åã¯è¨­å®šã‹ã‚‰å–å¾—**ï¼š`KsqlDslOptions.DlqTopicName` ã‚’ä½¿ç”¨ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä¾‹å¤–ï¼‰
   - **å—ä¿¡ã¯ byte[]**ï¼ˆKey/Valueï¼‰ã§è¡Œã„ã€ã‚¢ãƒ—ãƒªå´ã§å¯èª­åŒ–
   - **Confluent Avro wire-format** ã‚’å‰æã«ã€å…ˆé ­5ãƒã‚¤ãƒˆã‹ã‚‰ `SchemaId` ã‚’æŠ½å‡º  
     - `bytes[0] == 0`ã€`bytes[1..4]` ãŒ Big-Endian ã® SchemaId
   - **å¯èª­åŒ–ï¼ˆRawTextï¼‰ãƒ­ã‚¸ãƒƒã‚¯**ï¼š
     - å¯èƒ½ãªã‚‰ Schema Registry çµŒç”±ã® Generic ååºåˆ—åŒ– â†’ JSON æ•´å½¢ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ2ï¼‰
     - å¤±æ•—æ™‚ã¯ `UTF-8 JSON ã¨ã—ã¦æ•´å½¢` è©¦è¡Œ â†’ ã•ã‚‰ã«å¤±æ•—ã—ãŸã‚‰ **Base64 å…ˆé ­ N ãƒã‚¤ãƒˆï¼‹`(truncated)`**ï¼ˆNã¯ `MaxBytesForRawText`ï¼‰
     - `PayloadFormat` ã¯å¸¸ã« `"avro"` ã‚’ã‚»ãƒƒãƒˆ
   - **Headers**ï¼šUTF-8 ã¨ã—ã¦æ–‡å­—åˆ—åŒ–ï¼ˆä¸å¯èƒ½ãªå ´åˆã¯ Base64ï¼‰
   - **ã‚³ãƒŸãƒƒãƒˆæˆ¦ç•¥**ï¼š
     - `CommitOnRead=true`ï¼šãƒ¬ã‚³ãƒ¼ãƒ‰å‡¦ç†ï¼ˆå¯èª­åŒ–å«ã‚€ï¼‰ãŒå®Œäº†ã—ãŸã‚‰ **yield å‰ã« commit**
     - å¯èª­åŒ–ã«å¤±æ•—ã—ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ `DlqRecord` ã‚’ç”Ÿæˆã—ã¦ **commit**ï¼ˆç„¡é™ãƒªãƒˆãƒ©ã‚¤é˜²æ­¢ï¼‰
   - **FromBeginning**ï¼š`true` ã®å ´åˆã€åˆå›èµ·å‹•æ™‚ã« earliest ã¸ã‚·ãƒ¼ã‚¯
   - `CancellationToken` ã‚’é©åˆ‡ã«ä¼æ’­ã—ã€`OperationCanceledException` ã¯å¤–ã¸æŠ•ã’ãš **æ­£å¸¸çµ‚äº†**æ‰±ã„

3) **æ—¢å­˜æ§‹æˆã¨ã®çµ±åˆ**
   - `KsqlContext`ï¼ˆã¾ãŸã¯æ—¢å­˜ã® `KsqlContext` å®Ÿè£…ï¼‰ã« `IDlqClient` ã‚’ **DIæ³¨å…¥**ã—ã¦ `Dlq` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿”ã™
   - æ—¢å­˜ã® Consumer æ§‹ç¯‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ`KafkaConsumerManager` ç­‰ï¼‰ãŒã‚ã‚Œã°å†åˆ©ç”¨å¯ã€‚ãªã‘ã‚Œã°æœ€å°é™ã® `ConsumerBuilder<byte[],byte[]>` å®Ÿè£…ã§OK
   - Schema Registry ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆ`ISchemaRegistryClient`ï¼‰ã¯æ—¢å­˜ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒª/è¨­å®šã‚’æµç”¨

4) **ãƒ†ã‚¹ãƒˆ**
   - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ã®ã¿ã§OKï¼‰
     - **æ­£å¸¸ç³»**ï¼šConfluent wire-format + SR ã‚ã‚Š â†’ `SchemaId` ãŒè¨­å®šã•ã‚Œã€`RawText` ãŒ JSON æ•´å½¢ã•ã‚Œã‚‹
     - **SR ä¸å¯/å¤±æ•—ç³»**ï¼šUTF-8 JSON ã«è¦‹ãˆã‚‹ bytes â†’ JSON æ•´å½¢ã•ã‚Œã‚‹
     - **å®Œå…¨ãƒã‚¤ãƒŠãƒªç³»**ï¼š`RawText` ãŒ Base64 å…ˆé ­ï¼‹`(truncated)`ã€`SchemaId` ã¯å­˜åœ¨ã™ã‚Œã°ã‚»ãƒƒãƒˆ
     - **FromBeginning**ï¼š`FromBeginning=true` ã§ earliest ã‚·ãƒ¼ã‚¯ã®å‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã‚‹ï¼ˆãƒ¢ãƒƒã‚¯ã§æ¤œè¨¼ï¼‰
     - **CommitOnRead**ï¼š`true/false` å„è¨­å®šã§ commit å‘¼ã³å‡ºã—ã®æœ‰ç„¡ã‚’æ¤œè¨¼
     - **ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‹•ä½œ**ï¼š`CancellationToken` ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹
   - ï¼ˆä»»æ„ï¼‰ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼šTestcontainers ã§ Kafka+SR ã‚’ç«‹ã¦ã€å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥â†’`ReadAsync` ã§å–å¾—ãƒ»æ¤œè¨¼ï¼ˆæ™‚é–“ãŒåˆãˆã°ï¼‰

5) **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**
   - `api_reference.md` ã« **ã€ŒDLQ Read APIï¼ˆAvroå›ºå®šï¼‰ã€** ç¯€ã‚’æ–°è¦è¿½åŠ   
     - å…¬é–‹ã‚·ã‚°ãƒãƒãƒ£ï¼ˆä¸Šè¨˜ã®ã¾ã¾ï¼‰  
     - ä½¿ã„æ–¹ã‚µãƒ³ãƒ—ãƒ«ï¼ˆä»¥ä¸‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¨˜è¼‰ï¼‰  
     - ä»•æ§˜ï¼ˆFromBeginning/CommitOnRead/å¯èª­åŒ–ã®æŒ¯ã‚‹èˆã„ï¼‰  
     - æ—¢çŸ¥ã®åˆ¶ç´„ï¼ˆAvroå›ºå®šã€å†æŠ•å‡½ã¯éå¯¾å¿œã€æœ¬APIã¯â€œèª­ã‚€ã ã‘â€ï¼‰
   - æ—¢å­˜ã®ã€Œã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°/DeserializationErrorã€ç¯€ã« **é–¢é€£ãƒªãƒ³ã‚¯** ã‚’è¿½åŠ ï¼ˆDLQèª­å–ã¯ `.Dlq.ReadAsync(...)` ã‚’å‚ç…§ï¼‰
   - `CHANGELOG.md` è¿½åŠ ï¼ˆã‚¨ãƒ³ãƒˆãƒªä¾‹ï¼‰
     ```
     feat(dlq): Add IKsqlContext.Dlq.ReadAsync for Avro-based DLQ reading with human-readable RawText.
     ```

6) **éã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆã‚„ã‚‰ãªã„ï¼‰**
   - DLQ ã¸ã® **æ›¸ãè¾¼ã¿çµŒè·¯ã®å¤‰æ›´**  
   - **JSON æ ¼ç´**ã¸ã®åˆ‡æ›¿ãƒ»CSAS ç­‰ã®kSQLæ“ä½œ  
   - **Replay API** ã®å®Ÿè£…ï¼ˆä»Šå›ã¯ Read ã®ã¿ï¼‰

---

## å‚è€ƒã‚³ãƒ¼ãƒ‰ï¼ˆå¯èª­åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®é››å½¢ï¼‰

```csharp
static int? TryExtractSchemaId(byte[] bytes)
{
    if (bytes is { Length: >= 5 } && bytes[0] == 0)
        return (bytes[1] << 24) | (bytes[2] << 16) | (bytes[3] << 8) | bytes[4];
    return null;
}

static string? TryUtf8JsonPretty(byte[] bytes)
{
    try {
        var txt = System.Text.Encoding.UTF8.GetString(bytes);
        using var doc = System.Text.Json.JsonDocument.Parse(txt);
        return System.Text.Json.JsonSerializer.Serialize(doc,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
    } catch { return null; }
}

static string FallbackBase64(byte[] bytes, int max)
{
    var take = Math.Min(bytes.Length, max);
    var head = Convert.ToBase64String(bytes.AsSpan(0, take));
    return take < bytes.Length ? $"{head} (truncated)" : head;
}
```

> SR çµŒç”±ã® Avroâ†’JSON å¤‰æ›ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆGenericRecord åŒ–â†’JSONåŒ–ï¼‰ãŒã‚ã‚Œã°ãã‚Œã‚’åˆ©ç”¨ã€‚ãªã‘ã‚Œã° TODO ã¨ã—ã¦ã‚¹ã‚¿ãƒ–ã—ã€SRæœªåˆ©ç”¨ãƒ‘ã‚¹ï¼ˆ`TryUtf8JsonPretty` â†’ `FallbackBase64`ï¼‰ã§ãƒ†ã‚¹ãƒˆã‚’å…ˆã«é€šã™ã€‚

---

## å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆACï¼‰
- `IKsqlContext.Dlq.ReadAsync` ãŒå…¬é–‹ã•ã‚Œã€**Avroå›ºå®š**ã®ä»•æ§˜ã©ãŠã‚Šã«å‹•ä½œã™ã‚‹
- **Topicåã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‹ã‚‰å–å¾—**ã—ã€`DlqReadOptions` ã« `TopicName` ã¯å­˜åœ¨ã—ãªã„
- `DlqRecord.PayloadFormat == "avro"` ãŒå¸¸ã«ã‚»ãƒƒãƒˆã•ã‚Œã‚‹
- **å¯èª­åŒ–**ï¼šSRã‚ã‚Šã®Avroã§ JSON æ•´å½¢ã€SRãªã—/å¤±æ•—æ™‚ã« UTF-8 JSONæ•´å½¢ã¾ãŸã¯ Base64 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **FromBeginning/CommitOnRead** ã®æŒ™å‹•ãŒãƒ†ã‚¹ãƒˆã§ç¢ºèªã§ãã‚‹
- `api_reference.md` ãŒæ›´æ–°ã•ã‚Œã€ä½¿ç”¨ä¾‹ãŒæ²è¼‰ã•ã‚Œã¦ã„ã‚‹
- æ—¢å­˜ã®å…¬é–‹APIã¨ã®äº’æ›æ€§ã«å½±éŸ¿ãŒãªã„ï¼ˆç ´å£Šçš„å¤‰æ›´ãªã—ï¼‰

---

## ææ¡ˆã‚³ãƒŸãƒƒãƒˆç²’åº¦
1. `feat(api): add Dlq read-only interfaces (IKsqlContext.Dlq, IDlqClient, DlqRecord, DlqReadOptions)`  
2. `feat(impl): implement DlqClient.ReadAsync with Avro wire-format parsing and human-readable RawText`  
3. `test(dlq): add unit tests for ReadAsync (sr success/fallback/json/base64, fromBeginning, commit)`  
4. `docs(api): update api_reference.md with DLQ Read API (Avro only)`  
5. `chore: update CHANGELOG.md`

---

ä»¥ä¸Šã€‚ç–‘å•ç‚¹ãŒã‚ã‚Œã° `TODO:` ã‚³ãƒ¡ãƒ³ãƒˆã§æ®‹ã—ã€**ãƒ†ã‚¹ãƒˆã‚’å…ˆã«ã‚°ãƒªãƒ¼ãƒ³**ã«ã—ã¦ã‹ã‚‰SRçµŒç”±ã®Avroâ†’JSONå¤‰æ›ã®ä¸­èº«ã‚’è©°ã‚ã¦ãã ã•ã„ã€‚  

ï¼ˆ[[REDACTED_PHONE]]:10 JSTï¼‰
### system â€” 2025-08-10T09:06:08.870387+00:00

_(empty)_
### assistant â€” 2025-08-10T09:06:08.880048+00:00

_(empty)_
### assistant â€” 2025-08-10T09:06:11.800352+00:00

_(empty)_
### user â€” 2025-08-10T10:06:33.005000+00:00

addasync/foreachasync/toListAsync/DLQã¾ã§ç‰©ç†è©¦é¨“çµ‚ã‚ã£ãŸ
ä»Šåº¦ã¯ã‚¯ã‚¨ãƒªã®éƒ¨åˆ†ã«ãªã‚‹
KSQLDBå´ã§ã®å‡¦ç†ã¨ãªã‚‹ãŸã‚ã€ã‚¯ã‚¨ãƒªç™»éŒ²ï¼‹AddAsync å—ä¿¡å´ã¯KSQLDBã§ç™»éŒ²ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ ¼ç´å…ˆãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰ã®consumeã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã•ãã›ã„ã—ãŸã„
### system â€” 2025-08-10T10:06:33.180220+00:00

_(empty)_
### assistant â€” 2025-08-10T10:06:33.260257+00:00

ã„ã„ã­ã€ã“ã“ã‹ã‚‰ã¯ **KSQLDB ã§ã‚¯ã‚¨ãƒªã‚’ç™»éŒ²ï¼ˆæ°¸ç¶šåŒ–ï¼‰â†’ AddAsync ã§æŠ•å…¥ â†’ KSQLDB ãŒåã â€œæ ¼ç´å…ˆãƒˆãƒ”ãƒƒã‚¯ï¼ˆã‚·ãƒ³ã‚¯ï¼‰â€ ã‚’ã‚¢ãƒ—ãƒªãŒ consume** ã®å®šå‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œã‚Œã°ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚æœ€å°æ§‹æˆã®â€œå‹â€ã‚’ç½®ãã¾ã™ã€‚

# å…¨ä½“ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæµã‚Œï¼‰
1) **ã‚½ãƒ¼ã‚¹å®šç¾©**ï¼šã‚¢ãƒ—ãƒªãŒ `AddAsync` ã§æ›¸ããƒˆãƒ”ãƒƒã‚¯ã«å¯¾ã™ã‚‹ `CREATE STREAM`ï¼ˆAVROï¼‰
2) **ã‚¯ã‚¨ãƒªç™»éŒ²**ï¼š`CSAS/CTAS/INSERT INTO` ã§**æ°¸ç¶šã‚¯ã‚¨ãƒª**ã‚’ä½œæˆï¼ˆã‚·ãƒ³ã‚¯å…ˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ±ºã‚ã‚‹ï¼‰
3) **ã‚¢ãƒ—ãƒªå´**  
   - é€ä¿¡ï¼š`AddAsync<SourcePoco>(â€¦)` â†’ KSQLDB ãŒå‡¦ç†  
   - å—ä¿¡ï¼š**ã‚·ãƒ³ã‚¯ãƒˆãƒ”ãƒƒã‚¯**ç”¨ã® POCO ã‚’ä½œã‚Šï¼ˆã¾ãŸã¯ byte[]ï¼‰ã€é€šå¸¸ã®ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã§ subscribe

---

# 1) ã‚½ãƒ¼ã‚¹å®šç¾©ï¼ˆ`CREATE STREAM`ï¼‰
- ã‚¹ãƒˆãƒªãƒ¼ãƒ åã¯ **è‹±æ•°å­— + `_`**ï¼ˆ`-` ã‚„ `.` ã¯ä¸å¯ï¼‰
- **ãƒˆãƒ”ãƒƒã‚¯åã¯è‡ªç”±**ï¼ˆ`-` OKï¼‰ã€‚AVRO/TopicNameStrategy å‰æ

```sql
-- ã‚¢ãƒ—ãƒªã‹ã‚‰ AddAsync ã§æ›¸ãå…ˆï¼ˆä¾‹ï¼šorders-inï¼‰
CREATE STREAM orders_in (
  OrderId       STRING KEY,
  CustomerId    STRING,
  Amount        DECIMAL(10,2),
  CreatedAt     TIMESTAMP
) WITH (
  KAFKA_TOPIC='orders-in',
  KEY_FORMAT='AVRO',
  VALUE_FORMAT='AVRO',
  TIMESTAMP='CreatedAt',
  PARTITIONS=3,
  REPLICAS=1
);
```

> ã™ã§ã«ãƒˆãƒ”ãƒƒã‚¯ï¼‹ã‚¹ã‚­ãƒ¼ãƒãŒã‚ã‚‹å ´åˆã€**åˆ—å®šç¾©ã¯ã‚¹ã‚­ãƒ¼ãƒæº–æ‹ **ã§ã€‚æœªçŸ¥ãªã‚‰ `PRINT 'orders-in' FROM BEGINNING LIMIT 5;` ã§å½¢ç¢ºèªâ†’å®šç¾©ã€‚

---

# 2) ã‚¯ã‚¨ãƒªç™»éŒ²ï¼ˆæ°¸ç¶šåŒ–ï¼‰
## (A) å˜ç´”å¤‰æ›ï¼š`CSAS`
```sql
-- ä¾‹ï¼šå¿…è¦ãªåˆ—ã ã‘æ®‹ã—ã¦æ­£è¦åŒ–
CREATE STREAM IF NOT EXISTS orders_out
WITH (
  KAFKA_TOPIC='orders-out',      -- â† ã‚·ãƒ³ã‚¯å…ˆãƒˆãƒ”ãƒƒã‚¯ï¼ˆã‚¢ãƒ—ãƒªãŒ consume ã™ã‚‹å…ˆï¼‰
  VALUE_FORMAT='AVRO',
  PARTITIONS=3, REPLICAS=1
) AS
SELECT
  OrderId,
  UCASE(CustomerId) AS CustomerId,
  Amount,
  CreatedAt
FROM orders_in
EMIT CHANGES;
```

## (B) é›†è¨ˆãƒ“ãƒ¥ãƒ¼ï¼š`CTAS`ï¼ˆTABLEï¼‰
```sql
-- ä¾‹ï¼šé¡§å®¢åˆ¥ã®åˆè¨ˆé‡‘é¡ã‚’é›†è¨ˆ
CREATE TABLE IF NOT EXISTS orders_by_customer
WITH (
  KAFKA_TOPIC='orders-by-customer',   -- ã‚·ãƒ³ã‚¯å…ˆï¼ˆTABLEã®changelogï¼‰
  VALUE_FORMAT='AVRO',
  PARTITIONS=3, REPLICAS=1
) AS
SELECT CustomerId, SUM(Amount) AS TotalAmount
FROM orders_in
GROUP BY CustomerId
EMIT CHANGES;
```

> ãƒã‚¤ãƒ³ãƒˆ  
> - **æ°¸ç¶šã‚¯ã‚¨ãƒª**ã¯ KSQLDB ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ°ã‚Šç¶šã‘ã€æŒ‡å®šãƒˆãƒ”ãƒƒã‚¯ã«**å¸¸ã«æ›¸ãå‡ºã™**  
> - **ã‚·ãƒ³ã‚¯ãƒˆãƒ”ãƒƒã‚¯å**ã‚’æ˜ç¤ºã—ã¦ãŠãã¨ã€ã‚¢ãƒ—ãƒªãŒ subscribe ã—ã‚„ã™ã„  
> - **é›†è¨ˆï¼ˆTABLEï¼‰**ã¯*æ›´æ–°*ãŒæ¥ã‚‹ã®ã§ã€**changelog** ã¨ã—ã¦èª­ã‚€ã‹å†æ•´å½¢ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ åŒ–ã™ã‚‹ã‹ã‚’é¸ã¶

---

# 3) ç™»éŒ²ã‚³ãƒãƒ³ãƒ‰ï¼ˆPowerShell / RESTï¼‰
```powershell
# ä¾‹ï¼šã‚½ãƒ¼ã‚¹ä½œæˆ
curl -Method POST "http://localhost:8088/ksql" `
  -Headers @{ "Content-Type"="application/vnd.ksql.v1+json; charset=utf-8" } `
  -Body '{ "ksql": "CREATE STREAM orders_in (OrderId STRING KEY, CustomerId STRING, Amount DECIMAL(10,2), CreatedAt TIMESTAMP) WITH (KAFKA_TOPIC=''orders-in'', KEY_FORMAT=''AVRO'', VALUE_FORMAT=''AVRO'', TIMESTAMP=''CreatedAt'', PARTITIONS=3, REPLICAS=1);" }'

# ä¾‹ï¼šCSASï¼ˆã‚·ãƒ³ã‚¯ç™»éŒ²ï¼‰
curl -Method POST "http://localhost:8088/ksql" `
  -Headers @{ "Content-Type"="application/vnd.ksql.v1+json; charset=utf-8" } `
  -Body '{ "ksql": "CREATE STREAM IF NOT EXISTS orders_out WITH (KAFKA_TOPIC=''orders-out'', VALUE_FORMAT=''AVRO'', PARTITIONS=3, REPLICAS=1) AS SELECT OrderId, UCASE(CustomerId) AS CustomerId, Amount, CreatedAt FROM orders_in EMIT CHANGES;" }'
```

---

# 4) ã‚¢ãƒ—ãƒªå´ï¼šé€ä¿¡ â†’ å—ä¿¡
## é€ä¿¡ï¼ˆ`AddAsync`ï¼‰
```csharp
// POCOï¼ˆã‚½ãƒ¼ã‚¹ï¼‰
[KsqlStream]
[KsqlTopic("orders-in")]
public class OrderIn {
    [KsqlKey] public string OrderId { get; set; } = default!;
    public string CustomerId { get; set; } = default!;
    public decimal Amount { get; set; }
    [KsqlTimestamp] public DateTime CreatedAt { get; set; }
}

// é€ä¿¡
await ctx.Set<OrderIn>().AddAsync(new OrderIn {
    OrderId = Guid.NewGuid().ToString("D"),
    CustomerId = "c-001",
    Amount = 123.45m,
    CreatedAt = DateTime.UtcNow
});
```

## å—ä¿¡ï¼ˆã‚·ãƒ³ã‚¯ãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰ï¼‰
```csharp
// POCOï¼ˆã‚·ãƒ³ã‚¯ï¼šorders-out ã«åˆã‚ã›ã‚‹ï¼‰
[KsqlStream]
[KsqlTopic("orders-out")]
public class OrderOut {
    [KsqlKey] public string OrderId { get; set; } = default!;
    public string CustomerId { get; set; } = default!;
    public decimal Amount { get; set; }
    public DateTime CreatedAt { get; set; }
}

// é€æ¬¡å‡¦ç†
await foreach (var (msg, headers) in consumer.ConsumeAsync<OrderOut>(ct))
{
    // ã“ã“ã§é€šå¸¸ãƒ­ã‚¸ãƒƒã‚¯
}
```

> TABLEç³»ï¼ˆ`orders-by-customer`ï¼‰ã‚’èª­ã‚€å ´åˆ  
> - **æ›´æ–°ï¼ˆåŒä¸€ã‚­ãƒ¼ã®ä¸Šæ›¸ãï¼‰**ãŒæ¥ã‚‹ãŸã‚ã€é›†è¨ˆçµæœã‚’**æœ€æ–°å€¤ã¨ã—ã¦æ‰±ã†**å®Ÿè£…ã«ã™ã‚‹  
> - ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦æ‰±ã„ãŸã„å ´åˆã¯ã€åˆ¥é€” `EMIT CHANGES` ãª SELECT ã‚’å™›ã¾ã›ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ åŒ–ï¼ˆ`CREATE STREAM ... AS SELECT * FROM orders_by_customer EMIT CHANGES;`ï¼‰

---

# ãƒ†ã‚¹ãƒˆã®å‹ï¼ˆã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœ€å°ï¼‰
1) `CREATE STREAM orders_in` â†’ `CREATE STREAM orders_out AS SELECT ...` ã‚’ REST ã§ç™»éŒ²  
2) `AddAsync<OrderIn>` ã§æ•°ä»¶æŠ•å…¥  
3) `orders-out` ã‚’ 1 ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã§ subscribe â†’ æœŸå¾…å½¢ã§å±Šãã‹ã‚¢ã‚µãƒ¼ãƒˆ  
4) ï¼ˆTABLEã‚’ä½¿ã†å ´åˆã¯ï¼‰åŒä¸€ `CustomerId` ã§è¤‡æ•°ä»¶æŠ•å…¥ â†’ `orders-by-customer` ã§åˆè¨ˆãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã‚’æ¤œè¨¼

---

# é‹ç”¨ã®ã‚³ãƒ„
- **ã‚¹ãƒˆãƒªãƒ¼ãƒ å**ï¼š`snake_case`ã€**ãƒˆãƒ”ãƒƒã‚¯å**ï¼š`kebab-case` ã¨æ±ºã‚ã¦ãŠãã¨ã‚¯ã‚©ãƒ¼ãƒˆäº‹æ•…ã‚’é¿ã‘ã‚‰ã‚Œã‚‹  
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**ï¼šã¾ãšã¯ **AVRO**ï¼ˆTopicNameStrategyæ—¢å®šï¼‰ã§çµ±ä¸€ã€‚DLQã ã‘åˆ¥é‹ç”¨ã§ã‚‚OK  
- **ä¿å®ˆ**ï¼š`SHOW QUERIES;` ã§æ°¸ç¶šã‚¯ã‚¨ãƒªã‚’æ£šå¸ã—ã€`TERMINATE <query_id>;` ã§åœæ­¢å¯  
- **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**ï¼šä¸è¦ã«ãªã£ãŸã‚·ãƒ³ã‚¯ãƒˆãƒ”ãƒƒã‚¯ã¯æ˜ç¤ºå‰Šé™¤ï¼ˆèª¤ subscribe é˜²æ­¢ï¼‰

---

å¿…è¦ãªã‚‰ã€ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’**ã‚ãªãŸã®å…·ä½“ã‚¹ã‚­ãƒ¼ãƒ**ã«è½ã¨ã—ã¦ `curl` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚»ãƒƒãƒˆï¼ˆç™»éŒ²/å‰Šé™¤/ç¢ºèªï¼‰ã¾ã§ä½œã‚Šã¾ã™ã€‚ãƒˆãƒ”ãƒƒã‚¯åã¨åˆ—å®šç¾©ã‚’æ¸¡ã—ã¦ãã‚Œã‚Œã°ã€ãã®ã¾ã¾å›ã‚‹å½¢ã«ä»•ä¸Šã’ã‚‹ã‚ˆã€‚

ï¼ˆ[[REDACTED_PHONE]]:15 JSTï¼‰
### assistant â€” 2025-08-10T10:06:36.829980+00:00

_(empty)_
### assistant â€” 2025-08-10T10:06:41.461692+00:00

_(empty)_
### user â€” 2025-08-10T10:07:29.139000+00:00

CREATE STREAM orders_in â†’ CREATE STREAM orders_out AS SELECT ... ã‚’ REST ã§ç™»éŒ²
ã“ã“ã¯OnModelCreatingã§ãŠã“ãªã†
### assistant â€” 2025-08-10T10:07:29.389166+00:00

äº†è§£ã€‚**æ°¸ç¶šã‚¯ã‚¨ãƒªã®ç™»éŒ²ã‚’ `OnModelCreating` ã§ã‚„ã‚‹å‰æ**ã®ã€å®Ÿè£…â€œå‹â€ã‚’ç½®ãã¾ã™ã€‚  
ãƒã‚¤ãƒ³ãƒˆã¯ã€Œâ‘ ã‚½ãƒ¼ã‚¹STREAMå®šç¾©ã€ã€Œâ‘¡CSAS/CTASã‚’â€œãƒ¢ãƒ‡ãƒ«å®šç¾©ã¨ã—ã¦â€ç™»éŒ²ã€ã€Œâ‘¢èµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘åæ˜ ï¼ˆIF NOT EXISTS/ãƒãƒƒã‚·ãƒ¥ã§å†ªç­‰åŒ–ï¼‰ã€ã§ã™ã€‚

# æœ€å°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆC#ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

```csharp
// ä¾‹: ã‚ãªãŸã® DSL ãŒ DbContext é¢¨ãªã‚‰
public sealed class OrderContext : KsqlContext
{
    public OrderContext(KsqlDslOptions opt, ILoggerFactory lf) : base(opt, lf) { }

    protected override void OnModelCreating(IKsqlModelBuilder model)
    {
        // 1) ã‚½ãƒ¼ã‚¹: ã‚¢ãƒ—ãƒªãŒ AddAsync ã§æ›¸ãå…ˆï¼ˆorders-inï¼‰
        model.Stream<OrderIn>(s => s
            .WithTopic("orders-in")           // Kafkaãƒˆãƒ”ãƒƒã‚¯åï¼ˆkebab-caseæ¨å¥¨ï¼‰
            .WithKeyFormat("AVRO")
            .WithValueFormat("AVRO")
            .WithTimestamp(x => x.CreatedAt)
            .WithPartitions(3)
            .WithReplicas(1)
        );

        // 2) æ°¸ç¶šã‚¯ã‚¨ãƒª: CSASï¼ˆorders_out ã‚’å¸¸æ™‚åãï¼‰
        model.CreateStreamAsSelect("orders_out", q => q
            .WithTopic("orders-out")          // ã‚·ãƒ³ã‚¯å…ˆãƒˆãƒ”ãƒƒã‚¯
            .WithValueFormat("AVRO")
            .WithPartitions(3)
            .WithReplicas(1)
            .Select(@"
                SELECT
                  OrderId,
                  UCASE(CustomerId) AS CustomerId,
                  Amount,
                  CreatedAt
                FROM orders_in
                EMIT CHANGES")
            .IfNotExists()                    // å†ªç­‰åŒ–
        );

        // 3) ä¾‹ï¼šé›†è¨ˆTABLEï¼ˆå¿…è¦ãªã‚‰ï¼‰
        model.CreateTableAsSelect("orders_by_customer", q => q
            .WithTopic("orders-by-customer")
            .WithValueFormat("AVRO")
            .Select(@"
                SELECT CustomerId, SUM(Amount) AS TotalAmount
                FROM orders_in
                GROUP BY CustomerId
                EMIT CHANGES")
            .IfNotExists()
        );
    }
}
```

> DSLã« `CreateStreamAsSelect`/`CreateTableAsSelect` ãŒç„¡ã‘ã‚Œã°ã€**ç”ŸKSQL ã‚’ãƒ¢ãƒ‡ãƒ«ã«ç©ã‚€**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’1ã¤ç”¨æ„ã—ã¦ãã ã•ã„ï¼š
> ```csharp
> model.Sql(@"
>   CREATE STREAM IF NOT EXISTS orders_out WITH (KAFKA_TOPIC='orders-out', VALUE_FORMAT='AVRO', PARTITIONS=3, REPLICAS=1)
>   AS SELECT OrderId, UCASE(CustomerId) AS CustomerId, Amount, CreatedAt FROM orders_in EMIT CHANGES;");
> ```
> åå‰ã¯ `orders_out` ã®ã‚ˆã†ã«**è­˜åˆ¥å­ã¯ `_`**ã€ãƒˆãƒ”ãƒƒã‚¯åã¯ **`orders-out`** ã«ã—ã¦ã‚¯ã‚©ãƒ¼ãƒˆäº‹æ•…ã‚’é˜²ãã¾ã™ã€‚

# èµ·å‹•æ™‚é©ç”¨ï¼ˆå†ªç­‰ãƒ»å·®åˆ†ï¼‰
- æ—¢ã«ãŠæŒã¡ã® `InitializeWithSchemaRegistration()`ï¼`RegisterSchemasAndMaterializeAsync()` ã®ãƒ•ãƒ­ãƒ¼ã«ã€  
  **ãƒ¢ãƒ‡ãƒ«â†’DDL/ã‚¯ã‚¨ãƒªã®ç”Ÿæˆâ†’/ksql ã¸åæ˜ **ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
- å†ªç­‰æˆ¦ç•¥ï¼š
  - **`IF NOT EXISTS` ã‚’ä»˜ã‘ã‚‹**ï¼ˆSTREAM/TABLE/CSAS/CTASï¼‰
  - ã‚‚ã—ãã¯ **ã‚¯ã‚¨ãƒªæœ¬æ–‡ã®ãƒãƒƒã‚·ãƒ¥**ã‚’ `_ksql_migrations`ï¼ˆKafkaãƒˆãƒ”ãƒƒã‚¯ or ksqlDB TABLEï¼‰ã«ä¿å­˜ã—ã€**æœªç™»éŒ²ã®ã¿å®Ÿè¡Œ**  
    ï¼ˆå¤‰æ›´æ¤œçŸ¥ãŒè¦ã‚‹å ´åˆã¯ `TERMINATE`â†’å†ä½œæˆã®â€œæ‰‹å‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³â€è¨­è¨ˆã‚’ï¼‰

# ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä¾‹ï¼ˆé€ä¿¡/å—ä¿¡ï¼‰

```csharp
// ã‚½ãƒ¼ã‚¹å´ï¼ˆAddAsync ã§æŠ•ã’ã‚‹ï¼‰
[KsqlStream]
[KsqlTopic("orders-in")]
public class OrderIn {
    [KsqlKey] public string OrderId { get; set; } = default!;
    public string CustomerId { get; set; } = default!;
    public decimal Amount { get; set; }
    [KsqlTimestamp] public DateTime CreatedAt { get; set; }
}

// ã‚·ãƒ³ã‚¯å´ï¼ˆorders-out ã‚’ consume ã™ã‚‹POCOï¼‰
[KsqlStream]
[KsqlTopic("orders-out")]
public class OrderOut {
    [KsqlKey] public string OrderId { get; set; } = default!;
    public string CustomerId { get; set; } = default!;
    public decimal Amount { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

# å‹•ä½œç¢ºèªã®æµã‚Œï¼ˆæœ€çŸ­ï¼‰
1) ã‚¢ãƒ—ãƒªèµ·å‹• â†’ `OnModelCreating` ã®å®šç¾©ãŒ `/ksql` ã«åæ˜ ï¼ˆSTREAM/CSAS/CTASä½œæˆï¼‰  
2) `await ctx.Set<OrderIn>().AddAsync(new OrderIn { ... });` ã§æŠ•å…¥  
3) `orders-out` ã‚’é€šå¸¸ã® consumeï¼ˆæ—¢ã«ç‰©ç†è©¦é¨“æ¸ˆã¿ã® `ConsumeAsync<OrderOut>()`ï¼‰ã§å—ä¿¡ â†’ æœŸå¾…å½¢ã‚’ç¢ºèª

# ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´
- **ãƒã‚¤ãƒ•ãƒ³/ãƒ‰ãƒƒãƒˆ**ï¼šã‚¹ãƒˆãƒªãƒ¼ãƒ åã¯ `snake_case`ã€ãƒˆãƒ”ãƒƒã‚¯åã¯ `kebab-case`ã€‚`WITH (KAFKA_TOPIC='â€¦')` æŒ‡å®šã‚’å¿˜ã‚Œãªã„  
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸ä¸€è‡´**ï¼šAddAsync å´ã® AVRO ã‚¹ã‚­ãƒ¼ãƒã¨ `orders_in` å®šç¾©ã‚’å¿…ãšä¸€è‡´ã•ã›ã‚‹  
- **CTASã®èª­ã¿æ–¹**ï¼šTABLEã¯**ä¸Šæ›¸ãæ›´æ–°**ãŒæ¥ã‚‹ï¼ˆchangelogï¼‰ã€‚å¿…è¦ãªã‚‰ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å†æŠ•å½±ã—ã¦ã‹ã‚‰èª­ã‚€

---  

ã“ã®â€œå‹â€ã§ã‚ã‚Œã°ã€ã€Œ**ã‚¯ã‚¨ãƒªç™»éŒ²ã¯ `OnModelCreating` ã«é›†ç´„**ã€ã€Œ**ã‚¢ãƒ—ãƒªã¯ AddAsync/Consume ã«é›†ä¸­**ã€ã®åˆ†æ¥­ãŒã§ãã¾ã™ã€‚  
å¿…è¦ãªã‚‰ã€ã‚ãªãŸã®DSLå®Ÿè£…åã«åˆã‚ã›ãŸã‚³ãƒ¼ãƒ‰ï¼ˆ`model.Sql` or `model.CreateStreamAsSelect` ã®å…·ä½“ï¼‰ã«æ›¸ãæ›ãˆã¾ã™ã€‚  

ï¼ˆ[[REDACTED_PHONE]]:18 JSTï¼‰
### system â€” 2025-08-10T10:07:29.702973+00:00

_(empty)_
### assistant â€” 2025-08-10T10:07:33.085688+00:00

_(empty)_
### assistant â€” 2025-08-10T10:07:40.300364+00:00

_(empty)_
### user â€” 2025-08-10T10:08:24.415000+00:00

APIã®ã‚»ãƒƒãƒˆã¯æ·»ä»˜ã—ãŸå†…å®¹ã‚’ã¿ã¦
### assistant â€” 2025-08-10T10:08:25.772511+00:00

äº†è§£ã€å¸ä»¤ã€‚`OnModelCreating` ã§ **ã‚¯ã‚¨ãƒªç™»éŒ²â†’ã‚·ãƒ³ã‚¯å…ˆãƒˆãƒ”ãƒƒã‚¯ã‚’ã‚¢ãƒ—ãƒªã§ consume** ã¾ã§ã‚’ä¸€æ°—é€šè²«ã§ãã‚‹ã‚ˆã†ã€`api_reference.md` ã«ãã®ã¾ã¾è¿½è¨˜ã§ãã‚‹ **APIã‚»ãƒƒãƒˆï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆï¼‰** ã‚’ç”¨æ„ã—ãŸã‚ˆã€‚  
ï¼ˆæ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒˆãƒ¼ãƒ³ã«åˆã‚ã›ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹è¡¨ï¼‹ä½¿ç”¨ä¾‹ï¼‹æ³¨æ„ç‚¹ã§æ§‹æˆï¼‰

---

# è¿½è¨˜æ¡ˆï¼šOnModelCreating ã§ã®ã‚¯ã‚¨ãƒªç™»éŒ²ã¨ã‚·ãƒ³ã‚¯æ¶ˆè²»ï¼ˆCSAS/CTASï¼‰

## ãƒ¢ãƒ‡ãƒ«å®šç¾© APIï¼ˆã‚¯ã‚¨ãƒªç™»éŒ²ï¼‰

| API | èª¬æ˜ | å¯¾è±¡ | å®Ÿè£…çŠ¶æ…‹ |
|---|---|---|---|
| `model.Stream<T>(cfg => â€¦)` | ã‚½ãƒ¼ã‚¹STREAMå®šç¾©ï¼ˆ`AddAsync<T>` ã®æŠ•å…¥å£ã‚’å®£è¨€ï¼‰ | Model | ğŸš§ |
| `model.CreateStreamAsSelect(name, cfg => â€¦)` | **CSAS**: `CREATE STREAM â€¦ AS SELECT â€¦` ã‚’ç™»éŒ²ï¼ˆæ°¸ç¶šã‚¯ã‚¨ãƒªï¼‰ | Model | ğŸš§ |
| `model.CreateTableAsSelect(name, cfg => â€¦)` | **CTAS**: `CREATE TABLE â€¦ AS SELECT â€¦` ã‚’ç™»éŒ²ï¼ˆæ°¸ç¶šã‚¯ã‚¨ãƒªï¼‰ | Model | ğŸš§ |
| `model.Sql(@"â€¦")` | ä»»æ„ã® KSQL æ–‡ã‚’ãƒ¢ãƒ‡ãƒ«ã¸ç™»éŒ²ï¼ˆIF NOT EXISTS ä½µç”¨æ¨å¥¨ï¼‰ | Model | ğŸš§ |
### å…¸å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæœ€å°ï¼‰

```csharp
protected override void OnModelCreating(IKsqlModelBuilder model)
{
    // 1) ã‚¢ãƒ—ãƒªãŒ AddAsync ã§æ›¸ãã€Œã‚½ãƒ¼ã‚¹ã€å®£è¨€ï¼ˆorders-inï¼‰
    model.Stream<OrderIn>(s => s
        .WithTopic("orders-in")
        .WithKeyFormat("AVRO")
        .WithValueFormat("AVRO")
        .WithTimestamp(x => x.CreatedAt)
        .WithPartitions(3)
        .WithReplicas(1)
    );

    // 2) KSQLDB å´ã§å¸¸æ™‚å¤‰æ›ã—ã¦ã€Œã‚·ãƒ³ã‚¯ã€ã«åãï¼ˆorders-outï¼‰
    model.CreateStreamAsSelect("orders_out", q => q
        .WithTopic("orders-out")           // â† ã‚¢ãƒ—ãƒªã¯ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’ consume ã™ã‚‹
        .WithValueFormat("AVRO")
        .WithPartitions(3).WithReplicas(1)
        .Select(@"
            SELECT
              OrderId,
              UCASE(CustomerId) AS CustomerId,
              Amount,
              CreatedAt
            FROM orders_in
            EMIT CHANGES")
        .IfNotExists()                      // å†ªç­‰åŒ–
    );

    // 3) é›†è¨ˆãŒå¿…è¦ãªã‚‰ TABLE ã‚‚åŒæ§˜ã«ï¼ˆä»»æ„ï¼‰
    model.CreateTableAsSelect("orders_by_customer", q => q
        .WithTopic("orders-by-customer")
        .WithValueFormat("AVRO")
        .Select(@"
            SELECT CustomerId, SUM(Amount) AS TotalAmount
            FROM orders_in
            GROUP BY CustomerId
            EMIT CHANGES")
        .IfNotExists()
    );
}
```

> ãƒ¡ãƒ¢  
> - **ã‚¹ãƒˆãƒªãƒ¼ãƒ /ãƒ†ãƒ¼ãƒ–ãƒ«å**ã¯ `snake_case` ã‚’æ¨å¥¨ï¼ˆ`-`/`.` ã¯ä¸å¯ï¼‰ã€‚  
> - **ãƒˆãƒ”ãƒƒã‚¯å**ã¯ `kebab-case` ã‚’æ¨å¥¨ã—ã€`WITH (KAFKA_TOPIC='â€¦')` ç›¸å½“ã‚’ `.WithTopic(...)` ã§å¿…ãšæ˜ç¤ºã€‚  
> - æ°¸ç¶šã‚¯ã‚¨ãƒªã¯ **IF NOT EXISTS** ã§å†ªç­‰åŒ–ã€‚ä»•æ§˜å¤‰æ›´æ™‚ã¯ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹é‡ï¼ˆ`TERMINATE`â†’å†ä½œæˆï¼‰ã‚’é‹ç”¨ã§ç®¡ç†ã€‚

## é€å—ä¿¡ã®å®šå‹
### é€ä¿¡ï¼ˆã‚½ãƒ¼ã‚¹ã¸ `AddAsync`ï¼‰
```csharp
[KsqlStream]
[KsqlTopic("orders-in")]
public class OrderIn {
    [KsqlKey] public string OrderId { get; set; } = default!;
    public string CustomerId { get; set; } = default!;
    public decimal Amount { get; set; }
    [KsqlTimestamp] public DateTime CreatedAt { get; set; }
}

await ctx.Set<OrderIn>().AddAsync(new OrderIn {
    OrderId = Guid.NewGuid().ToString("D"),
    CustomerId = "c-001",
    Amount = 123.45m,
    CreatedAt = DateTime.UtcNow
});
```
### å—ä¿¡ï¼ˆã‚·ãƒ³ã‚¯ã‚’ consumeï¼‰
```csharp
[KsqlStream]
[KsqlTopic("orders-out")]
public class OrderOut {
    [KsqlKey] public string OrderId { get; set; } = default!;
    public string CustomerId { get; set; } = default!;
    public decimal Amount { get; set; }
    public DateTime CreatedAt { get; set; }
}

// é€æ¬¡å‡¦ç†ï¼ˆæ—¢å­˜ã®ç‰©ç†è©¦é¨“ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã‚‹ï¼‰
await foreach (var (msg, headers) in consumer.ConsumeAsync<OrderOut>(ct))
{
    // æœ¬å‡¦ç†â€¦
}
```

> TABLEï¼ˆ`orders-by-customer`ï¼‰ã‚’ç›´æ¥èª­ã‚€å ´åˆã¯ **changelogï¼ˆä¸Šæ›¸ãï¼‰** ã«ãªã‚‹ç‚¹ã«æ³¨æ„ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦æ‰±ã„ãŸã„å ´åˆã¯ã€åˆ¥é€” CSAS ã§å†æŠ•å½±ã—ã¦ã‹ã‚‰ consume ã™ã‚‹ã®ãŒå®‰å…¨ã€‚

## é‹ç”¨ãƒ»æ³¨æ„ç‚¹

- **ã‚¹ã‚­ãƒ¼ãƒæ•´åˆ**ï¼š`OrderIn` ã® AVRO ã‚¹ã‚­ãƒ¼ãƒã¨ `orders_in` ã®åˆ—å®šç¾©ã‚’ä¸€è‡´ã•ã›ã‚‹ã€‚  
- **äº’æ›æ€§**ï¼šã‚·ãƒ³ã‚¯ã®ã‚¹ã‚­ãƒ¼ãƒé€²åŒ–ã¯ **BACKWARD** ã‚’æ¨å¥¨ï¼ˆå¿…é ˆè¿½åŠ ã«ã¯ `default` ã‚’ä»˜ä¸ï¼‰ã€‚  
- **å¯è¦³æ¸¬æ€§**ï¼šã‚¯ã‚¨ãƒªã¯ `SHOW QUERIES;`ã€åœæ­¢ã¯ `TERMINATE <query_id>;`ã€‚ä¸è¦ãƒˆãƒ”ãƒƒã‚¯ã¯å‰Šé™¤ã€‚  
- **å‘½åè¡çªå›é¿**ï¼šã‚¢ãƒ—ãƒªå´ `Class` åã¨ KSQL `STREAM` åã¯ä¸€è‡´ã•ã›ãšï¼ˆ`OrderIn` â†” `orders_in` ã®ã‚ˆã†ã«åŒºåˆ¥ï¼‰ã€‚

---

å¿…è¦ãªã‚‰ã“ã®æ–‡é¢ã‚’ `api_reference.md` ã®ã€ŒFluent API ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€ç›´å¾Œã«æ–°ç¯€ã¨ã—ã¦å·®ã—è¾¼ã‚ã‚‹ã‚ˆã†æ•´å½¢ã™ã‚‹ã‚ˆã€‚åŠ ç­†ç®‡æ‰€ã®ä½ç½®æŒ‡å®šãŒã‚ã‚Œã°ã€ãã®ä½“è£ã«åˆã‚ã›ã¦å‡ºã—ç›´ã—ã¾ã™ã€‚

ï¼ˆ[[REDACTED_PHONE]]:22 JSTï¼‰
### system â€” 2025-08-10T10:08:26.456759+00:00

_(empty)_
### tool â€” 2025-08-10T10:08:26.492694+00:00

_(empty)_
### tool â€” 2025-08-10T10:08:26.523878+00:00

îˆ€fileciteîˆ‚turn3file0îˆ

# API Reference (Draft)

ã“ã®æ–‡æ›¸ã¯ `Kafka.Ksql.Linq` OSS ã«ãŠã‘ã‚‹å…¬é–‹ DSL/API ã¨ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ¦‚è¦ã‚’æ•´ç†ã—ãŸã‚‚ã®ã§ã™ã€‚ä»Šå¾Œã®è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¸ã®å‚ç…§åŸºç›¤ã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

## æ—¢å®šå€¤ã®å‚ç…§

- æ—¢å®šå€¤ä¸€è¦§ã¯ [docs_configuration_reference.md](docs_configuration_reference.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
### ãƒ†ã‚¹ãƒˆè¨­è¨ˆä¸Šã®æ³¨æ„
- Kafka ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¯ `Chr.Avro.Confluent` ã‚’åˆ©ç”¨ã—ãŸ POCO å‹ã®è‡ªå‹•ã‚¹ã‚­ãƒ¼ãƒé€£æºã‚’æ¨å¥¨ã—ã¾ã™ã€‚
- `GROUP BY` ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ Push Query ã¨ã—ã¦ `EMIT CHANGES` ãŒè‡ªå‹•ä»˜ä¸ã•ã‚Œã¾ã™ã€‚Pull Query ã‚„ TABLE ã‚¯ã‚¨ãƒªã§ `GROUP BY` ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
- `WINDOW` å¥ã¯ `GROUP BY` ã®ç›´å¾Œã«é…ç½®ã—ã¦ãã ã•ã„ã€‚
- `CASE` å¼ã§ã¯ `THEN`/`ELSE` ã®å‹ã‚’å¿…ãšä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- `MIN`/`MAX` ãªã©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ å°‚ç”¨é›†è¨ˆé–¢æ•°ã‚’å«ã‚€å ´åˆã€ã‚¯ã‚¨ãƒªã¯è‡ªå‹•çš„ã« `CREATE STREAM` ã¨ã—ã¦ç”Ÿæˆã•ã‚Œã¾ã™ã€‚`CREATE TABLE` ã‚’æ˜ç¤ºã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

## Context ã‚¯ãƒ©ã‚¹ã¨ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹

| API                   | èª¬æ˜                                   | å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ | å®Ÿè£…çŠ¶æ…‹ |
|------------------------|----------------------------------------|------------|---------|
| `IKsqlContext`         | ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ“ä½œã®æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹   | Context    | âœ…      |
| `KafkaContextCore`     | `IKsqlContext` å®Ÿè£…ã®åŸºåº•ã‚¯ãƒ©ã‚¹        | Context    | âœ…      |
| `KsqlContext`          | Kafkaé€£æºã‚’çµ±åˆã—ãŸæŠ½è±¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ    | Context    | âœ…      |
| `KsqlContextBuilder`   | `KsqlContextOptions` æ§‹ç¯‰ç”¨ãƒ“ãƒ«ãƒ€ãƒ¼   | Application| âœ…      |
| `KsqlContextOptions`   | ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¸ã‚¹ãƒˆãƒªç­‰ã®è¨­å®šä¿æŒ        | Application| âœ…      |
| `IEventSet<T>`         | LINQ/Streamingæ“ä½œã®å…±é€šã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹| Stream/Table| âœ…     |
| `IManualCommitMessage<T>` | æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸             | Subscription| âœ…     |

## LINQ é¢¨ DSL ä¸€è¦§

| DSL ãƒ¡ã‚½ãƒƒãƒ‰                   | èª¬æ˜                          | æˆ»ã‚Šå€¤å‹                          | å¯¾è±¡ãƒ¬ã‚¤ãƒ¤    | å®Ÿè£…çŠ¶æ…‹ |
|--------------------------------|-------------------------------|-----------------------------------|---------------|---------|
| `.Where(predicate)`            | æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿                  | `IEventSet<T>`                    | Stream/Table  | âœ…      |
| `.Window(WindowDef \| TimeSpan)` | ã‚¿ã‚¤ãƒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æŒ‡å®š       | `IQueryable<T>`                   | Stream        | âœ…      |
| `.Window(int minutes)`          | `WindowMinutes`ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿  | `IEntitySet<T>`                  | Stream/Table  | âœ…      |
| `.Window().BasedOn<TSchedule>(keySelector, ?openProp, ?closeProp)` | `[ScheduleRange]` å±æ€§ã€ã¾ãŸã¯ `openProp`/`closeProp` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é–‹å§‹/çµ‚äº†ã‚’ç¤ºã™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«POCOã«åŸºã¥ãã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç”Ÿæˆ | `IQueryable<T>` | Stream | âœ… |
| `.GroupBy(...)`                | ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãŠã‚ˆã³é›†ç´„          | `IEventSet<IGrouping<TKey, T>>`   | Stream/Table  | âœ…      |
| `.OnError(ErrorAction)`        | ã‚¨ãƒ©ãƒ¼å‡¦ç†æ–¹é‡æŒ‡å®š            | `EventSet<T>`                     | Stream        | âœ…      |
| `.WithRetry(int)`              | ãƒªãƒˆãƒ©ã‚¤è¨­å®š                  | `EventSet<T>`                     | Stream        | âœ…      |
| `.StartErrorHandling()`        | ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒ¼ãƒ³é–‹å§‹            | `IErrorHandlingChain<T>`          | Stream        | âœ…      |
| `.WithManualCommit()`          | æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿        | `IEntityBuilder<T>`               | Subscription  | âœ…      |
| `.Limit(int)`                  | **ä¿æŒä»¶æ•°åˆ¶é™ã€‚Tableå‹(Set<T>)ã§ã®ã¿åˆ©ç”¨å¯ã€‚OnModelCreatingã§å®šç¾©ã—ã€è¶…éåˆ†ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ã€‚** | `IEntitySet<T>`                  | Table  | âœ…      |

- `ToList`/`ToListAsync` ã¯ Pull Query ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€F:src/Query/Pipeline/DMLQueryGenerator.csâ€ L27-L34ã€‘ã€‚
- `WithManualCommit()` ã‚’æŒ‡å®šã—ãªã„ `ForEachAsync()` ã¯è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå‹•ä½œã¨ãªã‚Šã¾ã™ã€F:docs/old/manual_commit.mdâ€ L1-L23ã€‘ã€‚
- `OnError(ErrorAction.DLQ)` ã‚’æŒ‡å®šã™ã‚‹ã¨ DLQ ãƒˆãƒ”ãƒƒã‚¯ã¸é€ä¿¡ã•ã‚Œã¾ã™ã€F:docs/old/defaults.mdâ€ L52-L52ã€‘ã€‚
- `ctx.Set<DlqEnvelope>()` ã‚’æŒ‡å®šã™ã‚‹ã¨ DLQ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—ã§ãã¾ã™ã€‚DLQ ã¯ç„¡é™ãƒ­ã‚°ã®ãŸã‚ `Take()` ã‚„ `ToListAsync()` ãªã©ã®ä¸€æ‹¬å–å¾— API ã¯åˆ©ç”¨ã§ããšã€`ForEachAsync()` ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã¾ãŸ DLQ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ `.OnError(ErrorAction.DLQ)` ã‚’æŒ‡å®šã™ã‚‹ã¨ç„¡é™ãƒ«ãƒ¼ãƒ—ã«ãªã‚‹ãŸã‚ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚
- Messaging ã‚¯ãƒ©ã‚¹è‡ªä½“ã¯ DLQ é€ä¿¡å‡¦ç†ã‚’æŒãŸãšã€`ErrorOccurred`/`DeserializationError`/`ProduceError` ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã˜ã¦å¤–éƒ¨ã§ DLQ é€ä¿¡ã‚’è¡Œã„ã¾ã™ã€‚
- DLQ ã®å†…å®¹ç¢ºèªã¯ `ctx.Dlq.ReadAsync(...)` ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
- `Set<T>().Limit(n)` ã¯ Table å‹ã®ä¿æŒä»¶æ•°ã‚’åˆ¶é™ã™ã‚‹ DSL ã§ã™ã€‚`OnModelCreating` å†…ã§æŒ‡å®šã—ã€è¶…éåˆ†ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ã€‚Stream å‹ã‚„å®Ÿè¡Œæ™‚ã‚¯ã‚¨ãƒªã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
- ãƒãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã¯ `WithWindow().Select<TBar>()` ã§ `BarTime` ã«ä»£å…¥ã—ãŸå¼ãŒè‡ªå‹•çš„ã«è¨˜éŒ²ã•ã‚Œã€`Limit` ã®ä¸¦ã³æ›¿ãˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- `RemoveAsync(key)` ã¯å€¤ `null` ã®ãƒˆãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã‚’é€ã‚Šã€KTable ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è©²å½“ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
- `.Window().BasedOn<TSchedule>` ã‚’ç”¨ã„ã‚‹å ´åˆã€ãƒãƒ¼ã¯ `[ScheduleRange]` å±æ€§ã€ã¾ãŸã¯ `openProp`/`closeProp` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç¤ºã•ã‚ŒãŸ `Open` ï½ `Close` ã®ç¯„å›²ã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚æ—¥è¶³ç”Ÿæˆã§ `Close` ãŒ 6:30 ã®ã¨ãã¯ã€6:30 æœªæº€ã®ãƒ‡ãƒ¼ã‚¿ãŒå½“æ—¥ã®çµ‚å€¤ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
- ãƒãƒ¼ã‚„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å®šç¾©ã¯å¿…ãš `KafkaKsqlContext.OnModelCreating` å†…ã§å®£è¨€ã—ã¦ãã ã•ã„ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã¯å®šç¾©æ¸ˆã¿ã® `Set<T>` ã‚’å‚ç…§ã™ã‚‹ã ã‘ã§ã™ã€‚
- `WithWindow<Rate, MarketSchedule>()` ã«ç¶šã‘ã¦ `.Select<RateCandle>()` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ§‹æˆã§ãã¾ã™ã€‚
- `WithWindow<TEntity, TSchedule>(windows, timeSelector, rateKey, scheduleKey)` ã¨ã—ã¦ `timeSelector` å¼•æ•°ã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åŒºåˆ‡ã‚‹æ™‚åˆ»ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ˜ç¤ºã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æˆ»ã‚Šå€¤å‹ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã§ã€DSLãƒã‚§ãƒ¼ãƒ³ã«ãŠã‘ã‚‹æ¬¡ã®æ“ä½œã‚’åˆ¤æ–­ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ç‰¹ã« `OnError()` ã‚„ `WithRetry()` ã¯ `EventSet<T>` ã‚’è¿”ã™ãŸã‚ã€ç¶šã‘ã¦ `IEventSet` ç³»ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚
### ToQuery ãƒã‚§ãƒ¼ãƒ³

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | æ³¨æ„ç‚¹ |
|---|---|---|
| `.From<T>()` | ãƒ“ãƒ¥ãƒ¼å®šç¾©ã®é–‹å§‹ | - |
| `.Join<T2>(condition)` | 2ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã§ã®å†…éƒ¨çµåˆ | å¾Œç¶šã« `.Where` å¿…é ˆ |
| `.Where(predicate)` | çµåˆæ¡ä»¶ã‚„ãƒ•ã‚£ãƒ«ã‚¿ | `.Join` ä½¿ç”¨æ™‚ã¯å¿…é ˆ |
| `.Select(selector)` | æŠ•å½± | å‘¼ã³å‡ºã—é †åºã¯ `From`â†’`Join?`â†’`Where`â†’`Select` |

ã“ã‚Œã‚‰ã¯ `modelBuilder.Entity<T>().ToQuery(q => q ... )` å†…ã§ä½¿ç”¨ã—ã€`KsqlQueryModel` ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

## å±æ€§ (Attribute) å®šç¾©

| å±æ€§                       | å½¹å‰²                           | å®Ÿè£…çŠ¶æ…‹ |
|----------------------------|--------------------------------|---------|
| `MaxLengthAttribute`       | æ–‡å­—åˆ—é•·åˆ¶é™                   | âœ…      |
| `ScheduleRangeAttribute`   | å–å¼•é–‹å§‹ãƒ»çµ‚äº†ã‚’ã¾ã¨ã‚ã¦æŒ‡å®šã™ã‚‹å±æ€§ | ğŸš§ |

`WithDeadLetterQueue()` ã¯éå»ã®è¨­è¨ˆã§ææ¡ˆã•ã‚Œã¾ã—ãŸãŒã€ç¾åœ¨ã¯ `OnError(ErrorAction.DLQ)` ã«ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

## æ§‹æˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ãƒ“ãƒ«ãƒ€ãƒ¼

| API                        | èª¬æ˜                             | å®Ÿè£…çŠ¶æ…‹ |
|----------------------------|----------------------------------|---------|
| `KsqlDslOptions`           | DLQ è¨­å®šã‚„ ValidationMode ãªã© DSL å…¨ä½“ã®æ§‹æˆã‚’ä¿æŒ | âœ… |
| `ModelBuilder`             | POCO ã‹ã‚‰ `EntityModel` ã‚’æ§‹ç¯‰ã™ã‚‹ãƒ“ãƒ«ãƒ€ãƒ¼ | âœ… |
| `KafkaAdminService`        | DLQ ãƒˆãƒ”ãƒƒã‚¯ä½œæˆãªã©ã®ç®¡ç†æ“ä½œ  | âœ…      |
| `AvroOperationRetrySettings`| Avroæ“ä½œã”ã¨ã®ãƒªãƒˆãƒ©ã‚¤è¨­å®š     | âœ…      |
| `AvroRetryPolicy`          | ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚„é…å»¶ãªã©ã®è©³ç´°ãƒãƒªã‚·ãƒ¼ | âœ…  |

`KsqlDslOptions.DlqTopicName` ã¯æ—¢å®šã§ `"dead-letter-queue"` ã§ã™ã€F:src/Core/Dlq/DlqProducer.csâ€ L248-L256ã€‘ã€‚

<a id="fluent-api-list"></a>### Fluent API ä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|----------|------|
| `Entity<T>(readOnly = false, writeOnly = false)` | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰æŒ‡å®š |
| `.AsStream()` | ã‚¹ãƒˆãƒªãƒ¼ãƒ å‹ã¨ã—ã¦ç™»éŒ² |
| `.AsTable(topicName = null, useCache = true)` | ãƒ†ãƒ¼ãƒ–ãƒ«å‹ã¨ã—ã¦ç™»éŒ² |
| `.WithManualCommit()` | æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ– |
| `.ToQuery(build)` | æ–°DSLã§ã®ã‚¯ã‚¨ãƒªå®šç¾© |

<a id="fluent-api-guide"></a>
## Fluent API ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

POCO ãƒ¢ãƒ‡ãƒ«ã‚’ Fluent API ã§æ§‹æˆã™ã‚‹éš›ã®è¨­è¨ˆæŒ‡é‡ã¨ç§»è¡Œãƒ•ãƒ­ãƒ¼ã‚’ã¾ã¨ã‚ã¾ã™ã€‚å±æ€§ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®ç§»è¡Œå¾Œã¯
`IEntityBuilder<T>` ã‚’ç”¨ã„ã¦å®£è¨€çš„ã«è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
### 1. åŸºæœ¬æ–¹é‡
 - `[KsqlTopic]` ã‚„ `[KsqlKey]` ãªã©ã®å±æ€§ã§ãƒˆãƒ”ãƒƒã‚¯åã‚„ã‚­ãƒ¼é †åºã‚’å®£è¨€ã—ã¾ã™ã€‚
 - Fluent API ã¯ã‚¯ã‚¨ãƒªæ§‹ç¯‰ã‚„ãƒ¢ãƒ¼ãƒ‰æŒ‡å®šã®ã¿ã‚’æ‹…ã„ã€ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã¯å±æ€§ã«é›†ç´„ã—ã¾ã™ã€‚
 - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²æ™‚ã¯ `readonly` `writeonly` `readwrite` ã® 3 ç¨®é¡ã§å½¹å‰²ã‚’æŒ‡å®šã—ã€æœªæŒ‡å®šæ™‚ã¯ `readwrite` ã¨ã¿ãªã—ã¾ã™ã€‚
### 2. æ¨å¥¨è¨˜è¿°ä¾‹
```csharp
[KsqlTopic("orders")]
public class Order
{
    [KsqlKey(Order = 0)]
    public int Id { get; set; }
    public decimal Amount { get; set; }
}

void OnModelCreating(ModelBuilder builder)
{
    builder.Entity<Order>(writeOnly: true);
}
```
`[KsqlTopic]` ã‚„ `[KsqlDecimal]` å±æ€§ã§ãƒˆãƒ”ãƒƒã‚¯ã‚„ç²¾åº¦ã‚’å®£è¨€ã§ãã¾ã™ã€‚
### 3. æ—¢å­˜ POCO â†’ Fluent API ç§»è¡Œãƒ•ãƒ­ãƒ¼
1. POCO ã¸ `[KsqlTopic]` ã¨ `[KsqlKey]` ã‚’ä»˜ä¸ã—ã¦ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’è¨˜è¿°ã™ã‚‹ã€‚
2. `OnModelCreating` ã§ã¯ `Entity<T>()` ã®ç™»éŒ²ã®ã¿è¡Œã„ã€ãã®ä»–ã¯å±æ€§ã«å§”ã­ã‚‹ã€‚
3. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚­ãƒ¼é †åºã‚„ãƒˆãƒ”ãƒƒã‚¯è¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèªã™ã‚‹ã€‚
   æ—§å±æ€§ã«é–¢ã™ã‚‹è©³ç´°ã¯ `docs/namespaces/core_namespace_doc.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
### 4. MappingManager ã¨ã®é€£æº
`MappingManager` ã‚’åˆ©ç”¨ã—ã¦ key/value ã‚’æŠ½å‡ºã™ã‚‹ä¾‹ã§ã™ã€‚è©³ç´°ã¯ `docs/architecture/key_value_flow.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```csharp
var ctx = new MyKsqlContext(options);
var mapping = ctx.MappingManager;
var entity = new Order { Id = 1, Amount = 100 };
var (key, value) = mapping.ExtractKeyValue(entity);
await ctx.AddAsync(entity, headers: new Dictionary<string, string> { ["is_dummy"] = "true" });
```
#### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç™»éŒ²ã¯ `OnModelCreating` å†…ã§ä¸€æ‹¬å®šç¾©ã™ã‚‹ã€‚
- `MappingManager` ã‚’æ¯å› `new` ã—ãªã„ã€‚DI ã‚³ãƒ³ãƒ†ãƒŠã§å…±æœ‰ã—ã€ãƒ¢ãƒ‡ãƒ«ç™»éŒ²æ¼ã‚Œã‚’é˜²ãã€‚
### 5. è¿½åŠ æ¤œè¨äº‹é …
- `[KsqlTopic]` å±æ€§ã§æŒ‡å®šã§ããªã„è©³ç´°è¨­å®šã®æ‰±ã„ã‚’æ¤œè¨ä¸­ã€‚
- MappingManager ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ç¯„å›²ï¼‰ã‚’ç¢ºå®šã™ã‚‹å¿…è¦ã‚ã‚Šã€‚
### 6. ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã§ã®æ°—ã¥ã
- `AddSampleModels` æ‹¡å¼µã§ `MappingManager` ã¸ã®ç™»éŒ²ã‚’ã¾ã¨ã‚ã‚‹ã¨æ¼ã‚Œé˜²æ­¢ã«ãªã‚‹ã€‚
- è¤‡åˆã‚­ãƒ¼ã¯ `Dictionary<string, object>` ã¨ã—ã¦æŠ½å‡ºã•ã‚Œã‚‹ãŸã‚ã€å‹å®‰å…¨ãƒ©ãƒƒãƒ‘ãƒ¼ã®æ¤œè¨ä½™åœ°ã‚ã‚Šã€‚
- `Dictionary<string,string>` å‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ Avro ã® `map` (`{"type": "map", "values": "string"}`) ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã€‚
  - ã‚­ãƒ¼ãƒ»å€¤ã¨ã‚‚ã«æ–‡å­—åˆ—ã®ã¿ã‚µãƒãƒ¼ãƒˆã€‚ãã®ä»–ã®å‹ã‚„ãƒã‚¹ãƒˆæ§‹é€ ã¯æœªå¯¾å¿œã€‚
  - `null` ã¯è¨±å®¹ã•ã‚Œãªã„ãŸã‚ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ç©ºãƒ‡ã‚£ã‚¯ã‚·ãƒ§ãƒŠãƒªã§åˆæœŸåŒ–ã™ã‚‹ã€‚
- `decimal` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ `DecimalPrecisionConfig` ã§è¨­å®šã•ã‚ŒãŸ `precision`/`scale` ã‚’æŒã¤ Avro `bytes` (`logicalType: decimal`) ã¨ã—ã¦ç”Ÿæˆã•ã‚Œã‚‹ã€‚
- è¤‡æ•°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç™»éŒ²ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒã‚ã‚‹ã¨ `OnModelCreating` ã®è¨˜è¿°é‡ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹ã€‚
### 7. AddAsync çµ±ä¸€ã«ä¼´ã†ãƒã‚¤ãƒ³ãƒˆ
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ API ã¯ `AddAsync` ã«ä¸€æœ¬åŒ–ã—ãŸã€‚æ—§ `ProduceAsync` ã¯å»ƒæ­¢äºˆå®šã€‚
- LINQ ã‚¯ã‚¨ãƒªè§£æã‹ã‚‰ `MappingManager.ExtractKeyValue()` ã‚’çµŒç”±ã— `AddAsync` ã‚’å‘¼ã³å‡ºã™æµã‚Œã‚’ã‚µãƒ³ãƒ—ãƒ«åŒ–ã€‚
- è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã¯ [architecture/query_to_addasync_sample.md](architecture/query_to_addasync_sample.md) ã‚’å‚ç…§ã€‚

## ToQuery DSL

`ToQuery` ã¯ View å®šç¾©å°‚ç”¨ã® Fluent API ã§ã™ã€‚`From<T>()` ã‚’èµ·ç‚¹ã« `Join<T2>()`ã€`Where(...)`ã€`Select(...)` ã‚’é †ã«å‘¼ã³å‡ºã—ã¦ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚JOIN ã¯2ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚Šã€çµåˆæ¡ä»¶ã¯ `Join` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§æŒ‡å®šã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ `Where` ã§è¿½åŠ ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œãˆã¾ã™ã€‚å‘¼ã³å‡ºã—é †åºãŒå®ˆã‚‰ã‚Œãªã„å ´åˆã‚„æœªã‚µãƒãƒ¼ãƒˆã® JOIN æ•°ã¯æ§‹æ–‡æ¤œè¨¼ã§ä¾‹å¤–ã¨ãªã‚Šã¾ã™ã€‚

```csharp
modelBuilder.Entity<OrderSummary>().ToQuery(q => q
    .From<Order>()
    .Join<Customer>((o, c) => o.CustomerId == c.Id)
    .Where((o, c) => c.IsActive)
    .Select((o, c) => new OrderSummary { OrderId = o.Id, CustomerName = c.Name }));
```

`.ToQuery(...)` ã§å¾—ã‚‰ã‚ŒãŸ `KsqlQueryModel` ã¯ `KsqlContext` åˆæœŸåŒ–æ™‚ã« `CREATE STREAM/TABLE AS SELECT` æ–‡ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| API / Enum                 | èª¬æ˜                           | å®Ÿè£…çŠ¶æ…‹ |
|----------------------------|--------------------------------|---------|
| `ErrorAction` (Skip/Retry/DLQ) | ã‚¨ãƒ©ãƒ¼æ™‚ã®åŸºæœ¬ã‚¢ã‚¯ã‚·ãƒ§ãƒ³    | âœ…      |
| `ErrorHandlingPolicy`      | ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚„ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©è¨­å®šã‚’ä¿æŒ | âœ… |
| `ErrorHandlingExtensions`  | `.OnError()` `.WithRetryWhen()` ç­‰ã®æ‹¡å¼µ | âœ… |
| `DlqProducer` / `DlqEnvelope` | DLQ é€ä¿¡å‡¦ç†               | âœ…      |
| `DlqOptions`    | DLQ ãƒˆãƒ”ãƒƒã‚¯ã®ä¿æŒæœŸé–“ç­‰ã‚’æŒ‡å®š | âœ…      |
### DLQ Read APIï¼ˆAvroå›ºå®šï¼‰

```csharp
public interface IKsqlContext
{
    IDlqClient Dlq { get; }
}

public interface IDlqClient
{
    IAsyncEnumerable<DlqRecord> ReadAsync(
        DlqReadOptions? options = null,
        CancellationToken ct = default);
}
```

**ä½¿ã„æ–¹ã‚µãƒ³ãƒ—ãƒ«**

```csharp
await foreach (var rec in ctx.Dlq.ReadAsync())
{
    Console.WriteLine(rec.RawText);
}
```

**ä»•æ§˜**

- `FromBeginning=true` ã§ earliest ã¸ã‚·ãƒ¼ã‚¯
- `CommitOnRead=true` ã§ 1 ä»¶ã”ã¨ã«ã‚³ãƒŸãƒƒãƒˆ
- Avro ãƒ¯ã‚¤ãƒ¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ RawText ã‚’å¯èª­åŒ–

**æ—¢çŸ¥ã®åˆ¶ç´„**

- PayloadFormat ã¯å¸¸ã« `"avro"`
- å†æŠ•å‡½ã¯éå¯¾å¿œï¼ˆèª­ã‚€ã ã‘ï¼‰

## çŠ¶æ…‹ç›£è¦–ãƒ»å†…éƒ¨æ©Ÿæ§‹

| API                         | èª¬æ˜                             | å®Ÿè£…çŠ¶æ…‹ |
|-----------------------------|----------------------------------|---------|
| `ReadyStateMonitor`         | ãƒˆãƒ”ãƒƒã‚¯åŒæœŸçŠ¶æ…‹ã®ç›£è¦–           | âœ…      |
| `CacheBinding`         | Kafka ãƒˆãƒ”ãƒƒã‚¯ã¨ Cache ã®åŒæ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° | âœ… |
| `SchemaRegistryClient`      | ã‚¹ã‚­ãƒ¼ãƒç®¡ç†ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ        | âœ…      |
| `ResilientAvroSerializerManager` | Avroæ“ä½œã®ãƒªãƒˆãƒ©ã‚¤ç®¡ç†     | âœ…      |

| `WindowFinalizationManager` | Windowæœ€çµ‚åŒ–å‡¦ç†ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†  | âœ…      |

## å„ API ã®å‚™è€ƒ

- `IEventSet<T>.WithRetry()` ã®å®Ÿè£…ä¾‹ã¯ `EventSet.cs` ã«ã‚ã‚Šã¾ã™ã€F:src/EventSet.csâ€ L238-L258ã€‘ã€‚
- `OnError` ã®æ‹¡å¼µã¯ `EventSetErrorHandlingExtensions.cs` ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€F:src/EventSetErrorHandlingExtensions.csâ€ L8-L20ã€‘ã€‚
- æ‰‹å‹•ã‚³ãƒŸãƒƒãƒˆã®åˆ©ç”¨ä¾‹ã¯ [manual_commit.md](old/manual_commit.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
- `StartErrorHandling()` â†’ `.Map()` â†’ `.WithRetry()` ã®æµã‚Œã§ç´°ã‹ã„ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
- `AvroOperationRetrySettings` ã§ SchemaRegistry æ“ä½œã®ãƒªãƒˆãƒ©ã‚¤æ–¹é‡ã‚’åˆ¶å¾¡ã—ã¾ã™ã€F:src/Configuration/Options/AvroOperationRetrySettings.csâ€ L8-L33ã€‘ã€‚
### tool â€” 2025-08-10T10:08:26.607152+00:00

All the files uploaded by the user have been fully loaded. Searching won't provide additional information.
### assistant â€” 2025-08-10T10:08:29.365413+00:00

_(empty)_
### assistant â€” 2025-08-10T10:08:37.714516+00:00

_(empty)_
### user â€” 2025-08-10T10:09:37.714000+00:00

.Select(@"
            SELECT CustomerId, SUM(Amount) AS TotalAmount
            FROM orders_in
            GROUP BY CustomerId
            EMIT CHANGES")
ã“ã‚ŒãŒãŠã‹ã—ã„
Linqå¼ã§æ§‹æˆã™ã‚‹ã€‚apiä»•æ§˜æ›¸ã‹ã‚‰åˆ¤æ–­ã§ããªã‘ã‚Œã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã¾ãšæ›´æ–°ã™ã‚‹
### system â€” 2025-08-10T10:09:38.225099+00:00

_(empty)_
### assistant â€” 2025-08-10T10:09:38.368939+00:00

å¸ä»¤ã€äº†è§£ã€‚**SQLæ–‡å­—åˆ—ã§ã¯ãªã LINQ ã§ã‚¯ã‚¨ãƒªã‚’å®£è¨€**ã§ãã‚‹ã‚ˆã†ã«ã€ã¾ãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹æ¡ˆã‚’å‡ºã—ã¾ã™ã€‚ã“ã‚Œã‚’ãã®ã¾ã¾ `api_reference.md` ã«è¿½è¨˜ã™ã‚Œã°ã€å®Ÿè£…å´ã‚‚è¿·ã„ã¾ã›ã‚“ã€‚

---

# è¿½è¨˜æ¡ˆï¼šLINQ ãƒ™ãƒ¼ã‚¹ã® KSQL ã‚¯ã‚¨ãƒªå®£è¨€ï¼ˆCSAS/CTASï¼‰

## æ¦‚è¦
`OnModelCreating` ã§ã¯ã€**ç”ŸSQLã¯ä½¿ã‚ãš LINQ ã§ã‚¯ã‚¨ãƒªã‚’æ§‹æˆ**ã—ã¾ã™ã€‚  
ã“ã‚Œã«ã‚ˆã‚Š C# å‹å®‰å…¨ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è€æ€§ãƒ»IntelliSense ã‚’ç¢ºä¿ã—ã¤ã¤ã€KSQL ã® CSAS/CTAS ã‚’å®šç¾©ã§ãã¾ã™ã€‚

---

## API ã‚µãƒãƒª

```csharp
// CSAS: CREATE STREAM ... AS SELECT ...
model.CreateStream<TOut>("stream_name", q => q
    .From<TSource>()                         // å…¥åŠ›STREAM
    .Where(x => /* æ¡ä»¶ */)                 // ä»»æ„
    .Select(x => new TOut { /* å°„å½± */ })   // å¿…é ˆï¼ˆåŒ¿åå‹ä¸å¯ã€TOut ã¸ï¼‰
    .EmitChanges()                           // å¿…é ˆï¼ˆSTREAMï¼‰
    .WithTopic("kebab-case-topic")           // å¿…é ˆ
    .WithValueFormat("AVRO")                 // æ—¢å®š: AVRO
    .WithPartitions(3).WithReplicas(1)
    .IfNotExists()                           // ä»»æ„ï¼ˆå†ªç­‰åŒ–ï¼‰
);

// CTAS: CREATE TABLE ... AS SELECT ...
model.CreateTable<TOut>("table_name", q => q
    .From<TSource>()                         // å…¥åŠ›STREAM
    .GroupBy(x => x.CustomerId)              // é›†è¨ˆã‚­ãƒ¼ï¼ˆå˜ä¸€ã‚­ãƒ¼ï¼‰
    .Select(g => new TOut {                  // g ã¯ã‚°ãƒ«ãƒ¼ãƒ—
        CustomerId  = g.Key,                 // ã‚­ãƒ¼ã¯ g.Key
        TotalAmount = g.Sum(x => x.Amount)   // é›†è¨ˆé–¢æ•°ï¼ˆSum/Count/Min/Max/Avgï¼‰
    })
    .WithTopic("kebab-case-topic")
    .WithValueFormat("AVRO")
    .WithPartitions(3).WithReplicas(1)
    .IfNotExists()
);
```
### ã‚µãƒãƒ¼ãƒˆæ¼”ç®—
- `Where`, `Select`, `SelectMany`ï¼ˆå¿…è¦ã«å¿œã˜ï¼‰ã€`GroupBy`ï¼ˆå˜ä¸€ã‚­ãƒ¼ï¼‰
- é›†è¨ˆï¼š`g.Sum(...)`, `g.Count()`, `g.Min(...)`, `g.Max(...)`, `g.Avg(...)`
- åˆ¥åï¼š**`TOut` ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å**ãŒåˆ—åã«ãªã‚Šã¾ã™
- `EmitChanges()`ï¼š**STREAM ã®ã¨ãå¿…é ˆ**ã€‚TABLEï¼ˆCTASï¼‰ã§ã¯ä¸è¦
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ/ãƒˆãƒ”ãƒƒã‚¯/ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³/ãƒ¬ãƒ—ãƒªã‚«ã¯ `With*` ã§æŒ‡å®š
### æœªå¯¾å¿œ/æ³¨æ„
- è¤‡åˆã‚­ãƒ¼ `GroupBy(x => new { x.A, x.B })` ã¯å½“é¢éå¯¾å¿œï¼ˆå¿…è¦ãªã‚‰æ‹¡å¼µäºˆå®šï¼‰
- JOIN/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯æ¬¡æœŸæ‹¡å¼µï¼ˆæœ¬ç¯€ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ï¼‰

---

## ä¾‹ï¼šCSASï¼ˆæ­£è¦åŒ–ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰

**ç›®çš„**ï¼š`orders_in` ã‹ã‚‰ `orders_out` ã¸ã€CustomerId ã‚’å¤§æ–‡å­—åŒ–ã—ã¦ãƒŸãƒ©ãƒ¼ã™ã‚‹ã€‚

```csharp
model.CreateStream<OrderOut>("orders_out", q => q
    .From<OrderIn>()
    .Select(x => new OrderOut {
        OrderId     = x.OrderId,                 // KEY åˆ—ã‚’å¿…ãšå¼•ãç¶™ã
        CustomerId  = x.CustomerId.ToUpper(),
        Amount      = x.Amount,
        CreatedAt   = x.CreatedAt
    })
    .EmitChanges()
    .WithTopic("orders-out")
    .WithValueFormat("AVRO")
    .WithPartitions(3).WithReplicas(1)
    .IfNotExists()
);
```

> ç½®ãæ›ãˆå‰ï¼ˆNGä¾‹ãƒ»SQLç›´æ›¸ãï¼‰  
> ```sql
> CREATE STREAM orders_out AS
> SELECT OrderId, UCASE(CustomerId) AS CustomerId, Amount, CreatedAt FROM orders_in EMIT CHANGES;
> ```

---

## ä¾‹ï¼šCTASï¼ˆé›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**ç›®çš„**ï¼šé¡§å®¢åˆ¥ã®åˆè¨ˆé‡‘é¡ã‚’é›†è¨ˆã— `orders-by-customer` ã«æ°¸ç¶šåŒ–ã™ã‚‹ã€‚

```csharp
model.CreateTable<OrdersByCustomer>("orders_by_customer", q => q
    .From<OrderIn>()
    .GroupBy(x => x.CustomerId)
    .Select(g => new OrdersByCustomer {
        CustomerId  = g.Key,                  // â† GroupBy ã®ã‚­ãƒ¼
        TotalAmount = g.Sum(x => x.Amount)    // â† é›†è¨ˆé–¢æ•°
    })
    .WithTopic("orders-by-customer")
    .WithValueFormat("AVRO")
    .WithPartitions(3).WithReplicas(1)
    .IfNotExists()
);
```
### å¯¾å¿œã™ã‚‹ POCO
```csharp
[KsqlTable] // ã¾ãŸã¯ KsqlStreamï¼ˆæ¶ˆè²»å´ã®ç”¨é€”ã«åˆã‚ã›ã‚‹ï¼‰
[KsqlTopic("orders-by-customer")]
public class OrdersByCustomer
{
    [KsqlKey] public string  CustomerId   { get; set; } = default!;
    public decimal           TotalAmount  { get; set; }
}
```

---

## å‹ãƒãƒƒãƒ”ãƒ³ã‚°ã¨ãƒ«ãƒ¼ãƒ«

- **ã‚­ãƒ¼åˆ—**ï¼š`TOut` ã® `[KsqlKey]` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æ±ºã¾ã‚‹  
  - CSAS ã§ã¯ **å…¥åŠ›ã®ã‚­ãƒ¼**ã‚’å¿…ãšå¼•ãç¶™ãï¼ˆåˆ¥ã®åˆ—ã‚’ã‚­ãƒ¼ã«ã—ãŸã„å ´åˆã¯å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªãŸã‚å°†æ¥æ‹¡å¼µï¼‰
  - CTAS ã§ã¯ `GroupBy` ã®ã‚­ãƒ¼ãŒ `[KsqlKey]` ã«å¯¾å¿œ
- **æ™‚é–“åˆ—**ï¼š`[KsqlTimestamp]` ãŒã‚ã‚Œã° `TIMESTAMP='...'` ã‚’è‡ªå‹•ä»˜ä¸
- **æ•°å€¤/å°æ•°**ï¼š`decimal` ã¯ `DECIMAL(precision, scale)`ï¼ˆæœªæŒ‡å®šã¯å®Ÿè£…æ—¢å®šã«å¾“ã†ï¼‰
- **æ–‡å­—åˆ—**ï¼š`string` â†’ `STRING`
- **ãƒã‚¤ãƒˆåˆ—**ï¼š`byte[]` â†’ `BYTES`

---

## å†ªç­‰åŒ–ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `IfNotExists()` ã‚’ä»˜ä¸ã™ã‚‹ã¨åˆå›ã®ã¿ä½œæˆã—ã€2å›ç›®ä»¥é™ã¯ã‚¹ã‚­ãƒƒãƒ—  
- ã‚¯ã‚¨ãƒªå†…å®¹ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€**`TERMINATE <query_id>` â†’ å†ä½œæˆ**ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é‹ç”¨ã‚’æ¨å¥¨  
  - å¤‰æ›´æ¤œçŸ¥ï¼ˆãƒãƒƒã‚·ãƒ¥ï¼‰ã‚„ `_ksql_migrations` ã®è¨­è¨ˆã¯åˆ¥ç¯€å‚ç…§

---

## é€å—ä¿¡ï¼ˆå†æ²ï¼‰

**é€ä¿¡**ï¼š`OrderIn` ã‚’ `AddAsync` ã§æŠ•å…¥ â†’ KSQLDB ãŒå‡¦ç† â†’ `orders-out`/`orders-by-customer` ã«å‡ºåŠ›  
**å—ä¿¡**ï¼šã‚·ãƒ³ã‚¯å´ POCOï¼ˆ`OrderOut`/`OrdersByCustomer`ï¼‰ã§ `ConsumeAsync<T>()` ã‚’ä½¿ã†

---

## FAQ
- **Q: è¤‡æ•°åˆ—ã§ GroupBy ã—ãŸã„**  
  A: ç¾è¡Œ LINQ DSL ã¯å˜ä¸€ã‚­ãƒ¼ã®ã¿ã€‚è¤‡åˆã‚­ãƒ¼ã¯æ¬¡æœŸæ‹¡å¼µã€‚å¿…è¦ãªã‚‰ä¸€æ™‚çš„ã« SQL ç›´æ›¸ãã® `model.Sql()` ã‚’ä½¿ç”¨ã€‚
- **Q: `EmitChanges()` ã‚’ä»˜ã‘ã‚‹ã‹è¿·ã†**  
  A: **STREAMï¼ˆCSASï¼‰ã¯å¿…é ˆ**ã€‚TABLEï¼ˆCTASï¼‰ã¯ä¸è¦ã€‚
- **Q: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ AVRO ä»¥å¤–ã‚’ä½¿ãˆã‚‹ï¼Ÿ**  
  A: ç¾è¡Œã¯ AVRO æ¨å¥¨ã€‚`WithValueFormat("JSON")` ãªã©ã¯å°†æ¥æ‹¡å¼µã€‚

---

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå·®åˆ†ã‚’å…¥ã‚Œã‚Œã°ã€**ã€ŒSelect ã« SQL ã‚’ç›´æ›¸ãã—ãªã„ã€**æ–¹é‡ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚  
ã“ã®æ–¹é‡ã§OKãªã‚‰ã€Codexå‘ã‘ã« **å®Ÿè£…ã‚¿ã‚¹ã‚¯åŒ–ï¼ˆLINQâ†’KSQL ã®å¼æœ¨ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ»å¯¾å¿œæ¼”ç®—ï¼‰** ã®ä¾é ¼æ–‡ã‚‚ã™ãç”¨æ„ã—ã¾ã™ã€‚

ï¼ˆ[[REDACTED_PHONE]]:26 JSTï¼‰
### assistant â€” 2025-08-10T10:09:42.028141+00:00

_(empty)_
### assistant â€” 2025-08-10T10:09:46.946841+00:00

_(empty)_
