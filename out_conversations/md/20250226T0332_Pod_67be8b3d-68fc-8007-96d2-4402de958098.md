---
conversation_id: "67be8b3d-68fc-8007-96d2-4402de958098"
title: "Pod削除トラブルシューティング"
create_time: 1740540733.650477
update_time: 1740540907.939779
language_guess: "en"
num_messages: 7
part_index: 1
part_count: 1
---

### system — 2025-02-26T03:32:13.650477+00:00

_(empty)_

### user — 2025-02-26T03:32:13.655192+00:00

K8sのPodのリリースにYAMLを使用している･ DELETEコマンドで削除できない場合はどのような対応が考えられるか

### assistant — 2025-02-26T03:32:53.230511+00:00

_(empty)_

### assistant — 2025-02-26T03:32:53.230626+00:00

KubernetesのPodをYAMLでデプロイしていて、`kubectl delete` コマンドで削除できない場合、以下のような対応が考えられます。

### 1. **Podの状態を確認**
まずは、`kubectl get pod <pod-name> -o wide` や `kubectl describe pod <pod-name>` でPodの状態を確認しましょう。

- `Terminating` 状態で止まっている → 強制削除が必要
- `CrashLoopBackOff` や `Pending` → 他の原因の可能性あり

---

### 2. **強制削除 (`--force --grace-period=0`)**
通常の `kubectl delete pod <pod-name>` で削除できない場合、以下のコマンドで強制削除を試みる。

```sh
kubectl delete pod <pod-name> --grace-period=0 --force
```

**注意:**  
この方法ではAPIサーバーから直接Podのエントリを削除するため、場合によってはノード上にプロセスが残る可能性があります。その場合、次のステップで対処します。

---

### 3. **PodがDaemonSetの一部ではないか確認**
DaemonSetによって管理されているPodは `kubectl delete pod` では削除できません。DaemonSetを削除する場合は、以下のコマンドを実行してください。

```sh
kubectl delete daemonset <daemonset-name>
```

---

### 4. **PodのFinalizerを削除**
Podが `Terminating` 状態で削除されない場合、`kubectl get pod <pod-name> -o yaml` を実行し、`finalizers` が設定されていないか確認します。

もし `finalizers` が残っている場合、以下のように修正して削除できます。

```sh
kubectl patch pod <pod-name> -p '{"metadata":{"finalizers":null}}' --type=merge
```

---

### 5. **ノード上で強制削除**
ノード上で `kubectl delete` が効かない場合は、直接 `containerd` や `docker` を操作してPodを削除します。

**(1) ノードのリストを取得**
```sh
kubectl get nodes
```

**(2) 該当のノードにSSH接続**
```sh
ssh <node-name>
```

**(3) ノード上でPodのプロセスを確認**
```sh
crictl ps | grep <pod-name>
```
または
```sh
docker ps | grep <pod-name>
```

**(4) 強制削除**
```sh
crictl rm <container-id>
```
または
```sh
docker rm -f <container-id>
```

**(5) kubeletを再起動**
```sh
systemctl restart kubelet
```

---

### 6. **Kubernetes API経由で削除**
もし `kubectl` コマンドが効かない場合、`kubectl proxy` を利用してAPI経由で削除を試みる。

```sh
kubectl proxy &
curl -X DELETE http://127.0.0.1:8001/api/v1/namespaces/<namespace>/pods/<pod-name>
```

---

### 7. **ノードを再起動**
Podが完全に削除されない場合、影響の範囲を考慮しつつ、ノードの再起動も検討する。

```sh
reboot
```

---

### 8. **最終手段: ノードを除外してPodを消す**
特定のノードにあるPodが削除できない場合、ノードを一時的に除外してPodをクリアする。

```sh
kubectl drain <node-name> --ignore-daemonsets --delete-emptydir-data
```

その後、Podを削除してからノードを復帰させる。

```sh
kubectl uncordon <node-name>
```

---

### まとめ
| 状況 | 対応策 |
|------|------|
| `kubectl delete pod` で削除できない | `--grace-period=0 --force` で強制削除 |
| `Terminating` 状態で止まる | `finalizers` を削除 |
| DaemonSetのPodが削除できない | DaemonSet自体を削除 |
| ノード上にプロセスが残る | `crictl` または `docker` で手動削除 |
| `kubectl` が使えない | API経由で削除 |
| どうしても消えない | ノードをDrainしてクリア |

どの方法を試すかは、状況に応じて選択してください。

### user — 2025-02-26T03:34:39.527186+00:00

DAEMONSET　であるか判断する方法

### assistant — 2025-02-26T03:35:07.394158+00:00

KubernetesのPodがDaemonSetによって管理されているかどうかを判断する方法はいくつかあります。

---

## **1. Podの詳細を確認する**
以下のコマンドを実行して、Podの **"Controlled By"** を確認します。

```sh
kubectl get pod <pod-name> -o wide
```

または詳細情報を取得:

```sh
kubectl describe pod <pod-name>
```

### **出力例 (DaemonSetの場合)**
```yaml
Controlled By:  DaemonSet/<daemonset-name>
```
この場合、PodはDaemonSet `<daemonset-name>` によって管理されています。

---

## **2. DaemonSetの一覧から確認する**
クラスタ内のDaemonSetを一覧表示し、対象のPodが含まれているかを確認する。

```sh
kubectl get daemonset -A
```

特定のDaemonSet内のPod一覧を確認する場合:

```sh
kubectl get pods -o wide --selector=k8s-app=<daemonset-name>
```

---

## **3. Podのオーナー参照 (`ownerReferences`) を確認**
PodのYAML情報を取得し、`ownerReferences` フィールドを確認する。

```sh
kubectl get pod <pod-name> -o yaml
```

DaemonSetの場合、以下のような `ownerReferences` が含まれる:

```yaml
metadata:
  ownerReferences:
  - apiVersion: apps/v1
    kind: DaemonSet
    name: <daemonset-name>
    uid: <daemonset-uid>
```

---

## **4. すべてのPodのオーナーを確認**
クラスタ内のPodのオーナーがDaemonSetかどうかを一括確認する:

```sh
kubectl get pods -o custom-columns="NAME:.metadata.name,OWNER:.metadata.ownerReferences[0].kind"
```

DaemonSetのPodには `OWNER` に `DaemonSet` が表示される。

---

## **5. DaemonSetのPodかどうかスクリプトで判定**
特定のPodがDaemonSetに属しているか確認するシェルスクリプト:

```sh
pod_name="<pod-name>"
namespace="<namespace>"

owner_kind=$(kubectl get pod $pod_name -n $namespace -o jsonpath='{.metadata.ownerReferences[0].kind}')

if [ "$owner_kind" == "DaemonSet" ]; then
    echo "Pod $pod_name is managed by a DaemonSet."
else
    echo "Pod $pod_name is NOT managed by a DaemonSet."
fi
```

---

## **まとめ**
| 方法 | コマンド | 確認ポイント |
|------|---------|-------------|
| **Podの詳細確認** | `kubectl describe pod <pod-name>` | "Controlled By: DaemonSet/<daemonset-name>" |
| **DaemonSetの一覧表示** | `kubectl get daemonset -A` | PodがDaemonSetに含まれているか |
| **PodのYAML確認** | `kubectl get pod <pod-name> -o yaml` | `ownerReferences` に `kind: DaemonSet` があるか |
| **Podのオーナー一覧** | `kubectl get pods -o custom-columns="NAME:.metadata.name,OWNER:.metadata.ownerReferences[0].kind"` | OWNER が `DaemonSet` になっているか |

DaemonSetのPodは通常 `kubectl delete pod <pod-name>` では削除できないため、DaemonSet自体を削除する必要があります。

```sh
kubectl delete daemonset <daemonset-name>
```

状況に応じて適切な方法を選んでください。
