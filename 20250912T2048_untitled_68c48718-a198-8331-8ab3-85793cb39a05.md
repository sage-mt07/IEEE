---
conversation_id: "68c48718-a198-8331-8ab3-85793cb39a05"
title: "サンプル実装一覧解析"
create_time: 1757710107.250542
update_time: 1757769708.683326
language_guess: "en"
num_messages: 21
part_index: 1
part_count: 1
---

### user — 2025-09-12T20:48:26.861000+00:00

以下は「必要なサンプル実装の一覧」と、リポジトリ内の対応サンプルの有無・現状ステータスです。

基本/入門

Basic Produce/Consume: 最小の送受信（Builder使用、Schema Registry設定）
対応: examples/basic-produce-consume（ビルドOK）
Hello World: 1件送ってコンソールに出す（属性/Builder最小）
対応: examples/hello-world（存在する／ビルドNG：属性名未追従）
Config/Builder Usage: appsettings.json からの設定読み込み
対応: examples/configuration（存在、csprojなし・ドキュメント的）
対応: examples/configuration-mapping（存在する／ビルドNG：属性名・using未追従）
コンシューマ動作/品質

Manual Commit: autoCommit:false と Commit() の実装例
対応: examples/manual-commit（存在する／csprojなし）※物理検証は physicalTests/Runners/ManualCommitRunner で確認済
Error Handling + DLQ: 例外処理、DLQ転送の最小例
対応: examples/error-handling（存在する／ビルドNG：属性名未追従）
対応: examples/error-handling-dlq（存在する／ビルドNG：属性名未追従）
Retry/OnError: リトライ回数・間隔の設定例
対応: examples/retry-onerror（存在する／ビルドNG：属性名未追従）
Headers + Metadata: ヘッダー参照・メタ（Partition/Offset）取得
対応: examples/headers-meta（存在する／ビルドNG：リテラルエスケープ崩れ）
スキーマ/属性

Schema Attributes: [KsqlTopic], [KsqlKey], [KsqlDecimal], [KsqlTimestamp] の使用例
対応: examples/schema-attributes（存在する／ビルドNG：属性名未追従）
Contracts Library: 共有型・DTOのプロジェクト例
対応: examples/Contracts（ビルドOK）
クエリ/DSL

Query Filter: ストリームに対する簡単なフィルタ
対応: examples/query-filter（存在する／ビルドNG：属性名未追従）
View.ToQuery: View相当のクエリ構築
対応: examples/view-toquery（存在する／ビルドNG：属性名未追従）
Table Cache Lookup: キャッシュテーブルからの参照
対応: examples/table-cache-lookup（存在する／ビルドNG：API追従不足）
ウィンドウ/ロールアップ

Tumbling Live Consumer: ライブウィンドウの購読
対応: examples/tumbling-live-consumer（ビルドOK）
Rollup Verify (1m→5m): 集計検証・自動チェック
対応: examples/rollup-1m-5m-verify（存在する／ビルドNG：依存側の変更未追従）
WhenEmpty Schedule: WhenEmptyの埋め合わせロジック例
対応: examples/whenempty-schedule（ビルドOK）
運用/発展

Deduprates Producer: 重複除外・冪等送信イメージ
対応: examples/deduprates-producer（ビルドOK）
Daily Comparison: 日次比較・可視化（複数プロジェクト構成）
対応: examples/daily-comparison（存在する／ビルドNG：ライブラリ側API未追従）
OSS Bars Verify: OSS想定の自己検証サンプル
対応: examples/oss-bars-verify（ビルドOK）

### assistant — 2025-09-12T20:48:26.876887+00:00

_(empty)_

### assistant — 2025-09-12T20:48:26.929879+00:00

了解しました ✅  
提示いただいた一覧を整理すると、現状は **サンプルコードのカバレッジ自体は十分あるが、ライブラリ側のAPI・属性変更への追従不足でビルドが通らない例が多い** という状況ですね。大きく次のように分類できます。

---

## 1. ビルドOK（現行利用可能）
- **基本/入門**
  - examples/basic-produce-consume
- **ウィンドウ/ロールアップ**
  - examples/tumbling-live-consumer
  - examples/whenempty-schedule
- **運用/発展**
  - examples/deduprates-producer
  - examples/oss-bars-verify
- **スキーマ/属性**
  - examples/Contracts

👉 利用者へのガイドラインや README からのリンク先として、そのまま紹介可能。

---

## 2. 存在するがビルドNG（属性名・API追従不足）
- **基本/入門**
  - hello-world（属性名未追従）
  - configuration-mapping（属性名・using未追従）
- **コンシューマ動作/品質**
  - error-handling（属性名未追従）
  - error-handling-dlq（属性名未追従）
  - retry-onerror（属性名未追従）
  - headers-meta（リテラルエスケープ崩れ）
- **スキーマ/属性**
  - schema-attributes（属性名未追従）
- **クエリ/DSL**
  - query-filter（属性名未追従）
  - view-toquery（属性名未追従）
  - table-cache-lookup（API追従不足）
- **ウィンドウ/ロールアップ**
  - rollup-1m-5m-verify（依存側未追従）
- **運用/発展**
  - daily-comparison（ライブラリ側API未追従）

👉 大部分が「属性名・API変更の追従」不足。リファクタ後の `Ksql*` 系属性や `HasQuery` 系APIに差し替えれば復旧可能。

---

## 3. 存在するが csproj が無い（ドキュメント的 or ランナー依存）
- **基本/入門**
  - configuration（csprojなし・ドキュメント的）
- **コンシューマ動作/品質**
  - manual-commit（csprojなし。ただし physicalTests/Runners/ManualCommitRunner で確認済）

👉 サンプル群の統一感を持たせるなら、**examples/*/ サンプルはすべて csproj 形式で揃える**のがおすすめです。ドキュメント専用なら `docs/examples/` に移動して整理もアリ。

---

## 優先度付けの提案
1. **属性追従で直るもの（hello-world, query-filter, schema-attributes など）**  
   → OSS公開時の「最初に触る導入例」として必須なので最優先。
2. **csproj 不足サンプル（configuration, manual-commit）**  
   → 統一感を出す目的。build/run 可能にする。
3. **高度なAPI未追従（table-cache-lookup, daily-comparison, rollup-1m-5m-verify）**  
   → OSS安定後に追従でよい。初期公開ではドキュメント注釈だけでも可。

---

👆 この整理で「どこから直すか」を決められると思います。  
ご希望なら、**「属性名の追従リスト」**を私の方でまとめ直して、Codexに修正依頼できるタスク表に落とし込みましょうか？

### system — 2025-09-12T20:48:27.250542+00:00

_(empty)_

### user — 2025-09-12T20:48:27.250542+00:00

_(empty)_

### system — 2025-09-12T20:48:27.250542+00:00

_(empty)_

### system — 2025-09-12T20:48:27.454452+00:00

_(empty)_

### user — 2025-09-12T20:49:07.696000+00:00

サンプルの充足度を確認してる

### system — 2025-09-12T20:49:10.961955+00:00

_(empty)_

### system — 2025-09-12T20:49:11.001443+00:00

_(empty)_

### assistant — 2025-09-12T20:49:12.006851+00:00

_(empty)_

### assistant — 2025-09-12T20:49:22.550037+00:00

了解、司令。サンプルの**充足度サマリ**をいまの棚卸しから即断で出します。

## 全体サマリ
- **総数** 20  
- **ビルドOK** 6  
- **ビルドNG（追従不足）** 12  
- **csprojなし** 2  

## 項目別カバレッジ（✔=OK / △=一部 / ✖=未充足）
- **基本/入門**：△（OK: basic-produce-consume／NG: hello-world, configuration-mapping／csprojなし: configuration）
- **コンシューマ動作/品質**：✖（manual-commit=csprojなし、他は属性/API未追従でNG）
- **スキーマ/属性**：△（Contracts=OK／schema-attributes=NG）
- **クエリ/DSL**：✖（query-filter, view-toquery, table-cache-lookup=NG）
- **ウィンドウ/ロールアップ**：△（OK: tumbling-live-consumer, whenempty-schedule／NG: rollup-1m-5m-verify）
- **運用/発展**：△（OK: deduprates-producer, oss-bars-verify／NG: daily-comparison）

## 直近の「公開前に必須」12本（優先順）
1) **hello-world**（最小導線）  
2) **configuration**（csproj化）  
3) **configuration-mapping**  
4) **manual-commit**（csproj化＋最小実行）  
5) **error-handling**  
6) **error-handling-dlq**  
7) **retry-onerror**  
8) **headers-meta**  
9) **schema-attributes**（KsqlTopic/Key/Decimal/Timestamp）  
10) **query-filter**  
11) **view-toquery**  
12) **rollup-1m-5m-verify**

> 上記12本が通れば、「導入→運用の基本線」は一通りデモ可能。  
> **table-cache-lookup / daily-comparison** は「追従コスト高」枠なので、初回公開では *Experimental* 注記に下げてもOK。

## 30分で効く修復バッチ（方針）
- **属性・名前空間の一括置換**：`[Ksql*]` の現行名へ、`using` 自動追加（ソリューション全体で codemod）。  
- **APIシグネチャ追従**：`HasQuery` / `ToQuery` 周りの破壊的変更点テンプレを適用。  
- **リテラル崩れ修正**：`headers-meta` の文字列エスケープを統一。  
- **examples/* をすべて csproj 化**：`Example.Default.csproj` テンプレ＋共通 `Directory.Build.props`。  
- **CI スモーク**：`dotnet build examples/* -c Release` をマトリクス実行し、NG を即時検知。

この順で進めれば、最短で**“触って分かる”体験ライン**を満たせます。次アクションとして、私の方で「属性名・APIの**追従差分リスト**」を作って、該当サンプルにマッピングした**修正タスクリスト（チェックボックス付）**まで一気に出しますね。

— 送信: [[REDACTED_PHONE]]:49 JST

### assistant — 2025-09-12T20:49:31.326667+00:00

_(empty)_

### assistant — 2025-09-12T20:49:32.263005+00:00

_(empty)_

### user — 2025-09-12T20:53:04.870000+00:00

以下にまとめます
basics: basic-produce-consume（hello-world統合）
configuration: appsettings＋最小マッピング（configuration-mapping統合）
error-handling: Retry/DLQ切替（2本統合）
query-basics: filter＋view（2本統合）
windowing: tumbling-live＋rollup検証を1本に集約 or 役割分担で並存（入門/検証）
advanced: daily-comparison（高度シナリオ）、oss-bars-verify（OSS検証）

### assistant — 2025-09-12T20:53:05.702693+00:00

いいね、その整理でいきましょう。司令の統合方針を“そのまま出荷できる形”に落とし込む提案です。最短で混乱なく移行できるよう、**ディレクトリ構成・csprojテンプレ・CI・チェックリスト**まで一気に固めます。

# 提案：最終サンプル構成（examples/ 配下）
```
examples/
  basics/                     # basic-produce-consume（hello-world統合）
  configuration/             # appsettings + 最小マッピング（configuration-mapping統合）
  error-handling/            # Retry/DLQ切替（2本統合）
  query-basics/              # filter + view（2本統合）
  windowing/
    intro/                   # tumbling-live（入門）
    verify/                  # rollup検証（検証）
  advanced/
    daily-comparison/        # 高度シナリオ
    oss-bars-verify/         # OSS自己検証
```
> **運用ポイント**  
> - windowing は「入門/検証」を**並存**推奨（1本集約も可能だが、入門の認知負荷が上がる）。  
> - examples 直下は**8本**に集約。README から“10分で触れる順”で導線を敷く。

---

## 共有ビルド設定（ルート）
- `Directory.Build.props`（全サンプル共通）
  - `TargetFramework` は `net8.0`（`net10` 対応は別ブランチで）
  - `Nullable`=enable, `LangVersion`=preview（必要なら）
  - 共通 PackageReference（ライブラリ、Logging、Configuration）
- `Directory.Packages.props`（Central Package Management を使うなら）
- `Examples.props`（共通 `DefineConstants`：`EXAMPLES`, `ENABLE_DLQ` など）

### 例：Directory.Build.props（抜粋）
```xml
<Project>
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="8.*" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="8.*" />
    <PackageReference Include="Serilog.Sinks.Console" Version="5.*" />
  </ItemGroup>
</Project>
```

---

## 各サンプルの“完成条件”チェックリスト
共通 Done 定義（PR テンプレにも流用可）：
- [ ] `dotnet build` / `dotnet run` 単独で実行可能
- [ ] `appsettings.json` サンプルと環境変数の両対応（`KAFKA__...` 形式）
- [ ] README（1画面：目的→前提→手順→期待出力→トラブルシュート）
- [ ] 例外時のメッセージが**利用者目線**（内部仕様語を避ける）
- [ ] `Program.cs` 200行以内（詳細は `Modules/*` に分離）

### basics
- **内容**：最小 Produce → Consume（Builder + Schema Registry）
- **統合**：hello-world を**内部に含める**（`--one-shot` で 1件だけ送信＆コンソール出力）
- [ ] `--one-shot` スイッチで 1件送信モード
- [ ] `--count N` で件数調整

### configuration
- **内容**：`appsettings.json` → Builder/Consumer 設定反映 + **最小マッピング**
- **統合**：configuration-mapping の要点だけ残す（DTO と属性は最小）
- [ ] `appsettings.Development.json` も同梱
- [ ] 必須キーに対する**起動時バリデーション**（丁寧なエラー）

### error-handling
- **内容**：`Retry` / `DLQ` を**1本で切替**  
  - `--mode Retry` or `--mode Dlq`
  - `--retryCount` / `--retryDelayMs`
  - `--dlqTopic`
- [ ] 例外シミュレータ（`--failRate 0.1` など）で再現容易に
- [ ] 最後のリトライ成功時は**Warning ログ**（司令の要望）

### query-basics
- **内容**：Filter + View（`HasQuery` / `ToQuery`）
- [ ] 1つの `KsqlContext` に「生フィルタ」「View相当」の**両パス**
- [ ] 最小の `WHERE` 相当、投影、件数チェック

### windowing
- **intro**：TUMBLING（ライブ購読）＋最小 OHLC  
- **verify**：`1m→5m` rollup の**検証**（自動チェック）  
- [ ] `intro` は**観測重視**（コンソールでわかる）
- [ ] `verify` は**自動テスト**重視（ExitCode で合否）

### advanced
- **daily-comparison**：高度（**現状 NG でも “Experimental” 注記で公開可**）
- **oss-bars-verify**：OK（自己検証スイート）

---

## コード規約（examples 共通）
- ルート名前空間：`Kafka.Ksql.Linq.Examples.*`
- `Program.cs` は**トップレベル短縮**＋`builder.Services` 拡張メソッドで配線
- `appsettings.json` の**最低限キー**はすべて `IOptions<T>` バリデーション
- 属性は**現行の正式名**のみ使用（古い別名は一切使わない）
- ログは **Console 最優先**（Serilog）＋ `--verbose` フラグ

---

## 破壊的変更の**codemod**（一括置換ガイド）
> この4系で大半復旧できます。リポジトリ全体に適用推奨。

1) **属性名の追従**
- `[KsqlTopic]` / `[KsqlKey]` / `[KsqlDecimal]` / `[KsqlTimestamp]`  
  → 旧別名・旧名前空間が残っていれば新命名に統一  
- Using 追加：`using Kafka.Ksql.Linq.Schema;`（例）

2) **クエリ API**
- `View.ToQuery(...)` → 現行 `HasQuery(...)`/`DefineQuery(...)` パターンへ  
- `ToQuery()` の戻りと登録位置を**`OnModelCreating` に集約**

3) **テーブルキャッシュ**
- 古い `TableCache.Lookup*` 系呼び出し → 新 `UseTableCache()` + 取得 API に追従

4) **リテラル崩れ**
- 文字列補間・エスケープの **$ / @** 組合せを点検（`headers-meta`）

---

## CI（GitHub Actions）スモーク（抜粋）
```yaml
name: Examples Build
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sample:
          - basics
          - configuration
          - error-handling
          - query-basics
          - windowing/intro
          - windowing/verify
          - advanced/daily-comparison
          - advanced/oss-bars-verify
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - run: dotnet build examples/${{ matrix.sample }} -c Release
```
> **後追い**で `dotnet test`（`windowing/verify` だけでも可）を追加。

---

## README 入口（上から順に触れる導線）
1. basics → 2. configuration → 3. error-handling → 4. query-basics → 5. windowing（intro→verify）→ 6. advanced  
> 1ページ目は**5分導線**。詳細は各サンプルの README に分散。

---

## 即時アクション（私の作業提案）
1. `examples/` を上記構成へ移設（残骸は `examples/_legacy` へ一時退避）
2. 共通 `Directory.Build.props` 追加
3. basics / configuration / error-handling / query-basics の**4本だけ**先にビルド通す
4. windowing を **intro→verify** の二段構えに再配置（検証は後追い）
5. README 入口の**10分導線**を作成

この順だと**今日中に“触れるライン”を復活**できます。必要なら、各サンプルの **`Program.cs` 雛形**（ホスト/設定/ログの最小配線）もすぐ出します。

— 送信: [[REDACTED_PHONE]]:53 JST

### system — 2025-09-12T20:53:06.973295+00:00

_(empty)_

### system — 2025-09-12T20:53:06.979347+00:00

_(empty)_

### assistant — 2025-09-12T20:53:07.286055+00:00

_(empty)_

### assistant — 2025-09-12T20:53:20.205712+00:00

_(empty)_
