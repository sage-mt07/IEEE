---
conversation_id: "678096bb-7ed0-8007-b2e7-3719af28e787"
title: "pgaudit Azure Monitor設定"
create_time: 1736480443.778407
update_time: 1737103922.086182
language_guess: "en"
num_messages: 8
part_index: 1
part_count: 1
---

### system — 2025-01-10T03:40:43.778407+00:00

_(empty)_

### user — 2025-01-10T03:40:43.780613+00:00

pgauditの出力をAzure monitorに設定する方法

### tool — 2025-01-10T03:41:08.706999+00:00

**Connecting PostgreSQL logs to Azure Monitor**

I’m gathering info on integrating pgaudit logs with Azure Monitor, considering both Azure Database for PostgreSQL and self-managed PostgreSQL on an Azure VM.

**Mapping log integration**

I'm detailing the steps to link pgaudit logs with Azure Monitor, including setting up pgaudit, configuring PostgreSQL logs, and using Azure diagnostics to gather and manage these logs.

**Mapping out integration**

I'm setting up Azure Monitor for pgaudit logs, focusing on Azure Database for PostgreSQL managed service and custom log locations, with a step-by-step guide in Japanese.

### assistant — 2025-01-10T03:41:08.707083+00:00

以下では、PostgreSQL の拡張機能である **pgaudit** による監査ログを Azure Monitor（Log Analytics など）で一元管理するための、大まかな設定手順の例を紹介します。Azure での構成方法は、利用しているサービス（Azure Database for PostgreSQL、もしくは Azure VM 上で動かしている PostgreSQL など）やバージョンにより若干異なる場合があります。必要に応じて読み替えてご利用ください。

---

## 1. 前提条件

1. **pgaudit がインストール・利用可能な環境であること**  
   - Azure Database for PostgreSQL（特に Flexible Server や Hyperscale (Citus)）の場合、pgaudit 拡張機能を有効化できるかどうかを事前に確認してください。  
   - Azure VM 上に自前で PostgreSQL をインストールしている場合は、サーバーに対して pgaudit をインストールします。

2. **Azure Monitor / Azure Log Analytics ワークスペースを準備していること**  
   - 監査ログを送信するための Log Analytics ワークスペースを Azure ポータル上で作成しておきます。

3. **OS / DB のログが Azure Monitor に転送できるようになっていること**  
   - Azure Database for PostgreSQL のマネージド サービスの場合は、Azure portal の「診断設定」または「監査」機能を利用してログを収集できるか確認します。  
   - Azure VM の場合は Azure Monitor Agent (旧 Log Analytics Agent や Azure Monitor Agent) をインストールして、PostgreSQL のログファイルをカスタム ログとして収集する設定を行います。

---

## 2. pgaudit の設定

### 2-1. pgaudit のインストール・有効化

- **Azure Database for PostgreSQL - Flexible Server** などで pgaudit が使用可能な場合、拡張機能を下記のように有効化します。

```sql
CREATE EXTENSION IF NOT EXISTS pgaudit;
```

- **Azure VM** 上に PostgreSQL をインストールしている場合は、`pgaudit` パッケージのインストールを行い、`postgresql.conf` の `shared_preload_libraries` に追記します。

```bash
# 例: Ubuntu/Debian 系
sudo apt-get update
sudo apt-get install postgresql-14-pgaudit  # バージョンはご利用環境に応じて調整
```

```conf
# postgresql.conf
shared_preload_libraries = 'pgaudit'
```

### 2-2. pgaudit の監査ログ設定

`postgresql.conf` 内にて、pgaudit に関するパラメーターを設定します。主なパラメーターは以下のとおりです。

```conf
# pgaudit.log 設定例
pgaudit.log = 'all'
# 実際には 'read', 'write', 'ddl', 'role', 'all' など必要に応じて設定

# pgaudit.log_catalog
# true にすると system catalog に対するクエリもログに残せますが、不要に多量のログが出る場合があるので注意
pgaudit.log_catalog = off

# pgaudit.log_client
# true にすると psql のクライアント側に直接監査ログが表示されます
pgaudit.log_client = off
```

また、PostgreSQL の標準ログを有効にしておく必要があります。以下の設定が典型例です。

```conf
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%a.log'
log_rotation_age = '1d'
log_rotation_size = 0
log_line_prefix = '%m [%p] %u@%d '
# pgaudit で詳細を出す場合は log_statement や log_duration 等も適宜オンにする
```

> **注意**: Azure Database for PostgreSQL - Flexible Server やマネージド インスタンスでは、`postgresql.conf` を直接編集するのではなく、Azure portal 上のパラメータ設定(「サーバーパラメータ」など)から変更する必要があります。

---

## 3. Azure Monitor / Log Analytics でのログ収集設定

### 3-1. Azure Database for PostgreSQL (マネージド サービス) の場合

Azure Database for PostgreSQL - Flexible Server や Single Server (将来的には非推奨) などでは、Azure Portal から **診断設定 (Diagnostic Settings)** を使ってログを Azure Monitor / Log Analytics に送ることができます。ただし pgaudit のログが PostgreSQL の「標準ログ」として出力される形式であれば収集可能ですが、サービス側でサポートされていない監査拡張のログは転送が難しいケースがあります。

1. Azure portal で「Azure Database for PostgreSQL」の対象サーバーを選択
2. 左メニューから「診断設定 (Diagnostic settings)」をクリック
3. 「診断設定を追加」から、収集したいログ (PostgreSQL Logs / Connections / Checkpoints など) を選択
4. 送信先に「Log Analytics ワークスペース」を選択し、紐づけたいワークスペースを選択

> **補足**: Flexible Server や Hyperscale でサポートされている pgaudit バージョンの場合は、PostgreSQL の標準ログと同じ形式で出力されるため、通常のログ収集設定で pgaudit ログも含まれることが多いです。もし収集できない場合は、マイクロソフト サポートまたは公式ドキュメントで pgaudit のサポート可否を確認する必要があります。

### 3-2. Azure VM (IaaS) 上で PostgreSQL を動かす場合

Azure VM 上の PostgreSQL で pgaudit を導入している場合、以下のように **Azure Monitor Agent (AMA)** や **Log Analytics Agent (旧 Microsoft OMS Agent)** を用いて、`pg_log` ディレクトリのファイルを「カスタム ログ」として収集するのが一般的です。

1. **Azure Monitor Agent** (または **Log Analytics Agent**) をインストール  
   - Azure VM 作成時に「拡張機能」でインストールするか、後から手動でインストールします。

2. **Log Analytics ワークスペース** を作成しておき、エージェントをそのワークスペースに紐づける。  

3. Azure Portal で対象 VM の「診断設定」または「Extensions (拡張機能)」から、収集したいログ ファイルを指定  
   - AMA の場合は「Data Collection Rule (DCR)」で、テキストベースのログファイル収集を設定します。  
   - Log Analytics Agent (MMA/OMS) の場合は「カスタム ログ」機能を用い、`var/log/postgresql/pg_log` などのディレクトリにあるファイルを指定します。

4. ログ形式や時刻フォーマットのパターンなどを指定し、正しくパースできるように設定します。  

5. 数分待ってから、Log Analytics ワークスペースの「ログ」(KQL エディタ) で `CustomLog_CL` などのテーブル名からログが取得できることを確認します。pgaudit のログも PostgreSQL の標準ログに含まれていれば、そのまま取得可能です。

---

## 4. Log Analytics でのログ分析

1. Azure Portal の Log Analytics ワークスペースに移動し、「ログ」を開きます。  
2. 「テーブル」ビューにて、収集したカスタム ログや `PostgreSQLLogs` テーブルなどを確認し、データが入っているか調べます。  
3. KQL (Kusto Query Language) を用いて必要な監査イベントを抽出・分析します。  
   ```kusto
   -- 例: カスタムログ "PostgreSQLAudit_CL" に pgaudit のログを格納している場合
   PostgreSQLAudit_CL
   | where Message contains "AUDIT"
   | order by TimeGenerated desc
   ```
   - フィールド名やテーブル名は実際の設定によって異なります。
   - Azure Database for PostgreSQL の診断ログの場合、テーブル名が `AzureDiagnostics` などになることもあります。

4. ログクエリ結果をもとにアラートを設定したり、Power BI や Workbook などで可視化することで、セキュリティ監査やコンプライアンス要件を満たすために役立ちます。

---

## 5. まとめ

- **pgaudit** は PostgreSQL の拡張機能として、きめ細かい監査ログを取得するために有用ですが、Azure Database for PostgreSQL (マネージド サービス) でサポートされているかどうか、サーバーの種類やバージョンによって異なるため注意が必要です。  
- **Azure Database for PostgreSQL - Flexible Server** や **Hyperscale (Citus)** などでは、pgaudit を拡張機能として有効化できるケースもあります。  
- **Azure VM** (IaaS) 上であれば、自由度が高く pgaudit を使いやすい反面、自分で Azure Monitor Agent や診断設定を行い、ログディレクトリからカスタム ログとして収集・解析する必要があります。  
- いずれの場合でも、pgaudit のログを **PostgreSQL の標準ログ** として出力することで、Azure Monitor (Log Analytics) がサポートするログ収集設定の範囲内に含めることがポイントです。

これらのステップを踏むことで、pgaudit による監査ログを Azure Monitor / Log Analytics へ取り込み、セキュリティ監査やコンプライアンス向上のための統合的なログ管理を行うことができます。

### user — 2025-01-10T03:43:40.128539+00:00

Azure database for postgresqlのログにAzureDiagnostics,AzureMetricsのみがある

### tool — 2025-01-10T03:44:12.942574+00:00

**Clarifying log availability**

I discussed the user's confusion regarding Azure database for PostgreSQL logs, noting that AzureDiagnostics and AzureMetrics are visible, but pgaudit logs are not.

**Verifying server parameters**

I’m ensuring pgaudit is logging correctly to standard logs and noting that some Azure environments might not support it fully, requiring standard logs or parsing AzureDiagnostics for log details.

**Confirming pgaudit installation**

It's essential to verify if the pgaudit extension is installed with `CREATE EXTENSION pgaudit;` and ensure the server parameters are correctly set for logging.

### assistant — 2025-01-10T03:44:12.942740+00:00

Azure Database for PostgreSQL の診断ログを Log Analytics ワークスペース (または Event Hub / Storage アカウント) に送信する場合、通常は Azure ポータルの「診断設定 (Diagnostic settings)」から「PostgreSQL Logs」などのログ カテゴリを選択すると、Log Analytics 上では下記のようなテーブルに格納されることが多いです。

- **AzureDiagnostics**  
  (Single Server / Flexible Server 共通で、PostgreSQL のエラーログやクエリログなどが格納される)
- **AzureMetrics**  
  (メトリック情報)

ただし、下記のような理由で pgaudit のログが取得できない / 見えないケースが考えられます。

1. **pgaudit がサポートされていない** (Single Server など)  
2. **pgaudit ログが「標準ログ (PostgreSQL Logs)」として連携されず、pgaudit の出力が反映されない**  
3. **Diagnostic settings で「PostgreSQL Logs」を有効にしていない**  
4. **表示されるテーブルは AzureDiagnostics しかなくても、その中のフィールド (例: `Message`, `msg_s` など) に pgaudit ログが混在している場合がある**  

以下のポイントを確認してみてください。

---

## 1. pgaudit がサポートされているかどうかを確認

### 1-1. サーバー種別とバージョンの確認

- **Single Server** や **Basic / General Purpose / Memory Optimized** などの SKU で動作している場合、pgaudit がサポートされていないことがあります。  
- **Flexible Server** や **Hyperscale (Citus)** では、一部のバージョンで pgaudit が有効化できる場合があります。

#### pgaudit サポート可否の確認
Azure Portal の「サーバーパラメータ」や「拡張機能」タブで、`pgaudit` 拡張が一覧にあるかどうかをチェックしてみてください。  
- もし拡張機能として表示されていない場合は、該当の SKU でサポートがない可能性があります。  
- 拡張機能が確認できた場合は、`CREATE EXTENSION pgaudit;` によってインストールが可能かどうか試してみてください。

---

## 2. pgaudit のログ出力を「標準ログ」に含める設定

もし pgaudit を利用できる環境 (Flexible Server 等) であっても、pgaudit が出力するログが **PostgreSQL の標準ログ** として扱われないと、Azure Monitor には転送されません。

### 2-1. shared_preload_libraries

`postgresql.conf` (Azure Flexible Server では「サーバーパラメータ」) の `shared_preload_libraries` に `pgaudit` が設定されていることを確認します。

```
shared_preload_libraries = 'pgaudit'
```

### 2-2. pgaudit.logパラメータ

`postgresql.conf` または「サーバーパラメータ」で、pgaudit のログ対象を設定します。代表的には下記のようにします。

```
pgaudit.log = 'all'
```
- `'read', 'write', 'ddl', 'role'` など用途に応じて設定します。

pgaudit のログは PostgreSQL の標準ログに出力されるため、標準ログが正しく収集されていれば、pgaudit のログも Azure Monitor に入るはずです。

---

## 3. Azure Diagnostics 設定 (Diagnostic settings) の確認

Azure Portal で、対象の Azure Database for PostgreSQL の画面に移動し、左メニュー「Monitoring」→「Diagnostic settings」を開きます。  
そこで **「PostgreSQL Logs」** にチェックが入っているかを確認してください。  

もし `AzureDiagnostics` テーブルが既にできていて、**「PostgreSQL Logs」** も有効になっているなら、pgaudit ログは下記のように **`AzureDiagnostics` テーブルの中に他のログ (PostgreSQL のエラーログやクエリログ) と混ざって格納** されることがあります。

> **参考:**  
> AzureDiagnostics テーブルには、カラム名 (例: `ResourceId`, `Category`, `msg_s`, `Level`, `log_line`, `log_data` など) を持つ形で、さまざまなログがまとまって格納されることがよくあります。pgaudit のログだけを抽出したい場合は、KQL の `where` 句などでフィルタリングします。

---

## 4. Log Analytics 上で pgaudit ログを探す (KQL)

pgaudit が標準ログに出力されている場合、Log Analytics (Azure Monitor) の「ログ」画面で `AzureDiagnostics` テーブルに対して下記のようなクエリを投げてみてください。

```kusto
AzureDiagnostics
| where Category == "PostgreSQLLogs"
// もしカテゴリ名が PostgresLogs, PostgreSQLLogs, PostgreSQLQureryLogs など異なる場合は適宜読み替え
| where msg_s contains "AUDIT"
| order by TimeGenerated desc
```

- `msg_s` はカスタム フィールド名の一例です。実際は `Message`, `log_data` などの場合もあるので、**「スキーマ」(テーブルのカラム一覧)** を見て該当カラムを特定してください。  
- pgaudit ログには "AUDIT:" など特有の文字列が含まれるため、それでフィルタリングすると見つけやすいです。

もし上記のように検索しても何もヒットしない場合は、そもそも pgaudit のログが出力されていないか、pgaudit を利用できないサーバーか、あるいは標準ログとして認識されていない可能性があります。

---

## 5. それでも取得できない場合の考慮事項

1. **Single Server などで pgaudit 非対応**  
   - Azure Database for PostgreSQL の Single Server SKU では、pgaudit が使えないケースが多いです。公式ドキュメントやサーバーパラメータ一覧を確認してみてください。  
2. **拡張機能のインストール / 有効化ができない**  
   - マネージド サービスの制限により、`CREATE EXTENSION` が許可されていない拡張機能の場合は利用不可です。  
3. **標準ログが出力されていない**  
   - PostgreSQL のログ出力 (`log_destination`, `logging_collector` など) が無効の状態だと、pgaudit のログも含め、Azure Monitor 側には送られません。  
4. **pgaudit のログ設定不足**  
   - `pgaudit.log` パラメータが適切に設定されていないと、必要なアクションが監査されない場合があります。  
5. **Log Analytics 側のデータ保持期間 / クエリ範囲**  
   - すでに時間が経過しすぎてログが削除されている場合や、クエリ時に検索範囲が短いとヒットしない可能性があります。

---

## まとめ

- Azure Database for PostgreSQL で pgaudit を利用した監査ログを取得したい場合、まずは **pgaudit のサポート可否 (SKU/バージョン/拡張機能一覧)** を確認してください。  
- pgaudit を利用できる環境では、**pgaudit のログを PostgreSQL の標準ログとして出力** し、Azure ポータルの「診断設定 (Diagnostic settings)」で **「PostgreSQL Logs」** を有効にすると、**AzureDiagnostics テーブル** にログが送信されることが多いです。  
- KQL クエリで `AzureDiagnostics` (Category == "PostgreSQLLogs" など) を参照し、pgaudit 独自の文字列 (例: "AUDIT") でフィルタリングすると、該当ログを見つけやすくなります。  
- もしどうしても pgaudit が利用できない環境 (Single Server 等) であれば、Azure Database for PostgreSQL が提供している**組み込みのログ機能 / 監査機能**や、アプリケーションレベルでの監査を検討する必要があります。

ご質問の「AzureDiagnostics と AzureMetrics のみがある」という状況は、**診断ログのカテゴリ選択や pgaudit ログの標準ログへの出力設定が反映されていない**、あるいは **pgaudit 非対応環境** である可能性が高いです。まずは上記のポイントをひとつずつチェックしてみてください。
