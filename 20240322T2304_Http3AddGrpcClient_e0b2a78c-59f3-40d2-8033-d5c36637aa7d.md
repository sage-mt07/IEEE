---
conversation_id: "e0b2a78c-59f3-40d2-8033-d5c36637aa7d"
title: "Http3を使用するAddGrpcClient"
create_time: 1711148693.675154
update_time: 1711150430.712344
language_guess: "en"
num_messages: 12
part_index: 1
part_count: 1
---

### system — 2024-03-22T23:04:53.675154+00:00

_(empty)_

### user — 2024-03-22T23:04:53.675729+00:00

.net6でaddgrpclientを利用するコードでhttp3を利用するよう修正するポイントを示せ

### assistant — 2024-03-22T23:05:04.161094+00:00

.NET 6 で `AddGrpcClient` を使用して HTTP/3 を利用するには、いくつかの手順を踏む必要があります。HTTP/3 を使用するには、 gRPC と ASP.NET Core Web アプリケーションにおいて HTTP/3 をサポートする必要があります。下記の手順に従って、`.NET 6` で `AddGrpcClient` を利用するコードを修正して HTTP/3 を利用するポイントを示します。

1. **HTTP/3 サポートの有効化**:
   HTTP/3 を利用するために、最初に gRPC サーバーとクライアントの両方で HTTP/3 のサポートを有効にする必要があります。Kestrel サーバーを使用している場合、以下のように `KestrelServerOptions` を構成します。

   ```csharp
   var builder = WebApplication.CreateBuilder(args);

   // HTTP/3 サポートを有効化する
   builder.WebHost.UseKestrel(options =>
   {
       options.Listen(IPAddress.Any, 5000, listenOptions =>
       {
           listenOptions.Protocols = Microsoft.AspNetCore.Server.Kestrel.Core.HttpProtocols.Http3;
       });
   });
   ```

   このように設定することで、Kestrel サーバーは HTTP/3 プロトコルをサポートするようになります。

2. **gRPC クライアントの HTTP/3 有効化**:
   gRPC クライアントにおいても、HTTP/3 を有効にする必要があります。これには、`GrpcChannelOptions` を使用して、HTTP/3 を使用するように設定する必要があります。

   ```csharp
   var channel = GrpcChannel.ForAddress("https://example.com", new GrpcChannelOptions
   {
       HttpHandler = new WinHttpHandler
       {
           SslOptions = new SslClientAuthenticationOptions
           {
               TargetHost = Dns.GetHostEntry("example.com").HostName,
               RemoteCertificateValidationCallback = delegate { return true; }
           }
       },
       // HTTP/3 を有効化する
       HttpClient = new HttpClient(new QuicHttpMessageHandler())
   });
   ```

   ここでは、`QuicHttpMessageHandler` を使用して、HTTP/3 を有効にしています。

3. **.NET 6 の `AddGrpcClient` を使用する**:
   `AddGrpcClient` を使用して gRPC クライアントを登録する場合、そのまま利用できます。HTTP/3 を利用する場合も、上記で示したように `GrpcChannelOptions` を使用して、HTTP/3 を有効にする必要があります。

   ```csharp
   builder.Services.AddGrpcClient<Greeter.GreeterClient>(options =>
   {
       // HTTP/3 を有効化する
       options.HttpClient = new HttpClient(new QuicHttpMessageHandler());
   });
   ```

   これにより、`.NET 6` で `AddGrpcClient` を利用する際に、HTTP/3 を有効にすることができます。

注意: このコード例では、`.NET 6` における簡単な gRPC クライアントの作成と、HTTP/3 の有効化方法を示しています。ただし、実際のプロジェクトに組み込む際には、セキュリティやパフォーマンスに関する考慮が必要です。

### user — 2024-03-22T23:31:02.833925+00:00

http3はsslが必須なのか

### assistant — 2024-03-22T23:31:07.118681+00:00

HTTP/3 は、Transport Layer Security (TLS) を使用してセキュアな通信を行うことが一般的ですが、必須ではありません。HTTP/3 は基本的に QUIC (Quick UDP Internet Connections) プロトコルの上に構築されています。QUIC 自体は、セキュリティ機能を含んでおり、TLS 1.3 を使用して暗号化された通信を提供します。TLS 1.3 は、クライアントとサーバー間の通信を暗号化し、データのプライバシーと安全性を確保します。

したがって、HTTP/3 を実装する場合、通常は TLS による暗号化が利用されます。これにより、データの盗聴や改ざんから保護され、安全な通信が確立されます。

ただし、HTTP/3 の仕様自体は TLS に依存しているわけではありません。そのため、理論的には非暗号化の通信も可能です。しかし、実際の運用環境ではセキュリティの観点から TLS を使用することが推奨されます。

### user — 2024-03-22T23:31:43.254316+00:00

SslOptions = new SslClientAuthenticationOptions
        {
            TargetHost = Dns.GetHostEntry("example.com").HostName,
            RemoteCertificateValidationCallback = delegate { return true; }
        }
は必須なのか

### assistant — 2024-03-22T23:31:47.233887+00:00

`SslOptions` を使用してクライアント認証オプションを設定することは、通常、クライアントがサーバーの証明書を検証するための機能です。しかし、これはHTTP/3を利用するために必須なものではありません。実際、HTTP/3自体はTLS上で構築されていますが、このコードでは直接HTTP/3を扱っているわけではなく、gRPC経由での通信を行っているようです。

したがって、この設定は必須ではなく、クライアントがサーバーの証明書を検証しない場合や、サーバーが自己署名証明書を使用している場合などに便利です。ただし、実際の運用環境ではセキュリティの観点から、サーバーの証明書を適切に検証することが推奨されます。

### user — 2024-03-22T23:32:31.654173+00:00

.net6でhttp3を利用するためのプロジェクトの設定を示せ。dockerを利用する前提とする

### assistant — 2024-03-22T23:32:40.819055+00:00

.NET 6 で HTTP/3 を利用するためのプロジェクトの設定を示します。この設定は、ASP.NET Core Web アプリケーションを構築する場合に適しています。また、Docker を使用しているという前提で、Dockerfile も含みます。

まず、`Dockerfile` から始めます。

```Dockerfile
# .NET 6 のランタイムをベースにする
FROM mcr.microsoft.com/dotnet/runtime:6.0 AS base
WORKDIR /app

# ビルドステージを設定する
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build
WORKDIR /src
COPY ["YourProjectName/YourProjectName.csproj", "YourProjectName/"]
RUN dotnet restore "YourProjectName/YourProjectName.csproj"
COPY . .
WORKDIR "/src/YourProjectName"
RUN dotnet build "YourProjectName.csproj" -c Release -o /app/build

# ビルドされたアプリケーションをパッケージ化する
FROM build AS publish
RUN dotnet publish "YourProjectName.csproj" -c Release -o /app/publish

# 実行用の環境をセットアップする
FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "YourProjectName.dll"]
```

次に、プロジェクトファイル(`YourProjectName.csproj`)にHTTP/3 の依存関係を追加します。

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net6.0</TargetFramework>
    <AspNetCoreHostingModel>OutOfProcess</AspNetCoreHostingModel>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="6.0.0" />
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="6.0.0" />
    <!-- 他の必要なパッケージ -->
  </ItemGroup>

</Project>
```

また、HTTP/3 を有効にするために、`Program.cs` で Kestrel サーバーを設定する必要があります。

```csharp
var builder = WebApplication.CreateBuilder(args);

// HTTP/3 サポートを有効化する
builder.WebHost.UseKestrel(options =>
{
    options.Listen(IPAddress.Any, 5000, listenOptions =>
    {
        listenOptions.Protocols = Microsoft.AspNetCore.Server.Kestrel.Core.HttpProtocols.Http3;
    });
});

var app = builder.Build();

// エンドポイント、ミドルウェアの設定など

app.Run();
```

これで、HTTP/3 を使用する ASP.NET Core Web アプリケーションの設定ができました。Docker を使用してデプロイする場合は、上記の`Dockerfile`を使用してイメージをビルドし、コンテナを起動します。

### user — 2024-03-22T23:33:48.152374+00:00

EnablePreviewFeaturesの設定は不要か

### assistant — 2024-03-22T23:33:50.709451+00:00

`.NET 6` では、HTTP/3 を利用するためには `EnablePreviewFeatures` の設定は不要です。`HTTP/3` は標準の機能として提供されており、`Preview Features` としてマークされているわけではありません。

`EnablePreviewFeatures` は、`.NET` のプレビュー機能を有効にするために使用されますが、`HTTP/3` は `.NET 6` の標準機能であり、プレビュー機能ではありません。

したがって、`EnablePreviewFeatures` の設定は不要です。HTTP/3 を利用するには、適切な `Kestrel` の設定と gRPC クライアントの設定を行うだけで十分です。
