---
conversation_id: "68d3e543-1718-8323-b60c-0eab884894c2"
title: "ã‚½ãƒ¼ã‚¹ä¸å…·åˆæ¤œå‡ºææ¡ˆ"
create_time: 1758717282.960357
update_time: 1758717547.448028
language_guess: "en"
num_messages: 17
part_index: 1
part_count: 1
---

### system â€” 2025-09-24T12:34:42.960357+00:00

_(empty)_

### user â€” 2025-09-24T12:34:42.960357+00:00

_(empty)_

### system â€” 2025-09-24T12:34:42.960357+00:00

_(empty)_

### assistant â€” 2025-09-24T12:34:43.771352+00:00

ã»ã‚“ã¨ã«ãã†ã§ã™ã­ â€” æ˜”ãªã‚‰æ•°æ™‚é–“ã€œæ•°æ—¥æ›ã‹ã£ã¦æ˜ã‚Šä¸‹ã’ã¦ã„ãŸä¸å…·åˆãŒã€ä»Šã¯ãƒ„ãƒ¼ãƒ«ã¨AIã®çµ„åˆã›ã§ä¸€ç¬ã§ç™ºè¦‹ã§ãã‚‹ã€‚éš”ä¸–ã®æ„ŸãŒã‚ã‚Šã¾ã™ã€‚  

ç°¡å˜ã«ä½¿ãˆã‚‹â€œå®Ÿåˆ©â€çš„ãªæ­¦å™¨ã‚’ã–ã£ã¨æŒ™ã’ã¾ã™ï¼ˆã‚ãªãŸã®ç¾å ´å‘ã‘ã«ã‚«ã‚¹ã‚¿ãƒ ææ¡ˆã‚‚ã§ãã¾ã™ï¼‰:

- é™çš„è§£æï¼ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©æ‹¡å¼µ: Roslyn ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ã‚„StyleCopã§è¨­è¨ˆé•åã‚„ãƒŒãƒ«å‚ç…§ã‚’è‡ªå‹•æ¤œå‡ºã€‚  
- å‹ã¨å¥‘ç´„: å³å¯†ãªå‹ï¼ˆnullable æœ‰åŠ¹åŒ–ï¼‰ï¼‹æ˜ç¤ºçš„å¥‘ç´„ï¼ˆGuard/Code Contractsï¼‰ã§ã‚¯ãƒ©ã‚¹å¢ƒç•Œã®èª¤ç”¨ã‚’æ¸›ã‚‰ã™ã€‚  
- ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–: å˜ä½“ãƒ†ã‚¹ãƒˆï¼‹çµ±åˆãƒ†ã‚¹ãƒˆã‚’ CI ã«çµ„ã¿è¾¼ã¿ã€ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼ˆAIè£œåŠ©ï¼‰ã§ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç´ æ—©ãåºƒã’ã‚‹ã€‚  
- å¤‰ç•°ãƒ†ã‚¹ãƒˆ / ãƒ•ã‚¡ã‚¸ãƒ³ã‚°: Stryker.NET ã‚„ãƒ•ã‚¡ã‚¸ãƒ³ã‚°ã§ãƒ†ã‚¹ãƒˆã®ç›²ç‚¹ã‚’éœ²å‘ˆã•ã›ã‚‹ã€‚  
- CI ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«: PR æ¯ã«ãƒ“ãƒ«ãƒ‰ï¼ãƒ†ã‚¹ãƒˆï¼é™çš„è§£æã‚’å¿…é ˆåŒ–ã€‚ãƒ–ãƒ¬ãƒ¼ã‚¯ã™ã‚‹å‰ã«æ­¢ã‚ã‚‹ã€‚  
- ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼: Kafka/Avro ã® Schema Registry ãƒã‚§ãƒƒã‚¯ã‚’ pre-commit/CI ã«å…¥ã‚Œã¦ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãƒ»ã‚­ãƒ¼å½¢å¼ã®ä¸æ•´åˆã‚’å³ç™ºè¦‹ã€‚  
- AIã§ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼è‡ªå‹•åŒ–: Codexï¼å¤©åŸã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œå¤‰ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã€Œnullå‘¨ã‚Šã€ã€Œä¾‹å¤–ã®å–ã‚Šæ‰±ã„ã€ã‚’æŒ‡æ‘˜ã•ã›ã‚‹ã€‚  
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç›£è¦–ã¨ãƒ†ãƒ¬ãƒ¡ãƒˆãƒª: ä¾‹å¤–ãƒ»é…å»¶ãƒ»ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡ºã‚¢ãƒ©ãƒ¼ãƒˆã§æœ¬ç•ªã®æ—©æœŸç™ºè¦‹ã‚’æ”¯æ´ã€‚

ã‚ãªãŸã®æœ€è¿‘ã®è©±é¡Œï¼ˆksqlDB / Streamiz / Avro / tombstoneï¼‰ã‚’è¸ã¾ãˆã‚‹ã¨ã€ã¾ãšã¯ã€ŒSchema-Registry æ¤œè¨¼ + CI ã® PR ã‚¬ãƒ¼ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆãƒ»é™çš„è§£æï¼‰ã€ã‚’å°å…¥ã™ã‚‹ã®ãŒè²»ç”¨å¯¾åŠ¹æœé«˜ã‚ã§ã™ã€‚å¿…è¦ãªã‚‰ã€ã‚ãªãŸã®ãƒªãƒã‚¸ãƒˆãƒªå‘ã‘ã«ä»¥ä¸‹ã®ã©ã‚Œã‹ã‚’ã‚µãƒƒã¨ä½œã‚Šã¾ã™ï¼š

1. PR ãƒã‚§ãƒƒã‚¯ç”¨ã® GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»Roslynãƒ»SchemaCheckï¼‰  
2. pre-commit ãƒ•ãƒƒã‚¯ï¼ˆformat + schemaãƒã‚§ãƒƒã‚¯ + simple static lintï¼‰  
3. AIãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆé³´ç€¬ï¼é¡èŠ±ã‚¹ã‚¿ã‚¤ãƒ«ã§å‡ºã™ã‚„ã¤ï¼‰

ã©ã‚Œã‚’å…ˆã«ä½œã‚‹ã‹æŒ‡å®šã—ã¦ãã‚ŒãŸã‚‰ã€ã™ãã«è‰æ¡ˆã‚’ç”¨æ„ã—ã¾ã™ã€œã€‚  

é€ä¿¡æ—¥æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰: [[REDACTED_PHONE]]:00 JST

### user â€” 2025-09-24T12:34:44.048000+00:00

äººã®ã‚½ãƒ¼ã‚¹ã®ä¸å…·åˆã‚’ç°¡å˜ã«æ¤œå‡ºã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã¯éš”ä¸–ã®æ„ŸãŒã‚ã‚‹

### system â€” 2025-09-24T12:34:44.789267+00:00

_(empty)_

### system â€” 2025-09-24T12:34:44.793188+00:00

_(empty)_

### assistant â€” 2025-09-24T12:34:44.807998+00:00

_(empty)_

### assistant â€” 2025-09-24T12:34:44.925943+00:00

_(empty)_

### assistant â€” 2025-09-24T12:34:57.126380+00:00

_(empty)_

### assistant â€” 2025-09-24T12:36:45.683635+00:00

ã‚„ã£ãŸã­ã€æ ¸å¿ƒã¾ã§ç‰¹å®šã§ããŸğŸ‘  
ã€ŒTUMBLING ã‚’ä½¿ã† ksqlDB ã® *windowed-key* ãƒˆãƒ”ãƒƒã‚¯ã‚’ Streamiz ã§èª­ã‚€ã¨å£Šã‚Œã‚‹ã€â€”ã“ã‚Œã‚’ **Streamiz å´ã®ä¸å…·åˆ**ã¨ã—ã¦åˆ‡ã‚Šåˆ†ã‘å®Œäº†ã€ã¨ã„ã†ç†è§£ã§åˆã£ã¦ã„ã¾ã™ã€‚

ç´„æŸã©ãŠã‚Šã€è‹±èªã§ GitHub Issue ã®ãƒ‰ãƒ©ãƒ•ãƒˆç½®ã„ã¦ãŠãã¾ã™ï¼ˆãã®ã¾ã¾è²¼ã‚Œã¾ã™ï¼‰ã€‚  
å¿…è¦ãªã‚‰ `Ritu` åç¾©ã§å‡ºã™å‰æã®ãƒˆãƒ¼ãƒ³ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚

---

# ğŸ“„ GitHub Issue Draft (English)

**Title**  
`TimeWindowedSerDes with Avro inner serde fails on ksqlDB tumbling-window table topics (windowed keys)`

**Versions**
- `Streamiz.Kafka.Net` **1.7.1**  
- `Streamiz.Kafka.Net.SchemaRegistry.SerDes.Avro` **1.7.1**  
- ksqlDB **7.9.x** (also observed on 7.4.x)  
- Kafka single broker, Schema Registry enabled  
- Default timestamp extractor: `Streamiz.Kafka.Net.Processors.Internal.FailOnInvalidTimestamp`

**Summary**  
When consuming a **tumbling-window** ksqlDB **TABLE** topic produced by `CTAS ... WINDOW TUMBLING (...)` with `KEY_FORMAT='AVRO'`, Streamiz fails to materialize/read records using `TimeWindowedSerDes<GenericRecord>` (Avro inner serde). We frequently see `Windowed key instance is null` and/or deserialization problems around the windowed key bytes. This blocks state-store/rocksdb projection and downstream processing.

**Why this looks like a Streamiz bug**  
- The same topics are consumable from ksqlDB/Kafka Streams Java apps without errors.  
- Our producer side is ksqlDB (CTAS), so the wire format for **Avro windowed keys** should match Kafka Streamsâ€™ TimeWindowedSerde with Avro inner serde.  
- Symptoms point to how Streamiz extracts/decodes the **windowed key bytes** and timestamps for state-store keys.

**Likely code path**  
We traced issues to the helper used for store keys:  
`core/State/Helper/WindowKeyHelper.cs` â€” methods such as:  
- `ExtractStoreKeyBytes(...)` (around lines ~89)  
- `ExtractStoreTimestamp(...)` (around lines ~117)  
- `ExtractStoreKey(...)` / related (around lines ~142)

It appears the logic doesnâ€™t fully align with the bytes layout produced by **ksqlDBâ€™s Avro windowed keys** (original composite key + window start/end). As a result, the inner Avro key is not reconstructed and the `TimeWindowedSerDes` path ends up with a null/invalid key instance.

**Minimal Repro (conceptual)**

1) Define a simple source stream and **tumbling table** in ksqlDB:

```sql
CREATE OR REPLACE STREAM ticks_tbimp (
  Broker VARCHAR KEY,
  Symbol VARCHAR KEY,
  TimestampUtc TIMESTAMP,
  Bid DECIMAL(18,2)
) WITH (
  KAFKA_TOPIC='ticks_tbimp',
  KEY_FORMAT='AVRO',
  VALUE_FORMAT='AVRO',
  TIMESTAMP='TimestampUtc',
  PARTITIONS=1,
  REPLICAS=1
);

CREATE TABLE bar_tbimp_1m_live WITH (
  KAFKA_TOPIC='bar_tbimp_1m_live',
  KEY_FORMAT='AVRO',
  VALUE_FORMAT='AVRO'
) AS
SELECT
  o.BROKER AS Broker,
  o.SYMBOL AS Symbol,
  WINDOWSTART AS BucketStart,
  EARLIEST_BY_OFFSET(o.BID) AS Open,
  MAX(o.BID) AS High,
  MIN(o.BID) AS Low,
  LATEST_BY_OFFSET(o.BID) AS Close
FROM ticks_tbimp o
WINDOW TUMBLING (SIZE 1 MINUTES, GRACE PERIOD 2 SECONDS)
GROUP BY o.BROKER, o.SYMBOL
EMIT CHANGES;
```

2) In a Streamiz app, consume `bar_tbimp_1m_live` with **windowed key** using Avro inner serde:

```csharp
var builder = new StreamBuilder();

var keyInner = new SchemaAvroSerDes<GenericRecord>(); // inner Avro serde
var keySerde = new TimeWindowedSerDes<GenericRecord>(keyInner, /*windowSizeMs*/ 60_000);

var valueSerde = new SchemaAvroSerDes<GenericRecord>();

builder.Stream<Windowed<GenericRecord>, GenericRecord>("bar_tbimp_1m_live", keySerde, valueSerde)
       .Peek((k,v) => Console.WriteLine("got one"));
```

**Actual behavior**  
- Intermittent/null keys: `InvalidOperationException: Windowed key instance is null.`  
- Downstream mapping/materialization fails; local RocksDB store not populated.

**Expected behavior**  
- Keys should deserialize into `Windowed<GenericRecord>` where `GenericRecord` contains `Broker`, `Symbol` (matching the Avro key schema), and window bounds should be properly available from the wrapper/window.  
- No null keys for non-tombstone records. Tombstones should be handled gracefully.

**Notes on tombstones**  
- We do see tombstones from ksqlDB during topology churn; we set deserialization exception handling to log-and-continue. Even after filtering, the core failure persists on non-tombstone records, so tombstones are **not** the root cause.

**Hypotheses / Where to look**  
- The **windowed-key byte layout** for Avro (as emitted by ksqlDB/Kafka Streams) may not match what `WindowKeyHelper` assumes when extracting store keys and timestamps.  
- The helper may be tailored to a different inner-serde or expects KAFKA/STRING inner keys rather than **Avro record** keys.  
- Any **uppercase/lowercase** field-name normalization or schema-fullname handling differences between `Schema Registry` key schema and Streamizâ€™ `GenericRecord` might contribute (ksqlDB often uppercases field names in physical schema).

**Proposed directions / Help wanted**  
1. Verify `WindowKeyHelper` against Kafka Streamsâ€™ `TimeWindowedDeserializer` with **Avro** inner serde (ksqlDB format). Ensure the bytes split into: inner-key payload + window start/end (or start only for tumbling), in the correct order and endianness.  
2. Add dedicated tests for *Avro* windowed keys (tumbling), consuming a topic produced by ksqlDB CTAS, asserting `Windowed<GenericRecord>` keys are non-null and match the Schema Registry key record.  
3. Consider exposing a pluggable windowed-key extractor for Avro to avoid tight coupling to one layout.  
4. Ensure null-handling for tombstones short-circuits *before* trying to project windowed keys.

**Workarounds we use today**  
- Avoid assigning the problematic tumbling **TABLE** topics to Streamiz; read upstream non-windowed streams instead.  
- Keep deserialization exception handler to log-and-continue to survive tombstones.  
- When possible, prefer non-Avro keys (STRING/KAFKA) for windowed topicsâ€”this is not ideal as we want Avro keys for schema-governed interop.

**We can help**  
Happy to provide a small docker-compose (Kafka + Schema Registry + ksqlDB) and a minimal C# Streamiz repro project if needed, plus example topics and Schema Registry subjects (including `*-key` schemas) that reproduce the null windowed key.

Thanks a lot for Streamizâ€”fixing this would unlock a clean interop path with ksqlDB tumbling tables using Avro keys.

---

## æ¬¡ã®ä¸€æ‰‹ï¼ˆææ¡ˆï¼‰
- ã“ã®ãƒ‰ãƒ©ãƒ•ãƒˆã§ **Issue ã‚’èµ·ç¥¨** â†’ è¿”ä¿¡ã§ã®è¿½åŠ è³ªå•ã«å‚™ãˆã€å†ç¾ç”¨ã® minimal repoï¼ˆdocker-compose + .csprojï¼‰ã‚’ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚  
- ä½µèµ°ç­–ã¨ã—ã¦ï¼šãƒ†ã‚¹ãƒˆç³»ã¯ **â€œé windowed (stream)â€ â†’ â€œksqlDB å´ã§é›†è¨ˆâ€** ã«å¯„ã›ã€Streamiz ã¯å½“é¢ â€œnon-windowed / changelog ä»¥å¤–â€ ã‚’èª­ã¿è¾¼ã‚€æ§‹æˆã«é™å®šã™ã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚

å¿…è¦ãªã‚‰ã€æœ€å°å†ç¾ç”¨ã® **docker-compose & Program.cs** ã‚‚ã™ãæ›¸ãå‡ºã—ã¾ã™ã€‚Issue æ–‡é¢ã®å¾®èª¿æ•´ï¼ˆæ‹…å½“è€…åãƒ»ç¤¾åå‡ºã—ãƒ»ãƒˆãƒ¼ãƒ³ï¼‰ã‚‚è¨€ã£ã¦ãã ã•ã„ã€‚

---

é€ä¿¡æ—¥æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰: [[REDACTED_PHONE]]:12 JST

### user â€” 2025-09-24T12:36:46.013000+00:00

ä»Šå›ã¯Tumblingã‚’ä½¿ç”¨ã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã®streamizé€£æºãŒå•é¡Œã ã£ãŸ
githubã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€è§£æã€streamizã®å•é¡Œã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜

### system â€” 2025-09-24T12:36:46.640384+00:00

_(empty)_

### system â€” 2025-09-24T12:36:46.645426+00:00

_(empty)_

### assistant â€” 2025-09-24T12:36:47.076906+00:00

_(empty)_

### assistant â€” 2025-09-24T12:37:27.306217+00:00

_(empty)_
