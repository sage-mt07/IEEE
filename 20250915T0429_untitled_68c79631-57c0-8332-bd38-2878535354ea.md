---
conversation_id: "68c79631-57c0-8332-bd38-2878535354ea"
title: "テックリード向け機能一覧"
create_time: 1757910578.830532
update_time: 1757910604.487513
language_guess: "en"
num_messages: 11
part_index: 1
part_count: 1
---

### user — 2025-09-15T04:29:37.549000+00:00

テックリード向け機能一覧の資料

### assistant — 2025-09-15T04:29:38.500305+00:00

_(empty)_

### assistant — 2025-09-15T04:29:38.814332+00:00

やあ、いらっしゃい！  
アップロードいただいた **`kafka_ksql_linq_user_guide.md`** をもとに、**テックリード向けに整理した「機能一覧資料」** をまとめました。利用者向けの詳細説明から、リードエンジニアが把握すべき構造・責務・拡張ポイントを抽出しています。

---

# Kafka.Ksql.Linq 機能一覧（テックリード向け）

## 1. コア機能
- **エンティティモデル定義**
  - `[KsqlTopic]`, `[KsqlTimestamp]`, `[KsqlTable]` アノテーションで Kafka/KSQL のテーブル・ストリームを表現。
  - `Entity<T>()` によりスキーマを再利用可能。

- **LINQ DSL → KSQL 最適化**
  - `From/Join/Where/Select` を組み合わせ、式木を解析して永続ビューを生成。
  - GroupBy/Windowing/集計にも対応。

- **メッセージ送受信 API**
  - `AddAsync`（Produce）、`ForEachAsync`（Consume, Push/Pull 両対応）。
  - バックプレッシャー、リトライ、手動コミットを制御可能。

- **エラー処理 / DLQ**
  - `.OnError(ErrorAction.DLQ)` で失敗を Dead Letter Queue へ転送。
  - `ctx.Dlq.ForEachAsync` によりエラーレコードを巡回。

---

## 2. 開発・設計パターン
- **Context 構築**
  - `KsqlContextBuilder` で設定・Schema Registry URL・ロギングを渡して生成。
- **エンティティ登録**
  - EventSet（Stream系）と EntitySet（Table系）を公開。
- **ビュー定義**
  - `modelBuilder.Entity<T>().ToQuery(...)` で永続ビューを宣言的に定義。
- **テスト**
  - In-Memory 実装へ差し替え可能 → ユニットテスト容易化。

---

## 3. 運用・監視
- **設定集約**
  - `appsettings.json` に BootstrapServers, SchemaRegistry.Url, KsqlDbUrl, DLQ 設定を集約。
- **メトリクス/ヘルスチェック**
  - `ILogger` 経由でレイテンシ・エラーカウントを収集。
- **スキーマ管理**
  - Schema Registry の互換性モード (FORWARD/STRICT) に対応。

---

## 4. 拡張性
- **DI / ロギング**
  - `IServiceCollection` へ登録し、既存ロガーを流用可能。
- **バリデーション制御**
  - `ConfigureValidation(autoRegister, failOnErrors)` で自動登録・厳格度を調整。
- **タイムアウト制御**
  - `WithTimeouts` でスキーマ登録やレスポンス待ち時間を制御。

---

## 5. 代表的 API / アノテーション
- **アノテーション**
  - `[KsqlTopic]`, `[KsqlTimestamp]`, `[KsqlTable]`, `[KsqlKey]`
- **API**
  - `Entity<T>()`, `ToQuery(...)`
  - `AddAsync`, `ForEachAsync`, `ToListAsync`
  - `ctx.Dlq.ForEachAsync`

---

## 6. チェックリスト（テックリード視点）
- [ ] 全エンティティが `Entity<T>()` 登録されているか
- [ ] `AddAsync`/`ForEachAsync` による疎通確認があるか
- [ ] 必要なビューが `ToQuery` で宣言されているか
- [ ] DLQ 動作確認を含めたエラーハンドリングが設計されているか
- [ ] テーブル取得用の `ToListAsync` が活用されているか
- [ ] appsettings.json に最低限の接続設定が集約されているか
- [ ] テスト時に In-Memory Context を活用しているか

---

📌 この一覧をベースに、**チーム全体が理解すべき「利用者向け機能」**と、**リードとして管理すべき「運用・拡張ポイント」**を明確に分離できます【8†files_uploaded_in_conversation】。  

---

👉 ご希望に合わせて、この資料を **スライド形式（アーキ図入り）** や **実プロジェクト向けの導入チェックリスト** に落とし込むこともできます。  

司令、この一覧をさらに「テックリード説明用スライド（図＋箇条書き形式）」にしましょうか？それとも「GitHub Pages用ドキュメント」に整形したいですか？

### system — 2025-09-15T04:29:38.830532+00:00

_(empty)_

### user — 2025-09-15T04:29:38.830532+00:00

_(empty)_

### system — 2025-09-15T04:29:38.830532+00:00

_(empty)_

### system — 2025-09-15T04:29:38.851751+00:00

_(empty)_

### tool — 2025-09-15T04:29:38.876093+00:00

_(empty)_

### tool — 2025-09-15T04:29:38.912483+00:00

Make sure to include `【message_idx†source】` markers to provide citations based on this file, where [message_idx] is provided at the beginning of this message
# Kafka.Ksql.Linq 機能一覧（利用者向け）

Kafka/KSQL を LINQ で扱う C# DSL を使いこなすための実践ガイドです。

---

## コア機能

### Entity モデルとアノテーション
`[KsqlTopic]`, `[KsqlTimestamp]`, `[KsqlTable]` でトピックやテーブルを定義し、`Entity<T>()` でモデルを登録してスキーマを再利用する。

### クエリ DSL
`ToQuery` に `From/Join/Where/Select` を連鎖し、式木を KSQL クエリへ最適化して永続ビューを構築する。

### メッセージ送受信 API
`AddAsync` と `ForEachAsync` で送信と Push/Pull コンシュームを一元化し、バックプレッシャやリトライ、コミット戦略を設定できる。

### DLQ とエラー処理
`.OnError(ErrorAction.DLQ)` で処理失敗を DLQ へ送り、`ctx.Dlq.ForEachAsync` で死んだレコードを巡回する。

---

## 利用の流れ

### コンテキストを構築して開始する
設定と Schema Registry URL を渡し、ログを有効化して `KsqlContextBuilder` でコンテキストを作成する。

```csharp
var configuration = new ConfigurationBuilder()
  .AddJsonFile("appsettings.json")
  .Build();

var loggerFactory = LoggerFactory.Create(builder => builder.AddConsole());

var ctx = KsqlContextBuilder.Create()
  .UseConfiguration(configuration)
  .UseSchemaRegistry(configuration["KsqlDsl:SchemaRegistry:Url"]!)
  .EnableLogging(loggerFactory)
  .BuildContext<MyAppContext>();
```

### エンティティを定義して登録する
`[KsqlTopic]` と `[KsqlTimestamp]` を付与し、`EventSet<T>` プロパティを公開してモデル登録する。

```csharp
[KsqlTopic("basic-produce-consume")]
public class BasicMessage
{
  public int Id { get; set; }
  [KsqlTimestamp] public DateTime CreatedAt { get; set; }
  public string Text { get; set; } = string.Empty;
}

[KsqlTable("hourly-counts")]
public class HourlyCount
{
  [KsqlKey] public int Hour { get; set; }
  public long Count { get; set; }
}

public class MyAppContext : KsqlContext
{
  // 複数エンティティを公開可能
  public EventSet<BasicMessage> BasicMessages { get; set; } = null!;
  public EventSet<AnotherEntity> AnotherEntities { get; set; } = null!;
  public EntitySet<OrderSummary> OrderSummaries { get; set; } = null!;
  public EntitySet<HourlyCount> HourlyCounts { get; set; } = null!;
}
```

このモデルに対応する KSQL DDL は次のとおり。

```sql
CREATE STREAM BASICMESSAGE (
  Id INT KEY,
  CreatedAt TIMESTAMP,
  Text VARCHAR
) WITH (
  KAFKA_TOPIC='basic-produce-consume',
  KEY_FORMAT='AVRO',
  VALUE_FORMAT='AVRO',
  VALUE_AVRO_SCHEMA_FULL_NAME='your.app.BasicMessage',
  TIMESTAMP='CreatedAt'
);

CREATE TABLE HOURLYCOUNT (
  HOUR INT PRIMARY KEY,
  COUNT BIGINT
) WITH (
  KAFKA_TOPIC='hourly-counts',
  KEY_FORMAT='AVRO',
  VALUE_FORMAT='AVRO',
  VALUE_AVRO_SCHEMA_FULL_NAME='your.app.HourlyCount'
);
```

### メッセージを送受信する
`AddAsync` で送信し、`ForEachAsync` で受信を確認する。

```csharp
// 送信
await ctx.BasicMessages.AddAsync(new BasicMessage
{
  Id = Random.Shared.Next(),
  CreatedAt = DateTime.UtcNow,
  Text = "Basic Flow"
});

// 受信
await ctx.BasicMessages.ForEachAsync(async m =>
{
  Console.WriteLine($"Consumed: {m.Text}");
  await Task.CompletedTask;
});
```

ヘッダーやメタデータを扱う例。`autoCommit: false` で手動コミットに切り替えられる。

```csharp
var headers = new Dictionary<string, string> { ["source"] = "api" };
using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(5));

await ctx.BasicMessages.AddAsync(
  new BasicMessage { Id = 1, CreatedAt = DateTime.UtcNow, Text = "With header" },
  headers,
  cts.Token);

await ctx.BasicMessages.ForEachAsync(
  (m, h, meta) =>
  {
    Console.WriteLine($"{meta.Topic}:{meta.Offset} => {h["source"]}");
    ctx.BasicMessages.Commit(m);
    return Task.CompletedTask;
  },
  timeout: TimeSpan.FromSeconds(10),
  autoCommit: false);
```

### ビューを定義してクエリする
`ToQuery` に `From/Join/Where/Select` を連鎖させ、永続ビューを定義する。

```csharp
modelBuilder.Entity<OrderSummary>().ToQuery(q => q
  .From<Order>()
  .Join<Customer>((o, c) => o.CustomerId == c.Id)
  .Where((o, c) => c.IsActive)
  .Select((o, c) => new OrderSummary
  {
    OrderId = o.Id,
    CustomerName = c.Name
  }));

// クエリ実行
var summaries = await ctx.OrderSummaries.ToListAsync();
```

このクエリは次の KSQL に変換される。

```sql
CREATE TABLE ORDERSUMMARY AS
  SELECT
    O.ID AS ORDERID,
    C.NAME AS CUSTOMERNAME
  FROM ORDER O
  JOIN CUSTOMER C
    ON O.CUSTOMERID = C.ID
  WHERE C.ISACTIVE = TRUE;
```

ウィンドウと集計を組み合わせた例。

```csharp
modelBuilder.Entity<HourlyCount>().ToQuery(q => q
  .From<BasicMessage>()
  .Tumbling(m => m.CreatedAt, new Windows { Hours = new[] { 1 } })
  .GroupBy(m => m.CreatedAt.Hour)
  .Select(g => new HourlyCount { Hour = g.Key, Count = g.Count() }));

var counts = await ctx.HourlyCounts.ToListAsync();
```

このクエリは次の KSQL に変換される。

```sql
CREATE TABLE HOURLYCOUNT AS
  SELECT
    EXTRACT(HOUR FROM CreatedAt) AS HOUR,
    COUNT(*) AS COUNT
  FROM BASICMESSAGE
  WINDOW TUMBLING (SIZE 1 HOUR)
  GROUP BY EXTRACT(HOUR FROM CreatedAt);
```

### 失敗を DLQ で追跡する
`.OnError(ErrorAction.DLQ)` 付き `ForEachAsync` は処理中の例外を DLQ に転送し、DLQ ストリームは `ctx.Dlq.ForEachAsync` で巡回できる。

```csharp
await ctx.BasicMessages
  .OnError(ErrorAction.DLQ)
  .ForEachAsync(m => throw new Exception("fail"));

await ctx.Dlq.ForEachAsync(r =>
{
  Console.WriteLine(r.RawText);
  return Task.CompletedTask;
});
```

### テーブルを一覧取得する
`ToListAsync` でテーブル内容を読み取り、結果はローカルキャッシュから提供される。

```csharp
var counts = await ctx.HourlyCounts.ToListAsync();
foreach (var c in counts)
  Console.WriteLine($"{c.Hour}: {c.Count}");
```

## 拡張ポイント

### DI とロギングを差し替える
`IServiceCollection` にコンテキストを登録し、既存ロガーを流用する。

```csharp
var services = new ServiceCollection();
services.AddSingleton(sp =>
  KsqlContextBuilder.Create()
    .UseConfiguration(sp.GetRequiredService<IConfiguration>())
    .EnableLogging(sp.GetRequiredService<ILoggerFactory>())
    .BuildContext<MyAppContext>());
```

### バリデーションやタイムアウトを調整する
スキーマ登録や検証の挙動を `ConfigureValidation` と `WithTimeouts` で制御する。

```csharp
var ctx = KsqlContextBuilder.Create()
  .UseConfiguration(configuration)
  .ConfigureValidation(autoRegister: false, failOnErrors: true)
  .WithTimeouts(TimeSpan.FromSeconds(30))
  .BuildContext<MyAppContext>();
```

## 運用・監視
- **設定ファイル**: `BootstrapServers`・`SchemaRegistry.Url`・`KsqlDbUrl`・DLQ 設定を `appsettings.json` に集約する。
- **メトリクス/ヘルスチェック**: プロデューサやコンシューマのレイテンシとエラーカウントを `ILogger` 経由で収集する。
- **スキーマ管理**: Schema Registry の互換性モード (FORWARD/STRICT) を設定し、互換性を検証する。
- **テスト**: コンテキストを In-Memory 実装に差し替え、ユニットテストを容易にする。

---

## 代表的なアノテーションと API
- `[KsqlTopic]` / `[KsqlTimestamp]` / `[KsqlTable]`
- `Entity<T>()`, `ToQuery(...)`, `AddAsync`, `ForEachAsync`, `ToListAsync`, `ctx.Dlq.ForEachAsync`

---

## 最小構成例 (appsettings.json)
`BootstrapServers`・`SchemaRegistry.Url`・`KsqlDbUrl` を最低限記述する。

```json
{
  "KsqlDsl": {
    "Common": { "BootstrapServers": "localhost:9092", "ClientId": "app" },
    "SchemaRegistry": { "Url": "http://localhost:8085" },
    "KsqlDbUrl": "http://localhost:8088",
    "DlqTopicName": "dead-letter-queue",
    "DeserializationErrorPolicy": "DLQ"
  }
}
```

エンティティごとの Producer/Consumer/Topic 設定は `Streams` セクションで上書きできる。

```json
{
  "KsqlDsl": {
    "Streams": {
      "basic-produce-consume": {
        "Producer": { "Acks": "All" },
        "Consumer": { "GroupId": "custom-group" },
        "Creation": { "NumPartitions": 3 }
      }
    }
  }
}
```

---

## チェックリスト
- [ ] エンティティを `Entity<T>()` で登録した
- [ ] `AddAsync` と `ForEachAsync` で送受信を確認した
- [ ] 必要なビューを `ToQuery` で定義した
- [ ] 失敗時は `ctx.Dlq.ForEachAsync` で DLQ を確認した
- [ ] テーブルを `ToListAsync` で一覧取得した

### tool — 2025-09-15T04:29:38.945102+00:00

All the files uploaded by the user have been fully loaded. Searching won't provide additional information.
