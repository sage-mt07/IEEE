---
conversation_id: "67806fa3-20dc-8007-beef-e825fcca3c8c"
title: "PostgreSQLクエリログ確認方法"
create_time: 1736470435.377422
update_time: 1737103928.759366
language_guess: "en"
num_messages: 13
part_index: 1
part_count: 1
---

### system — 2025-01-10T00:53:55.377422+00:00

_(empty)_

### user — 2025-01-10T00:53:55.400436+00:00

Azure Database for Postgresql flexibleserverを利用している
アプリケーションから更新処理が正しく行われない事象があるため、調査をおこないたい。
データベース側のクエリログの取得のための設定と、ログの確認方法を示せ

### assistant — 2025-01-10T00:54:12.426232+00:00

_(empty)_

### assistant — 2025-01-10T00:54:12.426364+00:00

Azure Database for PostgreSQL Flexible Serverでクエリログを取得するには、以下の手順で設定と確認を行います。

---

### **1. クエリログの有効化**
Azure Database for PostgreSQL Flexible Serverでクエリログを有効にするには、サーバーパラメータを変更します。

#### **手順:**
1. **Azureポータルにログイン**
   - Azureポータルにアクセスし、対象のPostgreSQL Flexible Serverを選択します。

2. **構成の変更**
   - サイドバーで「**設定**」→「**パラメータ**」を選択します。
   - 以下のパラメータを変更します:
     - **log_statement**: `all` に設定（すべてのクエリをログに記録）
     - **log_min_duration_statement**: `0` に設定（すべてのクエリの実行時間を記録）

3. **設定の保存**
   - パラメータの変更を保存します。

4. **ログリテンションの設定**
   - 必要に応じて「**サーバーログの保持期間**」を確認し、適切に設定します。

---

### **2. クエリログの確認**
PostgreSQL Flexible Serverでは、クエリログはAzure Monitorに送信されます。Azure Monitorでログを確認する手順は以下の通りです。

#### **手順:**
1. **ログの有効化**
   - 「**診断設定**」を開きます。
   - 「**診断設定を追加**」をクリックし、以下を有効化します:
     - **PostgreSQLLogs**
   - ログの出力先を選択します（Log Analytics ワークスペース、Azure Storage、または Event Hub）。

2. **ログの確認方法**
   - **Log Analytics ワークスペース**を利用する場合:
     - 「Log Analytics ワークスペース」に移動し、ログをクエリします。
     - 以下のKQLクエリを使用してクエリログを確認します:
       ```kql
       AzureDiagnostics
       | where ResourceType == "POSTGRESQLFLEXIBLESERVER"
       | where log_statement_s contains "INSERT" or log_statement_s contains "UPDATE" or log_statement_s contains "DELETE"
       | project TimeGenerated, log_statement_s, Message
       ```
   - **Azure Storage**を利用する場合:
     - ストレージアカウントに保存されたログファイルをダウンロードし、任意のログビューアで確認します。
   - **Event Hub**を利用する場合:
     - Event Hubに送信されたログをリスナーで受け取ります。

---

### **3. クエリログの分析**
- **実行されたクエリの確認**
  ログで更新系クエリ（`UPDATE`や`DELETE`）を探します。
- **エラーメッセージの確認**
  ログ中にエラーメッセージが記録されている場合、それを解析します。

---

### **補足**
必要に応じて以下も確認してください:
- アプリケーションのエラーログ（データベースとの接続エラーやタイムアウトの有無）。
- ネットワークの問題（接続の不安定さやファイアウォールの影響）。
- PostgreSQLのテーブルやスキーマに関する権限設定（アプリケーションの実行ユーザーが正しい権限を持っているか）。

これらを組み合わせて調査を進めてください。

### user — 2025-01-10T00:56:39.769041+00:00

特定のDBを処理条件に入れる

### assistant — 2025-01-10T00:56:58.630259+00:00

特定のデータベースを対象にクエリログを取得するには、PostgreSQL Flexible Serverで特定のデータベース名を条件にフィルタリングする方法を活用します。

Azure Monitorやログ収集設定自体でデータベース名を指定する機能はありませんが、ログクエリやアプリケーションからのアクセス方法に応じて絞り込みが可能です。

以下に、特定のデータベースを条件に含めた設定と確認方法を示します。

---

### **1. データベース名を含めたログ設定の確認**
PostgreSQLの標準ログにはデータベース名が含まれます。これをAzure Monitorで確認できるよう、**log_connections**および**log_disconnections**も有効化することをお勧めします。

#### **パラメータ設定:**
以下のパラメータを設定します。
1. **log_statement**: `all` （すべてのクエリをログに記録）
2. **log_min_duration_statement**: `0` （すべてのクエリの実行時間を記録）
3. **log_connections**: `on` （接続時のログを記録）
4. **log_disconnections**: `on` （切断時のログを記録）

これにより、ログにデータベース名を含む接続情報が記録され、後続のフィルタリングが容易になります。

---

### **2. クエリログの確認（特定のデータベースに絞り込む）**
Azure MonitorのLog Analyticsで、特定のデータベースを条件にフィルタリングするクエリを使用します。

#### **KQLクエリ例:**
```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"  // データベース名を指定
| project TimeGenerated, database_name_s, log_statement_s, Message
```

#### **クエリの解説:**
- `database_name_s`: ログに記録されたデータベース名の列。
- `your_database_name`: 条件にしたいデータベース名に置き換えてください。
- `log_statement_s`: 実行されたクエリの内容。

---

### **3. クエリログをアプリケーション側で特定のデータベースに限定する**
アプリケーションの接続文字列で、特定のデータベースに接続するよう設定することで、ログ出力もそのデータベースに限定されます。

#### **例:**
接続文字列の例:
```
Host=myserver.postgres.database.azure.com;
Database=your_database_name;
Username=myuser;
Password=mypassword;
```

この場合、アプリケーションは`your_database_name`にのみ接続するため、クエリログもそのデータベースに関連するものに限定されます。

---

### **4. Azure StorageやEvent Hubでのログ確認**
Azure Monitorでは、すべてのクエリログが収集されますが、**Azure Storage**や**Event Hub**にログを転送して後処理を行う方法も利用できます。

#### **ストレージログの例:**
- ダウンロードしたログファイルをフィルタリングツール（grep、PowerShell、Pythonなど）で処理します。
- データベース名を含む行のみを抽出します。

#### **PowerShell例:**
```powershell
Select-String -Path "path_to_log_file.log" -Pattern "your_database_name"
```

---

### **5. 調査のポイント**
- **接続の安定性:** アプリケーションが指定したデータベースに正しく接続できているか。
- **エラー内容:** ログに記録されるエラーメッセージの詳細（例: 権限不足、タイムアウトなど）。
- **パフォーマンス:** 特定のデータベースで遅延が発生している場合、クエリ計画やインデックス設定を確認。

---

これにより、特定のデータベースに関連する更新処理の調査が効率的に進められます。

### user — 2025-01-10T00:58:25.783769+00:00

AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"
| where TimeGenerated between(datetime("[[REDACTED_PHONE]]-01T00:00:00Z") .. datetime("[[REDACTED_PHONE]]-31T23:59:59Z"))
| project TimeGenerated, database_name_s, log_statement_s, Message
を評価

### assistant — 2025-01-10T00:58:48.004975+00:00

このクエリはAzure MonitorのLog Analyticsを使用して、Azure Database for PostgreSQL Flexible Serverの特定のデータベースに関連するログを特定の期間で絞り込むために利用されます。クエリの構造を評価し、以下に詳細を解説します。

---

### **クエリの評価と解説**

1. **`AzureDiagnostics` テーブル**
   - Azure Monitorで収集された診断ログが保存されるテーブルです。
   - PostgreSQL Flexible Serverのクエリログもこのテーブルに保存されます。

2. **`where ResourceType == "POSTGRESQLFLEXIBLESERVER"`**
   - PostgreSQL Flexible Serverに関連するログのみを抽出します。
   - 他のリソース（例えばAzure SQL DatabaseやVMなど）のログを除外するための条件です。

3. **`where database_name_s == "your_database_name"`**
   - `your_database_name` に一致するデータベース名のログをフィルタリングします。
   - データベースごとにログを分けたい場合に有効です。
   - 注意: `database_name_s` はAzureDiagnosticsテーブルに存在するデータベース名列（_suffix `_s` は文字列型列を示します）。

4. **`where TimeGenerated between(datetime("[[REDACTED_PHONE]]-01T00:00:00Z") .. datetime("[[REDACTED_PHONE]]-31T23:59:59Z"))`**
   - 日付範囲を設定して、2023年12月1日から12月31日までのログに限定しています。
   - `TimeGenerated` はログが記録されたタイムスタンプを指します。

5. **`project TimeGenerated, database_name_s, log_statement_s, Message`**
   - 必要な列のみを抽出します。
     - **`TimeGenerated`**: ログのタイムスタンプ。
     - **`database_name_s`**: データベース名。
     - **`log_statement_s`**: 実行されたクエリのログ。
     - **`Message`**: クエリ実行に関連する追加情報やエラーメッセージ。

---

### **クエリの改良提案**
現状のクエリは十分に目的を果たしますが、場合によっては以下の改善が考えられます。

1. **特定のクエリ種類をフィルタリング**
   - 更新系（`UPDATE`、`INSERT`、`DELETE`）に限定したい場合:
     ```kql
     | where log_statement_s contains "UPDATE" or log_statement_s contains "INSERT" or log_statement_s contains "DELETE"
     ```

2. **タイムゾーンに注意**
   - 現在のクエリではUTCを使用していますが、ローカルタイムを使用したい場合、日付部分を調整する必要があります。

3. **エラーの抽出**
   - エラーが発生したクエリだけを確認したい場合:
     ```kql
     | where Message contains "ERROR"
     ```

---

### **例: 改良されたクエリ**
以下は、特定のデータベースに関連する更新系クエリで、2023年12月のエラーを抽出する例です。

```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"
| where log_statement_s contains "UPDATE" or log_statement_s contains "INSERT" or log_statement_s contains "DELETE"
| where TimeGenerated between(datetime("[[REDACTED_PHONE]]-01T00:00:00Z") .. datetime("[[REDACTED_PHONE]]-31T23:59:59Z"))
| where Message contains "ERROR"
| project TimeGenerated, database_name_s, log_statement_s, Message
```

---

### **結果の解釈**
- **クエリが返す情報:**
  - 指定されたデータベースに対するクエリ（特定期間内の`UPDATE`、`INSERT`、`DELETE`）。
  - 実行されたクエリのログとエラー情報（存在する場合）。

- **この情報でできること:**
  - アプリケーションから正しくクエリが実行されているかの確認。
  - エラーが発生したクエリとその詳細の調査。

---

### **結論**
現在のクエリは特定データベースの特定期間のクエリログを取得するために適切で、調査目的に合致しています。必要に応じてエラー抽出やクエリ種別のフィルタリングを追加することで、より具体的な情報にアクセス可能です。

### user — 2025-01-10T00:59:15.093069+00:00

ローカルタイムを利用する場合

### assistant — 2025-01-10T00:59:35.660166+00:00

Azure MonitorのLog Analyticsクエリでローカルタイムを使用する場合、`datetime`関数で指定するタイムスタンプをローカルタイムに変換し、それに基づいてクエリを記述する必要があります。Azure MonitorのデフォルトタイムスタンプはUTCですので、ローカルタイムとの時差を考慮します。

---

### **ローカルタイムを使用したクエリの例**
以下のクエリは、日本標準時（JST, UTC+9）をローカルタイムとして利用する場合の例です。

#### **クエリ例:**
```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"
| where TimeGenerated between(datetime("[[REDACTED_PHONE]]-01T00:00:00Z") .. datetime("[[REDACTED_PHONE]]-31T23:59:59Z"))
| extend LocalTime = TimeGenerated + 9h  // ローカルタイムに変換
| where LocalTime between(datetime("[[REDACTED_PHONE]]-01T00:00:00") .. datetime("[[REDACTED_PHONE]]-31T23:59:59"))  // ローカルタイムで絞り込み
| project LocalTime, database_name_s, log_statement_s, Message
```

---

### **クエリのポイント**
1. **`extend`を使用してローカルタイムを生成**
   - `TimeGenerated + 9h` でタイムスタンプをJST（UTC+9）に変換しています。
   - 他のタイムゾーンの場合は、適切な時間差を加減します（例: UTC-5なら `- 5h`）。

2. **ローカルタイムで絞り込み**
   - ローカルタイム範囲でログをフィルタリングするため、`between`の条件にローカルタイムを使用します。

3. **`project`でローカルタイムを表示**
   - `project`で必要な列（`LocalTime`など）を選択して、ローカルタイムを表示します。

---

### **ローカルタイムを直接利用する場合（簡易版）**
クエリ全体をUTC基準ではなく、ローカルタイム基準で記述する方法もあります。

#### **クエリ例:**
```kql
AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"
| where TimeGenerated between(datetime("[[REDACTED_PHONE]]-30T15:00:00Z") .. datetime("[[REDACTED_PHONE]]-31T14:59:59Z"))  // JSTをUTCに変換
| project TimeGenerated, database_name_s, log_statement_s, Message
```

- **UTCへの変換**
  - JSTの「[[REDACTED_PHONE]]:00:00」をUTCに変換すると「[[REDACTED_PHONE]]:00:00」になります。
  - JSTの「[[REDACTED_PHONE]]:59:59」をUTCに変換すると「[[REDACTED_PHONE]]:59:59」になります。

---

### **結果の解釈**
- ローカルタイム（JST）を基準としたログ情報が取得され、`LocalTime`列でローカルタイムのタイムスタンプが確認できます。
- ローカルタイムで条件を指定したい場合は、`extend`による変換が便利です。
- ログの取得範囲を完全にローカルタイム基準にしたい場合は、UTC基準での時刻範囲を計算して指定します。

---

この方法を利用することで、ローカルタイムに基づいてAzure Database for PostgreSQL Flexible Serverのログを効率的に確認できます。

### user — 2025-01-10T01:04:17.792905+00:00

AzureDiagnostics
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"
| extend LocalTime = TimeGenerated + 9h  // ローカルタイムに変換
| where LocalTime between(datetime("[[REDACTED_PHONE]]-01T00:00:00") .. datetime("[[REDACTED_PHONE]]-31T23:59:59"))  // ローカルタイムで絞り込み
| project LocalTime, database_name_s, log_statement_s, Message
| order by LocalTime asc  // LocalTime で昇順にソート
を評価

### assistant — 2025-01-10T01:04:41.398378+00:00

このクエリは、**Azure MonitorのLog Analytics**で、Azure Database for PostgreSQL Flexible Serverの特定のデータベースに関連するログをローカルタイム（例: 日本標準時 JST）で取得し、時間順に並べて確認するためのものです。構造は正しく、目的に沿った効果的なクエリです。

以下にこのクエリの詳細評価と解説を示します。

---

### **クエリの各部分の評価**

#### **1. 基本的なフィルタリング**
```kql
| where ResourceType == "POSTGRESQLFLEXIBLESERVER"
| where database_name_s == "your_database_name"
```
- **評価:**
  - AzureDiagnosticsテーブルからPostgreSQL Flexible Server関連のログを取得するためのフィルタです。
  - `ResourceType`と`database_name_s`による絞り込みは、対象ログの正確な抽出に役立ちます。

#### **2. ローカルタイムへの変換**
```kql
| extend LocalTime = TimeGenerated + 9h
```
- **評価:**
  - UTCで記録された`TimeGenerated`を日本標準時（JST, UTC+9）に変換するためのステップです。
  - これにより、ローカルタイムでの時刻範囲指定や表示が可能になります。
  - 正確な計算が行われており問題ありません。

#### **3. 時間範囲での絞り込み**
```kql
| where LocalTime between(datetime("[[REDACTED_PHONE]]-01T00:00:00") .. datetime("[[REDACTED_PHONE]]-31T23:59:59"))
```
- **評価:**
  - ローカルタイム基準で2023年12月1日から12月31日までのログに絞り込んでいます。
  - 日付と時刻の範囲指定は適切で、正確に動作します。

#### **4. 必要な列の抽出**
```kql
| project LocalTime, database_name_s, log_statement_s, Message
```
- **評価:**
  - 必要な情報（ローカルタイム、データベース名、クエリ内容、メッセージ）だけを抽出しています。
  - 結果の簡潔性を保ちながら、調査に必要な情報を明確に表示する効果的な構成です。

#### **5. 時間順での並び替え**
```kql
| order by LocalTime asc
```
- **評価:**
  - ローカルタイムで昇順に並べることで、時系列に沿ったログの確認が可能です。
  - トラブルシューティングや調査時に、クエリの実行順序を把握しやすくなります。

---

### **クエリのメリット**
1. **ローカルタイムの利用**
   - JSTなどのローカルタイムに変換し、使いやすい形式でデータを確認できます。
2. **絞り込み条件の正確性**
   - データベース名と時間範囲で絞り込むことで、不要なログを排除できます。
3. **簡潔な結果表示**
   - 必要な列だけを表示するため、ログの可読性が向上しています。
4. **時間順ソート**
   - ログの順序を把握しやすく、エラーや不具合の追跡に便利です。

---

### **改良提案（必要に応じて）**
1. **特定のクエリ種別をフィルタ**
   - 例えば、更新系クエリ（`UPDATE`、`INSERT`、`DELETE`）に限定する場合:
     ```kql
     | where log_statement_s contains "UPDATE" or log_statement_s contains "INSERT" or log_statement_s contains "DELETE"
     ```

2. **エラーメッセージの抽出**
   - エラーに関連するログだけを確認する場合:
     ```kql
     | where Message contains "ERROR"
     ```

3. **ログ量の多さに対応**
   - 絞り込み条件を追加することで、非常に大きなログ量を効率的に処理可能です。

---

### **結論**
このクエリは、PostgreSQL Flexible Serverの特定データベースに関連するログをローカルタイムで効率的に確認するのに適しています。データ量が多い場合や特定の問題を調査する場合に、必要に応じて条件を追加することでさらに有効活用できます。
