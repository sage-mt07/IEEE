---
conversation_id: "68a59c12-5f10-8323-9059-0a43049b5f27"
title: "Avroã‚­ãƒ¼å¤‰æ›´æ–¹æ³•"
create_time: 1755683885.201421
update_time: 1755722549.221173
language_guess: "en"
num_messages: 21
part_index: 1
part_count: 1
---

### system â€” 2025-08-20T09:58:05.201421+00:00

_(empty)_

### user â€” 2025-08-20T09:58:05.201421+00:00

_(empty)_

### system â€” 2025-08-20T09:58:05.201421+00:00

_(empty)_

### assistant â€” 2025-08-20T09:58:06.635077+00:00

ã‚„ã‚ã€å¸ä»¤ï¼æŠ€è¡“çš„ã«è¦ç‚¹ã ã‘ã€‚

çµè«–ã ã‘å…ˆã«ï¼š  
- **å¯èƒ½ã§ã™ã€‚**ã€Œã©ã®æ®µéšã®â€œkeyâ€ã‚’å¤‰ãˆãŸã„ã‹ã€ã§ã‚„ã‚Šæ–¹ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚  
  1) **å…¥åŠ›ãƒˆãƒ”ãƒƒã‚¯ã®Keyã‚’ä»˜ã‘æ›¿ãˆã¦å‡¦ç†ã—ãŸã„** â†’ `SelectKey`ï¼ˆã¾ãŸã¯`Map`â†’`GroupByKey`ï¼‰ã§å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã€‚  
  2) **RocksDBã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒˆã‚¢ã«ä¿å­˜ã•ã‚Œã‚‹Keyã®å‹/ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å¤‰ãˆãŸã„** â†’ ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºå‰ã«Keyã‚’å¤‰æ›ã—ã€**å¯¾å¿œã™ã‚‹Key SerDes**ã‚’æŒ‡å®šã—ã¦æ–°ã—ã„ã‚¹ãƒˆã‚¢åã§ä½œã‚‹ï¼ˆæ—¢å­˜ã‚¹ãƒˆã‚¢ã®â€œã‚­ãƒ¼å½¢å¼ã ã‘å·®ã—æ›¿ãˆâ€ã¯ä¸å¯ã€ç§»è¡ŒãŒå¿…è¦ï¼‰ã€‚

---

# 1) Avroãƒˆãƒ”ãƒƒã‚¯ â†’ Keyã®ä»˜ã‘æ›¿ãˆï¼ˆå‡¦ç†ç³»ã®ã‚­ãƒ¼ï¼‰
```csharp
var builder = new StreamBuilder();

// å€¤ã¯Avroã€ã‚­ãƒ¼ã¯æ–‡å­—åˆ—ã®ä¾‹ï¼ˆAvroã‚­ãƒ¼ã‚‚å¯ï¼‰
var stream = builder.Stream<string, MyAvro>(
    "src-avro-topic",
    Consumed.With(new StringSerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)));

// ã“ã“ã§ã‚­ãƒ¼ã‚’ä»˜ã‘æ›¿ãˆã‚‹ï¼ˆä¾‹ãˆã° Broker+Symbol ã«ï¼‰
var rekeyed = stream.SelectKey((k, v) => $"{v.Broker}:{v.Symbol}");
// å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªã‚‰ GroupByKey() or Through() ã‚’æŒŸã‚€
var repartitioned = rekeyed
    .Through("tmp-repartition", Produced.With(new StringSerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)));
```
- `SelectKey` ã ã‘ã ã¨**åŒä¸€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å†…**ã®æ¦‚å¿µä¸Šã®ã‚­ãƒ¼å¤‰æ›´ã§ã™ã€‚  
- **é›†ç´„/ã‚¸ãƒ§ã‚¤ãƒ³**ãªã©ã‚­ãƒ¼å¢ƒç•Œã«ä¾å­˜ã™ã‚‹æ“ä½œã‚’ã™ã‚‹ãªã‚‰ã€`GroupByKey()` ã‚„ `Through()` ã§**å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³**ï¼ˆæ–°ãƒˆãƒ”ãƒƒã‚¯çµŒç”±ï¼‰ã«ã—ã¦ãã ã•ã„ã€‚

---

# 2) RocksDBï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒˆã‚¢ï¼‰ã®ã‚­ãƒ¼å½¢å¼ã‚’å¤‰ãˆã‚‹
RocksDBã«æ ¼ç´ã•ã‚Œã‚‹ã‚­ãƒ¼ã¯ã€**ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ™‚ç‚¹ã®Keyå‹ï¼‹Key SerDes**ã§æ±ºã¾ã‚Šã¾ã™ã€‚  
ã—ãŸãŒã£ã¦ã€**ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºå‰ã«Keyã‚’å¤‰æ›**ã—ã€`Materialized.With(keySerde, valueSerde).As("new-store")` ã®ã‚ˆã†ã«**æ–°ã—ã„ã‚¹ãƒˆã‚¢å**ã§ä½œã‚Šã¾ã™ã€‚

```csharp
var grouped = repartitioned.GroupByKey(
    Grouped.With(new StringSerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)));

var aggregated = grouped.Aggregate(
    initializer: () => new MyAgg(),
    aggregator: (key, value, agg) => Update(agg, value),
    Materialized
        .With(new StringSerDes(), new JsonSerDes<MyAgg>())   // â˜… RocksDBã«ä¿å­˜ã•ã‚Œã‚‹ã‚­ãƒ¼/å€¤ã®SerDes
        .As("bars-store")                                     // â˜… æ–°ã—ã„ã‚¹ãƒˆã‚¢åï¼ˆ= æ–°ã—ã„RocksDB + changelogï¼‰
);
```

- **æ—¢å­˜ã‚¹ãƒˆã‚¢ã®ã‚­ãƒ¼å½¢å¼ã‚’å¤‰ãˆã‚‹â€œã ã‘â€ã¯ä¸å¯**ã§ã™ã€‚  
  - äº’æ›æ€§ã®ãªã„Key SerDesã«å·®ã—æ›¿ãˆã‚‹ã¨**å¾©å…ƒã«å¤±æ•—**ã—ã¾ã™ã€‚  
  - **æ–°ã—ã„ã‚¹ãƒˆã‚¢å**ã‚’ä½¿ã£ã¦**å†æ§‹ç¯‰**ï¼ˆchangelogã‹ã‚‰ã®ãƒªãƒ“ãƒ«ãƒ‰ or å…¥åŠ›å†ãƒ—ãƒ¬ã‚¤ï¼‰ãŒåŸºæœ¬ã€‚
- ã©ã†ã—ã¦ã‚‚åŒåã‚¹ãƒˆã‚¢ã«å…¥ã‚Œæ›¿ãˆãŸã„å ´åˆã¯ã€**ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç§»è¡Œ**ï¼ˆã‚¢ãƒ—ãƒªåœæ­¢â†’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé€€é¿/å‰Šé™¤â†’åˆå›èµ·å‹•ã§ç©ºçŠ¶æ…‹ã‹ã‚‰å†æ§‹ç¯‰ï¼‰ã§ã™ãŒã€**æ¨å¥¨ã¯æ–°ã‚¹ãƒˆã‚¢å**ã§ã™ã€‚

---

# 3) Avro Key/Value ã®SerDeså‘¨ã‚Š
- **ValueãŒAvro**ï¼š`ConfluentAvroSerDes<T>`ï¼ˆã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¸ã‚¹ãƒˆãƒªè¨­å®šå¿…é ˆï¼‰ã€‚  
- **Keyã‚‚Avroã«ã—ãŸã„**å ´åˆï¼šã‚­ãƒ¼å´ã«ã‚‚ Avro SerDes ã‚’å‰²ã‚Šå½“ã¦å¯èƒ½ã§ã™ï¼ˆãŸã ã—ã€Kafkaã®é‹ç”¨ã§ã¯**ã‚­ãƒ¼ã¯æ–‡å­—åˆ—/ãƒã‚¤ãƒˆåˆ—**ã«å˜ç´”åŒ–ã™ã‚‹ã“ã¨ãŒå¤šã„ï¼‰ã€‚
- æ—¢å­˜ãƒˆãƒ”ãƒƒã‚¯ã®**ã‚­ãƒ¼ã®ã‚¹ã‚­ãƒ¼ãƒè‡ªä½“ã‚’å¤‰ãˆã‚‹**ï¼ˆä¾‹ï¼šStringâ†’Avroï¼‰å ´åˆã¯ã€**äº’æ›æ€§ãƒãƒªã‚·ãƒ¼**ã¨**å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³**ã®å½±éŸ¿ã«æ³¨æ„ã€‚

---

# 4) æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ»ç§»è¡Œã®æ³¨æ„ç‚¹ï¼ˆè¦ç‚¹ï¼‰
- **ã‚¹ãƒˆã‚¢åã‚’å¤‰ãˆã‚‹** â†’ è‡ªå‹•çš„ã«**æ–°ã—ã„changelog**ã§å†æ§‹ç¯‰ã€‚æ—§ã‚¹ãƒˆã‚¢ã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã«å‰Šé™¤ã€‚  
- **ãƒˆãƒãƒ­ã‚¸ã®äº’æ›æ€§**ï¼šé‹ç”¨ä¸­ã‚¢ãƒ—ãƒªã®ãƒˆãƒãƒ­ã‚¸å¤‰æ›´ã§ã¯ã€**ãƒãƒ¼ãƒ‰å**ã‚„**ã‚¹ãƒˆã‚¢å**ãŒå¤‰ã‚ã‚‹ã¨äº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚**ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚ˆã‚Šæ–°ãƒ‡ãƒ—ãƒ­ã‚¤**ã®æ–¹ãŒå®‰å…¨ã€‚  
- **éå»ãƒ‡ãƒ¼ã‚¿ã®å†æ§‹ç¯‰**ãŒå¿…è¦ãªã‚‰ã€å…¥åŠ›ãƒˆãƒ”ãƒƒã‚¯ã‚’**`auto.offset.reset=earliest`**ã§æœ€åˆã‹ã‚‰èª­ã‚€ã€ã‚‚ã—ãã¯**ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µ**ï¼ˆå°‚ç”¨ã‚¸ãƒ§ãƒ–ï¼‰ã‚’ç”¨æ„ã€‚

---

# 5) å…¸å‹ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®ã€Œã§ãã‚‹/ã§ããªã„ã€
- å…¥åŠ›ã®**â€œå‡¦ç†ã‚­ãƒ¼â€ã ã‘å¤‰ãˆã‚‹** â†’ âœ… `SelectKey` + `GroupByKey/Through`  
- RocksDBã®**ä¿å­˜ã‚­ãƒ¼å½¢å¼ï¼ˆå‹/ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ–¹å¼ï¼‰ã‚’å¤‰ãˆã‚‹** â†’ âœ… å¯èƒ½ã€‚ãŸã ã—**æ–°ã—ã„ã‚¹ãƒˆã‚¢åï¼‹å¯¾å¿œSerDesã§å†æ§‹ç¯‰**ãŒå‰æ  
- **æ—¢å­˜ã‚¹ãƒˆã‚¢ã‚’ãã®ã¾ã¾ã«â€œã‚­ãƒ¼SerDesã ã‘å·®ã—æ›¿ãˆâ€** â†’ âŒ éæ¨å¥¨/åŸºæœ¬ä¸å¯ï¼ˆå¾©å…ƒå¤±æ•—ãƒªã‚¹ã‚¯å¤§ï¼‰

---

å¿…è¦ãªã‚‰ã€å¸ä»¤ã®ç¾åœ¨ã®ãƒˆãƒãƒ­ã‚¸ï¼ˆ`builder`ã®å®šç¾©ã¨`Materialized`ã®ç®‡æ‰€ï¼‰ã‚’è²¼ã£ã¦ãã‚Œã‚Œã°ã€**æœ€å°å·®åˆ†ã®ç§»è¡Œæ‰‹é †**ã«è½ã¨ã—è¾¼ã¿ã¾ã™ã€‚  

é€ä¿¡æ—¥æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ï¼š[[REDACTED_PHONE]]:00

### system â€” 2025-08-20T09:58:07.182049+00:00

_(empty)_

### system â€” 2025-08-20T09:58:07.188578+00:00

_(empty)_

### assistant â€” 2025-08-20T09:58:07.210551+00:00

_(empty)_

### assistant â€” 2025-08-20T09:58:08.064368+00:00

_(empty)_

### user â€” 2025-08-20T09:58:09.528000+00:00

æŠ€è¡“çš„è³ªå•
avroå½¢å¼ã®topicã‚’streamizã§rocksdbã¸é€£æºã™ã‚‹
ãã®éš›ã«keyã®æŒã¡æ–¹ã‚’å¤‰æ›´ã§ãã‚‹ï¼Ÿ

### assistant â€” 2025-08-20T09:58:33.370304+00:00

_(empty)_

### system â€” 2025-08-20T10:00:46.584264+00:00

_(empty)_

### system â€” 2025-08-20T10:00:46.616595+00:00

_(empty)_

### assistant â€” 2025-08-20T10:00:46.684669+00:00

ã‚„ã‚å¸ä»¤ã€‚è¦ä»¶ã¯ã€Œè¤‡æ•°ã‚«ãƒ©ãƒ è¤‡åˆã‚­ãƒ¼ â†’ æ–‡å­—åˆ—ã‚­ãƒ¼åŒ–ã—ã¦ã€RocksDBï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒˆã‚¢ï¼‰ã«é€£æºã€ã€‚ã§ãã¾ã™ã€‚å®Ÿå‹™ã§å®‰å…¨ã«ã‚„ã‚‹ã«ã¯ä¸‹ã®æ‰‹é †ï¼‹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ã¦ãã ã•ã„ã€‚

# æ–¹é‡ï¼ˆå®‰å…¨ç‰ˆï¼‰
1) **è¤‡åˆã‚­ãƒ¼ã‚’æ±ºå®šè«–çš„ãªæ–‡å­—åˆ—ã¸æ­£è¦åŒ–**ï¼ˆåŒºåˆ‡ã‚Šãƒ»ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãƒ»ã‚«ãƒ«ãƒãƒ£å›ºå®šï¼‰  
2) **SelectKey** ã§ã‚­ãƒ¼ã‚’ãã®æ–‡å­—åˆ—ã«ä»˜ã‘æ›¿ãˆ  
3) **GroupByKey/Through** ã§å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªå ´åˆï¼‰  
4) **Materialized.With(StringSerDes, â€¦).As("store-name")** ã§ RocksDB ã«æ–‡å­—åˆ—ã‚­ãƒ¼ã§ä¿å­˜

## 1) æ±ºå®šè«–çš„ãªæ–‡å­—åˆ—ã‚­ãƒ¼ã®ä½œã‚Šæ–¹ï¼ˆæ¨å¥¨ãƒ«ãƒ¼ãƒ«ï¼‰
- åŒºåˆ‡ã‚Šã« **`'\u001F'` (Unit Separator)** ã‚’ä½¿ã†ï¼ˆäººãŒæ‰“ãŸãªã„ãƒ»è¡çªã—ã«ãã„ï¼‰ã€‚  
- å„è¦ç´ ã¯ **URL-safe Base64** ã‹ **ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**ï¼ˆ`Replace("\u001F", "%1F")` ãªã©ï¼‰ã§è¡çªå›é¿ã€‚  
- æ—¥ä»˜/æ•°å€¤ã¯ **`InvariantCulture`** ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯ **UTC ISO8601** å›ºå®šï¼‰ã€‚  
- å°†æ¥æ‹¡å¼µç”¨ã« **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¥é ­è¾**ã‚’ä»˜ã‘ã‚‹ï¼ˆä¾‹ï¼š`"v1âŸbroker=...âŸsymbol=...âŸts=..."`ï¼‰ã€‚

### ä¾‹ï¼šãƒ˜ãƒ«ãƒ‘
```csharp
static class KeyFmt
{
    private const char Sep = '\u001F';
    private static string E(string s) => s.Replace("\u001F", "%1F");
    private static string E(DateTimeOffset tsUtc) => tsUtc.ToUniversalTime().ToString("O", System.Globalization.CultureInfo.InvariantCulture);
    private static string E(decimal d) => d.ToString(System.Globalization.CultureInfo.InvariantCulture);

    public static string V1(string broker, string symbol, DateTimeOffset tsUtc)
        => string.Join(Sep, "v1", $"b={E(broker)}", $"s={E(symbol)}", $"t={E(tsUtc)}");
}
```

## 2) Streamiz ã§ã®ã‚­ãƒ¼ä»˜ã‘æ›¿ãˆï½RocksDB é€£æºï¼ˆC#ï¼‰
```csharp
var builder = new StreamBuilder();

// Avroå€¤ã‚’èª­ã‚€ï¼ˆã‚­ãƒ¼ã¯å…ƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¾ã¾ã§OKï¼‰
var src = builder.Stream<byte[], MyAvro>(
    "rates-avro",
    Consumed.With(new ByteArraySerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)));

// ä¾‹ï¼‰å€¤ã®è¤‡æ•°ã‚«ãƒ©ãƒ ã‹ã‚‰æ–‡å­—åˆ—ã‚­ãƒ¼ã‚’ç”Ÿæˆ
var rekeyed = src.SelectKey((origKey, v) =>
    KeyFmt.V1(v.Broker, v.Symbol, DateTime.SpecifyKind(v.Timestamp, DateTimeKind.Utc)));

// é›†ç´„ã‚„ã‚¸ãƒ§ã‚¤ãƒ³ã‚’ã™ã‚‹ãªã‚‰å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã¨ãã ã‘ï¼‰
var repartitioned = rekeyed.Through(
    "rates-repartition",
    Produced.With(new StringSerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)));

// ãŸã¨ãˆã° KTable åŒ–ã—ã¦ RocksDB ã«ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚º
var table = repartitioned
    .GroupByKey(Grouped.With(new StringSerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)))
    .Aggregate(
        () => new MyAgg(),
        (key, v, agg) => UpdateAgg(agg, v),
        Materialized
            .As<string, MyAgg, IKeyValueStore<Bytes, byte[]>>("rates-store") // RocksDB å
            .WithKeySerDes(new StringSerDes())                               // â˜… RocksDB ã®ã‚­ãƒ¼å‹ = string
            .WithValueSerDes(new JsonSerDes<MyAgg>()));
```

> ãƒã‚¤ãƒ³ãƒˆ  
> - **SelectKey** ã—ãŸã ã‘ã§ã¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚**é›†ç´„/ã‚¸ãƒ§ã‚¤ãƒ³ã®å‰**ã« `GroupByKey()` ã‚„ `Through()` ã§**å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³**ã—ã¦ãã ã•ã„ã€‚  
> - RocksDB ã«ä¿å­˜ã•ã‚Œã‚‹ã‚­ãƒ¼ã¯ **Materialized.With(ã‚­ãƒ¼SerDes)** ã§æ±ºã¾ã‚Šã€ã“ã“ã§ **StringSerDes** ã‚’æŒ‡å®šã—ã¾ã™ã€‚

## 3) å…ƒã‚­ãƒ¼ãŒ Avro/è¤‡åˆæ§‹é€ ãªå ´åˆ
- **å…ƒã‚­ãƒ¼ãŒ Avro ãƒ¬ã‚³ãƒ¼ãƒ‰**ã§ã‚‚åŒã˜ã€‚`SelectKey((kAvro, v) => KeyFmt.V1(kAvro.Broker, kAvro.Symbol, kAvro.Ts))` ã®ã‚ˆã†ã«å–ã‚Šå‡ºã—ã¦æ–‡å­—åˆ—åŒ–ã€‚  
- ã‚­ãƒ¼ã®ä¸€éƒ¨ãŒ **å€¤å´**ã€ä¸€éƒ¨ãŒ **ã‚­ãƒ¼å´**ã«æ•£ã£ã¦ã„ã‚‹å ´åˆã‚‚ã€`SelectKey` å†…ã§ä¸¡æ–¹ã‹ã‚‰çµ„ã¿ç«‹ã¦ã‚Œã°OKã€‚

## 4) æ—¢å­˜ã‚¹ãƒˆã‚¢ã‹ã‚‰ã®ç§»è¡Œ
- **ã‚­ãƒ¼å½¢å¼ã‚’å¤‰ãˆã‚‹ï¼åˆ¥ã‚¹ãƒˆã‚¢å**ãŒåŸå‰‡ï¼ˆä¾‹ï¼š`"rates-store"` â†’ `"rates-store-v1"`ï¼‰ã€‚  
- æ–°ã‚¹ãƒˆã‚¢ã¯ **changelog ã‹ã‚‰è‡ªå‹•å†æ§‹ç¯‰**ã•ã‚Œã¾ã™ã€‚å¤ã„ã‚¹ãƒˆã‚¢ã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã«å‰Šé™¤ã€‚  
- é‹ç”¨ä¸­ã®ãƒˆãƒãƒ­ã‚¸äº’æ›æ€§ã«æ³¨æ„ï¼ˆãƒãƒ¼ãƒ‰å/ã‚¹ãƒˆã‚¢åã®å¤‰æ›´ã¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°æ›´æ–°ä¸å¯ãªã“ã¨ãŒå¤šã„ â†’ **æ–°ãƒ‡ãƒ—ãƒ­ã‚¤**ãŒå®‰å…¨ï¼‰ã€‚

## 5) ã‚ã‚ŠãŒã¡ãªè½ã¨ã—ç©´
- åŒºåˆ‡ã‚Šè¡çªï¼ã‚«ãƒ«ãƒãƒ£ä¾å­˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ â†’ **ä¸Šã® KeyFmt ãƒ«ãƒ¼ãƒ«ã§å›é¿**ã€‚  
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¶ã‚Œ â†’ **UTC â€œOâ€ å½¢å¼å›ºå®š**ã€‚  
- æ–‡å­—åˆ—ã‚­ãƒ¼ãŒé•·ã™ãã‚‹ â†’ å¿…è¦ãªã‚‰ **ãƒãƒƒã‚·ãƒ¥ä»˜ã**ï¼ˆ`"{prefix}:{SHA256(baseKey)}"`ï¼‰ã‚’æ¡ç”¨ã€‚ãŸã ã— **åŸæ–‡ã‚­ãƒ¼ã‚‚æ®‹ã™**ï¼ˆãƒ‡ãƒãƒƒã‚°/å†ç”Ÿæˆç”¨ï¼‰ã€‚

---

å¿…è¦ãªã‚‰ã€å¸ä»¤ã®ã€Œå®Ÿéš›ã®è¤‡åˆã‚­ãƒ¼ï¼ˆé …ç›®åï¼‰ã€ã‚’æ•™ãˆã¦ãã‚Œã‚Œã° **`KeyFmt` ã®å®Ÿè£…ã‚’ãã®ã¾ã¾å·®ã—æ›¿ãˆ**ç‰ˆã§è¿”ã™ã‚ˆï¼ˆ`decimal`/`DateOnly`/`Guid` å¯¾å¿œè¾¼ã¿ï¼‰ã€‚  

é€ä¿¡æ—¥æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ï¼š[[REDACTED_PHONE]]:â€”

### assistant â€” 2025-08-20T10:00:48.300705+00:00

_(empty)_

### user â€” 2025-08-20T10:00:49.212000+00:00

topicå´ã¯è¤‡æ•°ã®ã‚«ãƒ©ãƒ ã«ã‚ˆã‚‹ã‚­ãƒ¼ãŒã‚ã‚‹ã€‚ã“ã‚Œã‚’stringå¤‰æ›ã—ã¦rocksdbé€£æºã™ã‚‹

### assistant â€” 2025-08-20T10:01:05.276365+00:00

_(empty)_

### system â€” 2025-08-20T10:15:11.753522+00:00

_(empty)_

### system â€” 2025-08-20T10:15:11.815969+00:00

_(empty)_

### assistant â€” 2025-08-20T10:15:11.836225+00:00

å¸ä»¤ã€ã‚ã‚ŠãŒã¨ã†ğŸ˜Š  
ã“ã®è¤‡åˆã‚­ãƒ¼ â†’ æ–‡å­—åˆ—ã‚­ãƒ¼å¤‰æ›ï¼‹RocksDBé€£æºã®æ•´ç†ã¯ã€è‡ªåˆ†ã§ã‚‚ã‹ãªã‚Šã€Œå®Ÿå‹™ã§ãã®ã¾ã¾ä½¿ãˆã‚‹ã€å†…å®¹ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚  

åˆ¥ã®å¤©åŸã«ä¼ãˆã‚‹ãªã‚‰ã€æ¬¡ã®ã‚ˆã†ã«æ¸¡ã™ã¨ç†è§£ã•ã‚Œã‚„ã™ã„ã‚ˆï¼š

---

### ä¼é”ç”¨ã¾ã¨ã‚ï¼ˆå¤©åŸå‘ã‘ï¼‰

- **ç›®çš„**: Avroå½¢å¼ã®ãƒˆãƒ”ãƒƒã‚¯ã§ã€è¤‡æ•°ã‚«ãƒ©ãƒ ã‹ã‚‰æˆã‚‹ã‚­ãƒ¼ã‚’ã€Œæ±ºå®šè«–çš„ãªæ–‡å­—åˆ—ã€ã«å¤‰æ›ã—ã¦ RocksDB ã«ä¿å­˜ã™ã‚‹ã€‚  
- **æ–¹æ³•**:
  1. **SelectKey** ã§è¤‡æ•°ã‚«ãƒ©ãƒ ã‚’çµ„ã¿åˆã‚ã› â†’ æ–‡å­—åˆ—åŒ–ï¼ˆåŒºåˆ‡ã‚Šãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ±ºã‚æ‰“ã¡ï¼‰  
  2. **GroupByKey/Through** ã§å†ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰  
  3. **Materialized.With(StringSerDes, â€¦).As("store-name")** ã§ RocksDB ã«ä¿å­˜  
- **æ–‡å­—åˆ—åŒ–ã®ãƒ«ãƒ¼ãƒ«ä¾‹**:  
  - åŒºåˆ‡ã‚Šã« `\u001F`ï¼ˆUnit Separatorï¼‰  
  - è¡çªå›é¿ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†  
  - æ—¥ä»˜/æ•°å€¤ã¯ `InvariantCulture` å›ºå®š  
  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¥é ­è¾ã‚’ä»˜ã‘ã¦å°†æ¥æ‹¡å¼µå¯¾å¿œ  
- **æ³¨æ„ç‚¹**:
  - æ—¢å­˜ã‚¹ãƒˆã‚¢ã«ã‚­ãƒ¼å½¢å¼ã ã‘å·®ã—æ›¿ãˆã¯ä¸å¯ â†’ æ–°ã—ã„ã‚¹ãƒˆã‚¢åã‚’ä½¿ã£ã¦å†æ§‹ç¯‰  
  - ãƒˆãƒãƒ­ã‚¸äº’æ›æ€§ã®ãŸã‚ã€æ—¢å­˜ãƒãƒ¼ãƒ‰å/ã‚¹ãƒˆã‚¢åã‚’å¤‰æ›´ã™ã‚‹ã¨ãƒ­ãƒ¼ãƒªãƒ³ã‚°æ›´æ–°ä¸å¯ã«ãªã‚‹ã“ã¨ãŒå¤šã„  

### ç°¡æ˜“ã‚³ãƒ¼ãƒ‰æ–­ç‰‡
```csharp
var rekeyed = src.SelectKey((k, v) =>
    KeyFmt.V1(v.Broker, v.Symbol, DateTime.SpecifyKind(v.Timestamp, DateTimeKind.Utc)));

var table = rekeyed
    .GroupByKey(Grouped.With(new StringSerDes(), new ConfluentAvroSerDes<MyAvro>(srConfig)))
    .Aggregate(
        () => new MyAgg(),
        (key, v, agg) => UpdateAgg(agg, v),
        Materialized.As<string, MyAgg, IKeyValueStore<Bytes, byte[]>>("rates-store")
            .WithKeySerDes(new StringSerDes())
            .WithValueSerDes(new JsonSerDes<MyAgg>()));
```

---

ã“ã®ã¾ã¾ä¼ãˆã‚Œã°ã€Œè¤‡åˆã‚­ãƒ¼ â†’ æ–‡å­—åˆ—ã‚­ãƒ¼åŒ– â†’ RocksDB ä¿å­˜ã€ã®æµã‚ŒãŒä¸€ç›®ã§ã‚ã‹ã‚‹ã¯ãšã€‚  
ã‚‚ã—å¸ä»¤ãŒã€Œè¦ç‚¹ã ã‘ã€ã®çŸ­ç¸®ç‰ˆãŒå¿…è¦ãªã‚‰ã€ç®‡æ¡æ›¸ã3è¡Œãã‚‰ã„ã«åœ§ç¸®ã—ã¦æ¸¡ã™ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã€‚  

ğŸ‘‰ å¸ä»¤ã€ä¼ãˆã‚‹ã¨ãã¯ã€Œè©³ã—ãç†è§£ã•ã›ãŸã„ã€ã‹ã€Œæœ€å°é™ã®æ‰‹é †ã‚’æ¸¡ã—ãŸã„ã€ã‹ã€ã©ã£ã¡ã®ã‚¹ã‚¿ã‚¤ãƒ«ã«ã™ã‚‹ï¼Ÿ  

é€ä¿¡æ—¥æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ï¼š[[REDACTED_PHONE]]:27

### user â€” 2025-08-20T10:15:16.504000+00:00

ã™ã°ã‚‰ã—ã„ãƒ»ã€€åˆ¥ã®å¤©åŸã«ä¼ãˆãŸã„
